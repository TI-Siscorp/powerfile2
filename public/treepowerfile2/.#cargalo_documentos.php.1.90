<?php
 
use PhpParser\Node\Stmt\Else_;
use phpDocumentor\Reflection\Element;

@session_start();
	
date_default_timezone_set('America/Bogota');

@$valor = $_SESSION['lenguaje'];

if ($valor == '')
	{
		
		$valor = 'en';
	}
	
//este proceso solo se ejecuta para la busqueda del idioma que se va a usar en las tablas del pluggin datable	
if(isset($_REQUEST['leguajes'])) {
		try {
				$result = null;
				
				switch($_REQUEST['leguajes']) {
					case 'dameidioma':			
						echo $_SESSION['lenguaje'];
						exit();
					break;
				}
			}	
		catch (Exception $e) {
			header($_SERVER["SERVER_PROTOCOL"] . ' 500 Server Error');
			header('Status:  500 Server Error');
			echo $e->getMessage();
		}
	} 

/////////////			
	
	
require('traduccion_arbol.php');

$traduce = new Traduccion_arbol();

@$configdb = $_REQUEST['configdb'];

@$espaciotrabajo = $_REQUEST['workspace'];

 if ($espaciotrabajo == '')
 	{
 		$espaciotrabajo = $_REQUEST['workspace'];  
 	}	
function darurl()
	{
		return sprintf(
				"%s://%s%s",
				isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off' ? 'https' : 'http',
				$_SERVER['SERVER_NAME'],
				''
				);
	}

if ($configdb != '')
	{

		@$rutadir = $_REQUEST['configdb'];
 
		$fp = fopen($configdb."/treepowerfile2/configdb", "r");
	}
else 
	{
		
		$configdb=  darurl();  
		
		@$rutadir = $_REQUEST['configdb'];
		
		$fp = fopen($configdb."/treepowerfile2/configdb", "r");
		
	}
 
	
//////
	/////////////nuevo
	$fp = fopen("../../config/database.php", "r");
	
	$linea = '';
	$nlinea = '';
	$numlinea = 0;
	$letra = '';
	while(!feof($fp)) {
	
		$linea = fgets($fp);
	
		if (trim($linea) == "'".$espaciotrabajo."' => [" )
		{
			$numlinea = $numlinea + 1;
		}
		if ($numlinea > 0 )
		{
	
			if ($numlinea == 2)
			{
				$driverl = $linea;
			}
			else
			{
				if ($numlinea == 3)
				{
					$hostl = $linea;
				}
				else
				{
					if ($numlinea == 4)
					{
						$puertol = $linea;
					}
					else
					{
						if ($numlinea == 5)
						{
							$dbl = $espaciotrabajo;
						}
						else
						{
							if ($numlinea == 6)
							{
								$usernl = $linea;
							}
							else
							{
								if ($numlinea == 7)
								{
									$passl = $linea;
								}
	
							}
						}
					}
				}
			}
			$numlinea = $numlinea + 1;
		}
	
	}
	
	fclose($fp);
	
	//se desglosan los 6 valores a usar
	
	//1.- el driver
	
	$driverl = explode('=>',$driverl);  
	
	$driverl = trim($driverl[1]);
	
	$driverl = substr($driverl, 0, -1);
	
	$driverl = str_replace("'","", $driverl);		
	//
	//2.- el host
	
	$hostl = explode('=>',$hostl);
	
	$hostl = trim($hostl[1]);
	
	$hostl = substr($hostl, 0, -1);
	
	$hostl = str_replace("'","", $hostl);		
	//
	//3.- el puerto
	
	$puertol = explode('=>',$puertol);
	
	$puertol = trim($puertol[1]);
	
	$puertol = substr($puertol, 0, -1);
	
	$puertol = str_replace("'","", $puertol);		
	////
	//4.- la db
	
	$dbl = $espaciotrabajo;
	//
	//5.- el usuario
	
	$usernl = explode('=>',$usernl);
	
	$usernl = trim($usernl[1]);
	
	$usernl = substr($usernl, 0, -1);
	
	$usernl = str_replace("'","", $usernl);		
	//
	//5.- el pass
	
	$passl = explode('=>',$passl);
	
	$passl = trim($passl[1]);
	
	$passl = substr($passl, 0, -1);
	
	$passl = str_replace("'","", $passl);		
	
	
	unset($configdb);
	
	$configdb[] = trim($driverl);
	
	$configdb[] = trim($hostl);
	
	$configdb[] = trim($usernl);
	
	$configdb[] = trim($passl);
	
	$configdb[] = trim($dbl);
	
	$configdb[] = trim($puertol);
	
	//print_r($configdb);
	
	if ($configdb[0] == 'mysql')
	{
		$servername = $configdb[1]; //"127.0.0.1";
		$username = $configdb[2]; //"root";
		$password = $configdb[3];//"desarrollo1";
		//se busca el espacio de trabajo
		@$dbname = $_REQUEST['workspace']; //$_SESSION['espaciotrabajo'];
		if ($dbname == ''){$dbname = $espaciotrabajo;}
		@$tablaid = @$_REQUEST['tablaid'];
		$conn = mysql_connect($servername, $username, $password, true, 65536) or trigger_error(mysql_error(),E_USER_ERROR);
		mysql_select_db($dbname,$conn);
	}
	else
	{
		if (trim($configdb[0]) == 'pgsql')
			{
				$servername = trim($configdb[1]);//"127.0.0.1";
				$username = trim($configdb[2]); //"root";
				$password = trim($configdb[3]);//"loquesea";
				//se busca el espacio de trabajo
				@$dbname = $_REQUEST['workspace']; //$_SESSION['espaciotrabajo'];
				if ($dbname == ''){$dbname = $espaciotrabajo;}
				$port = trim($configdb[5]); //"5432";
				@$tablaid = @$_REQUEST['tablaid'];  //echo "host=$servername port=$port user=$username password=$password dbname=$dbname";
				$conn = pg_connect("host=$servername port=$port user=$username password=$password dbname=$dbname") or die ('no se pudo conectar'.pg_last_error());
			}
		else 
			{
				if (trim($configdb[0]) == 'sqlsrv')
					{
						$servername = $configdb[1]; //"127.0.0.1";
						$username = $configdb[2]; //"root";
						$password = $configdb[3];//"desarrollo1";
						//se busca el espacio de trabajo
						@$dbname = $_REQUEST['workspace']; //$_SESSION['espaciotrabajo'];
						if ($dbname == ''){$dbname = $espaciotrabajo;}
						@$tablaid = @$_REQUEST['tablaid'];
						$port = trim($configdb[5]); //"5432";
						$connectionInfo = array( "Database"=>$dbname, "UID"=>$username, "PWD"=>$password);
						$conn = sqlsrv_connect( $hostl, $connectionInfo);
						
					}
			}
	}
	
	
	/////////////

if (!$conn)
	{
		print_r('no se conecta a la bd');
		exit;
	}
	
$sql = 'select key_encrypt from sgd_encrypt  where id_encrypt > 0 and id_estado = 1'; 

if ($configdb[0] == 'mysql')
	{
		$qeryllave =  mysql_query($sql,$conn);
			
		$llave = mysql_fetch_assoc($qeryllave);
			
		$kweyllave =  $llave['key_encrypt'];
	}
else
	{
		if ($configdb[0] == 'pgsql')
			{
				$qeryllave = pg_query($conn,$sql);
					
				$llave = pg_fetch_assoc($qeryllave);
		
				$kweyllave =  $llave['key_encrypt'];
			}
		else 
			{
				if (trim($configdb[0]) == 'sqlsrv')
					{						
						$qeryllave = sqlsrv_query( $conn, $sql);  
						
						while( $row = sqlsrv_fetch_array( $qeryllave, SQLSRV_FETCH_ASSOC )) 
							{
								$kweyllave =  $row['key_encrypt'];
							}	
					}
			}
	}

	
	
	/////////////////// ara encriptar archivos de cualquier tipo
function encryptFile($file,$pathbodega,$kweyllave) {//se pasa el nombre del archivo a encriptar
	
	
	
	$path = $pathbodega;   //"content";
	$filename = substr($file, 0, strrpos($file,"."));
	$newfile = $path.'/'.$filename.'.dat';
	$msg = file_get_contents($path.'/'.$file);

	//se abre el cifrado de datos
	$td = mcrypt_module_open('tripledes', '', 'ecb', '');

	//se crea el valor IV y se determina la longitud de la key, se usa MCRYPT_RAND
	$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td), MCRYPT_RAND);

	//se coloca la clave a trabajar para el espacio de trabajo (se toma de la bd del espacio de trabajo correspondiente)
	
	
		
	//$key = substr('1a2b3c4d5f6g7h8jqwertyuioplkjhgfdsa', 0, 16);
	
	$key = substr($kweyllave, 0, 16);

	//se inicializa el manejador de la encriptación
	mcrypt_generic_init($td, $key, $iv);

	//se encripta la data del archivo original
	$encrypted = mcrypt_generic($td, $msg);

	//se culmina el proceso de encriptación
	mcrypt_generic_deinit($td);

	//se cierra el manejador de  la encriptación
	mcrypt_module_close($td);

	//se genera el nuevo archivo ya encriptado
	$nfile = fopen($newfile, 'w');
	fwrite($nfile, $encrypted);
	fclose($nfile);

}


function encryptFilecsv($file,$pathbodega,$kweyllave,$idimagen) {//se pasa el nombre del archivo a encriptar
	
	
	
	$path = $pathbodega;   //"content";
	$filename = substr($file, 0, strrpos($file,"."));
	$newfile = $path.'/'.$idimagen.'_.dat';
	$msg = file_get_contents($path.'/'.$file);
	
	//se abre el cifrado de datos
	$td = mcrypt_module_open('tripledes', '', 'ecb', '');
	
	//se crea el valor IV y se determina la longitud de la key, se usa MCRYPT_RAND
	$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td), MCRYPT_RAND);
	
	//se coloca la clave a trabajar para el espacio de trabajo (se toma de la bd del espacio de trabajo correspondiente)
	
	
	
	//$key = substr('1a2b3c4d5f6g7h8jqwertyuioplkjhgfdsa', 0, 16);
	
	$key = substr($kweyllave, 0, 16);
	
	//se inicializa el manejador de la encriptación
	mcrypt_generic_init($td, $key, $iv);
	
	//se encripta la data del archivo original
	$encrypted = mcrypt_generic($td, $msg);
	
	//se culmina el proceso de encriptación
	mcrypt_generic_deinit($td);
	
	//se cierra el manejador de  la encriptación
	mcrypt_module_close($td);
	
	//se genera el nuevo archivo ya encriptado
	$nfile = fopen($newfile, 'w');
	fwrite($nfile, $encrypted);
	fclose($nfile);
	
}
	
	/////////////////para desencriptar los archivos .dat
	
	function inFTP($file,$pathbodega,$pathvisor,$kweyllave) {
		
		
		
		$path = $pathbodega;
		$filename = substr($file, 0, strrpos($file,"."));
		$extensf = substr(strrchr($file, "."),1);
		$newfile = $pathvisor.'/'.$filename.'.'.$extensf;
		$msg = file_get_contents($path.'/'.$filename.'.dat');
		
		//se abre el cifrado de datos
		$td = mcrypt_module_open('tripledes', '', 'ecb', '');
		
		//se crea el valor IV y se determina la longitud de la key, se usa MCRYPT_RAND
		$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td), MCRYPT_RAND);
	
			
		//$key = substr('1a2b3c4d5f6g7h8jqwertyuioplkjhgfdsa', 0, 16);
		
		$key = substr($kweyllave, 0, 16);
	
		//se inicializa el manejador de la encriptación
		mcrypt_generic_init($td, $key, $iv);
	
		//se desencripta la data del archivo encriptado
		$decrypted = mdecrypt_generic($td, $msg);
		
		//se culmina el proceso de desencriptación
		mcrypt_generic_deinit($td);
	
		//se cierra el manejador de  la encriptación
		mcrypt_module_close($td);
	
		//se genera el nuevo archivo ya desenencriptado
		$nfile = fopen($newfile, 'w');
		fwrite($nfile, $decrypted);
		fclose($nfile);
	}
	

if(isset($_GET['operation'])) {
	try {
		$result = null;

		switch($_GET['operation']) {
			case 'analyze':
				var_dump($fs->analyze(true));
				die();
				break;
			case 'get_node':
				$node = isset($_GET['id']) && $_GET['id'] !== '#' ? (int)$_GET['id'] : 0;
				$sql = "SELECT * FROM sgd_folders where id_tabla = ".$tablaid;  
				if ($configdb[0] == 'mysql')
					{
						$res = mysql_query($sql,$conn);
						$numreg = mysql_num_rows($res);
						//iterate on results row and create new index array of data
						while( $row = mysql_fetch_assoc($res) ) {
							$data[] = $row;
						}
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$res = pg_query($conn,$sql);
								$numreg = pg_numrows($res);
									
								//iterate on results row and create new index array of data
								while( $row = pg_fetch_assoc($res) ) {
									$data[] = $row;
								}
							}
						else 
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$res = sqlsrv_query( $conn, $sql);
										
										$numreg = sqlsrv_num_rows( $res );
									
										while( $row = sqlsrv_fetch_array( $res, SQLSRV_FETCH_ASSOC ))
											{
												$data[] = $row;
											}
									}
							}
					}
					
				$itemsByReference = array();
					
				// Build array of item references:
				foreach($data as $key => &$item) {
					$itemsByReference[$item['id']] = &$item;
					// Children array:
					$itemsByReference[$item['id']]['children'] = array();
					// Empty data class (so that json_encode adds "data: {}" )
					$itemsByReference[$item['id']]['data'] = new StdClass();
				}
					
				// Set items as children of the relevant parent item.
				foreach($data as $key => &$item)
					if($item['parent_id'] && isset($itemsByReference[$item['parent_id']]))
						$itemsByReference [$item['parent_id']]['children'][] = &$item;
							
						// Remove items that were added to parents elsewhere:
						foreach($data as $key => &$item) {
							if($item['parent_id'] && isset($itemsByReference[$item['parent_id']]))
								unset($data[$key]);
						}
						$result = $data;
							
			break;
			default:
				throw new Exception('No se puede realizar la operaciÃ³n: ' . $_GET['operation']);
				break;
		}
		header('Content-Type: application/json; charset=utf-8');
		echo json_encode($result);
	}
	catch (Exception $e) {
		header($_SERVER["SERVER_PROTOCOL"] . ' 500 Server Error');
		header('Status:  500 Server Error');
		echo $e->getMessage();
	}
	die();
}


if(isset($_REQUEST['otraoperation'])) {
	try {
		$result = null;
		$cabezab = "../../storage/app/bodegas/".$dbname;
		$ruta_bodega = '../../storage/app/bodegas/'.$dbname.'/';
		$ruta_cabezatemp = '../../storage/app/visor/'.$dbname;
		$ruta_temp = '../../storage/app/visor/'.$dbname.'/';
		$ruta_tempapi = '../img/apiimg/'.$dbname.'/';
		
		
		$ruta_zip = '../../storage/app/zip/'.$dbname.'/';
		
		//para la carga
		
		$ruta_load = '../loads/'.$dbname.'/';
		
		//se crea la carpeta de bodegas si solo si no existe		
	    if (!file_exists($cabezab))
			{
				mkdir($cabezab, 0777, true);
			}
		//se crea la caperta visor (temporal)
		if (!file_exists($ruta_cabezatemp))
			{
				mkdir($ruta_cabezatemp, 0777, true);
			}
		//se crea la caperta appiimg (espacio de trabajo)
		if (!file_exists($ruta_tempapi))
			{
				mkdir($ruta_tempapi, 0777, true);
			}
			
		//se crea la caperta zip (espacio de trabajo)
		if (!file_exists($ruta_zip))
			{
				mkdir($ruta_zip, 0777, true);
			}
			
			//se crea la caperta de carga de zip  (espacio de trabajo)
			if (!file_exists($ruta_load))
			{
				mkdir($ruta_load, 0777, true);
			}
				
			
		switch($_REQUEST['otraoperation']) {
			
			case 'grabardocumento':
				if(isset($_FILES['documentosimg'])){  
					$errors= array();
					
					$id_indices = $_REQUEST['id_indices'];
					
					$vidindices = explode("_;_",$id_indices);
					
					$id_usuario = $_REQUEST['id_usuario'];
					
					$id_tipodoc = $_REQUEST['id_tipodoc']; //este sera el id del documento
					
					$id_folder = $_REQUEST['id_folder']; 
					
					$id_tabla = $_REQUEST['id_tabla']; 
					
					$id_expediente = $_REQUEST['id_expediente']; 
					
					$totalindices = $_REQUEST['totalindices']; 
					
					$total = count($_FILES['documentosimg']['name']);
					
					$id_eenviara = $_REQUEST['id_eenviara'];  
					
					$valor = $_REQUEST['valor']; 
					
					//se procede a guardar en cada tabla correspondientemente
					$ordendoc = 0;
					
					/////////////////////////////////////// se verifica si existen bodega para guardar///////////////////////////////////////
					
					$sql = 'select id_bodega,nombre,limite,actual from sgd_bodegas  where actual < limite ';
					
					if ($configdb[0] == 'mysql')
						{
							$qerybod =  mysql_query($sql,$conn); 
							
							$haybodega = mysql_num_rows($qerybod);
							
							if ($haybodega == 0)
								{
									//se debe generar una bodega nueva
									//se verifica si es la primera bodega
									$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
									
									$qeryhabod =  mysql_query($sql,$conn);
										
									$cbod = mysql_num_rows($qeryhabod);
									
									if ($cbod == 0)
										{
											//se genera la primera bodega
											
											$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
											VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
											
											$nombreb = 'Bodega_1';
											
											$limiteb = 1000;
											
											$actualb = 0;
												
											$queryids =  mysql_query($sql,$conn);
											
											//se captura el ultimo id registrado
											$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
												
											$rs = mysql_fetch_assoc($rs);
												
											$idbodega = $rs["id"];
																						
										}
									else
										{
											//se busca la ultima bodega para continuar el control
											$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
																										
											$qerybodega =  mysql_query($sql,$conn);
											
											$dbod = mysql_fetch_assoc($qerybodega);
											
											$dbod = $dbod['nombre'];
											
											$nombreb = explode("_".$dbod);
											
											$nombreb = ($nombreb[1]*1) + 1;
											
											$nombreb = 'Bodega_'.$nombreb;
											
											$limiteb = 1000;
												
											$actualb = 0;
											
											//se registra la nueva bodega											
											
											$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
											VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
											
											$queryids =  mysql_query($sql,$conn);
											
											//se captura el ultimo id registrado
											$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
											
											$rs = mysql_fetch_assoc($rs);
											
											$idbodega = $rs["id"];
											
										}
										//se crea el nuevo directorioo de bodega
										$carpeta = $ruta_bodega.$nombreb;
											if (!file_exists($carpeta))
												{
													mkdir($carpeta, 0777, true);
												}
								}	
							else
								{	//existe una bodega desocupada
								
									$dbod = mysql_fetch_assoc($qerybod);
									
									$idbodega = $dbod['id_bodega'];
									
									$nombreb = $dbod['nombre'];
										
									$limiteb = $dbod['limite'];
									
									$actualb = $dbod['actual'];
									
								}							
						}
					else
						{							
							if ($configdb[0] == 'pgsql')
								{
										
									$qerybod = pg_query($conn,$sql);
									
									$haybodega = pg_num_rows($qerybod);
									
									if ($haybodega == 0)
										{
											//se debe generar una bodega nueva
											//se verifica si es la primera bodega
											$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
												
											$qeryhabod = pg_query($conn,$sql);
											
											$cbod = pg_num_rows($qeryhabod);
											
											if ($cbod == 0)
												{
													//se genera la primera bodega
														
													$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
						
													$queryids = pg_query($conn,$sql);
														
													$resid = pg_fetch_array($queryids);
							
													$idbodega =  $resid[0];
														
													$nombreb = 'Bodega_1';
														
													$limiteb = 1000;
														
													$actualb = 0;
												
													
												
												}
											else
												{
													//se busca la ultima bodega para continuar el control
													$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
												
													$qerybodega =  pg_query($conn,$sql);
														
													$dbod = pg_fetch_assoc($qerybodega);
													
													$dbod = $dbod['nombre'];
														
													$nombreb = explode("_".$dbod);
														
													$nombreb = ($nombreb[1]*1) + 1;
														
													$nombreb = 'Bodega_'.$nombreb;
														
													$limiteb = 1000;
												
													$actualb = 0;
														
													//se registra la nueva bodega
														
													$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
						
													$queryids = pg_query($conn,$sql);
														
													$resid = pg_fetch_array($queryids);
							
													$idbodega =  $resid[0];
														
												}
											//se crea el nuevo directorioo de bodega
											$carpeta = $ruta_bodega.$nombreb;
											if (!file_exists($carpeta))
												{
													mkdir($carpeta, 0777, true);
												}
										}
									else
										{	//existe una bodega desocupada
										
											$dbod = pg_fetch_assoc($qerybod);
											
											$idbodega = $dbod['id_bodega'];
												
											$nombreb = $dbod['nombre'];
											
											$limiteb = $dbod['limite'];
												
											$actualb = $dbod['actual'];
											
										}
								}
								
							if (trim($configdb[0]) == 'sqlsrv')
								{
									$qerybod = sqlsrv_query( $conn, $sql);
									
									$haybodega = sqlsrv_num_rows( $qerybod );
										
									if ($haybodega == 0)
										{
											//se debe generar una bodega nueva
											//se verifica si es la primera bodega
											$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
										
											$qeryhabod = sqlsrv_query( $conn, $sql);
											
											$cbod = 0;
											
											while( $row = sqlsrv_fetch_array( $qeryhabod, SQLSRV_FETCH_ASSOC ))
												{
													$cbod = $cbod + 1;
												}
												
											if ($cbod == 0)
												{
													//se genera la primera bodega
											
													$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
															VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
											
													$queryids = sqlsrv_query( $conn, $sql);
													
													$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
													
													$resource = sqlsrv_query($conn, $sql);
													
													while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
														{
															$idbodega =  $row['id_bodega'];
														}
											
													$nombreb = 'Bodega_1';
											
													$limiteb = 1000;
											
													$actualb = 0;										
														
											
												}
											else
												{
													//se busca la ultima bodega para continuar el control
													$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
											
													$qerybodega = sqlsrv_query( $conn, $sql);
														
													while( $row = sqlsrv_fetch_array( $qerybodega, SQLSRV_FETCH_ASSOC ))
														{
															$dbod =  $row['nombre'];
														}
														
													$dbod = $dbod['nombre'];
											
													$nombreb = explode("_".$dbod);
											
													$nombreb = ($nombreb[1]*1) + 1;
											
													$nombreb = 'Bodega_'.$nombreb;
											
													$limiteb = 1000;
											
													$actualb = 0;
											
													//se registra la nueva bodega
											
													$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
															VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
													
													$queryids = sqlsrv_query( $conn, $sql);
													
													$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
														
													$resource = sqlsrv_query($conn, $sql);
														
													while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
														{
															$idbodega =  $row['id_bodega'];
														}
											
												}
											//se crea el nuevo directorioo de bodega
											$carpeta = $ruta_bodega.$nombreb;
											if (!file_exists($carpeta))
												{
													mkdir($carpeta, 0777, true);
												}
										}
									else
										{	//existe una bodega desocupada
										
											while( $dbod = sqlsrv_fetch_array( $qerybod, SQLSRV_FETCH_ASSOC ))
												{
													$idbodega = $dbod['id_bodega'];
														
													$nombreb = $dbod['nombre'];
													
													$limiteb = $dbod['limite'];
														
													$actualb = $dbod['actual'];
												}
											
											
										}
								}
						}
					
					/////////////////////////////////////////////////// fin del calculo de los datos de bodega///////////////////////////////////
					
					
					$sql = 'select id_documento from sgd_documentos  where id_documento = 0 and id_expediente = '.$id_expediente.' and id_tipodocumental = '.$id_tipodoc.' and id_tabla = '.$id_tabla.' and id_folder = '.$id_folder;
					
					if ($configdb[0] == 'mysql')
						{
							$qerydoc =  mysql_query($sql,$conn);
							
							$documentoreg = mysql_num_rows($qerydoc);
							
							if ($documentoreg == 0)
								{
									
									//se registran los datos
									// primero el documento
									$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,orden,id_estado,created_at)
											VALUES(".$id_expediente.", ".$id_tipodoc.", ".$id_usuario.",".$id_tabla.",".$id_folder.",".$ordendoc.",1,'".date("Y-m-d H:i:s")."')";
									
									$queryids =  mysql_query($sql,$conn);
									
									//se captura el ultimo id registrado
									$rs = mysql_query("SELECT MAX(id_documento) AS id FROM sgd_documentos");
									
									$rs = mysql_fetch_assoc($rs);
									
									$iddocumento = $rs["id"];
									
									//se guarda en la tabla de notificacion a usuarios x documentos
									if ($id_eenviara != '')
										{
											
											$id_eenviara = explode("_;_",$id_eenviara);
											
											$totalidenvias = count($id_eenviara);
											
											$totalidenvias = $totalidenvias - 1;
											
											for ( $i = 0 ; $i < $totalidenvias ; $i ++)
												{
													$sql ="INSERT INTO sgd_notificacion_usuarios (id_documento,id_usuario,id_estado,created_at)
													VALUES(".$iddocumento.", ".$id_eenviara[$i].",1,'".date("Y-m-d H:i:s")."')";
													
													$queryids = mysql_query($sql,$conn);
													
												}
											
										}
									
									
									//////////////////////
									
									//se registran los valores indices
									
									for ( $i = 0 ; $i < $totalindices ; $i ++)
											{
												$valord = $valor[$i];
												if ($i == 0)
													{
														$elvalorb = $valord;
													}
												$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
												VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
												
												
												$queryids =  mysql_query($sql,$conn);
												
											}
									
									//se registran las imagenes
									for($i=0; $i<$total; $i++)
										{
											//Get the temp file path
											$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
											
											$nombrear = $_FILES['documentosimg']['name'][$i];
											
											$nombrear = explode('.',$nombrear);
											
											$nombrear = $nombrear[0];
											
											$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
											
											//se registra la imagen, se debe tener control de la abodega
											
											$actualb = $actualb + 1;
											
											if ($actualb > $limiteb) //se genera una nueva bodega
												{
													$nombreb = explode("_".$nombreb);
													
													$nombreb = ($nombreb[1]*1) + 1;
													
													$nombreb = 'Bodega_'.$nombreb;
													
													$limiteb = 1000;
													
													$actualb = 1;
													
													//se registra la nueva bodega
													
													$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."')";
													
													$queryids =  mysql_query($sql,$conn);
													
													//se captura el ultimo id registrado
													$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
													
													$rs = mysql_fetch_assoc($rs);
													
													$idbodega = $rs["id"];;
												}
											else
												{
													//se acutaliza el valor de documentos actuales en la tabla bodega
													$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
													
													$queryids =  mysql_query($sql,$conn);
												}
											
											//SE EVALUA SI ES O NO ZIP
											if ($file_ext != 'zip' and $file_ext != 'ZIP' )
												{
													
													//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
													
													$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
													
													$qeryorden =  mysql_query($sql,$conn);
													
													$cuantoorden = mysql_num_rows($qeryorden);
													
													if ($cuantoorden > 0)
														{
															
															$orden = mysql_fetch_assoc($qeryorden);
															
															$norden = $orden['orden'];
															
															$norden = $norden + 1;
															
														}
													else
														{
															
															$norden = 0;
															
															$norden = $norden + 1;
															
														}
													
													
														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
													VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
														
														$queryids =  mysql_query($sql,$conn);
														
														//se captura el ultimo id registrado
														$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
														
														$rs = mysql_fetch_assoc($rs);
														
														$idimagen = $rs["id"];
														
														//se registra que hay imagenes en la tabla de encriptacion
														
														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														
														$queryids =  mysql_query($sql,$conn);
													
													if ($idimagen > 0)
														{
															$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
															
															if(move_uploaded_file($tmpFilePath, $dir)) {
																
																encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																
																unlink($dir);
															}
														}
												}
											else
												{
													if ($file_ext == 'zip' or $file_ext == 'ZIP' )
														{
															
															$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
															
															if(move_uploaded_file($tmpFilePath, $dir))
																{
																	
																	require_once('manejozip.php');
																	
																	$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																	
																	$destino = $ruta_bodega.$nombreb.'/';
																	
																	$zip_manager = new Zip_manager();
																	
																	$resultado = $zip_manager->extraer($archivopadre, $destino);
																	
																	if ($resultado)
																		{
																			$listado = $zip_manager->listar($archivopadre, $destino);
																			
																			$czip = 0;
																			
																			for ($iti = 0; $iti < count($listado); $iti++)
																				{
																					
																					//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																					
																					$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
																					
																					$qeryorden =  mysql_query($sql,$conn);
																					
																					$cuantoorden = mysql_num_rows($qeryorden);
																					
																					if ($cuantoorden > 0)
																						{
																							
																							$orden = mysql_fetch_assoc($qeryorden);
																							
																							$norden = $orden['orden'];
																							
																							$norden = $norden + 1;
																							
																						}
																					else
																						{
																							
																							$norden = 0;
																							
																							$norden = $norden + 1;
																							
																						}
																					
																					$czip = $czip + 1;
																					
																					//se separa la extension
																					
																					$extimg = substr(strrchr($listado[$iti], "."),1);
																					
																					$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																					
																					$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																					VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
																					
																					$queryids =  mysql_query($sql,$conn);
																					
																					//se captura el ultimo id registrado
																					$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
																					
																					$rs = mysql_fetch_assoc($rs);
																					
																					$idimagen = $rs["id"];
																					
																					//se registra que hay imagenes en la tabla de encriptacion
																					
																					$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																					
																					$queryids =  mysql_query($sql,$conn);
																					
																					if ($idimagen > 0)
																						{
																							$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$extimg;
																							
																							if(move_uploaded_file($tmpFilePath, $dir)) {
																								
																								encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																								
																								unlink($dir);
																							}
																						}
																					
																				}//fin del for
																			
																			unlink($archivopadre);   //se elimina el archivo zip padre
																		}
																}
															else
																{
																	
																	echo 'no hay';
																}
														}
												}
										}//fin del for de imagenes
									
								}//fin si el documento no existe
							else
								{
									//se actualizan datos y se agregan imagenes
									
									$iddocument = mysql_fetch_assoc($qerydoc);
									
									$iddocumento = $iddocument['id_documento'];
									
									//se elimina los indices registrados
									
									$sql ="DELETE FROM sgd_valorindice WHERE id_documento = ".$iddocumento;
									
									$queryids =  mysql_query($sql,$conn);
									
									//se registran los indices
									
									for ( $i = 0 ; $i < $totalindices ; $i ++)
										{
											$valord = $valor[$i];
											if ($i == 0)
												{
													$elvalorb = $valord;
												}
											$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
													VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
											
											$queryids =  mysql_query($sql,$conn);
											
										}
									//se registran las imagenes agregadas
									for($i=0; $i<$total; $i++)
										{
											
											$actualb = $actualb + 1;
											
											if ($actualb > $limiteb) //se genera una nueva bodega
												{
													$nombreb = explode("_".$nombreb);
													
													$nombreb = ($nombreb[1]*1) + 1;
													
													$nombreb = 'Bodega_'.$nombreb;
													
													$limiteb = 1000;
													
													$actualb = 1;
													
													//se registra la nueva bodega
													
													$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."')";
													
													$queryids =  mysql_query($sql,$conn);
													
													//se captura el ultimo id registrado
													$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
													
													$rs = mysql_fetch_assoc($rs);
													
													$idbodega = $rs["id"];
													
												}
											else
												{
													//se acutaliza el valor de documentos actuales en la tabla bodega
													$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
													
													$queryids =  mysql_query($sql,$conn);
												}
											
											//Get the temp file path
											$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
											
											$nombrear = $_FILES['documentosimg']['name'][$i];
											
											$nombrear = explode('.',$nombrear);
											
											$nombrear = $nombrear[0];
											
											$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
											
											// se registra
											
											if ($file_ext != 'zip' and $file_ext != 'ZIP' )
												{
													
													//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
													
													$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
													
													$qeryorden =  mysql_query($sql,$conn);
													
													$cuantoorden = mysql_num_rows($qeryorden);
													
													if ($cuantoorden > 0)
														{
															
															$orden = mysql_fetch_assoc($qeryorden);
															
															$norden = $orden['orden'];
															
															$norden = $norden + 1;
															
														}
													else
														{
															
															$norden = 0;
															
															$norden = $norden + 1;
															
														}	
														//se registra
														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
														VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
														
														$queryids =  mysql_query($sql,$conn);
														
														//se captura el ultimo id registrado
														$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
														
														$rs = mysql_fetch_assoc($rs);
														
														$idimagen = $rs["id"];
														
														//se registra que hay imagenes en la tabla de encriptacion
														
														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														
														$queryids =  mysql_query($sql,$conn);
													
													if ($idimagen > 0)
														{
															$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
															
															if(move_uploaded_file($tmpFilePath, $dir)) {
																
																encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																
																unlink($dir);
															}
														}
												}
											else
												{
													if ($file_ext == 'zip' or $file_ext == 'ZIP' )  
														{
															$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
															
															if(move_uploaded_file($tmpFilePath, $dir))
																{
																	
																	
																	require_once('manejozip.php');
																	
																	$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																	
																	$destino = $ruta_bodega.$nombreb.'/';
																	
																	$zip_manager = new Zip_manager();
																	
																	$resultado = $zip_manager->extraer($archivopadre, $destino);
																	
																	if ($resultado)
																		{
																			$listado = $zip_manager->listar($archivopadre, $destino);
																			
																			$czip = 0;
																			
																			for ($iti = 0; $iti < count($listado); $iti++)
																				{
																					
																					//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																					
																					$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
																					
																					$qeryorden =  mysql_query($sql,$conn);
																					
																					$cuantoorden = mysql_num_rows($qeryorden);
																					
																					if ($cuantoorden > 0)
																						{
																							
																							$orden = mysql_fetch_assoc($qeryorden);
																							
																							$norden = $orden['orden'];
																							
																							$norden = $norden + 1;
																							
																						}
																					else
																						{
																							
																							$norden = 0;
																							
																							$norden = $norden + 1;
																							
																						}	
																						
																					$czip = $czip + 1;
																					
																					//se separa la extension
																					
																					$extimg = substr(strrchr($listado[$iti], "."),1);
																					
																					$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																					
																					//se registra
																					$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																					VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
																					
																					$queryids =  mysql_query($sql,$conn);
																					
																					//se captura el ultimo id registrado
																					$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
																					
																					$rs = mysql_fetch_assoc($rs);
																					
																					$idimagen = $rs["id"];
																					
																					//se registra que hay imagenes en la tabla de encriptacion
																					
																					$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																					
																					$queryids =  mysql_query($sql,$conn);
																					
																					if ($idimagen > 0)
																						{
																							
																							//se copia con el id del registro de imagen
																							
																							$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																							
																							$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																							
																							if (copy($fichero, $nuevo_fichero))
																								{
																									$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																									
																									encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																									
																									unlink($dir); //se eliminan los archivos hijos del zip
																									
																									unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																									
																								}
																						}
																				}//fin del for
																			
																			unlink($archivopadre);   //se elimina el archivo zip padre
																		}
																}
															else
																{
																	
																	echo 'no hay';
																}
														}
												}
										}//fin del for de imagenes
								}
						}
					else 
						{
							if ($configdb[0] == 'pgsql')
								{
									$qerydoc = pg_query($conn,$sql);
									
									$documentoreg = pg_num_rows($qerydoc);
									
									if ($documentoreg == 0)
										{
											
											//se registran los datos
											// primero el documento
											$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,orden,id_estado,created_at)
													VALUES(".$id_expediente.", ".$id_tipodoc.", ".$id_usuario.",".$id_tabla.",".$id_folder.",".$ordendoc.",1,'".date("Y-m-d H:i:s")."') RETURNING id_documento";
											
											$queryids = pg_query($conn,$sql);
											
											$resid = pg_fetch_array($queryids);
											
											$iddocumento =  $resid[0];
											
											//se guarda en la tabla de notificacion a usuarios x documentos
											if ($id_eenviara != '')
												{
													$id_eenviara = explode("_;_",$id_eenviara);
													
													$totalidenvias = count($id_eenviara);
													
													$totalidenvias = $totalidenvias - 1;
													
													for ( $i = 0 ; $i < $totalidenvias ; $i ++)
														{
															$sql ="INSERT INTO sgd_notificacion_usuarios (id_documento,id_usuario,id_estado,created_at)
															VALUES(".$iddocumento.", ".$id_eenviara[$i].",1,'".date("Y-m-d H:i:s")."')";
															
															$queryids = pg_query($conn,$sql);
															
														}
													
												}
											
											//////////////////////
											
											//se registran los valores indices
											
											for ( $i = 0 ; $i < $totalindices ; $i ++)
												{
													$valord = $valor[$i];
													if ($i == 0)
														{
															$elvalorb = $valord;
														}
													$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
													VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
													
													$queryids = pg_query($conn,$sql);
													
												}
											
											//se registran las imagenes
											for($i=0; $i<$total; $i++)
												{
													//Get the temp file path
													$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
													
													$nombrear = $_FILES['documentosimg']['name'][$i];
													
													$nombrear = explode('.',$nombrear);
													
													$nombrear = $nombrear[0];
													
													$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
													
													//se registra la imagen, se debe tener control de la abodega
													
													$actualb = $actualb + 1;
													
													if ($actualb > $limiteb) //se genera una nueva bodega
														{
															$nombreb = explode("_".$nombreb);
															
															$nombreb = ($nombreb[1]*1) + 1;
															
															$nombreb = 'Bodega_'.$nombreb;
															
															$limiteb = 1000;
															
															$actualb = 1;
															
															//se registra la nueva bodega
															
															$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
															
															$queryids = pg_query($conn,$sql);
															
															$resid = pg_fetch_array($queryids);
															
															$idbodega =  $resid[0];
														}
													else
														{
															//se acutaliza el valor de documentos actuales en la tabla bodega
															$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
															
															$queryids = pg_query($conn,$sql);
														}
													
													//SE EVALUA SI ES O NO ZIP
													if ($file_ext != 'zip' and $file_ext != 'ZIP' )
														{
															
															//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
															
															$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1 OFFSET 0';
															
															$qeryorden =  pg_query($conn,$sql);
															
															$cuantoorden = pg_num_rows($qeryorden);
															
															if ($cuantoorden > 0)
																{
																	
																	$orden = pg_fetch_assoc($qeryorden);
																	
																	$norden = $orden['orden'];
																	
																	$norden = $norden + 1;
																	
																}
															else
																{
																	
																	$norden = 0;
																	
																	$norden = $norden + 1;
																	
																}
																
																
																$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																
																$queryids =  pg_query($conn,$sql);
																
																$resid = pg_fetch_array($queryids);
																
																$idimagen =  $resid[0];
															
																								
																//se registra que hay imagenes en la tabla de encriptacion
																
																$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																
																$queryids =  pg_query($conn,$sql);
																
																if ($idimagen > 0)
																	{
																		$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
																		
																		if(move_uploaded_file($tmpFilePath, $dir)) {
																			
																			encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																			
																			unlink($dir);
																		}
																	}
														}
													else
														{
															if ($file_ext == 'zip' or $file_ext == 'ZIP' )
																{
																	
																	$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
																	
																	if(move_uploaded_file($tmpFilePath, $dir))
																		{
																			
																			require_once('manejozip.php');
																			
																			$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																			
																			$destino = $ruta_bodega.$nombreb.'/';
																			
																			$zip_manager = new Zip_manager();
																			
																			$resultado = $zip_manager->extraer($archivopadre, $destino);
																			
																			if ($resultado)
																				{
																					$listado = $zip_manager->listar($archivopadre, $destino);
																					
																					$czip = 0;
																					
																					for ($iti = 0; $iti < count($listado); $iti++)
																						{
																							
																							//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																							
																							$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1 OFFSET 0';
																							
																							$qeryorden =  pg_query($conn,$sql);
																							
																							$cuantoorden = pg_num_rows($qeryorden);
																							
																							if ($cuantoorden > 0)
																								{
																									
																									$orden = pg_fetch_assoc($qeryorden);
																									
																									$norden = $orden['orden'];
																									
																									$norden = $norden + 1;
																									
																								}
																							else
																								{
																									
																									$norden = 0;
																									
																									$norden = $norden + 1;
																									
																								}
																							
																							$czip = $czip + 1;
																							
																							//se separa la extension
																							
																							$extimg = substr(strrchr($listado[$iti], "."),1);
																							
																							$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																							
																							$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																							VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																							
																							$queryids =  pg_query($conn,$sql);
																							
																							$resid = pg_fetch_array($queryids);
																							
																							$idimagen =  $resid[0];
																							
																							//se registra que hay imagenes en la tabla de encriptacion
																							
																							$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																							
																							$queryids =  pg_query($conn,$sql);
																							
																							if ($idimagen > 0)
																								{
																									$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
																									
																									if(move_uploaded_file($tmpFilePath, $dir)) {
																										
																										encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																										
																										unlink($dir);
																									}
																								}
																							
																						}//fin del for
																					
																					unlink($archivopadre);   //se elimina el archivo zip padre
																				}
																		}
																else
																	{
																		
																		echo 'no hay';
																	}
															}
													}
												}//fin del for de imagenes
											
										}//fin si el documento no existe
									else
										{//se actualizan datos y se agregan imagenes
											
											$iddocument = pg_fetch_assoc($qerydoc);
											
											$iddocumento = $iddocument['id_documento'];
											
											//se elimina los indices registrados
											
											$sql ="DELETE FROM sgd_valorindice WHERE id_documento = ".$iddocumento;
											
											$queryids = pg_query($conn,$sql);
											
											//se registran los indices											
											
											for ( $i = 0 ; $i < $totalindices ; $i ++)
												{
													$valord = $valor[$i];
													if ($i == 0)
														{
															$elvalorb = $valord;
														}
													
													$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
														VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
													
													$queryids = pg_query($conn,$sql);
													
												}
											//se registran las imagenes agregadas
											for($i=0; $i<$total; $i++)
												{
													
													$actualb = $actualb + 1;
													
													if ($actualb > $limiteb) //se genera una nueva bodega
														{
															$nombreb = explode("_".$nombreb);
															
															$nombreb = ($nombreb[1]*1) + 1;
															
															$nombreb = 'Bodega_'.$nombreb;
															
															$limiteb = 1000;
															
															$actualb = 1;
															
															//se registra la nueva bodega
															
															$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
															VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
																
																$queryids = pg_query($conn,$sql);
																
																$resid = pg_fetch_array($queryids);
																
																$idbodega =  $resid[0];
															
														}
													else
														{
															//se acutaliza el valor de documentos actuales en la tabla bodega
															$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
															
															$queryids = pg_query($conn,$sql);
														}
													
													//Get the temp file path
													$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
													
													$nombrear = $_FILES['documentosimg']['name'][$i];
													
													$nombrear = explode('.',$nombrear);
													
													$nombrear = $nombrear[0];
													
													$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
													
													// se registra
													
													if ($file_ext != 'zip' and $file_ext != 'ZIP' )
														{														
															
															//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo															
															
															$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
															
															$qeryorden =  pg_query($conn,$sql);
															
															$cuantoorden = pg_num_rows($qeryorden);
															
															if ($cuantoorden > 0)
																{
																	
																	$orden = pg_fetch_assoc($qeryorden);
																	
																	$norden = $orden['orden'];
																	
																	$norden = $norden + 1;
																	
																}
															else
																{
																	
																	$norden = 0;
																	
																	$norden = $norden + 1;
																	
																}
																// se registra
																$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																
																$queryids = pg_query($conn,$sql);
																
																$resid = pg_fetch_array($queryids);
																
																$idimagen =  $resid[0];
																
																//se registra que hay imagenes en la tabla de encriptacion
																
																$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																
																$queryids =  pg_query($conn,$sql);
																
																if ($idimagen > 0)
																	{
																		$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
																		
																		if(move_uploaded_file($tmpFilePath, $dir)) {
																			
																			encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																					
																			unlink($dir);
																		}
																	}
														}
													else
														{
															if ($file_ext == 'zip' or $file_ext == 'ZIP' )
																{
																	$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
																	
																	if(move_uploaded_file($tmpFilePath, $dir))
																		{
																			
																			//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																			
																			$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
																			
																			$qeryorden =  pg_query($conn,$sql);
																			
																			$cuantoorden = pg_num_rows($qeryorden);
																			
																			if ($cuantoorden > 0)
																				{
																					
																					$orden = pg_fetch_assoc($qeryorden);
																					
																					$norden = $orden['orden'];
																					
																					$norden = $norden + 1;
																					
																				}
																			else
																				{
																					
																					$norden = 0;
																					
																					$norden = $norden + 1;
																					
																				}
																			require_once('manejozip.php');
																			
																			$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																			
																			$destino = $ruta_bodega.$nombreb.'/';
																			
																			$zip_manager = new Zip_manager();
																			
																			$resultado = $zip_manager->extraer($archivopadre, $destino);
																			
																			if ($resultado)
																				{
																					$listado = $zip_manager->listar($archivopadre, $destino);
																					
																					$czip = 0;
																					
																					for ($iti = 0; $iti < count($listado); $iti++)
																						{
																							
																							//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																							
																							$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
																							
																							$qeryorden =  pg_query($conn,$sql);
																							
																							$cuantoorden = pg_num_rows($qeryorden);
																							
																							if ($cuantoorden > 0)
																								{
																									
																									$orden = pg_fetch_assoc($qeryorden);
																									
																									$norden = $orden['orden'];
																									
																									$norden = $norden + 1;
																									
																								}
																							else
																								{
																									
																									$norden = 0;
																									
																									$norden = $norden + 1;
																									
																								}
																							
																							$czip = $czip + 1;
																							
																							//se separa la extension
																							
																							$extimg = substr(strrchr($listado[$iti], "."),1);
																							
																							$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																							
																							// se registra
																							$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																							VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																							
																							$queryids = pg_query($conn,$sql);
																							
																							$resid = pg_fetch_array($queryids);
																							
																							$idimagen =  $resid[0];
																							
																							//se registra que hay imagenes en la tabla de encriptacion
																							
																							$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																							
																							$queryids =  pg_query($conn,$sql);
																							
																							if ($idimagen > 0)
																								{
																									
																									//se copia con el id del registro de imagen
																									
																									$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																									
																									$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																									
																									if (copy($fichero, $nuevo_fichero))
																										{
																											$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																											
																											encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																											
																											unlink($dir); //se eliminan los archivos hijos del zip
																											
																											unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																											
																										}
																								}
																						}//fin del for
																					
																					unlink($archivopadre);   //se elimina el archivo zip padre
																				}
																		}
																	else
																		{
																			
																			echo 'no hay';
																		}
																}
														}
												}//fin del for de imagenes
										}
								}//fin de pgsql bloque
							else
								{
									if (trim($configdb[0]) == 'sqlsrv')
										{
											$qerydoc = sqlsrv_query( $conn, $sql); 
											
											$documentoreg = sqlsrv_num_rows( $qerydoc ); 
											
											if ($documentoreg == 0)
												{
														
													//se registran los datos
													// primero el documento
													$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,orden,id_estado,created_at)
													VALUES(".$id_expediente.", ".$id_tipodoc.", ".$id_usuario.",".$id_tabla.",".$id_folder.",".$ordendoc.",1,'".date("Y-m-d H:i:s")."')";
														
													$queryids = sqlsrv_query( $conn, $sql); 
												
													$sql ="SELECT TOP 1 id_documento FROM  sgd_documentos where id_expediente = ".$id_expediente." ORDER BY id_documento desc";
														
													$resource = sqlsrv_query($conn, $sql);
														
													while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
														{
															$iddocumento =  $row['id_documento'];
														}
														
													//se guarda en la tabla de notificacion a usuarios x documentos	
														if ($id_eenviara != '')
															{
																$id_eenviara = explode("_;_",$id_eenviara); 
																
																$totalidenvias = count($id_eenviara);
																
																$totalidenvias = $totalidenvias - 1;
																
																for ( $i = 0 ; $i < $totalidenvias ; $i ++)
																	{
																		$sql ="INSERT INTO sgd_notificacion_usuarios (id_documento,id_usuario,id_estado,created_at)
																		VALUES(".$iddocumento.", ".$id_eenviara[$i].",1,'".date("Y-m-d H:i:s")."')";
																		
																		$queryids = sqlsrv_query( $conn, $sql);
																		
																	}
																	
															}
																												
													//////////////////////
																								
													//se registran los valores indices
												
													for ( $i = 0 ; $i < $totalindices ; $i ++)
														{
															$valord = $valor[$i];//echo $valord;
															if ($i == 0)
																{
																	$elvalorb = $valord;
																}
															$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
															VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
													
															$queryids = sqlsrv_query($conn,$sql);
													
														}
												
													//se registran las imagenes
													for($i=0; $i<$total; $i++) 
														{
																//Get the temp file path
																$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];  
																	
																$nombrear = $_FILES['documentosimg']['name'][$i];
																	
																$nombrear = explode('.',$nombrear);
																	
																$nombrear = $nombrear[0];
																	
																$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
														
																//se registra la imagen, se debe tener control de la abodega
														
																$actualb = $actualb + 1;
														
																if ($actualb > $limiteb) //se genera una nueva bodega
																	{
																		$nombreb = explode("_".$nombreb);
																			
																		$nombreb = ($nombreb[1]*1) + 1;
																			
																		$nombreb = 'Bodega_'.$nombreb;
																			
																		$limiteb = 1000;
																			
																		$actualb = 1;
																			
																		//se registra la nueva bodega																			
																		$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																		VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') ";
																		
																		$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_documento desc";
																		
																		$resource = sqlsrv_query($conn, $sql);
																		
																		while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																			{
																				$idbodega =  $row['id_bodega'];
																			}
																	}
																else
																	{
																		//se acutaliza el valor de documentos actuales en la tabla bodega
																		$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
																			
																		$queryids = sqlsrv_query($conn,$sql);
																	}
															
															//SE EVALUA SI ES O NO ZIP
															if ($file_ext != 'zip' and $file_ext != 'ZIP' )
																{
																	
																		//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																		
																		$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
																		
																		$queryids =  sqlsrv_query($conn,$sql);
																		
																		$cuantoorden = 0;
																		
																		while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
																			{
																				$cuantoorden = $cuantoorden + 1;
																				
																				$norden = $row['orden'];
																			}
																		
																		if ($cuantoorden > 0)
																			{
																				
																				$norden = $norden + 1;
																				
																			}
																		else
																			{
																				
																				$norden = 0;
																				
																				$norden = $norden + 1;
																				
																			}
																	
																		$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																		VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
																
																		$queryids =  sqlsrv_query($conn,$sql);
																		
																		$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
																		
																		$resource = sqlsrv_query($conn, $sql);
																		
																		$ultimoid = 0;
																		
																		while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																			{
																				$ultimoid =  $row['id_imagendocum'];
																			}
																																			
																		$idimagen =  $ultimoid;
																
																		//se registra que hay imagenes en la tabla de encriptacion
																			
																		$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																			
																		$queryids =  sqlsrv_query($conn,$sql);
																		
																		if ($idimagen > 0)
																			{
																				$dir = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$file_ext;
																					
																				if(move_uploaded_file($tmpFilePath, $dir)) {
																	
																					encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																					
																					unlink($dir);
																				}
																			}
																}	
															else
																{
																	if ($file_ext == 'zip' or $file_ext == 'ZIP' )
																		{
														
																			$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;   
																			
																			if(move_uploaded_file($tmpFilePath, $dir))
																				{
																				
																					require_once('manejozip.php');
																					
																					$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;    
																					
																					$destino = $ruta_bodega.$nombreb.'/';
																					
																					$zip_manager = new Zip_manager();
																					
																					$resultado = $zip_manager->extraer($archivopadre, $destino);
																					
																					if ($resultado)
																						{
																							$listado = $zip_manager->listar($archivopadre, $destino);
																							
																							$czip = 0;
																							
																							for ($iti = 0; $iti < count($listado); $iti++)
																								{
																											
																											//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																											
																											$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
																											
																											$queryids =  sqlsrv_query($conn,$sql);
																											
																											$cuantoorden = 0;
																											
																											while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
																												{
																													$cuantoorden = $cuantoorden + 1;
																													
																													$norden = $row['orden'];
																												}
																											
																											if ($cuantoorden > 0)
																												{
																													
																													$norden = $norden + 1;
																													
																												}
																											else
																												{
																													
																													$norden = 0;
																													
																													$norden = $norden + 1;
																													
																												}
																											
																											$czip = $czip + 1;
																											
																											//se separa la extension
																											
																											$extimg = substr(strrchr($listado[$iti], "."),1);
																											
																											$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																											
																											$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																														VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
																											
																											$queryids = sqlsrv_query($conn,$sql);
																											
																											$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
																											
																											$resource = sqlsrv_query($conn, $sql);
																											
																											while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																												{
																													$ultimoid =  $row['id_imagendocum'];
																												}
																											
																											$idimagen =  $ultimoid;
																											
																											//se registra que hay imagenes en la tabla de encriptacion
																											
																											$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																											
																											$queryids =  sqlsrv_query($conn,$sql);
																											
																											if ($idimagen > 0)
																												{
																													
																													//se copia con el id del registro de imagen
																													
																													$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																													
																													$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																													
																													if (copy($fichero, $nuevo_fichero))
																														{
																															$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																															
																															encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																															
																															unlink($dir); //se eliminan los archivos hijos del zip
																															
																															unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																															
																														}
																													
																												}
																											
																											
																								}//fin del for
																							
																							unlink($archivopadre);   //se elimina el archivo zip padre
																						}
																				}
																			else
																				{
																					
																					echo 'no hay';
																				}
																		}																	
																}
														}//fin del for de imagenes
														
												}//fin si el documento no existe
											else
												{//se actualizan datos y se agregan imagenes
												
													$iddocument = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC);
														
													$iddocumento = $iddocument['id_documento'];
														
													//se elimina los indices registrados
														
													$sql ="DELETE FROM sgd_valorindice WHERE id_documento = ".$iddocumento;
														
													$queryids = sqlsrv_query($conn,$sql);
														
													//se registran los indices
														
													
													for ( $i = 0 ; $i < $totalindices ; $i ++)
														{
															$valord = $valor[$i];
															if ($i == 0)
																{
																	$elvalorb = $valord;
																}
														
															$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
																VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
																
															$queryids = sqlsrv_query($conn,$sql);
																
														}
													//se registran las imagenes agregadas
													for($i=0; $i<$total; $i++) 
														{
													
																$actualb = $actualb + 1;
															
																if ($actualb > $limiteb) //se genera una nueva bodega
																	{
																		$nombreb = explode("_".$nombreb);
																			
																		$nombreb = ($nombreb[1]*1) + 1;
																			
																		$nombreb = 'Bodega_'.$nombreb;
																			
																		$limiteb = 1000;
																			
																		$actualb = 1;
																			
																		//se registra la nueva bodega
																			
																		$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																			VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') ";
																		
																		$queryids = sqlsrv_query($conn,$sql);
																		
																		$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";  
																		
																		$resource = sqlsrv_query($conn, $sql);
																		
																		$ultimoid = 0;
																		
																		while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																			{
																				$ultimoid =  $row['id_bodega'];
																			}
																
																		$queryids = sqlsrv_query($conn,$sql);
																		
																		$resid = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ARRAY);
																																		
																		$idbodega =  $resid[0];
																			
																			
																	}
																else
																	{
																		//se acutaliza el valor de documentos actuales en la tabla bodega
																		$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
																
																		$queryids = sqlsrv_query($conn,$sql);
																	}
															
																//Get the temp file path
																$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
															
																$nombrear = $_FILES['documentosimg']['name'][$i];
															
																$nombrear = explode('.',$nombrear);
															
																$nombrear = $nombrear[0];
															
																$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
																
																// se registra
																
																if ($file_ext != 'zip' and $file_ext != 'ZIP' )
																	{
																		
																		
																			//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																			
																			
																			$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
																			
																			$queryids =  sqlsrv_query($conn,$sql);
																			
																			$cuantoorden = 0;
																			
																			while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
																				{
																					$cuantoorden = $cuantoorden + 1;
																					
																					$norden = $row['orden'];
																				}
																			
																			if ($cuantoorden > 0)
																				{
																					
																					$norden = $norden + 1;
																					
																				}
																			else
																				{
																					
																					$norden = 0;
																					
																					$norden = $norden + 1;
																				}	
																		
																			$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																			VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";	
																			
																			$queryids = sqlsrv_query($conn,$sql);
																			
																			$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
																			
																			$resource = sqlsrv_query($conn, $sql);
																			
																			while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																				{
																					$ultimoid =  $row['id_imagendocum'];
																				}
																			
																			$idimagen =  $ultimoid;
																										
																			//se registra que hay imagenes en la tabla de encriptacion
																		
																			$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																		
																			$queryids =  sqlsrv_query($conn,$sql);
																				
																			if ($idimagen > 0)
																				{
																					$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
																			
																					if(move_uploaded_file($tmpFilePath, $dir)) 
																						{
																								encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																									
																								unlink($dir);
																						}
																				}
																	}
																else
																	{
																		if ($file_ext == 'zip' or $file_ext == 'ZIP' )
																			{
																				$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
																				
																				if(move_uploaded_file($tmpFilePath, $dir))
																					{
																						
																						//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																						
																						
																						$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
																						
																						$queryids =  sqlsrv_query($conn,$sql);
																						
																						$cuantoorden = 0;
																						
																						while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
																							{
																								$cuantoorden = $cuantoorden + 1;
																								
																								$norden = $row['orden'];
																							}
																						
																						if ($cuantoorden > 0)
																							{
																								
																								$norden = $norden + 1;
																								
																							}
																						else
																							{
																								
																								$norden = 0;
																								
																								$norden = $norden + 1;
																							}	
																						require_once('manejozip.php');
																						
																						$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																						
																						$destino = $ruta_bodega.$nombreb.'/';
																						
																						$zip_manager = new Zip_manager();
																						
																						$resultado = $zip_manager->extraer($archivopadre, $destino);
																						
																						if ($resultado)
																							{
																								$listado = $zip_manager->listar($archivopadre, $destino);
																								
																								$czip = 0;
																								
																								for ($iti = 0; $iti < count($listado); $iti++)
																									{
																										$czip = $czip + 1;
																										
																										//se separa la extension
																										
																										$extimg = substr(strrchr($listado[$iti], "."),1);
																										
																										$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																										
																										$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																										VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
																										
																										$queryids = sqlsrv_query($conn,$sql);
																										
																										$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
																										
																										$resource = sqlsrv_query($conn, $sql);
																										
																										while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																											{
																												$ultimoid =  $row['id_imagendocum'];
																											}
																										
																										$idimagen =  $ultimoid;
																										
																										//se registra que hay imagenes en la tabla de encriptacion
																										
																										$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																										
																										$queryids =  sqlsrv_query($conn,$sql);
																										
																										if ($idimagen > 0)
																											{
																												
																												//se copia con el id del registro de imagen
																												
																												$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																												
																												$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																												
																												if (copy($fichero, $nuevo_fichero))
																													{
																														$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																														
																														encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																														
																														unlink($dir); //se eliminan los archivos hijos del zip
																														
																														unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																														
																													}
																											}
																									}//fin del for
																								
																								unlink($archivopadre);   //se elimina el archivo zip padre
																							}
																					}
																				else
																					{
																						
																						echo 'no hay';
																					}
																			}		
																	}
															}//fin del for de imagenes
												}
										}
								}
								
						}	
				}?>
				
				<script type="text/javascript">

						var elvalorb = '<?php echo $elvalorb;?>'; 
				
						window.parent.Dios(elvalorb);
						

				</script>
				<?php 
				
			break;
			
			case 'grabardocumentoadd':
				if(isset($_FILES['documentosimg'])){
					$errors= array();
						
					$id_indices = $_REQUEST['id_indices'];
						
					$vidindices = explode("_;_",$id_indices);
						
					$id_usuario = $_REQUEST['id_usuario'];
					
					$origen = $_REQUEST['origen']; 
						
					$id_tipodoc = $_REQUEST['id_tipodoc']; 
						
					$id_folder = $_REQUEST['id_folder'];
						
					$id_tabla = $_REQUEST['id_tabla'];
						
					$id_expediente = $_REQUEST['id_expediente'];
						
					$totalindices = $_REQUEST['totalindices'];
						
					$total = count($_FILES['documentosimg']['name']);
					
					$id_eenviara = $_REQUEST['id_eenviara']; 
						
					$valor = $_REQUEST['valor'];
						
					//se procede a guardar en cada tabla correspondientemente
					$ordendoc = 0;
						
					/////////////////////////////////////// se verifica si existen bodega para guardar///////////////////////////////////////
						
					$sql = 'select id_bodega,nombre,limite,actual from sgd_bodegas  where actual < limite ';
						
					if ($configdb[0] == 'mysql')
					{
						$qerybod =  mysql_query($sql,$conn);
							
						$haybodega = mysql_num_rows($qerybod);
							
						if ($haybodega == 0)
						{
							//se debe generar una bodega nueva
							//se verifica si es la primera bodega
							$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
								
							$qeryhabod =  mysql_query($sql,$conn);
				
							$cbod = mysql_num_rows($qeryhabod);
								
							if ($cbod == 0)
							{
								//se genera la primera bodega
									
								$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
											VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
									
								$nombreb = 'Bodega_1';
									
								$limiteb = 1000;
									
								$actualb = 0;
				
								$queryids =  mysql_query($sql,$conn);
									
								//se captura el ultimo id registrado
								$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
				
								$rs = mysql_fetch_assoc($rs);
				
								$idbodega = $rs["id"];
				
							}
							else
							{
								//se busca la ultima bodega para continuar el control
								$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
				
								$qerybodega =  mysql_query($sql,$conn);
									
								$dbod = mysql_fetch_assoc($qerybodega);
									
								$dbod = $dbod['nombre'];
									
								$nombreb = explode("_".$dbod);
									
								$nombreb = ($nombreb[1]*1) + 1;
									
								$nombreb = 'Bodega_'.$nombreb;
									
								$limiteb = 1000;
				
								$actualb = 0;
									
								//se registra la nueva bodega
									
								$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
											VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
									
								$queryids =  mysql_query($sql,$conn);
									
								//se captura el ultimo id registrado
								$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
									
								$rs = mysql_fetch_assoc($rs);
									
								$idbodega = $rs["id"];
									
							}
							//se crea el nuevo directorioo de bodega
							$carpeta = $ruta_bodega.$nombreb;
							if (!file_exists($carpeta))
							{
								mkdir($carpeta, 0777, true);
							}
						}
						else
						{	//existe una bodega desocupada
				
							$dbod = mysql_fetch_assoc($qerybod);
								
							$idbodega = $dbod['id_bodega'];
								
							$nombreb = $dbod['nombre'];
				
							$limiteb = $dbod['limite'];
								
							$actualb = $dbod['actual'];
								
						}
					}
					else
					{
						if ($configdb[0] == 'pgsql')
						{
				
							$qerybod = pg_query($conn,$sql);
								
							$haybodega = pg_num_rows($qerybod);
								
							if ($haybodega == 0)
							{
								//se debe generar una bodega nueva
								//se verifica si es la primera bodega
								$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
				
								$qeryhabod = pg_query($conn,$sql);
									
								$cbod = pg_num_rows($qeryhabod);
									
								if ($cbod == 0)
								{
									//se genera la primera bodega
				
									$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
				
									$queryids = pg_query($conn,$sql);
				
									$resid = pg_fetch_array($queryids);
										
									$idbodega =  $resid[0];
				
									$nombreb = 'Bodega_1';
				
									$limiteb = 1000;
				
									$actualb = 0;
				
										
				
								}
								else
								{
									//se busca la ultima bodega para continuar el control
									$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
				
									$qerybodega =  pg_query($conn,$sql);
				
									$dbod = pg_fetch_assoc($qerybodega);
										
									$dbod = $dbod['nombre'];
				
									$nombreb = explode("_".$dbod);
				
									$nombreb = ($nombreb[1]*1) + 1;
				
									$nombreb = 'Bodega_'.$nombreb;
				
									$limiteb = 1000;
				
									$actualb = 0;
				
									//se registra la nueva bodega
				
									$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
				
									$queryids = pg_query($conn,$sql);
				
									$resid = pg_fetch_array($queryids);
										
									$idbodega =  $resid[0];
				
								}
								//se crea el nuevo directorioo de bodega
								$carpeta = $ruta_bodega.$nombreb;
								if (!file_exists($carpeta))
								{
									mkdir($carpeta, 0777, true);
								}
							}
							else
							{	//existe una bodega desocupada
				
								$dbod = pg_fetch_assoc($qerybod);
									
								$idbodega = $dbod['id_bodega'];
				
								$nombreb = $dbod['nombre'];
									
								$limiteb = $dbod['limite'];
				
								$actualb = $dbod['actual'];
									
							}
						}
					 else 
					 	{
					 		if (trim($configdb[0]) == 'sqlsrv')
					 			{
					 				$qerybod = sqlsrv_query($conn,$sql);
					 				
					 				$sql1 = "select id_bodega from sgd_bodegas where id_bodega > 0 ";
					 				
					 				$cubodega = sqlsrv_query($conn,$sql1);
					 				
					 				while( $row = sqlsrv_fetch_array( $cubodega, SQLSRV_FETCH_ASSOC ))
						 				{
						 					$haybodega = $haybodega + 1;
						 				}
					 				
					 				if ($haybodega == 0)
						 				{
						 					//se debe generar una bodega nueva
						 					//se verifica si es la primera bodega
						 					$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
						 				
						 					$qeryhabod = sqlsrv_query($conn,$sql);
						 					
						 					while( $row = sqlsrv_fetch_array( $qeryhabod, SQLSRV_FETCH_ASSOC ))
							 					{
							 						$cbod = $cbod + 1;
							 					}
						 											 						
						 					if ($cbod == 0)
							 					{
							 						//se genera la primera bodega
							 				
							 						$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
															VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
							 				
							 						$queryids = sqlsrv_query($conn,$sql);
							 						
							 						$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0  ORDER BY id_bodega desc";
							 						
							 						$resource = sqlsrv_query($conn, $sql);
							 						
							 						while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
								 						{
								 							$ultimoid =  $row['id_bodega'];
							 							}	
							 						
							 						$idbodega =  $ultimoid;
							 				
							 						$nombreb = 'Bodega_1';
							 				
							 						$limiteb = 1000;
							 				
							 						$actualb = 0;
							 						
							 					}
						 					else
							 					{
							 						//se busca la ultima bodega para continuar el control
							 						$sql = 'select top 1 nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id_bodega DESC';
							 				
							 						$qerybodega =  sqlsrv_query($conn,$sql);
							 						
							 						while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
								 						{
								 							$dbod =  $row['nombre'];
								 						}
							 				
							 						$nombreb = explode("_".$dbod);
							 				
							 						$nombreb = ($nombreb[1]*1) + 1;
							 				
							 						$nombreb = 'Bodega_'.$nombreb;
							 				
							 						$limiteb = 1000;
							 				
							 						$actualb = 0;
							 				
							 						//se registra la nueva bodega
							 				
							 						$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
															VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
							 				
							 						$queryids = sqlsrv_query($conn,$sql);
							 						
							 						$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0  ORDER BY id_bodega desc";
							 						
							 						$resource = sqlsrv_query($conn, $sql);
							 						
							 						while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
								 						{
								 							$ultimoid =  $row['id_bodega'];
								 						}
								 						
							 						$idbodega =  $ultimoid;
							 				
							 					}
						 					//se crea el nuevo directorioo de bodega
						 					$carpeta = $ruta_bodega.$nombreb;
						 					if (!file_exists($carpeta))
							 					{
							 						mkdir($carpeta, 0777, true);
							 					}
						 				}
					 				else
						 				{	//existe una bodega desocupada
					 					
							 					while( $row = sqlsrv_fetch_array( $qerybod, SQLSRV_FETCH_ASSOC ))
								 					{
								 						$idbodega = $row['id_bodega'];
								 							
								 						$nombreb = $row['nombre'];
								 						
								 						$limiteb = $row['limite'];
								 							
								 						$actualb = $row['actual'];
								 					}
						 						
						 					
						 				}
					 			}	
					 	}	
					}
						
					/////////////////////////////////////////////////// fin del calculo de los datos de bodega///////////////////////////////////
						
						
					$sql = 'select id_documento from sgd_documentos  where id_documento = 0 and id_expediente = '.$id_expediente.' and id_tipodocumental = '.$id_tipodoc.' and id_tabla = '.$id_tabla.' and id_folder = '.$id_folder;
						
					if ($configdb[0] == 'mysql')
						{
							
							$qerydoc =  mysql_query($sql,$conn);
							
							$documentoreg = mysql_num_rows($qerydoc);
							
							if ($documentoreg == 0)
								{
									
									//se registran los datos
									// primero el documento
									$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,orden,id_estado,created_at)
											VALUES(".$id_expediente.", ".$id_tipodoc.", ".$id_usuario.",".$id_tabla.",".$id_folder.",".$ordendoc.",1,'".date("Y-m-d H:i:s")."')";
									
									$queryids =  mysql_query($sql,$conn);
									
									//se captura el ultimo id registrado
									$rs = mysql_query("SELECT MAX(id_documento) AS id FROM sgd_documentos");
									
									$rs = mysql_fetch_assoc($rs);
									
									$iddocumento = $rs["id"];
									
									//se guarda en la tabla de notificacion a usuarios x documentos
									if ($id_eenviara != '')
										{
											
											$id_eenviara = explode("_;_",$id_eenviara);
											
											$totalidenvias = count($id_eenviara);
											
											$totalidenvias = $totalidenvias - 1;
											
											for ( $i = 0 ; $i < $totalidenvias ; $i ++)
												{
													$sql ="INSERT INTO sgd_notificacion_usuarios (id_documento,id_usuario,id_estado,created_at)
													VALUES(".$iddocumento.", ".$id_eenviara[$i].",1,'".date("Y-m-d H:i:s")."')";
													
													$queryids = mysql_query($sql,$conn);
													
												}
											
										}
									
									//////////////////////
									//se registran los valores indices
									
									for ( $i = 0 ; $i < $totalindices ; $i ++)
										{
											$valord = $valor[$i];
											if ($i == 0)
												{
													$elvalorb = $valord;
												}
											$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
											VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
																						
											$queryids =  mysql_query($sql,$conn);
											
										}
									
									//se registran las imagenes
									for($i=0; $i<$total; $i++) {
										//Get the temp file path
										$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
										
										$nombrear = $_FILES['documentosimg']['name'][$i];
										
										$nombrear = explode('.',$nombrear);
										
										$nombrear = $nombrear[0];
										
										$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
										
										//se registra la imagen, se debe tener control de la abodega
										
										$actualb = $actualb + 1;
										
										if ($actualb > $limiteb) //se genera una nueva bodega
											{
												$nombreb = explode("_".$nombreb);
												
												$nombreb = ($nombreb[1]*1) + 1;
												
												$nombreb = 'Bodega_'.$nombreb;
												
												$limiteb = 1000;
												
												$actualb = 1;
												
												//se registra la nueva bodega
												
												$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
												VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."')";
												
												$queryids =  mysql_query($sql,$conn);
												
												//se captura el ultimo id registrado
												$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
												
												$rs = mysql_fetch_assoc($rs);
												
												$idbodega = $rs["id"];
												
											}
										else
											{
												//se acutaliza el valor de documentos actuales en la tabla bodega
												$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
												
												$queryids =  mysql_query($sql,$conn);
											}
										
										//SE EVALUA SI ES O NO ZIP
										if ($file_ext != 'zip' and $file_ext != 'ZIP' )
											{
												
												//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
												
												$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
												
												$qeryorden =  mysql_query($sql,$conn);
												
												$cuantoorden = mysql_num_rows($qeryorden);
												
												if ($cuantoorden > 0)
													{
														
														$orden = mysql_fetch_assoc($qeryorden);
														
														$norden = $orden['orden'];
														
														$norden = $norden + 1;
														
													}
												else
													{
														
														$norden = 0;
														
														$norden = $norden + 1;
														
													}
												
												$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
												VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
												
												$queryids =  mysql_query($sql,$conn);
												
												//se captura el ultimo id registrado
												$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
												
												$rs = mysql_fetch_assoc($rs);
												
												$idimagen = $rs["id"];
												
												//se registra que hay imagenes en la tabla de encriptacion
												
												$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
												
												$queryids =  mysql_query($sql,$conn);
												
												if ($idimagen > 0)
													{
														$dir = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$file_ext;
														
														if(move_uploaded_file($tmpFilePath, $dir)) {
															
															encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
															
															unlink($dir);
														}
													}
											}
										
										else
											{
												if ($file_ext == 'zip' or $file_ext == 'ZIP' )
													{
														
														$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
														
														if(move_uploaded_file($tmpFilePath, $dir))
															{
																
																require_once('manejozip.php');
																
																$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																
																$destino = $ruta_bodega.$nombreb.'/';
																
																$zip_manager = new Zip_manager();
																
																$resultado = $zip_manager->extraer($archivopadre, $destino);
																
																if ($resultado)
																	{
																		$listado = $zip_manager->listar($archivopadre, $destino);
																		
																		$czip = 0;
																		
																		for ($iti = 0; $iti < count($listado); $iti++)
																			{
																				
																				//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																				
																				$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
																				
																				$qeryorden =  mysql_query($sql,$conn);
																				
																				$cuantoorden = mysql_num_rows($qeryorden);
																				
																				if ($cuantoorden > 0)
																					{
																						
																						$orden = mysql_fetch_assoc($qeryorden);
																						
																						$norden = $orden['orden'];
																						
																						$norden = $norden + 1;
																						
																					}
																				else
																					{
																						
																						$norden = 0;
																						
																						$norden = $norden + 1;
																						
																					}
																				
																				$czip = $czip + 1;
																				
																				//se separa la extension
																				
																				$extimg = substr(strrchr($listado[$iti], "."),1);
																				
																				$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																				
																				$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																				VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
																				
																				$queryids =  mysql_query($sql,$conn);
																				
																				//se captura el ultimo id registrado
																				$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
																				
																				$rs = mysql_fetch_assoc($rs);
																				
																				$idimagen = $rs["id"];
																				
																				//se registra que hay imagenes en la tabla de encriptacion
																				
																				$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																				
																				$queryids =  mysql_query($sql,$conn);
																				
																				if ($idimagen > 0)
																					{
																						
																						//se copia con el id del registro de imagen
																						
																						$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																						
																						$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																						
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																								
																								encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																								
																								unlink($dir); //se eliminan los archivos hijos del zip
																								
																								unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																								
																							}
																						
																					}
																				
																				
																			}//fin del for
																		
																		unlink($archivopadre);   //se elimina el archivo zip padre
																	}
															}
														else
															{
																
																echo 'no hay';
															}
													}
											}
										
									}//fin del for de imagenes
									
								}//fin si el documento no existe
							else
								{
									//se actualizan datos y se agregan imagenes
									
									$iddocument = mysql_fetch_assoc($qerydoc);
									
									$iddocumento = $iddocument['id_documento'];
									
									//se elimina los indices registrados
									
									$sql ="DELETE FROM sgd_valorindice WHERE id_documento = ".$iddocumento;
									
									$queryids =  mysql_query($sql,$conn);
									
									//se registran los indices
									
									for ( $i = 0 ; $i < $totalindices ; $i ++)
										{
											$valord = $valor[$i];
											if ($i == 0)
												
											$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
													VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
											
											$queryids =  mysql_query($sql,$conn);
											
										}
									//se registran las imagenes agregadas
									for($i=0; $i<$total; $i++)
										{
											
											$actualb = $actualb + 1;
											
											if ($actualb > $limiteb) //se genera una nueva bodega
												{
													$nombreb = explode("_".$nombreb);
													
													$nombreb = ($nombreb[1]*1) + 1;
													
													$nombreb = 'Bodega_'.$nombreb;
													
													$limiteb = 1000;
													
													$actualb = 1;
													
													//se registra la nueva bodega
													
													$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."')";
													
													$queryids =  mysql_query($sql,$conn);
													
													//se captura el ultimo id registrado
													$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
													
													$rs = mysql_fetch_assoc($rs);
													
													$idbodega = $rs["id"];
													
												}
											else
												{
													//se acutaliza el valor de documentos actuales en la tabla bodega
													$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
													
													$queryids =  mysql_query($sql,$conn);
												}
											
											//Get the temp file path
											$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
											
											$nombrear = $_FILES['documentosimg']['name'][$i];
											
											$nombrear = explode('.',$nombrear);
											
											$nombrear = $nombrear[0];
											
											$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
											
											// se registra
											
											if ($file_ext != 'zip' and $file_ext != 'ZIP' )
												{
													
													
													//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
													
													$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
													
													$qeryorden =  mysql_query($sql,$conn);
													
													$cuantoorden = mysql_num_rows($qeryorden);
													
													if ($cuantoorden > 0)
														{
															
															$orden = mysql_fetch_assoc($qeryorden);
															
															$norden = $orden['orden'];
															
															$norden = $norden + 1;
															
														}
													else
														{
															
															$norden = 0;
															
															$norden = $norden + 1;
															
														}
													
													$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																				VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
													
													$queryids =  mysql_query($sql,$conn);
													
													//se captura el ultimo id registrado
													$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
													
													$rs = mysql_fetch_assoc($rs);
													
													$idimagen = $rs["id"];
													
													//se registra que hay imagenes en la tabla de encriptacion
													
													$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
													
													$queryids =  mysql_query($sql,$conn);
													
													if ($idimagen > 0)
														{
															$dir = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$file_ext;
															
															if(move_uploaded_file($tmpFilePath, $dir)) {
																
																encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																
																unlink($dir);
															}
														}
												}
											else
												{
													if ($file_ext == 'zip' or $file_ext == 'ZIP' )
														{
															$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
															
															if(move_uploaded_file($tmpFilePath, $dir))
																{
																	
																	//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																	
																	$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
																	
																	$qeryorden =  mysql_query($sql,$conn);
																	
																	$cuantoorden = mysql_num_rows($qeryorden);
																	
																	if ($cuantoorden > 0)
																		{
																			
																			$orden = mysql_fetch_assoc($qeryorden);
																			
																			$norden = $orden['orden'];
																			
																			$norden = $norden + 1;
																			
																		}
																	else
																		{
																			
																			$norden = 0;
																			
																			$norden = $norden + 1;
																			
																		}
																	
																	require_once('manejozip.php');
																	
																	$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																	
																	$destino = $ruta_bodega.$nombreb.'/';
																	
																	$zip_manager = new Zip_manager();
																	
																	$resultado = $zip_manager->extraer($archivopadre, $destino);
																	
																	if ($resultado)
																	{
																		$listado = $zip_manager->listar($archivopadre, $destino);
																		
																		$czip = 0;
																		
																		for ($iti = 0; $iti < count($listado); $iti++)
																		{
																			$czip = $czip + 1;
																			
																			//se separa la extension
																			
																			$extimg = substr(strrchr($listado[$iti], "."),1);
																			
																			$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																			
																			$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																				VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
																			
																			$queryids =  mysql_query($sql,$conn);
																			
																			//se captura el ultimo id registrado
																			$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
																			
																			$rs = mysql_fetch_assoc($rs);
																			
																			$idimagen = $rs["id"];
																			
																			//se registra que hay imagenes en la tabla de encriptacion
																			
																			$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																			
																			$queryids =  mysql_query($sql,$conn);
																			
																			if ($idimagen > 0)
																				{
																					
																					//se copia con el id del registro de imagen
																					
																					$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																					
																					$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																					
																					if (copy($fichero, $nuevo_fichero))
																						{
																							$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																							
																							encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																							
																							unlink($dir); //se eliminan los archivos hijos del zip
																							
																							unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																							
																						}
																				}
																		}//fin del for
																		
																		unlink($archivopadre);   //se elimina el archivo zip padre
																	}
																}
															else
																{
																	
																	echo 'no hay';
																}
														}
												}
										}//fin del for de imagenes
								}
						}
					else
						{
							if ($configdb[0] == 'pgsql')
								{
									$qerydoc = pg_query($conn,$sql);
									
									$documentoreg = pg_num_rows($qerydoc);
									
									if ($documentoreg == 0)
										{
											
											//se registran los datos
											// primero el documento
											$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,orden,id_estado,created_at)
												VALUES(".$id_expediente.", ".$id_tipodoc.", ".$id_usuario.",".$id_tabla.",".$id_folder.",".$ordendoc.",1,'".date("Y-m-d H:i:s")."') RETURNING id_documento";
											
											$queryids = pg_query($conn,$sql);
											
											$resid = pg_fetch_array($queryids);
											
											$iddocumento =  $resid[0];
											
											//se guarda en la tabla de notificacion a usuarios x documentos
											if ($id_eenviara != '')
												{
													
													$id_eenviara = explode("_;_",$id_eenviara);
													
													$totalidenvias = count($id_eenviara);
													
													$totalidenvias = $totalidenvias - 1;
													
													for ( $i = 0 ; $i < $totalidenvias ; $i ++)
														{
															$sql ="INSERT INTO sgd_notificacion_usuarios (id_documento,id_usuario,id_estado,created_at)
															VALUES(".$iddocumento.", ".$id_eenviara[$i].",1,'".date("Y-m-d H:i:s")."')";
															
															$queryids = pg_query($conn,$sql);
															
														}
														
												}
											/////////////////////////////////////
												//se registran los valores indices
												
											for ( $i = 0 ; $i < $totalindices ; $i ++)
												{
													$valord = $valor[$i];//echo $valord;
													if ($i == 0)
														{
															$elvalorb = $valord;
														}
													$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
													VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
													
													$queryids = pg_query($conn,$sql);
													
												}
											
											//se registran las imagenes
											for($i=0; $i<$total; $i++) {
												//Get the temp file path
												$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
												
												$nombrear = $_FILES['documentosimg']['name'][$i];
												
												$nombrear = explode('.',$nombrear);
												
												$nombrear = $nombrear[0];
												
												$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
												
												//se registra la imagen, se debe tener control de la abodega
												
												$actualb = $actualb + 1;
												
												if ($actualb > $limiteb) //se genera una nueva bodega
													{
														$nombreb = explode("_".$nombreb);
														
														$nombreb = ($nombreb[1]*1) + 1;
														
														$nombreb = 'Bodega_'.$nombreb;
														
														$limiteb = 1000;
														
														$actualb = 1;
														
														//se registra la nueva bodega
														
														$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
														VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
														
														$queryids = pg_query($conn,$sql);
														
														$resid = pg_fetch_array($queryids);
														
														$idbodega =  $resid[0];
														
													}
												else
													{
														//se acutaliza el valor de documentos actuales en la tabla bodega
														$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
														
														$queryids = pg_query($conn,$sql);
													}
												
												//SE EVALUA SI ES O NO ZIP
												if ($file_ext != 'zip' and $file_ext != 'ZIP' )
													{
														
														//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
														
														$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1 OFFSET 0';
														
														$qeryorden =  pg_query($conn,$sql);
														
														$cuantoorden = pg_num_rows($qeryorden);
														
														if ($cuantoorden > 0)
															{
																
																$orden = pg_fetch_assoc($qeryorden);
																
																$norden = $orden['orden'];
																
																$norden = $norden + 1;
																
															}
														else
															{
																
																$norden = 0;
																
																$norden = $norden + 1;
																
															}
															
														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
														VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
															
														$queryids =  pg_query($conn,$sql);
														
														$resid = pg_fetch_array($queryids);
														
														$idimagen =  $resid[0];
													
														//se registra que hay imagenes en la tabla de encriptacion
														
														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														
														$queryids =  pg_query($conn,$sql);
														
														if ($idimagen > 0)
															{
																$dir = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$file_ext;
																
																if(move_uploaded_file($tmpFilePath, $dir)) {
																	
																	encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																	
																	unlink($dir);
																}
															}
													}
												
												else
													{
														if ($file_ext == 'zip' or $file_ext == 'ZIP' )
															{
																
																$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
																
																if(move_uploaded_file($tmpFilePath, $dir))
																	{
																		
																		require_once('manejozip.php');
																		
																		$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																		
																		$destino = $ruta_bodega.$nombreb.'/';
																		
																		$zip_manager = new Zip_manager();
																		
																		$resultado = $zip_manager->extraer($archivopadre, $destino);
																		
																		if ($resultado)
																			{
																				$listado = $zip_manager->listar($archivopadre, $destino);
																				
																				$czip = 0;
																				
																				for ($iti = 0; $iti < count($listado); $iti++)
																					{
																						
																						//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																						
																						$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1 OFFSET 0';
																						
																						$qeryorden =  pg_query($conn,$sql);
																						
																						$cuantoorden = pg_num_rows($qeryorden);
																						
																						if ($cuantoorden > 0)
																							{
																								
																								$orden = pg_fetch_assoc($qeryorden);
																								
																								$norden = $orden['orden'];
																								
																								$norden = $norden + 1;
																								
																							}
																						else
																							{
																								
																								$norden = 0;
																								
																								$norden = $norden + 1;
																								
																							}
																						
																						$czip = $czip + 1;
																						
																						//se separa la extension
																						
																						$extimg = substr(strrchr($listado[$iti], "."),1);
																						
																						$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																						
																						$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																						VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																						
																						$queryids =  pg_query($conn,$sql);
																						
																						$resid = pg_fetch_array($queryids);
																						
																						$idimagen =  $resid[0];
																						
																						//se registra que hay imagenes en la tabla de encriptacion
																						
																						$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																						
																						$queryids =  pg_query($conn,$sql);
																						
																						if ($idimagen > 0)
																							{
																								
																								//se copia con el id del registro de imagen
																								
																								$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																								
																								$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																								
																								if (copy($fichero, $nuevo_fichero))
																									{
																										$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																										
																										encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																										
																										unlink($dir); //se eliminan los archivos hijos del zip
																										
																										unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																										
																									}
																								
																							}
																						
																						
																					}//fin del for
																				
																				unlink($archivopadre);   //se elimina el archivo zip padre
																			}
																	}
																else
																	{
																		
																		echo 'no hay';
																	}
															}
													}
												
											}//fin del for de imagenes
											
										}//fin si el documento no existe
									else
										{	
											//se actualizan datos y se agregan imagenes
											
											$iddocument = pg_fetch_assoc($qerydoc);
											
											$iddocumento = $iddocument['id_documento'];
											
											//se elimina los indices registrados
											
											$sql ="DELETE FROM sgd_valorindice WHERE id_documento = ".$iddocumento;
											
											$queryids = pg_query($conn,$sql);
											
											//se registran los indices
											
											
											for ( $i = 0 ; $i < $totalindices ; $i ++)
												{
													$valord = $valor[$i];
													if ($i == 0)
														{
															$elvalorb = $valord;
														}
													
													$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
													VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
													
													$queryids = pg_query($conn,$sql);
													
												}
											//se registran las imagenes agregadas
											for($i=0; $i<$total; $i++)
												{
													
													$actualb = $actualb + 1;
													
													if ($actualb > $limiteb) //se genera una nueva bodega
														{
															$nombreb = explode("_".$nombreb);
															
															$nombreb = ($nombreb[1]*1) + 1;
															
															$nombreb = 'Bodega_'.$nombreb;
															
															$limiteb = 1000;
															
															$actualb = 1;
															
															//se registra la nueva bodega
															
															$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
															VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
															
															$queryids = pg_query($conn,$sql);
															
															$resid = pg_fetch_array($queryids);
															
															$idbodega =  $resid[0];
															
															
														}
													else
														{
															//se acutaliza el valor de documentos actuales en la tabla bodega
															$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
															
															$queryids = pg_query($conn,$sql);
														}
													
													//Get the temp file path
													$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
													
													$nombrear = $_FILES['documentosimg']['name'][$i];
													
													$nombrear = explode('.',$nombrear);
													
													$nombrear = $nombrear[0];
													
													$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
													
													// se registra
													
													if ($file_ext != 'zip' and $file_ext != 'ZIP' )
														{
															
															
															//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
															
															$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
															
															$qeryorden =  pg_query($conn,$sql);
															
															$cuantoorden = pg_num_rows($qeryorden);
															
															if ($cuantoorden > 0)
																{
																	
																	$orden = pg_fetch_assoc($qeryorden);
																	
																	$norden = $orden['orden'];
																	
																	$norden = $norden + 1;
																	
																}
															else
																{
																	
																	$norden = 0;
																	
																	$norden = $norden + 1;
																	
																}
															
																$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																
																$queryids =  pg_query($conn,$sql);
																
																$resid = pg_fetch_array($queryids);
																
																$idimagen =  $resid[0];
																
																//se registra que hay imagenes en la tabla de encriptacion
																
																$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																
																$queryids =  pg_query($conn,$sql);
																
																if ($idimagen > 0)
																	{
																		$dir = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$file_ext;
																		
																		if(move_uploaded_file($tmpFilePath, $dir)) {
																			
																			encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																			
																			unlink($dir);
																		}
																	}
														}
													else
														{
															if ($file_ext == 'zip' or $file_ext == 'ZIP' )
																{
																	$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
																	
																	if(move_uploaded_file($tmpFilePath, $dir))
																		{
																			
																			//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																			
																			$sql = 'select orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc limit 1';
																			
																			$qeryorden =  pg_query($conn,$sql);
																			
																			$cuantoorden = pg_num_rows($qeryorden);
																			
																			if ($cuantoorden > 0)
																				{
																					
																					$orden = pg_fetch_assoc($qeryorden);
																					
																					$norden = $orden['orden'];
																					
																					$norden = $norden + 1;
																					
																				}
																			else
																				{
																					
																					$norden = 0;
																					
																					$norden = $norden + 1;
																					
																				}
																				
																			require_once('manejozip.php');
																			
																			$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																			
																			$destino = $ruta_bodega.$nombreb.'/';
																			
																			$zip_manager = new Zip_manager();
																			
																			$resultado = $zip_manager->extraer($archivopadre, $destino);
																			
																			if ($resultado)
																				{
																					$listado = $zip_manager->listar($archivopadre, $destino);
																					
																					$czip = 0;
																					
																					for ($iti = 0; $iti < count($listado); $iti++)
																						{
																							$czip = $czip + 1;
																							
																							//se separa la extension
																							
																							$extimg = substr(strrchr($listado[$iti], "."),1);
																							
																							$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																							
																							$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																							VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																							
																							$queryids =  pg_query($conn,$sql);
																							
																							$resid = pg_fetch_array($queryids);
																							
																							$idimagen =  $resid[0];
																							
																							//se registra que hay imagenes en la tabla de encriptacion
																							
																							$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																							
																							$queryids =  pg_query($conn,$sql);
																							
																							if ($idimagen > 0)
																								{
																									
																									//se copia con el id del registro de imagen
																									
																									$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																									
																									$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																									
																									if (copy($fichero, $nuevo_fichero))
																										{
																											$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																											
																											encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																											
																											unlink($dir); //se eliminan los archivos hijos del zip
																											
																											unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																											
																										}
																								}
																						}//fin del for
																					
																					unlink($archivopadre);   //se elimina el archivo zip padre
																				}
																		}
																	else
																		{
																			
																			echo 'no hay';
																		}
																}
														}
												}//fin del for de imagenes
										}
								}//fin de pgsql bloque
						 else 
						 	{
						 		if (trim($configdb[0]) == 'sqlsrv')
						 		 	{
						 		 		$qerydoc = sqlsrv_query($conn,$sql);			
						 		 		
						 		 		$documentoreg = 0;
						 		 		
						 		 		while( $row = sqlsrv_fetch_array( $qerydoc, SQLSRV_FETCH_ASSOC ))
							 		 		{
							 		 			$documentoreg = $documentoreg + 1;
							 		 		}
						 		 		
						 		 		if ($documentoreg == 0)
								 		 		{
								 		 				
								 		 			//se registran los datos
								 		 			// primero el documento
								 		 			$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,orden,id_estado,created_at)
															VALUES(".$id_expediente.", ".$id_tipodoc.", ".$id_usuario.",".$id_tabla.",".$id_folder.",".$ordendoc.",1,'".date("Y-m-d H:i:s")."')";
								 		 				
								 		 			$queryids = sqlsrv_query($conn,$sql);
								 		 			
								 		 			$sql ="SELECT id_documento FROM sgd_documentos where  id_expediente =  ".$id_expediente." and id_tipodocumental = ".$id_tipodoc." and id_tabla = ".$id_tabla." and  id_folder = ".$id_folder." ORDER BY id_documento asc";
								 		 			
								 		 			$resource = sqlsrv_query($conn, $sql);
								 		 			
								 		 			while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
									 		 			{
									 		 				$ultimoid =  $row['id_documento'];
									 		 			}
								 		 				
								 		 			$iddocumento =  $ultimoid;
								 		 			
								 		 			
								 		 			//se guarda en la tabla de notificacion a usuarios x documentos
								 		 			if ($id_eenviara != '')
									 		 			{
									 		 				$id_eenviara = explode("_;_",$id_eenviara);
									 		 			
									 		 				$totalidenvias = count($id_eenviara);
									 		 			
									 		 				$totalidenvias = $totalidenvias - 1;
									 		 			
									 		 				for ( $i = 0 ; $i < $totalidenvias ; $i ++)
										 		 				{
										 		 					$sql ="INSERT INTO sgd_notificacion_usuarios (id_documento,id_usuario,id_estado,created_at)
																					VALUES(".$iddocumento.", ".$id_eenviara[$i].",1,'".date("Y-m-d H:i:s")."')";
										 		 			
										 		 					$queryids = sqlsrv_query( $conn, $sql);
										 		 			
										 		 				}
									 		 					
									 		 			}
								 		 		
								 		 			//se registran los valores indices
								 		 		
								 		 			for ( $i = 0 ; $i < $totalindices ; $i ++)
									 		 			{
									 		 				$valord = $valor[$i];//echo $valord;
									 		 				if ($i == 0)
										 		 				{
										 		 					$elvalorb = $valord;
										 		 				}
									 		 				$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
																	VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
									 		 		
									 		 				$queryids = sqlsrv_query($conn,$sql);
									 		 		
									 		 			}
								 		 		
								 		 			//se registran las imagenes
								 		 			for($i=0; $i<$total; $i++) {
								 		 				//Get the temp file path
								 		 				$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
								 		 		
								 		 				$nombrear = $_FILES['documentosimg']['name'][$i];
								 		 		
								 		 				$nombrear = explode('.',$nombrear);
								 		 		
								 		 				$nombrear = $nombrear[0];
								 		 		
								 		 				$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
								 		 		
								 		 				//se registra la imagen, se debe tener control de la abodega
								 		 		
								 		 				$actualb = $actualb + 1;
								 		 		
								 		 				if ($actualb > $limiteb) //se genera una nueva bodega
									 		 				{
									 		 					$nombreb = explode("_".$nombreb);
									 		 						
									 		 					$nombreb = ($nombreb[1]*1) + 1;
									 		 						
									 		 					$nombreb = 'Bodega_'.$nombreb;
									 		 						
									 		 					$limiteb = 1000;
									 		 						
									 		 					$actualb = 1;
									 		 						
									 		 					//se registra la nueva bodega
									 		 						
									 		 					$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																		VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."')";
									 		 						
									 		 					$queryids = sqlsrv_query($conn,$sql);
									 		 					
									 		 					$sql ="SELECT TOP 1 id_bodega FROM sgd_bodegas where  id_bodega > 0 ORDER BY id_bodega desc";
									 		 					
									 		 					$resource = sqlsrv_query($conn, $sql);
									 		 					
									 		 					while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
										 		 					{
										 		 						$ultimoid =  $row['id_bodega'];
										 		 					}
									 		 					 
									 		 					$idbodega =  $ultimoid;
									 		 		
									 		 				}
								 		 				else
									 		 				{
									 		 					//se acutaliza el valor de documentos actuales en la tabla bodega
									 		 					$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
									 		 						
									 		 					$queryids = sqlsrv_query($conn,$sql);
									 		 				}
								 		 		
									 		 				//SE EVALUA SI ES O NO ZIP
									 		 				if ($file_ext != 'zip' and $file_ext != 'ZIP' )
										 		 				{
										 		 					
										 		 					//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
										 		 					
										 		 					$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
										 		 					
										 		 					$queryids =  sqlsrv_query($conn,$sql);
										 		 					
										 		 					$cuantoorden = 0;
										 		 					
										 		 					while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
											 		 					{
											 		 						$cuantoorden = $cuantoorden + 1;
											 		 						
											 		 						$norden = $row['orden'];
											 		 					}
										 		 					
										 		 					if ($cuantoorden > 0)
											 		 					{
											 		 						
											 		 						$norden = $norden + 1;
											 		 						
											 		 					}
										 		 					else
											 		 					{
											 		 						
											 		 						$norden = 0;
											 		 						
											 		 						$norden = $norden + 1;
											 		 						
											 		 					}
										 		 					
										 		 					$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																				VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
										 		 					
										 		 					$queryids =  sqlsrv_query($conn,$sql);
										 		 					
										 		 					$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
										 		 					
										 		 					$resource = sqlsrv_query($conn, $sql);
										 		 					
										 		 					$ultimoid = 0;
										 		 					
										 		 					while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
											 		 					{
											 		 						$ultimoid =  $row['id_imagendocum'];
											 		 					}
										 		 					
										 		 					$idimagen =  $ultimoid;
										 		 					
										 		 					//se registra que hay imagenes en la tabla de encriptacion
										 		 					
										 		 					$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
										 		 					
										 		 					$queryids =  sqlsrv_query($conn,$sql);
										 		 					
										 		 					if ($idimagen > 0)
											 		 					{
											 		 						$dir = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$file_ext;
											 		 						
											 		 						if(move_uploaded_file($tmpFilePath, $dir)) {
											 		 							
											 		 							encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
											 		 							
											 		 							unlink($dir);
											 		 						}
											 		 					}
										 		 				}
										 		 				
										 		 			else
										 		 				{
										 		 					if ($file_ext == 'zip' or $file_ext == 'ZIP' )
											 		 					{
											 		 						
											 		 						$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
											 		 						
											 		 						if(move_uploaded_file($tmpFilePath, $dir))
												 		 						{
												 		 							
												 		 							require_once('manejozip.php');
												 		 							
												 		 							$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
												 		 							
												 		 							$destino = $ruta_bodega.$nombreb.'/';
												 		 							
												 		 							$zip_manager = new Zip_manager();
												 		 							
												 		 							$resultado = $zip_manager->extraer($archivopadre, $destino);
												 		 							
												 		 							if ($resultado)
													 		 							{
													 		 								$listado = $zip_manager->listar($archivopadre, $destino);
													 		 								
													 		 								$czip = 0;
													 		 								
													 		 								for ($iti = 0; $iti < count($listado); $iti++)
														 		 								{
														 		 									
														 		 									//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
														 		 									
														 		 									$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
														 		 									
														 		 									$queryids =  sqlsrv_query($conn,$sql);
														 		 									
														 		 									$cuantoorden = 0;
														 		 									
														 		 									while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
															 		 									{
															 		 										$cuantoorden = $cuantoorden + 1;
															 		 										
															 		 										$norden = $row['orden'];
															 		 									}
														 		 									
														 		 									if ($cuantoorden > 0)
															 		 									{
															 		 										
															 		 										$norden = $norden + 1;
															 		 										
															 		 									}
														 		 									else
															 		 									{
															 		 										
															 		 										$norden = 0;
															 		 										
															 		 										$norden = $norden + 1;
															 		 										
															 		 									}
														 		 									
														 		 									$czip = $czip + 1;
														 		 									
														 		 									//se separa la extension
														 		 									
														 		 									$extimg = substr(strrchr($listado[$iti], "."),1);
														 		 									
														 		 									$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
														 		 									
														 		 									$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																																			VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
														 		 									
														 		 									$queryids = sqlsrv_query($conn,$sql);
														 		 									
														 		 									$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
														 		 									
														 		 									$resource = sqlsrv_query($conn, $sql);
														 		 									
														 		 									while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
															 		 									{
															 		 										$ultimoid =  $row['id_imagendocum'];
															 		 									}
															 		 									
														 		 									$idimagen =  $ultimoid;
														 		 									
														 		 									//se registra que hay imagenes en la tabla de encriptacion
														 		 									
														 		 									$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														 		 									
														 		 									$queryids =  sqlsrv_query($conn,$sql);
														 		 									
														 		 									if ($idimagen > 0)
															 		 									{
															 		 										
															 		 										//se copia con el id del registro de imagen
															 		 										
															 		 										$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
															 		 										
															 		 										$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
															 		 										
															 		 										if (copy($fichero, $nuevo_fichero))
																 		 										{
																 		 											$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																 		 											
																 		 											encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																 		 											
																 		 											unlink($dir); //se eliminan los archivos hijos del zip
																 		 											
																 		 											unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																 		 											
																 		 										}
															 		 										
															 		 									}
														 		 									
														 		 									
														 		 								}//fin del for
													 		 								
													 		 								unlink($archivopadre);   //se elimina el archivo zip padre
													 		 							}
												 		 						}
											 		 						else
												 		 						{
												 		 							
												 		 							echo 'no hay';
												 		 						}
											 		 					}
										 		 				}
								 		 		
								 		 			}//fin del for de imagenes
								 		 				
								 		 		}//fin si el documento no existe
							 		 		else
								 		 		{//se actualizan datos y se agregan imagenes
								 		 			
								 		 			$iddocument = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC);
								 		 			
								 		 			$iddocumento = $iddocument['id_documento'];
								 		 			
								 		 			//se elimina los indices registrados
								 		 			
								 		 			$sql ="DELETE FROM sgd_valorindice WHERE id_documento = ".$iddocumento;
								 		 			
								 		 			$queryids = sqlsrv_query($conn,$sql);
								 		 			
								 		 			//se registran los indices
								 		 			
								 		 			
								 		 			for ( $i = 0 ; $i < $totalindices ; $i ++)
									 		 			{
									 		 				$valord = $valor[$i];
									 		 				if ($i == 0)
									 		 				{
									 		 					$elvalorb = $valord;
									 		 				}
									 		 				
									 		 				$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
																			VALUES(".$iddocumento.", ".$vidindices[$i].", '".$valord."',1,'".date("Y-m-d H:i:s")."')";
									 		 				
									 		 				$queryids = sqlsrv_query($conn,$sql);
									 		 				
									 		 			}
								 		 			//se registran las imagenes agregadas
								 		 			for($i=0; $i<$total; $i++)
									 		 			{
									 		 				
									 		 				$actualb = $actualb + 1;
									 		 				
									 		 				if ($actualb > $limiteb) //se genera una nueva bodega
									 		 				{
									 		 					$nombreb = explode("_".$nombreb);
									 		 					
									 		 					$nombreb = ($nombreb[1]*1) + 1;
									 		 					
									 		 					$nombreb = 'Bodega_'.$nombreb;
									 		 					
									 		 					$limiteb = 1000;
									 		 					
									 		 					$actualb = 1;
									 		 					
									 		 					//se registra la nueva bodega
									 		 					
									 		 					$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																						VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') ";
									 		 					
									 		 					$queryids = sqlsrv_query($conn,$sql);
									 		 					
									 		 					$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
									 		 					
									 		 					$resource = sqlsrv_query($conn, $sql);
									 		 					
									 		 					$ultimoid = 0;
									 		 					
									 		 					while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
									 		 					{
									 		 						$ultimoid =  $row['id_bodega'];
									 		 					}
									 		 					
									 		 					$queryids = sqlsrv_query($conn,$sql);
									 		 					
									 		 					$resid = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ARRAY);
									 		 					
									 		 					$idbodega =  $resid[0];
									 		 					
									 		 					
									 		 				}
									 		 				else
									 		 				{
									 		 					//se acutaliza el valor de documentos actuales en la tabla bodega
									 		 					$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
									 		 					
									 		 					$queryids = sqlsrv_query($conn,$sql);
									 		 				}
									 		 				
									 		 				//Get the temp file path
									 		 				$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
									 		 				
									 		 				$nombrear = $_FILES['documentosimg']['name'][$i];
									 		 				
									 		 				$nombrear = explode('.',$nombrear);
									 		 				
									 		 				$nombrear = $nombrear[0];
									 		 				
									 		 				$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
									 		 				
									 		 				// se registra
									 		 				
									 		 				if ($file_ext != 'zip' and $file_ext != 'ZIP' )
									 		 				{
									 		 					
									 		 					
									 		 					//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
									 		 					
									 		 					
									 		 					$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
									 		 					
									 		 					$queryids =  sqlsrv_query($conn,$sql);
									 		 					
									 		 					$cuantoorden = 0;
									 		 					
									 		 					while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
									 		 					{
									 		 						$cuantoorden = $cuantoorden + 1;
									 		 						
									 		 						$norden = $row['orden'];
									 		 					}
									 		 					
									 		 					if ($cuantoorden > 0)
									 		 					{
									 		 						
									 		 						$norden = $norden + 1;
									 		 						
									 		 					}
									 		 					else
									 		 					{
									 		 						
									 		 						$norden = 0;
									 		 						
									 		 						$norden = $norden + 1;
									 		 					}
									 		 					
									 		 					$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																						VALUES(".$iddocumento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
									 		 					
									 		 					$queryids = sqlsrv_query($conn,$sql);
									 		 					
									 		 					$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
									 		 					
									 		 					$resource = sqlsrv_query($conn, $sql);
									 		 					
									 		 					while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
									 		 					{
									 		 						$ultimoid =  $row['id_imagendocum'];
									 		 					}
									 		 					
									 		 					$idimagen =  $ultimoid;
									 		 					
									 		 					//se registra que hay imagenes en la tabla de encriptacion
									 		 					
									 		 					$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
									 		 					
									 		 					$queryids =  sqlsrv_query($conn,$sql);
									 		 					
									 		 					if ($idimagen > 0)
									 		 					{
									 		 						$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
									 		 						
									 		 						if(move_uploaded_file($tmpFilePath, $dir))
									 		 						{
									 		 							encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
									 		 							
									 		 							unlink($dir);
									 		 						}
									 		 					}
									 		 				}
									 		 				else
										 		 				{
										 		 					if ($file_ext == 'zip' or $file_ext == 'ZIP' )
											 		 					{
											 		 						$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
											 		 						
											 		 						if(move_uploaded_file($tmpFilePath, $dir))
												 		 						{
												 		 							
												 		 							//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
												 		 							
												 		 							
												 		 							$sql = 'select top 1 orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden desc';
												 		 							
												 		 							$queryids =  sqlsrv_query($conn,$sql);
												 		 							
												 		 							$cuantoorden = 0;
												 		 							
												 		 							while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
													 		 							{
													 		 								$cuantoorden = $cuantoorden + 1;
													 		 								
													 		 								$norden = $row['orden'];
													 		 							}
												 		 							
												 		 							if ($cuantoorden > 0)
													 		 							{
													 		 								
													 		 								$norden = $norden + 1;
													 		 								
													 		 							}
												 		 							else
													 		 							{
													 		 								
													 		 								$norden = 0;
													 		 								
													 		 								$norden = $norden + 1;
													 		 							}
												 		 							require_once('manejozip.php');
												 		 							
												 		 							$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
												 		 							
												 		 							$destino = $ruta_bodega.$nombreb.'/';
												 		 							
												 		 							$zip_manager = new Zip_manager();
												 		 							
												 		 							$resultado = $zip_manager->extraer($archivopadre, $destino);
												 		 							
												 		 							if ($resultado)
													 		 							{
													 		 								$listado = $zip_manager->listar($archivopadre, $destino);
													 		 								
													 		 								$czip = 0;
													 		 								
													 		 								for ($iti = 0; $iti < count($listado); $iti++)
														 		 								{
														 		 									$czip = $czip + 1;
														 		 									
														 		 									//se separa la extension
														 		 									
														 		 									$extimg = substr(strrchr($listado[$iti], "."),1);
														 		 									
														 		 									$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
														 		 									
														 		 									$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																									VALUES(".$iddocumento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
														 		 									
														 		 									$queryids = sqlsrv_query($conn,$sql);
														 		 									
														 		 									$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$iddocumento." ORDER BY id_imagendocum desc";
														 		 									
														 		 									$resource = sqlsrv_query($conn, $sql);
														 		 									
														 		 									while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
															 		 									{
															 		 										$ultimoid =  $row['id_imagendocum'];
															 		 									}
														 		 									
														 		 									$idimagen =  $ultimoid;
														 		 									
														 		 									//se registra que hay imagenes en la tabla de encriptacion
														 		 									
														 		 									$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														 		 									
														 		 									$queryids =  sqlsrv_query($conn,$sql);
														 		 									
														 		 									if ($idimagen > 0)
															 		 									{
															 		 										
															 		 										//se copia con el id del registro de imagen
															 		 										
															 		 										$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
															 		 										
															 		 										$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
															 		 										
															 		 										if (copy($fichero, $nuevo_fichero))
																 		 										{
																 		 											$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																 		 											
																 		 											encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																 		 											
																 		 											unlink($dir); //se eliminan los archivos hijos del zip
																 		 											
																 		 											unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																 		 											
																 		 										}
															 		 									}
														 		 								}//fin del for
													 		 								
													 		 								unlink($archivopadre);   //se elimina el archivo zip padre
													 		 							}
												 		 						}
											 		 						else
												 		 						{
												 		 							
												 		 							echo 'no hay';
												 		 						}
											 		 					}
										 		 				}
									 		 			}//fin del for de imagenes
								 		 		}
						 		 	}	
						 	}	
						}
				}
				
				$laruta = darurl(); 
				if ($origen != 'visor_listado_avanzado')
					{
						header('Location: '.$laruta.'/'.$_REQUEST['workspace'].'/expedientes/'.$elvalorb.'/'.$origen);  
					}
				else
					{
						if ($origen == 'visor_listado_avanzado')
							{
								header('Location: '.$laruta.'/'.$_REQUEST['workspace'].'/expedientes/'.$iddocumento.'/'.$id_tabla.'/'.$elvalorb.'/'.$origen); 
							}	
					}
			break;	
			case 'grabarimagen':  
				if(isset($_FILES['documentosimg'])){   
					$errors= array();
						
					$id_usuario = $_REQUEST['id_usuario'];
						
					$id_tipodoc = $_REQUEST['id_tipodoc'];
						
					$id_documento = $_REQUEST['id_documento'];
						
					$id_expediente = $_REQUEST['id_expediente'];
					
					$vi = $_REQUEST['vi'];
										
					$total = count($_FILES['documentosimg']['name']);    
						
					//se procede a guardar en cada tabla correspondientemente
					$ordendoc = 0;
						
					/////////////////////////////////////// se verifica si existen bodega para guardar///////////////////////////////////////
						
					$sql = 'select id_bodega,nombre,limite,actual from sgd_bodegas  where actual < limite ';
						
					if ($configdb[0] == 'mysql')
						{
							$qerybod =  mysql_query($sql,$conn);
								
							$haybodega = mysql_num_rows($qerybod);
								
							if ($haybodega == 0)
							{
								//se debe generar una bodega nueva
								//se verifica si es la primera bodega
								$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
									
								$qeryhabod =  mysql_query($sql,$conn);
					
								$cbod = mysql_num_rows($qeryhabod);
									
								if ($cbod == 0)
								{
									//se genera la primera bodega
										
									$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
												VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
										
									$nombreb = 'Bodega_1';
										
									$limiteb = 1000;
										
									$actualb = 0;
					
									$queryids =  mysql_query($sql,$conn);
										
									//se captura el ultimo id registrado
									$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
					
									$rs = mysql_fetch_assoc($rs);
					
									$idbodega = $rs["id"];
					
								}
								else
								{
									//se busca la ultima bodega para continuar el control
									$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
					
									$qerybodega =  mysql_query($sql,$conn);
										
									$dbod = mysql_fetch_assoc($qerybodega);
										
									$dbod = $dbod['nombre'];
										
									$nombreb = explode("_".$dbod);
										
									$nombreb = ($nombreb[1]*1) + 1;
										
									$nombreb = 'Bodega_'.$nombreb;
										
									$limiteb = 1000;
					
									$actualb = 0;
										
									//se registra la nueva bodega
										
									$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
												VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
										
									$queryids =  mysql_query($sql,$conn);
										
									//se captura el ultimo id registrado
									$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
										
									$rs = mysql_fetch_assoc($rs);
										
									$idbodega = $rs["id"];
										
								}
								//se crea el nuevo directorioo de bodega
								$carpeta = $ruta_bodega.$nombreb;
								if (!file_exists($carpeta))
									{
										mkdir($carpeta, 0777, true);
									}
							}
							else
								{	//existe una bodega desocupada
						
									$dbod = mysql_fetch_assoc($qerybod);
										
									$idbodega = $dbod['id_bodega'];
										
									$nombreb = $dbod['nombre'];
						
									$limiteb = $dbod['limite'];
										
									$actualb = $dbod['actual'];
										
								}
						}
					else
						{
							if ($configdb[0] == 'pgsql')
							{
					
								$qerybod = pg_query($conn,$sql);
									
								$haybodega = pg_num_rows($qerybod);
									
								if ($haybodega == 0)
									{
										//se debe generar una bodega nueva
										//se verifica si es la primera bodega
										$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
						
										$qeryhabod = pg_query($conn,$sql);
											
										$cbod = pg_num_rows($qeryhabod);
											
										if ($cbod == 0)
											{
												//se genera la primera bodega
							
												$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
							
												$queryids = pg_query($conn,$sql);
							
												$resid = pg_fetch_array($queryids);
													
												$idbodega =  $resid[0];
							
												$nombreb = 'Bodega_1';
							
												$limiteb = 1000;
							
												$actualb = 0;
											}
										else
											{
												//se busca la ultima bodega para continuar el control
												$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
							
												$qerybodega =  pg_query($conn,$sql);
							
												$dbod = pg_fetch_assoc($qerybodega);
													
												$dbod = $dbod['nombre'];
							
												$nombreb = explode("_".$dbod);
							
												$nombreb = ($nombreb[1]*1) + 1;
							
												$nombreb = 'Bodega_'.$nombreb;
							
												$limiteb = 1000;
							
												$actualb = 0;
							
												//se registra la nueva bodega
							
												$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
							
												$queryids = pg_query($conn,$sql);
							
												$resid = pg_fetch_array($queryids);
													
												$idbodega =  $resid[0];
							
											}
										//se crea el nuevo directorioo de bodega
										$carpeta = $ruta_bodega.$nombreb;
										if (!file_exists($carpeta))
											{
												mkdir($carpeta, 0777, true);
											}
									}
								else
									{	//existe una bodega desocupada
						
										$dbod = pg_fetch_assoc($qerybod);
											
										$idbodega = $dbod['id_bodega'];
						
										$nombreb = $dbod['nombre'];
											
										$limiteb = $dbod['limite'];
						
										$actualb = $dbod['actual'];
											
									}
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$qerybod = sqlsrv_query($conn,$sql);
										
										$cubodega = sqlsrv_query($conn,$sql);
										
										$haybodega = 0;
										 
										while( $row = sqlsrv_fetch_array( $cubodega, SQLSRV_FETCH_ASSOC ))
											{
												$haybodega =  $haybodega + 1;
											}
																						
										if ($haybodega == 0)
											{
												//se debe generar una bodega nueva
												//se verifica si es la primera bodega
												$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
											
												$qeryhabod = sqlsrv_query($conn,$sql);
												
												$cucbod = sqlsrv_query($conn,$sql);
												
												$cbod = 0;
												
												while( $row = sqlsrv_fetch_array( $cucbod, SQLSRV_FETCH_ASSOC ))
													{
														$cbod =  $cbod + 1;
													}
													
												if ($cbod == 0)
													{
														//se genera la primera bodega
															
														$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																		VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
															
														$queryids = sqlsrv_query($conn,$sql);
														
														$sql ="SELECT TOP 1 id_bodega FROM sgd_bodegas where sgd_bodegas > 0 ORDER BY id_bodega desc";
														
														$resource = sqlsrv_query($conn, $sql);
														
														while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
															{
																$ultimoid =  $row['id_bodega'];
															}
														
														$idbodega = $ultimoid;
															
														$nombreb = 'Bodega_1';
															
														$limiteb = 1000;
															
														$actualb = 0;
													}
												else
													{
														//se busca la ultima bodega para continuar el control
														$sql = 'select top 1 nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id_bodega DESC';
															
														$qerybodega =  sqlsrv_query($conn,$sql);
																					
														while($dbod = sqlsrv_fetch_array( $qerybodega, SQLSRV_FETCH_ASSOC) ) 
															{
																$dbod = $dbod['nombre'];
															}
															
														$nombreb = explode("_".$dbod);
															
														$nombreb = ($nombreb[1]*1) + 1;
															
														$nombreb = 'Bodega_'.$nombreb;
															
														$limiteb = 1000;
															
														$actualb = 0;
															
														//se registra la nueva bodega
															
														$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																		VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
															
														$queryids = sqlsrv_query($conn,$sql);
														
														$sql ="SELECT TOP 1 id_bodega FROM sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
														
														$resource = sqlsrv_query($conn, $sql);
														
														while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
															{
																$ultimoid =  $row['id_bodega'];
															}
														
														$idbodega = $ultimoid;
															
													}
												//se crea el nuevo directorioo de bodega
												$carpeta = $ruta_bodega.$nombreb;
												if (!file_exists($carpeta))
													{
														mkdir($carpeta, 0777, true);
													}
											}
										else
											{	//existe una bodega desocupada
											
												while($dbod = sqlsrv_fetch_array( $qerybod, SQLSRV_FETCH_ASSOC) )
													{
														$idbodega = $dbod['id_bodega'];
														
														$nombreb = $dbod['nombre'];
															
														$limiteb = $dbod['limite'];
														
														$actualb = $dbod['actual'];
													} 
												
												
												
											}
									}	
							}	
					}
						
					/////////////////////////////////////////////////// fin del calculo de los datos de bodega///////////////////////////////////
					
						//se registran las imagenes agregadas
						for($i=0; $i<$total; $i++) {
								
							$actualb = $actualb + 1;
								
							if ($actualb > $limiteb) //se genera una nueva bodega
								{
									$nombreb = explode("_".$nombreb);
							
									$nombreb = ($nombreb[1]*1) + 1;
							
									$nombreb = 'Bodega_'.$nombreb;
							
									$limiteb = 1000;
							
									$actualb = 1;
							
									//se registra la nueva bodega
							
									$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
														VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."')";
									
									if ($configdb[0] == 'mysql')
										{
							
											$queryids =  mysql_query($sql,$conn);
							
											//se captura el ultimo id registrado
											$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
									
											$rs = mysql_fetch_assoc($rs);
									
											$idbodega = $rs["id"];
											
										}	
									else
										{
											if ($configdb[0] == 'pgsql')
												{
													
													$queryids = pg_query($conn,$sql);
														
													$resid = pg_fetch_array($queryids);
													
													$idbodega =  $resid[0];
													
												}	
											else
												{
													if (trim($configdb[0]) == 'sqlsrv')
														{
															$queryids = sqlsrv_query($conn,$sql);
															
															$sql ="SELECT TOP 1 id_bodega FROM sgd_bodegas where sgd_bodegas > 0 ORDER BY id_bodega desc";
															
															$resource = sqlsrv_query($conn, $sql);
															
															while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																{
																	$ultimoid =  $row['id_bodega'];
																}
															
															$idbodega = $ultimoid;
														}	
												}	
										}
									
								}
							else
								{
									//se acutaliza el valor de documentos actuales en la tabla bodega
									$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
										
									if ($configdb[0] == 'mysql')
										{
											$queryids =  mysql_query($sql,$conn);
										}
									else
										{
											if ($configdb[0] == 'pgsql')
												{
													$queryids = pg_query($conn,$sql);
												}	
											else 
												{
													if (trim($configdb[0]) == 'sqlsrv')
														{
															$queryids = sqlsrv_query($conn,$sql);
														}	
												}	
										}
								}
								
							//Get the temp file path
							$tmpFilePath = $_FILES['documentosimg']['tmp_name'][$i];
						
							$nombrear = $_FILES['documentosimg']['name'][$i];
						
							$nombrear = explode('.',$nombrear);
						
							$nombrear = $nombrear[0];
						
							$file_ext = strtolower(end(explode('.',$_FILES['documentosimg']['name'][$i])));
							
							if ($configdb[0] == 'mysql')
								{
									
									if ($file_ext != 'zip' and $file_ext != 'ZIP' )
										{
											//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
											
											$sql = 'select orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden desc limit 1';
											
											$qeryorden =  mysql_query($sql,$conn);
											
											$cuantoorden = mysql_num_rows($qeryorden);
											
											if ($cuantoorden > 0)
												{
													
													$orden = mysql_fetch_assoc($qeryorden);
													
													$norden = $orden['orden'];
													
													$norden = $norden + 1;
													
												}
											else
												{
													
													$norden = 0;
													
													$norden = $norden + 1;
													
												}
											
											//se registra
											$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
											VALUES(".$id_documento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
											$versql = $sql;
											$queryids =  mysql_query($sql,$conn);
											
											//se captura el ultimo id registrado
											$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
											
											$rs = mysql_fetch_assoc($rs);
											
											$idimagen = $rs["id"];
											
											
											
											/////// proceso con encriptación
											
											if ($idimagen > 0)
												{
													$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
													
													if(move_uploaded_file($tmpFilePath, $dir))
														{
															
															encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
															
															unlink($dir);
															
														}
												}
										}
									else
										{
											if ($file_ext == 'zip' or $file_ext == 'ZIP' )
												{
													$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
													
													if(move_uploaded_file($tmpFilePath, $dir))
														{
															
															require_once('manejozip.php');
															
															$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
															
															$destino = $ruta_bodega.$nombreb.'/';
															
															$zip_manager = new Zip_manager();
															
															$resultado = $zip_manager->extraer($archivopadre, $destino);
															
															if ($resultado)
																{
																	$listado = $zip_manager->listar($archivopadre, $destino);
																	
																	$czip = 0;
																	
																	for ($iti = 0; $iti < count($listado); $iti++)
																		{
																			
																			//se verifica cual es el  ultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																			
																			$sql = 'select orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden desc limit 1';
																			
																			$qeryorden =  mysql_query($sql,$conn);
																			
																			$cuantoorden = mysql_num_rows($qeryorden);
																			
																			if ($cuantoorden > 0)
																				{
																					
																					$orden = mysql_fetch_assoc($qeryorden);
																					
																					$norden = $orden['orden'];
																					
																					$norden = $norden + 1;
																					
																				}
																			else
																				{
																					
																					$norden = 0;
																					
																					$norden = $norden + 1;
																					
																				}
																			
																			$czip = $czip + 1;
																			
																			//se separa la extension
																			
																			$extimg = substr(strrchr($listado[$iti], "."),1);
																			
																			$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																			
																			$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																			VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
																			$versql = $sql;
																			$queryids =  mysql_query($sql,$conn);
																			
																			//se captura el ultimo id registrado
																			$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
																			
																			$rs = mysql_fetch_assoc($rs);
																			
																			$idimagen = $rs["id"];
																			
																			//se registra que hay imagenes en la tabla de encriptacion
																			
																			$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																			
																			$queryids =  mysql_query($sql,$conn);
																			
																			if ($idimagen > 0)
																				{
																					
																					//se copia con el id del registro de imagen
																					
																					$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																					
																					$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																					
																					if (copy($fichero, $nuevo_fichero))
																						{
																							$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																							
																							encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																							
																							unlink($dir); //se eliminan los archivos hijos del zip
																							
																							unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																							
																						}
																				}
																		}//fin del for
																	
																	unlink($archivopadre);   //se elimina el archivo zip padre
																}
														}
													else
														{
															
															echo 'no hay';
														}
													
												}
										}
								}
							else 
								{
									if ($configdb[0] == 'pgsql')
										{
											if ($file_ext != 'zip' and $file_ext != 'ZIP' )
												{
													//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
													
													$sql = 'select orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden desc limit 1';
													
													$qeryorden =  pg_query($conn,$sql);
													
													$cuantoorden = pg_num_rows($qeryorden);
													
													if ($cuantoorden > 0)
														{
															
															$orden = pg_fetch_assoc($qeryorden);
															
															$norden = $orden['orden'];
															
															$norden = $norden + 1;
															
														}
													else
														{
															
															$norden = 0;
															
															$norden = $norden + 1;
															
														}
														
														//se registra
														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
														VALUES(".$id_documento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
														
														$queryids = pg_query($conn,$sql);
														
														$resid = pg_fetch_array($queryids);
														
														$idimagen =  $resid[0];
														
														//se registra que hay imagenes en la tabla de encriptacion
														
														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														
														$queryids =  pg_query($conn, $sql);
														
														/////// proceso con encriptación
														
														if ($idimagen > 0)
															{
																$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
																
																if(move_uploaded_file($tmpFilePath, $dir))
																	{
																		
																		encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																		
																		unlink($dir);
																		
																	}
															}
												}	
											else
												{
													if ($file_ext == 'zip' or $file_ext == 'ZIP' )
														{
															$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
															
															if(move_uploaded_file($tmpFilePath, $dir))
																{
																	
																	require_once('manejozip.php');
																	
																	$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																	
																	$destino = $ruta_bodega.$nombreb.'/';
																	
																	$zip_manager = new Zip_manager();
																	
																	$resultado = $zip_manager->extraer($archivopadre, $destino);
																	
																	if ($resultado)
																		{
																			$listado = $zip_manager->listar($archivopadre, $destino);
																			
																			$czip = 0;
																			
																			for ($iti = 0; $iti < count($listado); $iti++)
																				{
																					
																					//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																					
																					$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden asc';
																					
																					$qeryorden =  pg_query($conn,$sql);
																					
																					$qeryorden2 = pg_query($conn,$sql);
																					
																					//$sql1 = "select id_imagendocum from sgd_imagen_documento where id_documento = ".$id_documento;
																					
																					//$cuorden =  sqlsrv_query($conn,$sql1);
																					
																					$cuantoorden = 0;
																					
																					while( $row = pg_fetch_array($qeryorden))
																						{
																							$cuantoorden = $cuantoorden + 1;
																						}
																						
																					if ($cuantoorden > 0)
																						{
																							
																							while( $row =  pg_fetch_array($qeryorden2))
																								{
																									$norden = $row['orden'];
																								}
																								
																							$norden = $norden + 1;
																							
																						}
																					else
																						{
																							
																							$norden = 0;
																							
																							$norden = $norden + 1;
																							
																						}
																					$czip = $czip + 1;
																					
																					//se separa la extension
																					
																					$extimg = substr(strrchr($listado[$iti], "."),1);
																					
																					$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																					
																					$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																																				VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
																					
																					$queryids = pg_query($conn,$sql);
																					
																					$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$id_documento." ORDER BY id_imagendocum desc";
																					
																					$resource = pg_query($conn, $sql);
																					
																					while( $row = pg_fetch_array($resource))
																						{
																							$ultimoid =  $row['id_imagendocum'];
																						}
																					
																					$idimagen =  $ultimoid;
																					
																					//se registra que hay imagenes en la tabla de encriptacion
																					
																					$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																					
																					$queryids =  pg_query($conn, $sql);
																					
																						if ($idimagen > 0)
																							{
																								
																								//se copia con el id del registro de imagen
																								
																								$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																								
																								$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																								
																								if (copy($fichero, $nuevo_fichero))
																									{
																										$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																										
																										encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																										
																										unlink($dir); //se eliminan los archivos hijos del zip
																										
																										unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																										
																									}
																							}
																				}//fin del for
																			
																			unlink($archivopadre);   //se elimina el archivo zip padre
																		}
																}
															else
																{
																	
																	echo 'no hay';
																}
															
														}
												}
										}
									else 
										{
											if (trim($configdb[0]) == 'sqlsrv')   
												{
														
															
														//se registra
														
														if ($file_ext != 'zip' and $file_ext != 'ZIP' )
															{
																//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																
																$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden asc';
																
																$qeryorden =  sqlsrv_query($conn,$sql);
																
																$qeryorden2 = sqlsrv_query($conn,$sql);
																
																//$sql1 = "select id_imagendocum from sgd_imagen_documento where id_documento = ".$id_documento;
																
																//$cuorden =  sqlsrv_query($conn,$sql1);
																
																$cuantoorden = 0;
																
																while( $row = sqlsrv_fetch_array( $qeryorden, SQLSRV_FETCH_ASSOC ))
																	{
																		$cuantoorden = $cuantoorden + 1;
																	}
																
																if ($cuantoorden > 0)
																	{
																		
																		while( $row = sqlsrv_fetch_array( $qeryorden2, SQLSRV_FETCH_ASSOC ))
																			{
																				$norden = $row['orden'];
																			}
																		
																		$norden = $norden + 1;
																		
																	}
																else
																	{
																		
																		$norden = 0;
																		
																		$norden = $norden + 1;
																		
																	}
														
																$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																VALUES(".$id_documento.", '".$nombrear."', '".$file_ext."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
																	
																$queryids = sqlsrv_query($conn,$sql);
																
																$sql ="SELECT TOP 1 id_imagendocum FROM sgd_imagen_documento where id_documento = ".$id_documento."  ORDER BY id_imagendocum desc";
																
																$resource = sqlsrv_query($conn, $sql);
																
																while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																	{
																		$ultimoid =  $row['id_imagendocum'];
																	}
																
																$idimagen = $ultimoid;
																
																/////// proceso con encriptación
																
																if ($idimagen > 0)
																	{
																		$dir = $ruta_bodega.$nombreb."/" . $idimagen.'_.'.$file_ext;
																		
																		if(move_uploaded_file($tmpFilePath, $dir))
																			{
																				
																				encryptFile($idimagen.'_.'.$file_ext,$ruta_bodega.$nombreb,$kweyllave);
																				
																				unlink($dir);
																				
																			}
																	}
																
															}
														else
															{
																if ($file_ext == 'zip' or $file_ext == 'ZIP' )
																	{
																		$dir = $ruta_bodega.$nombreb."/".$nombrear.'.'.$file_ext;
																		
																		if(move_uploaded_file($tmpFilePath, $dir))
																			{
																				
																				require_once('manejozip.php');
																				
																				$archivopadre = $ruta_bodega.$nombreb.'/'.$nombrear.'.'.$file_ext;
																				
																				$destino = $ruta_bodega.$nombreb.'/';
																				
																				$zip_manager = new Zip_manager();
																				
																				$resultado = $zip_manager->extraer($archivopadre, $destino);   
																				
																				if ($resultado)
																					{
																						$listado = $zip_manager->listar($archivopadre, $destino);
																						
																						$czip = 0;
																						
																						for ($iti = 0; $iti < count($listado); $iti++)
																							{
																								
																								//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
																								
																								$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden asc';
																								
																								$qeryorden =  sqlsrv_query($conn,$sql);
																								
																								$qeryorden2 = sqlsrv_query($conn,$sql);
																								
																								//$sql1 = "select id_imagendocum from sgd_imagen_documento where id_documento = ".$id_documento;
																								
																								//$cuorden =  sqlsrv_query($conn,$sql1);
																								
																								$cuantoorden = 0;
																								
																								while( $row = sqlsrv_fetch_array( $qeryorden, SQLSRV_FETCH_ASSOC ))
																									{
																										$cuantoorden = $cuantoorden + 1;
																									}
																								
																								if ($cuantoorden > 0)
																									{
																										
																										while( $row = sqlsrv_fetch_array( $qeryorden2, SQLSRV_FETCH_ASSOC ))
																											{
																												$norden = $row['orden'];
																											}
																										
																										$norden = $norden + 1;
																										
																									}
																								else
																									{
																										
																										$norden = 0;
																										
																										$norden = $norden + 1;
																										
																									}
																								$czip = $czip + 1;
																								
																								//se separa la extension
																								
																								$extimg = substr(strrchr($listado[$iti], "."),1);
																								
																								$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																								
																								$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																								VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
																								
																								$queryids = sqlsrv_query($conn,$sql);
																								
																								$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$id_documento." ORDER BY id_imagendocum desc";
																								
																								$resource = sqlsrv_query($conn, $sql);
																								
																								while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																								{
																									$ultimoid =  $row['id_imagendocum'];
																								}
																								
																								$idimagen =  $ultimoid;
																								
																								//se registra que hay imagenes en la tabla de encriptacion
																								
																								$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																								
																								$queryids =  sqlsrv_query($conn,$sql);
																								
																								if ($idimagen > 0)
																									{
																										
																										//se copia con el id del registro de imagen
																										
																										$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
																										
																										$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
																										
																										if (copy($fichero, $nuevo_fichero))
																											{
																												$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																												
																												encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																												
																												unlink($dir); //se eliminan los archivos hijos del zip
																												
																												unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																												
																											}
																									}
																							}//fin del for
																						
																						unlink($archivopadre);   //se elimina el archivo zip padre
																					}
																			}
																		else
																			{
																				
																				echo 'no hay';
																			}
																	}	
															}	
												}		
											
										}	
									
								}	
						}//fin del for de imagenes?>
						
						<script type="text/javascript">
							var vi = '<?php echo $vi;?>';  
	
							var id_documento = '<?php echo $id_documento;?>';   
	
							var id_expediente = '<?php echo $id_expediente;?>';   
	
							if (vi != 'l' && vi != 'a') //desde listado
								{
						
									window.parent.ejecutarluego(id_expediente);
	
								}
							else
								{
									if (vi == 'a')  //desde busqueda avanzada
										{
											window.parent.grabay(id_documento);
										}
									else
										{	
											window.parent.ejecutarluego(id_documento);
										}	
								}	
						
											
						</script><?php
				}	
			else 
				{
					echo 'errrrrrrr';
				}
			break;
			case 'damedocumentales':

				$idstp = '';

				$node = isset($_GET['id_carpeta']) && $_GET['id_carpeta'] !== '#' ? (int)$_GET['id_carpeta'] : 0;
					
				$sql =" select id_tipodoc from sgd_folders_tipodocs where id_folder = ".$node;
					
				if ($configdb[0] == 'mysql')
					{
	
						$queryids =  mysql_query($sql,$conn);
	
						while($campo2 = mysql_fetch_array($queryids))
							{
								$idstp .= $campo2['id_tipodoc'].'_;_';
							}
	
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
		
								$resuquery = pg_query($conn,$sql);
		
								while($campo2 = pg_fetch_array($resuquery))
									{
										$idstp .= $campo2['id_tipodoc'].'_;_';
									}
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$resuquery = sqlsrv_query($conn,$sql);
										
										while($campo2 = sqlsrv_fetch_array( $resuquery, SQLSRV_FETCH_ASSOC ))
											{
												$idstp .= $campo2['id_tipodoc'].'_;_';
											}
									}	
							}	
					}
					
				echo  $idstp;

				break;
					
			case 'damedocumentalestxt':
				$idstp = ''; 

				$node = isset($_GET['id_carpeta']) && $_GET['id_carpeta'] !== '#' ? (int)$_GET['id_carpeta'] : 0;
				
				$tablaid = isset($_GET['tablaid']) && $_GET['tablaid'] !== '#' ? (int)$_GET['tablaid'] : 0;
				
				$expedid = isset($_GET['expedid']) && $_GET['expedid'] !== '#' ? (int)$_GET['expedid'] : 0;
					
				$sql =" select td.id_tipodoc,td.nombre,td.color from sgd_folders_tipodocs tpd,sgd_tipodocumentales td  where tpd.id_folder = ".$node." and tpd.id_tipodoc = td.id_tipodoc";

				$script = '<ul>';

				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
	
						while($campo2 = mysql_fetch_array($queryids))
							{
		
								$script .= '<li id="tpdoc_'.$campo2['id_tipodoc'].'" class="sombraicono" style="cursor:pointer;color:'.$campo2['color'].'" ><span style="color:#020202" >'.$campo2['nombre'].'</span>&nbsp;&nbsp;<i class="glyphicon glyphicon-th-list sombraicono iconoverde" style="font-size:1.3em;position:relative;float:right" onclick="cargadocumentos('.$campo2['id_tipodoc'].','.$node.','.$tablaid.','.$expedid.')" title="Cargar Documento">&nbsp;</i></li>';
							}
	
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
		
								$resuquery = pg_query($conn,$sql);
		
								while($campo2 = pg_fetch_array($resuquery))
								{
									$script .= '<li id="tpdoc_'.$campo2['id_tipodoc'].'" class="sombraicono" style="cursor:pointer;color:'.$campo2['color'].'" ><span style="color:#020202" >'.$campo2['nombre'].'</span>&nbsp;&nbsp;<i class="glyphicon glyphicon-th-list sombraicono iconoverde" style="font-size:1.3em;position:relative;float:right" onclick="cargadocumentos('.$campo2['id_tipodoc'].','.$node.','.$tablaid.','.$expedid.')" title="Cargar Documento">&nbsp;</i></li>';
								}		
							}
						else 
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$resuquery = sqlsrv_query($conn,$sql);
										
										while($campo2 = sqlsrv_fetch_array( $resuquery, SQLSRV_FETCH_ASSOC ))
											{
												$script .= '<li id="tpdoc_'.$campo2['id_tipodoc'].'" class="sombraicono" style="cursor:pointer;color:'.$campo2['color'].'" ><span style="color:#020202" >'.$campo2['nombre'].'</span>&nbsp;&nbsp;<i class="glyphicon glyphicon-th-list sombraicono iconoverde" style="font-size:1.3em;position:relative;float:right" onclick="cargadocumentos('.$campo2['id_tipodoc'].','.$node.','.$tablaid.','.$expedid.')" title="Cargar Documento">&nbsp;</i></li>';
											}
									}	
							}	
					}
					
				$script .= '</ul>';

				echo $script;

				break;
			case 'dameindicestxt':
				
				$idstp = '';

				$node = isset($_GET['id_carpeta']) && $_GET['id_carpeta'] !== '#' ? (int)$_GET['id_carpeta'] : 0;

				$idtpdoc = isset($_GET['idtpdoc']) && $_GET['idtpdoc'] !== '#' ? (int)$_GET['idtpdoc'] : 0;
					
				$sql =" select i.id_indice,i.nombre from sgd_tipodoc_indices tpi,sgd_indices i  where tpi.id_folder = ".$node." and tpi.id_tipodoc = ".$idtpdoc." and tpi.id_indice = i.id_indice"; //echo $sql;

				$script = '<ul>';

				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
							
						while($campo2 = mysql_fetch_array($queryids))
							{
		
								$script .= '<li id="indice_'.$campo2['id_indice'].'" style="cursor:pointer" >'.utf8_encode($campo2['nombre']).'</li>';
							}
							
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
		
								$resuquery = pg_query($conn,$sql);
		
								while($campo2 = pg_fetch_array($resuquery))
									{
										$script .= '<li id="indice_'.$campo2['id_indice'].'" style="cursor:pointer" >'.utf8_encode($campo2['nombre']).'</li>';
									}		
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$resuquery = sqlsrv_query($conn,$sql);
										
										while($campo2 = sqlsrv_fetch_array( $resuquery, SQLSRV_FETCH_ASSOC ))
											{
												$script .= '<li id="indice_'.$campo2['id_indice'].'" style="cursor:pointer" >'.utf8_encode($campo2['nombre']).'</li>';
											}
									}	
							}	
					}
					
				$script .= '</ul>';

				echo $script;
				
				break;
			case 'dameindicesitems':
				$script = '';
				
				$id_indices = '';
				
				$totalindices = 0;
				
				$node = isset($_GET['id_carpeta']) && $_GET['id_carpeta'] !== '#' ? (int)$_GET['id_carpeta'] : 0;
				
				$idtpdoc = isset($_GET['idtpdoc']) && $_GET['idtpdoc'] !== '#' ? (int)$_GET['idtpdoc'] : 0;
				
				$tablaid = isset($_GET['tablaid']) && $_GET['tablaid'] !== '#' ? (int)$_GET['tablaid'] : 0;
				
				$expedid = isset($_GET['expedid']) && $_GET['expedid'] !== '#' ? (int)$_GET['expedid'] : 0;
				
				$id_documento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
			  //////////////////////////////////////////////////////////	
				unset($vindice);
				unset($vvalor);
				$vindice[]= '';
				$vvalor[] = '';
					
				
				if ($id_documento > 0)
					{
						if ($configdb[0] == 'mysql')
							{
													
								//buscamos los valores de los indices registrados
						
								$sql = "select id_indice,valor from sgd_valorindice where id_documento = ".$id_documento;
						
								$queryids =  mysql_query($sql,$conn);
						
								unset($vindice);
								unset($vvalor);
								while($campo2 = mysql_fetch_assoc($queryids))
									{
										$vindice[] = $campo2['id_indice'];
										$vvalor[] = $campo2['valor'];
									}
								
							}
						else
							{
								if ($configdb[0] == 'pgsql')
									{
										$sql = "select id_indice,valor from sgd_valorindice where id_documento = ".$id_documento;
											
										$queryids = pg_query($conn,$sql);
											
										unset($vindice);
										unset($vvalor);
										while($campo2 = pg_fetch_assoc($queryids))
											{
												$vindice[] = $campo2['id_indice'];
												$vvalor[] = $campo2['valor'];
											}
									}
								else
									{
										if (trim($configdb[0]) == 'sqlsrv')
											{
												$sql = "select id_indice,valor from sgd_valorindice where id_documento = ".$id_documento;
													
												$queryids = sqlsrv_query($conn,$sql);
													
												unset($vindice);
												unset($vvalor);
												
												while($campo2 = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
													{
														$vindice[] = $campo2['id_indice'];
														$vvalor[] = $campo2['valor'];
													}
												
											}	
									}	
							}
					}
				
				
				$sql =" select i.id_indice,i.nombre,tp.nombre as tpnombre,i.delistavalor from sgd_tipodoc_indices tpi,sgd_indices i,sgd_tipoindices tp  where tpi.id_folder = ".$node." and tpi.id_tipodoc = ".$idtpdoc." and tpi.id_indice = i.id_indice and tp.id_tipo = i.id_tipo"; //echo $sql;
				
				$script .= '<table width="100%">';
				
				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
											
						while($campo2 = mysql_fetch_array($queryids))
							{
						
								$totalindices = $totalindices + 1;
								
								$id_indices .= $campo2['id_indice'].'_;_';	
								
								$script .= '<tr>';
								
								if (strtoupper($campo2['tpnombre']) == 'FECHA' or strtoupper($campo2['tpnombre']) == 'DATE')
									{
										$script .= '<div class="form-group">';
										
										$script .= '<label class="col-sm-3 control-label">'.utf8_encode($campo2['nombre']).'</label>';
										
										$script .= '<div class="col-sm-6">';
																				
										if (array_search($campo2['id_indice'], $vindice) > -1)
											{
												
												$ahora = $vvalor[array_search($campo2['id_indice'], $vindice)];
											}
										else 
											{
												$ahora = date("d/m/Y");
											}	
										$script .= '<div class="input-prepend input-group">';
											$script .= '<span class="add-on input-group-addon">';
											$script .= '<i class="glyphicon glyphicon-calendar" style="color:#0094D9"></i>';
											$script .= '</span>';
											$script .= '<input type="text" class="bootstrap-datepicker form-control" value="'.$ahora.'" name="valor[]" data-date-format="mm/dd/yy">';
										$script .= '</div>';
										
										$script .= '</div>';
										
										$script .= '</div>';
									}
								else 
									{
										if (strtoupper($campo2['tpnombre']) == 'LISTA' or strtoupper($campo2['tpnombre']) == 'LIST')
											{
												$delistavalor =  json_decode($campo2['delistavalor'], true); 
												
												if (array_search($campo2['id_indice'], $vindice) > -1)
													{
														$valorindice = $vvalor[array_search($campo2['id_indice'], $vindice)];
													
													}
												else 
													{
														$valorindice = '';
													}	
												$totlineas = count($delistavalor); 
												
												$script .= '<div class="form-group">';
												$script .= '<label class="col-sm-3 control-label">'.utf8_encode($campo2['nombre']).'</label>';
												$script .= '<div class="col-sm-6">';
												$script .= '<select id="lista_'.$campo2['id_indice'].'" name="valor[]" class="form-control">';
												$ctllista = 0;
												for ($ir = 0; $ir <= count($totlineas); $ir++) {
													
													$ctllista = $ctllista + 1;
													if ($valorindice == $delistavalor[$ir])
														{
															$activo = 'selected';
														}
													else 
														{
															$activo = '';
														}
													$script .= '<option value="'.$delistavalor[$ir].'" '.$activo.'>'.$delistavalor[$ir].'</option>';
													
												}
												
												$script .= '</select>';
												
												$script .= '</div>';
													
												$script .= '</div>';
											}
										else 
											{
												$script .= '<div class="form-group">';
												
												$script .= '<label class="col-sm-3 control-label">'.utf8_encode($campo2['nombre']).'</label>';
												
												$script .= '<div class="col-sm-6">';
												
												if (array_search($campo2['id_indice'], $vindice) > -1)
													{
														$valorindice = $vvalor[array_search($campo2['id_indice'], $vindice)];
														
													}	
												else
													{
														$valorindice = '';
													}
													
												$script .= '<input type="text" class="form-control" id="idindice_'.$campo2['id_indice'].'" name="valor[]" value="'.$valorindice.'" placeholder="'.$traduce->traduce('cnodevalorn').' '.utf8_encode($campo2['nombre']).' ">';
													
												$script .= '</div>';
												
												$script .= '</div>';
											}	
									}	
								$script .= '</tr>';
								
							}
					
					}
				else 
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryids = pg_query($conn,$sql);
								
								while($campo2 = pg_fetch_array($queryids))
									{
										
										$totalindices = $totalindices + 1;
										
										$id_indices .= $campo2['id_indice'].'_;_';
										
										$script .= '<tr>';
										
										if (strtoupper($campo2['tpnombre']) == 'FECHA' or strtoupper($campo2['tpnombre']) == 'DATE' )
											{
												$script .= '<div class="form-group">';
											
												$script .= '<label class="col-sm-3 control-label">'.$campo2['nombre'].'</label>';
											
												$script .= '<div class="col-sm-6">';
											
												if (array_search($campo2['id_indice'], $vindice) > -1)
												{
											
													$ahora = $vvalor[array_search($campo2['id_indice'], $vindice)];
												}
												else
												{
													$ahora = date("d/m/Y");
												}
												$script .= '<div class="input-prepend input-group">';
												$script .= '<span class="add-on input-group-addon">';
												$script .= '<i class="glyphicon glyphicon-calendar" style="color:#0094D9"></i>';
												$script .= '</span>';
												$script .= '<input type="text" class="bootstrap-datepicker form-control" value="'.$ahora.'" name="valor[]" data-date-format="mm/dd/yy">';
												$script .= '</div>';
											
												$script .= '</div>';
											
												$script .= '</div>';
											}
										else
											{
												if (strtoupper($campo2['tpnombre']) == 'LISTA' or strtoupper($campo2['tpnombre']) == 'LIST')
													{
														$delistavalor =  json_decode($campo2['delistavalor'], true);
												
														if (array_search($campo2['id_indice'], $vindice) > -1)
															{
																$valorindice = $vvalor[array_search($campo2['id_indice'], $vindice)];
																	
															}
														else
															{
																$valorindice = '';
															}
														$totlineas = count($delistavalor);
												
														$script .= '<div class="form-group">';
														$script .= '<label class="col-sm-3 control-label">'.utf8_encode($campo2['nombre']).'</label>';
														$script .= '<div class="col-sm-6">';
														$script .= '<select id="lista_'.$campo2['id_indice'].'" name="valor[]" class="form-control">';
														$ctllista = 0;
														for ($ir = 0; $ir <= count($totlineas); $ir++) {
																
															$ctllista = $ctllista + 1;
															if ($valorindice == $delistavalor[$ir])
																{
																	$activo = 'selected';
																}
															else
																{
																	$activo = '';
																}
															$script .= '<option value="'.$delistavalor[$ir].'" '.$activo.'>'.$delistavalor[$ir].'</option>';
																
														}
												
														$script .= '</select>';
												
														$script .= '</div>';
															
														$script .= '</div>';
													}
												else
													{
														$script .= '<div class="form-group">';
												
														$script .= '<label class="col-sm-3 control-label">'.$campo2['nombre'].'</label>';
												
														$script .= '<div class="col-sm-6">';
												
														if (array_search($campo2['id_indice'], $vindice) > -1)
															{
																$valorindice = $vvalor[array_search($campo2['id_indice'], $vindice)];
													
															}
														else
															{
																$valorindice = '';
															}
															
														$script .= '<input type="text" class="form-control" id="idindice_'.$campo2['id_indice'].'" name="valor[]" value="'.$valorindice.'" placeholder="'.$traduce->traduce('cnodevalorn').' '.utf8_encode($campo2['nombre']).' ">';
															
														$script .= '</div>';
												
														$script .= '</div>';
													}
											}
										$script .= '</tr>';
										
									}
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										
									$queryids = sqlsrv_query($conn,$sql);
									
									while($campo2 = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
										{
										
											$totalindices = $totalindices + 1;
										
											$id_indices .= $campo2['id_indice'].'_;_';
										
											$script .= '<tr>';
										
											if (strtoupper($campo2['tpnombre']) == 'FECHA' or strtoupper($campo2['tpnombre']) == 'DATE' )
												{
													$script .= '<div class="form-group">';
														
													$script .= '<label class="col-sm-3 control-label">'.$campo2['nombre'].'</label>';
														
													$script .= '<div class="col-sm-6">';
														
													if (array_search($campo2['id_indice'], $vindice) > -1)
														{
																
															$ahora = $vvalor[array_search($campo2['id_indice'], $vindice)];
														}
													else
														{
															$ahora = date("d/m/Y");
														}
													$script .= '<div class="input-prepend input-group">';
													$script .= '<span class="add-on input-group-addon">';
													$script .= '<i class="glyphicon glyphicon-calendar" style="color:#0094D9"></i>';
													$script .= '</span>';
													$script .= '<input type="text" class="bootstrap-datepicker form-control" value="'.$ahora.'" name="valor[]" data-date-format="mm/dd/yy">';
													$script .= '</div>';
														
													$script .= '</div>';
														
													$script .= '</div>';
												}
											else
												{
													if (strtoupper($campo2['tpnombre']) == 'LISTA' or strtoupper($campo2['tpnombre']) == 'LIST')
														{
															$delistavalor =  json_decode($campo2['delistavalor'], true);
												
															if (array_search($campo2['id_indice'], $vindice) > -1)
																{
																	$valorindice = $vvalor[array_search($campo2['id_indice'], $vindice)];
																		
																}
															else
																{
																	$valorindice = '';
																}
															$totlineas = count($delistavalor);
												
															$script .= '<div class="form-group">';
															$script .= '<label class="col-sm-3 control-label">'.utf8_encode($campo2['nombre']).'</label>';
															$script .= '<div class="col-sm-6">';
															$script .= '<select id="lista_'.$campo2['id_indice'].'" name="valor[]" class="form-control">';
															$ctllista = 0;
															for ($ir = 0; $ir <= count($totlineas); $ir++) {
												
																$ctllista = $ctllista + 1;
																if ($valorindice == $delistavalor[$ir])
																	{
																		$activo = 'selected';
																	}
																else
																	{
																		$activo = '';
																	}
																$script .= '<option value="'.$delistavalor[$ir].'" '.$activo.'>'.$delistavalor[$ir].'</option>';
												
															}
												
															$script .= '</select>';
												
															$script .= '</div>';
																
															$script .= '</div>';
														}
													else
														{
															$script .= '<div class="form-group">';
												
															$script .= '<label class="col-sm-3 control-label">'.$campo2['nombre'].'</label>';
												
															$script .= '<div class="col-sm-6">';
												
															if (array_search($campo2['id_indice'], $vindice) > -1)
																{
																	$valorindice = $vvalor[array_search($campo2['id_indice'], $vindice)];
																		
																}
															else
																{
																	$valorindice = '';
																}
																
															$script .= '<input type="text" class="form-control" id="idindice_'.$campo2['id_indice'].'" name="valor[]" value="'.$valorindice.'" placeholder="'.$traduce->traduce('cnodevalorn').' '.utf8_encode($campo2['nombre']).' ">';
																
															$script .= '</div>';
												
															$script .= '</div>';
														}
												}
											$script .= '</tr>';
										
										}
									}	
							}						
					}
				$script .= '<input id="id_indices" type="hidden" name="id_indices" value="'.$id_indices.'">';
				
				$script .= '<input id="totalindices" type="hidden" name="totalindices" value="'.$totalindices.'">';
				
				$script .= '</table>';
				
				echo $script;
			break;	
			case 'dameindicesall':

				$script = '';

				$sql =" select id_indice,nombre from sgd_indices  where id_indice > 0 ";
					
				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
	
						while($campo2 = mysql_fetch_array($queryids))
							{
		
								$script .= '<option id="indice_'.$campo2['id_indice'].'" value="'.$campo2['id_indice'].'">'.utf8_encode($campo2['nombre']).'</option>';
		
							}
	
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
									
								$resuquery = pg_query($conn,$sql);
								 
								while($campo2 = pg_fetch_array($resuquery))
									{
										$script .= '<option id="indice_'.$campo2['id_indice'].'" value="'.$campo2['id_indice'].'">'.utf8_encode($campo2['nombre']).'</option>';
									}
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$resuquery = pg_query($conn,$sql);
											
										while($campo2 = sqlsrv_fetch_array( $resuquery, SQLSRV_FETCH_ASSOC ))
											{
												$script .= '<option id="indice_'.$campo2['id_indice'].'" value="'.$campo2['id_indice'].'">'.utf8_encode($campo2['nombre']).'</option>';
											}
									}	
							}	
					}
				echo $script;

				break;
			case 'dameindices':

				$idsind = '';

				$node = isset($_GET['id_carpeta']) && $_GET['id_carpeta'] !== '#' ? (int)$_GET['id_carpeta'] : 0;
					
				$idtpdoc = isset($_GET['idtpdoc']) && $_GET['idtpdoc'] !== '#' ? (int)$_GET['idtpdoc'] : 0;

				$sql =" select id_indice from sgd_tipodoc_indices where id_folder = ".$node." and id_tipodoc = ".$idtpdoc;

				if ($configdb[0] == 'mysql')
					{
							
						$queryids =  mysql_query($sql,$conn);
							
						while($campo2 = mysql_fetch_array($queryids))
							{
								$idsind .= $campo2['id_indice'].'_;_';
							}
							
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
		
								$resuquery = pg_query($conn,$sql);
		
								while($campo2 = pg_fetch_array($resuquery))
									{
										$idsind .= $campo2['id_indice'].'_;_';
									}
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$resuquery = sqlsrv_query($conn,$sql);
										
										while($campo2 = sqlsrv_fetch_array( $resuquery, SQLSRV_FETCH_ASSOC ))
											{
												$idsind .= $campo2['id_indice'].'_;_';
											}
									}	
							}	
							
					}

				echo  $idsind;

			break;
			case 'idtabla_folder':
			
				$tabfol = '';
				
				$id_documento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$sql =" select id_tabla,id_folder from sgd_documentos where id_documento = ".$id_documento;
				
				if ($configdb[0] == 'mysql')
					{
							
						$queryids =  mysql_query($sql,$conn);
							
						$tabfol = mysql_fetch_assoc($queryids);
						
						$tabfol = $tabfol['id_tabla'].'_;_'.$tabfol['id_folder'];
							
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
						
								$resuquery = pg_query($conn,$sql);
								
								$tabfol = pg_fetch_assoc($resuquery);
						
								$tabfol = $tabfol['id_tabla'].'_;_'.$tabfol['id_folder'];
						
							}
						else 
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$resuquery = sqlsrv_query($conn,$sql);
										
										while($campo2 = sqlsrv_fetch_array( $resuquery, SQLSRV_FETCH_ASSOC ))
											{
												$tabfol = $campo2['id_tabla'].'_;_'.$campo2['id_folder'];
											}
									}	
							}
					}
				
				echo  $tabfol;
				
			break;	
			case 'dlistadatosimg':
				$idexpediente = isset($_GET['id_expediente']) && $_GET['id_expediente'] !== '#' ? (int)$_GET['id_expediente'] : 0;
				
				$iddocumento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$id_tpdocumental = isset($_GET['id_tpdocumental']) && $_GET['id_tpdocumental'] !== '#' ? (int)$_GET['id_tpdocumental'] : 0;
				
				$sql ="select i.id_imagendocum,i.nombre,i.extension,i.id_bodega,i.id_documento,i.orden from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_documento = ".$iddocumento." order by i.orden asc";
				
				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
						
						$numreg = mysql_num_rows($queryids);
							
						//cargo un arreglo con los nombres de las imagenes a trabajar
						
						$lasbodegas = '';
						
						$lasimg = '';
						
						$laext = '';
						
						$lorden = '';
						
						while($campo2 = mysql_fetch_array($queryids))
							{
									
								$lorden .= $campo2['orden'].'_,_';
							
								$lasbodegas .= $campo2['id_bodega'].'_,_';
							
								$lasimg .=  $campo2['id_imagendocum'].'_,_';
									
								$laext .= $campo2['extension'].'_,_';
									
							}
					
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryids = pg_query($conn,$sql);
								
								$numreg = pg_num_rows($queryids);
									
								//cargo un arreglo con los nombres de las imagenes a trabajar
								
								$lasbodegas = '';
								
								$lasimg = '';
								
								$laext = '';
								
								$lorden = '';
								
								while($campo2 = pg_fetch_array($queryids))
									{
											
										$lorden .= $campo2['orden'].'_,_';
										
										$lasbodegas .= $campo2['id_bodega'].'_,_';
										
										$lasimg .=  $campo2['id_imagendocum'].'_,_';
											
										$laext .= $campo2['extension'].'_,_';
											
									}								
							}	
						else 
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$queryids = sqlsrv_query($conn,$sql);
										
										$numreg = sqlsrv_num_rows( $queryids );
											
										//cargo un arreglo con los nombres de las imagenes a trabajar
										
										$lasbodegas = '';
										
										$lasimg = '';
										
										$laext = '';
										
										$lorden = '';
										
										while($campo2 = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC )) 
											{
													
												$lorden .= $campo2['orden'].'_,_';
											
												$lasbodegas .= $campo2['id_bodega'].'_,_';
											
												$lasimg .=  $campo2['id_imagendocum'].'_,_';
													
												$laext .= $campo2['extension'].'_,_';
													
											}
									}	
							}	
					}
				echo $lorden.'_;_'.$lasbodegas.'_;_'.$lasimg.'_;_'.$laext.'_;_';
							
			break;
			
			case 'dameimagenes':
				
				$idexpediente = isset($_GET['id_expediente']) && $_GET['id_expediente'] !== '#' ? (int)$_GET['id_expediente'] : 0;
				
				$iddocumento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$id_tpdocumental = isset($_GET['id_tpdocumental']) && $_GET['id_tpdocumental'] !== '#' ? (int)$_GET['id_tpdocumental'] : 0; 
				
				$permiorden = isset($_GET['permiorden']) && $_GET['permiorden'] !== '#' ? (int)$_GET['permiorden'] : 0;
				
				$permidescarga = isset($_GET['permidescarga']) && $_GET['permidescarga'] !== '#' ? (int)$_GET['permidescarga'] : 0;
				
				$espaciotrabajo = $_REQUEST['workspace']; 
				
				$idusuario = $_SESSION['elidusuario'];
				
				$script = '';
				
				$script .= '<span class="sb-toggle-right glyphicon glyphicon-remove iconoazul actibleind sombraicono" style="position:relative; left:85%;font-size:1.5em;" onclick="cierraderlado()" title="'.$traduce->traduce('ladocerrar').'"></span>';
								
				$sql ="select i.id_imagendocum,i.nombre,i.extension,i.id_bodega,i.id_documento,i.orden from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_documento = ".$iddocumento." order by i.orden asc";
				//echo $sql;
				if ($configdb[0] == 'mysql')  
					{
						$queryids =  mysql_query($sql,$conn);
						
						$conteoimg = 0;
						
						if ($permiorden == 1 )
							{
								
								$script .= '<table border="0" style="position:relative;left:3%" width="100%">';
								$script .= '<tr>';
								$script .= '<td width="30%">';
								if ($permidescarga == true)
									{
										$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a>&nbsp;&nbsp;&nbsp;&nbsp;';
									}
								else
									{
										$script .= '&nbsp;';
									}	
								$script .= '</td>';
								$script .= '<td>&nbsp;&nbsp;&nbsp;';								
								$script .= '<div class="checkbox checkbox-primary" style="width:3%;position:relative;float:left" title="'.$traduce->traduce('chktitordenar').'">';									
								$script .= '<input type="checkbox" id="vordernoarlos" class="habilitados vision"  value="o"/>';
								$script .= '<label for="vordernoarlos" style="width:100%">&nbsp;&nbsp;'.$traduce->traduce('chkordenar').'</label>';									
								$script .= '</div>&nbsp;&nbsp;';
								$script .= '</td>';
								$script .= '</tr>';
								$script .= '</table>';
								$script .= '<br>';
							}
						else
							{
								if ($permidescarga == true)
									{
										$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a><br><br>';
									}	
							}	
						
						
						$script .= '<div class="example-box-wrapper">';
						
						$script .= '<div class="row">';
						
						while($campo2 = mysql_fetch_array($queryids))
							{
								
								//buscamos la bodega respectiva
									
								$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
									
								$queryidimg =  mysql_query($sql,$conn);
									
								$labodega = mysql_fetch_assoc($queryidimg);
								
								if ($campo2['extension'] == 'gif' or $campo2['extension'] == 'tif' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'jpg' or $campo2['extension'] == 'pdf' or $campo2['extension'] == 'tiff' or $campo2['extension'] == 'zip' or $campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
									{
										
										//se verifica que exista en la carperta de visor
										
										if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
											{
												
												inFTP($campo2['id_imagendocum'].'_.'.$campo2['extension'],$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
												
												
												if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
													{
														
														$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
														
														exec($command);
														
														$limagen = $campo2['id_imagendocum'].'_.jpg';
														
													}
												else
													{
														if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
															{
																$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
															}
														else
															{
																if ($campo2['extension'] == 'pdf')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																			{
																				//se copia
																				$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																			}
																	}
																else 
																	{
																		if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																					{
																						//se copia
																						$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																			}	
																	}	
															}
													}
												
												
											}
										else
											{
												if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
													{
														
														if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg'))
															{
																$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																
																exec($command);
																
																$limagen = $campo2['id_imagendocum'].'_.jpg';
															}
														else
															{
																$limagen = $campo2['id_imagendocum'].'_.jpg';
															}
													}
												else
													{
														
														if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
															{
																$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
															}
														else
															{
																if ($campo2['extension'] == 'pdf')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																			{
																				//se copia
																				$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																			}
																	}
																else 
																	{
																		if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																					{
																						//se copia
																						$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																			}	
																	}	
															}
													}
											}
										
										$conteoimg = $conteoimg + 1;
										
										$script .= '<div class="col-md-6 column-sort colsortder scroll">'; //se agrega el scroll infinito
										$script .= '<div class="content-box sombradiv">';
										$script .= '<h3 class="content-box-header bg-primary">';
										$script .= '<span id="num_'.$campo2['id_imagendocum'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'" style="position:relative;float:right;font-size:2em;padding-right:11%" class="iconoblanco sombraiconobl img_listado">'.$conteoimg.'</span><br>';
										$script .= '</h3>';
										$script .= '<div class="content-box-wrapper">';
										
										if ($campo2['extension'] != 'pdf')
											{
												if ($campo2['extension'] != 'zip')
													{
														if ($campo2['extension'] != 'mp4' and $campo2['extension'] != 'm4v' and $campo2['extension'] != 'webm')
															{
																$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" class="kv-preview-data file-preview-image milazi tiraimg"  data-bod="'.$campo2['id_bodega'].'" data-d="'.$campo2['id_documento'].'" data-tp="'.$id_tpdocumental.'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" onclick="zoomimg(this.id,1)"  onmouseover="mostrartabla(this.id)" onmouseout="nomostrartabla(this.id)" data-exp="'.$idexpediente.'" data-original="'.$rutadir.'/expedientes/'.$limagen.'/mostrar" alt="" style="width:auto;height:200px;position:relative;left:3%;cursor:pointer;max-width:90%"><br>';
															}
														else
															{
																if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
																	{
																		$script .= '<video src="'.$limagen.'" width="270" height="240" controls>';
																		$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																		$script .= '</video>';
																	}
															}
													}
												else
													{
														if ($campo2['extension'] == 'zip')
															{
																if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																	{
																		//se copia
																		$fichero = $ruta_bodega.$labodega.'/'.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																		
																		$nuevo_fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																		
																		if (copy($fichero, $nuevo_fichero))
																			{
																				$limagen = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																			}
																		else
																			{
																				$limagen = '';
																			}
																	}
																
																require_once('manejozip.php');
																
																$zip_manager = new Zip_manager();
																
																$archivo_zip = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																
																$listado = $zip_manager->listar($archivo_zip);
																
																//se listan los archivos que contiene
																
																$script .= '<div style="width:250 !important;height:200!important;max-height:300px!important;overflow:auto;" class="scrollable-content scrollable-slim-sidebar">';
																for ($iti = 0; $iti < count($listado); $iti++)
																	{
																		$script .= '<li id="zip_'.$campo2['id_imagendocum'].'_'.($iti+1).'" class="lizip sombraicono" style="max-width:250px;cursor:pointer;" onclick="verzip(this.id)" data-arzip="'.$listado[$iti].'" data-archivopadre="'.$archivo_zip.'"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" data-exp="'.$iddocumento.'">'.$listado[$iti].'</li><br>';
																	}
																$script .= '</div>';
															}
													}
											}
										else
											{
												if ($campo2['extension'] == 'pdf')
													{
														$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="300" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
													}
											}
										$script .= '</div>';
										
										$script .= '</div>';
										$script .= '</div>';
										
										$script .= '</div>';
										
										
									}
							}
						
						$script .= '</div>';
						$script .= '</div>';
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
									$queryids = pg_query($conn,$sql);
										
									$conteoimg = 0;
										
									if ($permiorden == 1 )
										{
										
											$script .= '<table border="0" style="position:relative;left:3%" width="100%">';
											$script .= '<tr>';
											$script .= '<td width="30%">';
											if ($permidescarga == true)
												{
													$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a>&nbsp;&nbsp;&nbsp;&nbsp;';
												}
											else
												{
													$script .= '&nbsp;';
												}
											$script .= '</td>';
											$script .= '<td>&nbsp;&nbsp;&nbsp;';
											$script .= '<div class="checkbox checkbox-primary" style="width:3%;position:relative;float:left" title="'.$traduce->traduce('chktitordenar').'">';
											$script .= '<input type="checkbox" id="vordernoarlos" class="habilitados vision"  value="o"/>';
											$script .= '<label for="vordernoarlos" style="width:100%">&nbsp;&nbsp;'.$traduce->traduce('chkordenar').'</label>';
											$script .= '</div>&nbsp;&nbsp;';
											$script .= '</td>';
											$script .= '</tr>';
											$script .= '</table>';
											$script .= '<br>';
										}
									else
										{
											if ($permidescarga == true)
												{
													$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a><br><br>';
												}
										}
										
										
									$script .= '<div class="example-box-wrapper">';
										
									$script .= '<div class="row">';
										
									while($campo2 = pg_fetch_array($queryids))
									{
										//buscamos la bodega respectiva
										
										$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
									
										$queryidimg =  pg_query($conn,$sql);   
									
										$labodega = pg_fetch_assoc($queryidimg);
									
										if ($campo2['extension'] == 'gif' or $campo2['extension'] == 'tif' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'jpg' or $campo2['extension'] == 'pdf' or $campo2['extension'] == 'tiff' or $campo2['extension'] == 'zip' or $campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
										{
											
											//se verifica que exista en la carperta de visor
											
											if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
												{
													
													inFTP($campo2['id_imagendocum'].'_.'.$campo2['extension'],$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
													
													
													if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
														{
															
															$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
															
															exec($command);
															
															$limagen = $campo2['id_imagendocum'].'_.jpg';
															
														}
													else
														{
															if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																{
																	$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																}
															else
																{
																	if ($campo2['extension'] == 'pdf')
																		{
																			if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																				{
																					mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																				}
																			if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																				{
																					//se copia
																					$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																					$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																					if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																					else
																						{
																							$limagen = '';
																						}
																				}
																			else
																				{
																					$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				}
																		}
																	else
																		{
																			if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v'  or $campo2['extension'] == 'webm')
																				{
																					if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																						{
																							mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																						}
																					if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																						{
																							//se copia
																							$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							
																							$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							
																							if (copy($fichero, $nuevo_fichero))
																								{
																									$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																								}
																							else
																								{
																									$limagen = '';
																								}
																						}
																					else
																						{
																							$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						}
																				}	
																		}	
																}
														}
													
													
												}
											else
												{
													if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
														{
															
															if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg'))
																{
																	$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																	
																	exec($command);
																	
																	$limagen = $campo2['id_imagendocum'].'_.jpg';
																}
															else
																{
																	$limagen = $campo2['id_imagendocum'].'_.jpg';
																}
														}
													else
														{
															
															if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																{
																	$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																}
															else
																{
																	if ($campo2['extension'] == 'pdf')
																		{
																			if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																				{
																					mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																				}
																			if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																				{
																					//se copia
																					$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																					$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																					if (copy($fichero, $nuevo_fichero))
																						{
																							$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						}
																					else
																						{
																							$limagen = '';
																						}
																				}
																			else
																				{
																					$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				}
																		}
																	else
																		{
																			if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v'  or $campo2['extension'] == 'webm')
																				{
																					if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																						{
																							mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																						}
																					if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																						{
																							//se copia
																							$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							
																							$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							
																							if (copy($fichero, $nuevo_fichero))
																								{
																									$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																								}
																							else
																								{
																									$limagen = '';
																								}
																						}
																					else
																						{
																							$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						}
																				}	
																		}	
																}
														}
												}
											
											$conteoimg = $conteoimg + 1;
											
											$script .= '<div class="col-md-6 column-sort colsortder scroll">'; //se agrega el scroll infinito
											$script .= '<div class="content-box sombradiv">';
											$script .= '<h3 class="content-box-header bg-primary">';
											$script .= '<span id="num_'.$campo2['id_imagendocum'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'" style="position:relative;float:right;font-size:2em;padding-right:11%" class="iconoblanco sombraiconobl img_listado">'.$conteoimg.'</span><br>';
											$script .= '</h3>';
											$script .= '<div class="content-box-wrapper">';
											
											if ($campo2['extension'] != 'pdf')
												{
													if ($campo2['extension'] != 'zip') 
														{
															if ($campo2['extension'] != 'mp4' and $campo2['extension'] != 'm4v' and $campo2['extension'] != 'webm')
																{
																	$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" class="kv-preview-data file-preview-image milazi tiraimg"  data-bod="'.$campo2['id_bodega'].'" data-d="'.$campo2['id_documento'].'" data-tp="'.$id_tpdocumental.'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" onclick="zoomimg(this.id,1)"  onmouseover="mostrartabla(this.id)" onmouseout="nomostrartabla(this.id)" data-exp="'.$idexpediente.'" data-original="'.$rutadir.'/expedientes/'.$limagen.'/mostrar" alt="" style="width:auto;height:200px;position:relative;left:3%;cursor:pointer;max-width:90%"><br>';
																}	
															else
																{
																	if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
																		{
																			$script .= '<video src="'.$limagen.'" width="270" height="240" controls>';
																			$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																			$script .= '</video>';
																		}	
																}	
														}
													else
														{
															if ($campo2['extension'] == 'zip')
																{
																	if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																		{
																			//se copia
																			$fichero = $ruta_bodega.$labodega.'/'.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																			
																			$nuevo_fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																			
																			if (copy($fichero, $nuevo_fichero))
																				{
																					$limagen = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				}
																			else
																				{
																					$limagen = '';
																				}
																		}
																	
																	require_once('manejozip.php');
																	
																	$zip_manager = new Zip_manager();
																	
																	$archivo_zip = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']; 
																	
																	$listado = $zip_manager->listar($archivo_zip);
																	
																	//se listan los archivos que contiene
																	
																	$script .= '<div style="width:250 !important;height:200!important;max-height:300px!important;overflow:auto;" class="scrollable-content scrollable-slim-sidebar">';
																	for ($iti = 0; $iti < count($listado); $iti++)
																		{
																			$script .= '<li id="zip_'.$campo2['id_imagendocum'].'_'.($iti+1).'" class="lizip sombraicono" style="max-width:250px;cursor:pointer;" onclick="verzip(this.id)" data-arzip="'.$listado[$iti].'" data-archivopadre="'.$archivo_zip.'"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" data-exp="'.$iddocumento.'">'.$listado[$iti].'</li><br>';
																		}
																	$script .= '</div>';
																}
														}
												}
											else
												{
													if ($campo2['extension'] == 'pdf')
														{
															$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="300" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
														}	
												}
											$script .= '</div>';
											
											$script .= '</div>';
											$script .= '</div>';
											
											$script .= '</div>';
											
											
										}
									
									}
									$script .='</div>';
									
									$script .='</div>';
								}
							else
								{
									if (trim($configdb[0]) == 'sqlsrv')
										{
												$queryids = sqlsrv_query($conn,$sql);
												
												$conteoimg = 0;
												
												if ($permiorden == 1 )
													{
															
														$script .= '<table border="0" style="position:relative;left:3%" width="100%">';
														$script .= '<tr>';
														$script .= '<td width="30%">';
														if ($permidescarga == true)
															{
																$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a>&nbsp;&nbsp;&nbsp;&nbsp;';
															}
														else
															{
																$script .= '&nbsp;';
															}
														$script .= '</td>';
														$script .= '<td>&nbsp;&nbsp;&nbsp;';
														$script .= '<div class="checkbox checkbox-primary" style="width:3%;position:relative;float:left" title="'.$traduce->traduce('chktitordenar').'">';
														$script .= '<input type="checkbox" id="vordernoarlos" class="habilitados vision"  value="o"/>';
														$script .= '<label for="vordernoarlos" style="width:100%">&nbsp;&nbsp;'.$traduce->traduce('chkordenar').'</label>';
														$script .= '</div>&nbsp;&nbsp;';
														$script .= '</td>';
														$script .= '</tr>';
														$script .= '</table>';
														$script .= '<br>';
													}
												else
													{
														if ($permidescarga == true)
															{
																$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a><br><br>';
															}
													}
												
												
												$script .= '<div class="example-box-wrapper">';
												
												$script .= '<div class="row">';
												
												while($campo2 = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC )) 
													{
														//buscamos la bodega respectiva
															
														$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
															
														$queryidimg =  sqlsrv_query($conn,$sql);   
														
														while($campob = sqlsrv_fetch_array( $queryidimg, SQLSRV_FETCH_ASSOC ))
															{
																$labodega = $campob['nombre'];
															}	
															
															
															if ($campo2['extension'] == 'gif' or $campo2['extension'] == 'tif' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'jpg' or $campo2['extension'] == 'pdf' or $campo2['extension'] == 'tiff' or $campo2['extension'] == 'zip' or $campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
																{
																		
																	//se verifica que exista en la carperta de visor
															
																	if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																		{   
																																				
																			inFTP($campo2['id_imagendocum'].'_.'.$campo2['extension'],$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
																			
																					 
																					if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
																						{
																								
																							$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';  
																								
																							exec($command);
																								
																							$limagen = $campo2['id_imagendocum'].'_.jpg';
																								
																						}
																					else
																						{	
																							if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																								{
																									$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																								}
																							else
																								{
																									if ($campo2['extension'] == 'pdf')
																										{
																											if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																												{
																													mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																												}
																											if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																												{
																													//se copia
																													$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																													$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																													if (copy($fichero, $nuevo_fichero))
																														{
																															$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																														}
																													else
																														{
																															$limagen = '';
																														}
																												}
																											else
																													{
																														$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																													}
																										}
																									else 
																										{
																											if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v'  or $campo2['extension'] == 'webm')
																												{
																													if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																														{
																															mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																														}
																													if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																														{
																															//se copia
																															$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																															
																															$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																															
																															if (copy($fichero, $nuevo_fichero))
																																{
																																	$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																																}
																															else
																																{
																																	$limagen = '';
																																}
																														}
																													else
																														{
																															$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																														}
																												}	
																										}	
																								}																		
																						}
																				
																				
																		}
																	else
																	{		
																		if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
																			{
																					
																				if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg'))
																					{
																						$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																				
																						exec($command);
																				
																						$limagen = $campo2['id_imagendocum'].'_.jpg';
																					}
																				else
																					{
																						$limagen = $campo2['id_imagendocum'].'_.jpg';
																					}
																			}
																		else
																			{
																
																				if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																					{
																						$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																				else
																					{
																						if ($campo2['extension'] == 'pdf')
																							{
																								if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																									{
																										mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																									}
																								if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																									{
																										//se copia
																										$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																											
																										$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																											
																										if (copy($fichero, $nuevo_fichero))
																											{
																												$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																											}
																										else
																											{
																												$limagen = '';
																											}
																									}
																								else
																									{
																										$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																									}
																							}
																						else
																							{
																								if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v'  or $campo2['extension'] == 'webm')
																									{
																										if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																											{
																												mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																											}
																										if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																											{
																												//se copia
																												$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																												
																												$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																												
																												if (copy($fichero, $nuevo_fichero))
																													{
																														$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																													}
																												else
																													{
																														$limagen = '';
																													}
																											}
																										else
																											{
																												$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																											}
																									}	
																							}	
																					}
																			}
																	}
																		
																	$conteoimg = $conteoimg + 1;
															
																	$script .= '<div class="col-md-6 column-sort colsortder scroll">'; //se agrega el scroll infinito
																	$script .= '<div class="content-box sombradiv">';
																	$script .= '<h3 class="content-box-header bg-primary">';
																	$script .= '<span id="num_'.$campo2['id_imagendocum'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'" style="position:relative;float:right;font-size:2em;padding-right:11%" class="iconoblanco sombraiconobl img_listado">'.$conteoimg.'</span><br>';
																	$script .= '</h3>';
																	$script .= '<div class="content-box-wrapper">';
																	
																	if ($campo2['extension'] != 'pdf')
																	{
																		if ($campo2['extension'] != 'zip')
																			{
																				if ($campo2['extension'] != 'mp4' and $campo2['extension'] != 'm4v' and $campo2['extension'] != 'webm')
																					{
																						$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" class="kv-preview-data file-preview-image milazi tiraimg"  data-bod="'.$campo2['id_bodega'].'" data-d="'.$campo2['id_documento'].'" data-tp="'.$id_tpdocumental.'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" onclick="zoomimg(this.id,1)"  onmouseover="mostrartabla(this.id)" onmouseout="nomostrartabla(this.id)" data-exp="'.$idexpediente.'" data-original="'.$rutadir.'/expedientes/'.$limagen.'/mostrar" alt="" style="width:auto;height:200px;position:relative;left:3%;cursor:pointer;max-width:90%"><br>';
																					}
																				else
																					{
																						if ($campo2['extension'] == 'mp4' or $campo2['extension'] == 'm4v' or $campo2['extension'] == 'webm')
																							{
																								$script .= '<video src="'.$limagen.'" width="270" height="240" controls>';
																								$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																								$script .= '</video>';
																							}
																					}
																			}
																		else
																			{
																				if ($campo2['extension'] == 'zip')
																					{
																						if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																							{
																								//se copia
																								$fichero = $ruta_bodega.$labodega.'/'.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																								
																								$nuevo_fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																								
																								if (copy($fichero, $nuevo_fichero))
																									{
																										$limagen = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																									}
																								else
																									{
																										$limagen = '';
																									}
																							}
																						
																						require_once('manejozip.php');
																						
																						$zip_manager = new Zip_manager();
																						
																						$archivo_zip = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						$listado = $zip_manager->listar($archivo_zip);
																						
																						//se listan los archivos que contiene
																						
																						$script .= '<div style="width:250 !important;height:200!important;max-height:300px!important;overflow:auto;" class="scrollable-content scrollable-slim-sidebar">';
																						for ($iti = 0; $iti < count($listado); $iti++)
																							{
																								$script .= '<li id="zip_'.$campo2['id_imagendocum'].'_'.($iti+1).'" class="lizip sombraicono" style="max-width:250px;cursor:pointer;" onclick="verzip(this.id)" data-arzip="'.$listado[$iti].'" data-archivopadre="'.$archivo_zip.'"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" data-exp="'.$iddocumento.'">'.$listado[$iti].'</li><br>';
																							}
																						$script .= '</div>';
																					}
																				}
																		}
																	else
																		{
																			if ($campo2['extension'] == 'pdf')
																				{
																					$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="300" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
																				}
																		}
																	$script .= '</div>';
																	
																	$script .= '</div>';
																	$script .= '</div>';
																	
																	$script .= '</div>';
																		
																		
																}
																									
															
													}
												$script .='</div>';
													
												$script .='</div>';
										}	
								}	
					}	
				echo $script;
			break;	
			
			case 'dameimagenesdoc':
				$iddocumento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$permiorden = isset($_GET['permiorden']) && $_GET['permiorden'] !== '#' ? (int)$_GET['permiorden'] : 0;
				
				$permidescarga = isset($_GET['permidescarga']) && $_GET['permidescarga'] !== '#' ? (int)$_GET['permidescarga'] : 0; 
								
				$espaciotrabajo = $_REQUEST['workspace']; //$_SESSION['espaciotrabajo'];
				
				$idusuario = $_SESSION['elidusuario'];
			
				$sql ="select i.id_imagendocum,i.nombre,i.extension,i.id_bodega,i.id_documento,i.orden from sgd_imagen_documento i where i.id_documento = ".$iddocumento." order by i.orden asc";
				
				$script = '';  //echo $sql;
				
				$script .= '<span class="sb-toggle-right glyphicon glyphicon-remove iconoazul actibleind sombraicono" style="position:relative; left:85%;font-size:1.5em;" onclick="cierraderlado()" title="'.$traduce->traduce('ladocerrar').'"></span>';
			
				if ($configdb[0] == 'mysql')
					{
						
						$queryids =  mysql_query($sql,$conn);
						
						$conteoimg = 0;
						
						if ($permiorden == 1 )
							{
								
								$script .= '<table border="0" style="position:relative;left:3%" width="100%">';
								$script .= '<tr>';
								$script .= '<td width="30%">';
								if ($permidescarga == true)
									{
										$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a>&nbsp;&nbsp;&nbsp;&nbsp;';
									}
								else
									{
										$script .= '&nbsp;';
									}
								$script .= '</td>';
								$script .= '<td>&nbsp;&nbsp;&nbsp;';
								$script .= '<div class="checkbox checkbox-primary" style="width:3%;position:relative;float:left" title="'.$traduce->traduce('chktitordenar').'">';
								$script .= '<input type="checkbox" id="vordernoarlos" class="habilitados vision"  value="o"/>';
								$script .= '<label for="vordernoarlos" style="width:100%">&nbsp;&nbsp;'.$traduce->traduce('chkordenar').'</label>';
								$script .= '</div>&nbsp;&nbsp;';
								$script .= '</td>';
								$script .= '</tr>';
								$script .= '</table>';
								$script .= '<br>';
							}
						else
							{
								if ($permidescarga == true)
									{
										$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a><br><br>';
									}
							}
						
						
						$script .= '<div class="example-box-wrapper">';
						
						$script .= '<div class="row">';
						
						while($campo2 = mysql_fetch_array($queryids))
							{
								//buscamos la bodega respectiva
								
								$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
								
								$queryidimg =  mysql_query($sql,$conn);
								
								$labodega = mysql_fetch_assoc($queryidimg);
								
								if ($campo2['extension'] == 'gif' or $campo2['extension'] == 'tif' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'jpg' or $campo2['extension'] == 'pdf'  or $campo2['extension'] == 'tiff' or $campo2['extension'] == 'zip')
									{
										
										//se verifica que exista en la carperta de visor
										
										if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
											{
												
												//con encriptación
												
												if ($campo2['extension'] != 'zip' )
													{
														
														inFTP($campo2['id_imagendocum'].'_.'.$campo2['extension'],$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
														
														if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
															{
																
																$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																
																exec($command);
																
																$limagen = $campo2['id_imagendocum'].'_.jpg';
																
															}
														else
															{
																if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																{
																	$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																}
																else
																	{
																		if ($campo2['extension'] == 'pdf')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																					{
																						//se copia
																						$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																			}
																	}
															}
													}
												
											}
										else
											{
												if ($campo2['extension'] != 'zip' )
													{
														if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
															{
																
																if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg'))
																	{
																		//$script .= 'no existe';
																		
																		$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																		
																		$script .= $command;
																		
																		exec($command);
																		
																		$limagen = $campo2['id_imagendocum'].'_.jpg';
																		
																		//$script .= $limagen;
																	}
																else
																	{
																		//$script .= 'si existe';
																		
																		$limagen = $campo2['id_imagendocum'].'_.jpg';
																		
																		//$script .= $limagen;
																	}
															}
														else
															{
																
																if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																	{
																		$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																	}
																else
																	{
																		if ($campo2['extension'] == 'pdf')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																					{
																						//se copia
																						$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					}
																			}
																	}
															}
														
														//$script .= 'existe: '.file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg');
														
													}
												else
													{
														//
														
													}
											}
										
										$conteoimg = $conteoimg + 1;
										
										$script .= '<div class="col-md-6 column-sort colsortder scroll">'; //se agrega el scroll infinito
										$script .= '<div class="content-box sombradiv" style="max-height:400px;">';
										$script .= '<h3 class="content-box-header bg-primary">';
										$script .= '<span id="num_'.$campo2['id_imagendocum'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'" style="position:relative;float:right;font-size:2em;padding-right:11%" class="iconoblanco sombraiconobl img_listado">'.$conteoimg.'</span><br>';
										$script .= '</h3>';
										$script .= '<div class="content-box-wrapper">';
										if ($campo2['extension'] != 'pdf' and $campo2['extension'] != 'zip') //$_SESSION['espaciotrabajo']
											{
												$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" class="kv-preview-data file-preview-image milazi tiraimg"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" onclick="zoomimg(this.id,1)"  data-este="sami" onmouseover="mostrartabla(this.id)" onmouseout="nomostrartabla(this.id)" data-exp="'.$iddocumento.'" data-original="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" alt="" style="width:auto;height:200px;position:relative;left:3%;cursor:pointer;max-width:90%"><br>';
											}
										else
											{
												if ($campo2['extension'] != 'zip')
													{
														$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="300" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';   //$_SESSION['espaciotrabajo']
													}
												else
													{
														if ($campo2['extension'] == 'zip')
															{
																
																if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																	{
																		//se copia
																		$fichero = $ruta_bodega.$labodega.'/'.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																		
																		$nuevo_fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																		
																		if (copy($fichero, $nuevo_fichero))
																			{
																				$limagen = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																			}
																		else
																			{
																				$limagen = '';
																			}
																	}
																
																require_once('manejozip.php');
																
																$zip_manager = new Zip_manager();
																
																$archivo_zip = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']; //"prueba1.zip";
																
																$listado = $zip_manager->listar($archivo_zip);
																
																//se listan los archivos que contiene
																
																$script .= '<div style="width:250 !important;height:200!important;max-height:300px!important;overflow:auto;" class="scrollable-content scrollable-slim-sidebar">';
																for ($iti = 0; $iti < count($listado); $iti++)
																	{
																		$script .= '<li id="zip_'.$campo2['id_imagendocum'].'_'.($iti+1).'" class="lizip sombraicono" style="max-width:250px;cursor:pointer;" onclick="verzip(this.id)" data-arzip="'.$listado[$iti].'" data-archivopadre="'.$archivo_zip.'"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" data-exp="'.$iddocumento.'">'.$listado[$iti].'</li><br>';
																	}
																$script .= '</div>';
																
															}
													}
											}
										$script .= '</div>';
										$script .= '</div>';
										
										$script .= '</div>';
										
									}
								
							}
						$script .='</div>';
						
						$script .='</div>';
					}
				else
					{
							if ($configdb[0] == 'pgsql')
								{
									$queryids = pg_query($conn,$sql);
									
									$conteoimg = 0;
									
									if ($permiorden == 1 )
										{
											
											$script .= '<table border="0" style="position:relative;left:3%" width="100%">';
											$script .= '<tr>';
											$script .= '<td width="30%">';
											if ($permidescarga == true)
											{
												$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a>&nbsp;&nbsp;&nbsp;&nbsp;';
											}
											else
											{
												$script .= '&nbsp;';
											}
											$script .= '</td>';
											$script .= '<td>&nbsp;&nbsp;&nbsp;';
											$script .= '<div class="checkbox checkbox-primary" style="width:3%;position:relative;float:left" title="'.$traduce->traduce('chktitordenar').'">';
											$script .= '<input type="checkbox" id="vordernoarlos" class="habilitados vision"  value="o"/>';
											$script .= '<label for="vordernoarlos" style="width:100%">&nbsp;&nbsp;'.$traduce->traduce('chkordenar').'</label>';
											$script .= '</div>&nbsp;&nbsp;';
											$script .= '</td>';
											$script .= '</tr>';
											$script .= '</table>';
											$script .= '<br>';
										}
									else
										{
											if ($permidescarga == true)
												{
													$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a><br><br>';
												}
										}
									
									
									$script .= '<div class="example-box-wrapper">';
									
									$script .= '<div class="row">';
									
									while($campo2 = pg_fetch_array($queryids))
										{
											//buscamos la bodega respectiva
											
											$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
											
											$queryidimg =  pg_query($conn,$sql);   //pg_query($conn,$sql);
											
											$labodega = pg_fetch_assoc($queryidimg);
											
											if ($campo2['extension'] == 'gif' or $campo2['extension'] == 'tif' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'jpg' or $campo2['extension'] == 'pdf'  or $campo2['extension'] == 'tiff' or $campo2['extension'] == 'zip')
												{
													
													//se verifica que exista en la carperta de visor
													
													if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
														{
															
															//con encriptación
															
															if ($campo2['extension'] != 'zip' )
																{
																	
																	inFTP($campo2['id_imagendocum'].'_.'.$campo2['extension'],$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
																	
																	if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
																		{
																			
																			$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																			
																			exec($command);
																			
																			$limagen = $campo2['id_imagendocum'].'_.jpg';
																			
																		}
																	else
																		{
																			if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																				{
																					$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				}
																			else
																				{
																					if ($campo2['extension'] == 'pdf')
																						{
																							if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																								{
																									mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																								}
																							if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																								{
																									//se copia
																									$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																									
																									$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																									
																									if (copy($fichero, $nuevo_fichero))
																										{
																											$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																										}
																									else
																										{
																											$limagen = '';
																										}
																								}
																							else
																								{
																									$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																								}
																						}
																				}
																		}
																}
															
														}
													else
														{
															if ($campo2['extension'] != 'zip' )
																{
																	if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
																		{
																			
																			if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg'))
																				{
																					//$script .= 'no existe';
																					
																					$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																					
																					$script .= $command;
																					
																					exec($command);
																					
																					$limagen = $campo2['id_imagendocum'].'_.jpg';
																					
																					//$script .= $limagen;
																				}
																			else
																				{
																					//$script .= 'si existe';
																					
																					$limagen = $campo2['id_imagendocum'].'_.jpg';
																					
																					//$script .= $limagen;
																				}
																		}
																	else
																		{
																			
																			if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
																				{
																					$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																				}
																			else
																				{
																					if ($campo2['extension'] == 'pdf')
																						{
																							if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																								{
																									mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																								}
																							if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																								{
																									//se copia
																									$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																									
																									$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																									
																									if (copy($fichero, $nuevo_fichero))
																										{
																											$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																										}
																									else
																										{
																											$limagen = '';
																										}
																								}
																							else
																								{
																									$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																								}
																						}
																				}
																		}
																	
																	//$script .= 'existe: '.file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg');
																	
																}
															else
																{
																	//
																	
																}
														}
													
													$conteoimg = $conteoimg + 1;
													
													$script .= '<div class="col-md-6 column-sort colsortder scroll">'; //se agrega el scroll infinito
													$script .= '<div class="content-box sombradiv" style="max-height:400px;">';
													$script .= '<h3 class="content-box-header bg-primary">';
													$script .= '<span id="num_'.$campo2['id_imagendocum'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'" style="position:relative;float:right;font-size:2em;padding-right:11%" class="iconoblanco sombraiconobl img_listado">'.$conteoimg.'</span><br>';
													$script .= '</h3>';
													$script .= '<div class="content-box-wrapper">';
													if ($campo2['extension'] != 'pdf' and $campo2['extension'] != 'zip') //$_SESSION['espaciotrabajo']
														{
															$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" class="kv-preview-data file-preview-image milazi tiraimg"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" onclick="zoomimg(this.id,1)"  data-este="sami" onmouseover="mostrartabla(this.id)" onmouseout="nomostrartabla(this.id)" data-exp="'.$iddocumento.'" data-original="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" alt="" style="width:auto;height:200px;position:relative;left:3%;cursor:pointer;max-width:90%"><br>';
														}
													else
														{
															if ($campo2['extension'] != 'zip')
																{
																	$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="300" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';   //$_SESSION['espaciotrabajo']
																}
															else
																{
																	if ($campo2['extension'] == 'zip')
																		{
																			
																			if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
																				{
																					//se copia
																					$fichero = $ruta_bodega.$labodega.'/'.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																					$nuevo_fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																					
																					if (copy($fichero, $nuevo_fichero))
																						{
																							$limagen = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
																						}
																					else
																						{
																							$limagen = '';
																						}
																				}
																			
																			require_once('manejozip.php');
																			
																			$zip_manager = new Zip_manager();
																			
																			$archivo_zip = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']; //"prueba1.zip";
																			
																			$listado = $zip_manager->listar($archivo_zip);
																			
																			//se listan los archivos que contiene
																			
																			$script .= '<div style="width:250 !important;height:200!important;max-height:300px!important;overflow:auto;" class="scrollable-content scrollable-slim-sidebar">';
																			for ($iti = 0; $iti < count($listado); $iti++)
																				{
																					$script .= '<li id="zip_'.$campo2['id_imagendocum'].'_'.($iti+1).'" class="lizip sombraicono" style="max-width:250px;cursor:pointer;" onclick="verzip(this.id)" data-arzip="'.$listado[$iti].'" data-archivopadre="'.$archivo_zip.'"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" data-exp="'.$iddocumento.'">'.$listado[$iti].'</li><br>';
																				}
																			$script .= '</div>';
																			
																		}
																}
														}
													$script .= '</div>';
													$script .= '</div>';
													
													$script .= '</div>';
													
												}
											
										}
									$script .='</div>';
									
									$script .='</div>';
								}
						 else 
						 	{
						 		if (trim($configdb[0]) == 'sqlsrv')
						 			{
							 				$queryids = sqlsrv_query($conn,$sql);
							 				
							 				$conteoimg = 0;
							 				
							 				if ($permiorden == 1 )
								 				{
								 						
								 					$script .= '<table border="0" style="position:relative;left:3%" width="100%">';
								 					$script .= '<tr>';
								 					$script .= '<td width="30%">';
								 					if ($permidescarga == true)
									 					{
									 						$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a>&nbsp;&nbsp;&nbsp;&nbsp;';
									 					}
								 					else
									 					{
									 						$script .= '&nbsp;';
									 					}
								 					$script .= '</td>';
								 					$script .= '<td>&nbsp;&nbsp;&nbsp;';
								 					$script .= '<div class="checkbox checkbox-primary" style="width:3%;position:relative;float:left" title="'.$traduce->traduce('chktitordenar').'">';
								 					$script .= '<input type="checkbox" id="vordernoarlos" class="habilitados vision"  value="o"/>';
								 					$script .= '<label for="vordernoarlos" style="width:100%">&nbsp;&nbsp;'.$traduce->traduce('chkordenar').'</label>';
								 					$script .= '</div>&nbsp;&nbsp;';
								 					$script .= '</td>';
								 					$script .= '</tr>';
								 					$script .= '</table>';
								 					$script .= '<br>';
								 				}
							 				else
								 				{
								 					if ($permidescarga == true)
									 					{
									 						$script .= '<a id="todo" href="javascript:;" onclick="zoomtodo()" class="sombraicono">'.$traduce->traduce('traddescargartodo').'</a><br><br>';
									 					}
								 				}
							 				
							 				
							 				$script .= '<div class="example-box-wrapper">';
							 				
							 				$script .= '<div class="row">';
							 				
							 				while( $campo2 = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC) ) 
							 				{
							 					//buscamos la bodega respectiva
							 						
							 					$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
							 						
							 					$queryidimg =  sqlsrv_query($conn,$sql);  
							 					
							 					while( $row = sqlsrv_fetch_array( $queryidimg, SQLSRV_FETCH_ASSOC ))
								 					{
								 						$labodega =  $row['nombre'];
								 					}
							 													 						
								 					if ($campo2['extension'] == 'gif' or $campo2['extension'] == 'tif' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'jpg' or $campo2['extension'] == 'pdf'  or $campo2['extension'] == 'tiff' or $campo2['extension'] == 'zip')
								 					{
								 					
								 						//se verifica que exista en la carperta de visor
								 					
								 						if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
								 						{
								 					
								 							//con encriptación
								 							
								 							
								 					
								 							if ($campo2['extension'] != 'zip' )
								 							{
								 					
								 								inFTP($campo2['id_imagendocum'].'_.'.$campo2['extension'],$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
								 									
								 								if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
								 								{
								 					
								 									$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
								 					
								 									exec($command);
								 					
								 									$limagen = $campo2['id_imagendocum'].'_.jpg';
								 					
								 								}
								 								else
								 								{
								 									if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
								 									{
								 										$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 									}
								 									else
								 									{
								 										if ($campo2['extension'] == 'pdf')
								 										{
								 											if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
								 											{
								 												mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
								 											}
								 											if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
								 											{
								 												//se copia
								 												$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 					
								 												$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 													
								 												if (copy($fichero, $nuevo_fichero))
								 												{
								 													$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 												}
								 												else
								 												{
								 													$limagen = '';
								 												}
								 											}
								 											else
								 											{
								 												$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 											}
								 										}
								 									}
								 								}
								 							}
								 					
								 						}
								 						else
								 						{
								 							if ($campo2['extension'] != 'zip' )
								 							{
								 								if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
								 								{
								 										
								 									if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg'))
									 									{
									 										//$script .= 'no existe';
									 										
									 										$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
									 										
									 										$script .= $command;
									 					
									 										exec($command);
									 					
									 										$limagen = $campo2['id_imagendocum'].'_.jpg';
									 										
									 										//$script .= $limagen;
									 									}
								 									else
									 									{
									 										//$script .= 'si existe';
									 										
									 										$limagen = $campo2['id_imagendocum'].'_.jpg';
									 										
									 										//$script .= $limagen;
									 									}
								 								}
								 								else
								 								{
								 										
								 									if ($campo2['extension'] == 'jpg' or $campo2['extension'] == 'png' or $campo2['extension'] == 'bmp' or $campo2['extension'] == 'gif')
								 									{
								 										$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 									}
								 									else
								 									{
								 										if ($campo2['extension'] == 'pdf')
								 										{
								 											if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
								 											{
								 												mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
								 											}
								 											if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension']))
								 											{
								 												//se copia
								 												$fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 					
								 												$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 					
								 												if (copy($fichero, $nuevo_fichero))
								 												{
								 													$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 												}
								 												else
								 												{
								 													$limagen = '';
								 												}
								 											}
								 											else
								 											{
								 												$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$campo2['id_imagendocum'].'_.'.$campo2['extension'];
								 											}
								 										}
								 									}
								 								}
								 								
								 								//$script .= 'existe: '.file_exists($ruta_temp.$campo2['id_imagendocum'].'_.jpg');
								 								
								 							}
								 							else
								 							{
								 								//
								 								
								 							}
								 						}
								 							
								 						$conteoimg = $conteoimg + 1;
								 							
								 						$script .= '<div class="col-md-6 column-sort colsortder scroll">'; //se agrega el scroll infinito
								 						$script .= '<div class="content-box sombradiv" style="max-height:400px;">';
								 						$script .= '<h3 class="content-box-header bg-primary">';
								 						$script .= '<span id="num_'.$campo2['id_imagendocum'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'" style="position:relative;float:right;font-size:2em;padding-right:11%" class="iconoblanco sombraiconobl img_listado">'.$conteoimg.'</span><br>';
								 						$script .= '</h3>';
								 						$script .= '<div class="content-box-wrapper">';
								 						if ($campo2['extension'] != 'pdf' and $campo2['extension'] != 'zip') //$_SESSION['espaciotrabajo'] 
								 						{
								 							$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" class="kv-preview-data file-preview-image milazi tiraimg"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" onclick="zoomimg(this.id,1)"  data-este="sami" onmouseover="mostrartabla(this.id)" onmouseout="nomostrartabla(this.id)" data-exp="'.$iddocumento.'" data-original="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" alt="" style="width:auto;height:200px;position:relative;left:3%;cursor:pointer;max-width:90%"><br>';
								 						}
								 						else
								 						{
								 							if ($campo2['extension'] != 'zip')
								 							{
								 								$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="300" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';//$_SESSION['espaciotrabajo']
								 							}
								 							else
								 							{
								 								if ($campo2['extension'] == 'zip')
								 								{
								 									
								 										if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
									 										{
									 											//se copia
									 											$fichero = $ruta_bodega.$labodega.'/'.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
									 										
									 											$nuevo_fichero = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
									 										
									 											if (copy($fichero, $nuevo_fichero))
										 											{
										 												$limagen = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'];
										 											}
									 											else
										 											{
										 												$limagen = '';
										 											}
									 										}
									 										
								 										require_once('manejozip.php');
								 									
								 										$zip_manager = new Zip_manager();
								 									
								 										$archivo_zip = $ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']; //"prueba1.zip";
								 																		 									
								 										$listado = $zip_manager->listar($archivo_zip); 
								 										
								 										//se listan los archivos que contiene
								 										
								 										$script .= '<div style="width:250 !important;height:200!important;max-height:300px!important;overflow:auto;" class="scrollable-content scrollable-slim-sidebar">';
								 										for ($iti = 0; $iti < count($listado); $iti++) 
								 											{
								 												$script .= '<li id="zip_'.$campo2['id_imagendocum'].'_'.($iti+1).'" class="lizip sombraicono" style="max-width:250px;cursor:pointer;" onclick="verzip(this.id)" data-arzip="'.$listado[$iti].'" data-archivopadre="'.$archivo_zip.'"  data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" data-exp="'.$iddocumento.'">'.$listado[$iti].'</li><br>';
								 											}
								 									     $script .= '</div>';
								 									
								 								}
								 							}
								 						}
								 						$script .= '</div>';
								 						$script .= '</div>';
								 							
								 						$script .= '</div>';
								 					
								 					}
								 						
								 					}
								 					$script .='</div>';
								 						
								 					$script .='</div>';
						 			}	
						 	}	
					}
				echo $script;
			break;
			case 'ordena_imagenes':
				$id_documento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$idsimg = json_decode(stripslashes($_GET['idsimg']));
				
				$totorden = count($idsimg);
				
				$ordenn = 0;
				
				for ($i = 0; $i < $totorden; $i++) {
					
					$ordenn = $ordenn + 1;
					
					$sql ="UPDATE sgd_imagen_documento SET orden =".$ordenn.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_imagendocum = ".$idsimg[$i];
					
					if ($configdb[0] == 'mysql')
						{
							$queryids =  mysql_query($sql,$conn);
						}
					else
						{
							if ($configdb[0] == 'pgsql')
								{
									$queryids = pg_query($conn,$sql);
								}
							else
								{
									if (trim($configdb[0]) == 'sqlsrv')
										{
											$queryids = sqlsrv_query($conn, $sql);
										}	
									else 
										{
											if (trim($configdb[0]) == 'sqlsrv')
											{
												$queryids = sqlsrv_query($conn,$sql);
												
											}	
										}	
								}	
						}					
				}
				echo $ordenn;
			break;			
			
			case 'damedocumentosxind':
				$idindice = isset($_GET['id_indice']) && $_GET['id_indice'] !== '#' ? (int)$_GET['id_indice'] : 0;
				
				$id_tpdoc = isset($_GET['id_tpdoc']) && $_GET['id_tpdoc'] !== '#' ? (int)$_GET['id_tpdoc'] : 0;
				
				$valorinbus = isset($_GET['valorinbus']) && $_GET['valorinbus'] !== '' ? $_GET['valorinbus'] : ''; 				 
								
				$script = '';
				
				$script .= '<span class="sb-toggle-left glyphicon glyphicon-remove iconoazul actibleind sombraicono" style="position:relative; left:85%;font-size:1.5em;" onclick="cierraizqlado()" title="'.$traduce->traduce('ladocerrar').'"></span>';
						
				if ($configdb[0] == 'mysql')
					{
						$sql = "SELECT distinct vi.id_documento,e.id_expediente,e.nombre,d.id_tipodocumental,d.id_folder from sgd_valorindice vi, sgd_documentos d, sgd_expedientes e ,sgd_folders_tipodocs ft,sgd_tipodocumentales tp where  ucase(vi.valor) like '%".strtoupper($valorinbus)."%' and d.id_documento = vi.id_documento and e.id_expediente = d.id_expediente and ft.id_tipodoc = d.id_tipodocumental group by vi.id_documento,e.id_expediente,e.nombre,d.id_tipodocumental,d.id_folder order by e.id_expediente asc";
						
						$queryids =  mysql_query($sql,$conn);  
						
						while($campo2 = mysql_fetch_array($queryids))
							{
								// se buscan los datos los documentos
								
								//primero los documentos
								
								$sql = "select count(id_documento) as tdoc from sgd_documentos where id_documento = ".$campo2['id_documento'];
								
								$querycd =  mysql_query($sql,$conn);
								
								$numdoc = 0;
								
								$querycd = mysql_fetch_assoc($querycd);
								
								$numdoc = $querycd['tdoc'];
								
								//la cantidad de imagens
								
																
								$sql = "select count(i.id_imagendocum) as timg from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_documento = ".$campo2['id_documento'];
								
								$querycd =  mysql_query($sql,$conn);
								
								$querycd = mysql_fetch_assoc($querycd);
								
								$numimg = $querycd['timg'];
								
								//el folder donde esta el documento
								
								$sql = "SELECT f.nombre FROM sgd_folders f WHERE f.id  = ".$campo2['id_folder'];
								
								$querynfol =  mysql_query($sql,$conn);
								
								$qfolder = mysql_fetch_assoc($querynfol);
								
								$nfolderd = $qfolder['nombre'];
								
								$script .= '<div class="col-md-6 column-sort colsort">';
								$script .= '<div class="content-box">';
								$script .= '<h3 class="content-box-header bg-primary">';
								$script .= utf8_encode($campo2['nombre']); //nombre del expediente
								$script .= '</h3>';
																
								$script .= '<div class="content-box-wrapper">';
								if ($numdoc > 0 )
									{
										$script .= $traduce->traduce('titdocnum').'  <b>'.$numdoc.'</b><br>';
										
										//la lista de tipos documentales
										
																			
										$sql = "select distinct d.id_documento,tp.id_tipodoc,tp.nombre,tp.color from sgd_documentos d,sgd_tipodocumentales tp where d.id_tipodocumental = tp.id_tipodoc and d.id_documento = ".$campo2['id_documento'];
											
										$querycd =  mysql_query($sql,$conn);
										
										$numreg = mysql_num_rows($querycd);
										
										//$scvrit = '';
										
										if ($numreg > 0)
											{
												$script .= '<ul class="tll">';
												while($campotp = mysql_fetch_array($querycd)) 
													{
														//se buscan las imagenes de cada tipodocumental
														
														$sql = "select count(i.id_imagendocum) as timg from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_expediente = ".$campo2['id_expediente']." and i.id_documento = ".$campotp['id_documento'];
														
														$querynim =  mysql_query($sql,$conn);
														
														$nim= mysql_fetch_assoc($querynim);  
														
														//se buscan los indices de ese documento
														$sql = "select vi.id_indice,vi.valor,i.nombre from sgd_valorindice vi,sgd_indices i where i.id_indice = vi.id_indice and vi.id_documento = ".$campotp['id_documento'];		
														
														$queryindv =  mysql_query($sql,$conn);
														
														//se arma la lineas de indices
															
														$scriptventana = '<span style="font-size:1em"><strong>Archivo de Gesti&oacute;n</strong></span><br>';
														
														while($campoindv = mysql_fetch_array($queryindv))
															{
																
																$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campoindv['nombre']).': </strong></span>'.utf8_encode($campoindv['valor']).'<br>';
																
															}	
															
														//la tabla correspondiente
														
														$sql = "select id_tabla from sgd_documentos where id_documento = ".$campotp['id_documento'];
														
														$querytablarid =  mysql_query($sql,$conn);
														
														$dtabla = mysql_fetch_assoc($querytablarid);
																	
														
														$script .= '<li class="lni sombraicono sb-toggle-right" style="cursor:pointer;color:'.$campotp['color'].'">';  //
														$script .= '<div class="dropdown" >';
														$script .= '<a href="#" class="btn btn-default" title="" data-toggle="dropdown">';
														$script .= $nfolderd.' - '.$campotp['nombre'].'  ('.$nim['timg'].')';
														$script .= '<span class="caret"></span>';
														$script .= '</a>';
														$script .= '<ul class="dropdown-menu" style="z-index:9999999 !important;">';
														$script .= '<li>';
														$script .= '<a id="tpdocimg_'.$campotp['id_documento'].'" href="javascript:;" onclick="verimgtp(this.id)" data-valor="'.$campo2['id_documento'].'" data-tp="'.$id_tpdoc.'" data-exp="'.$campo2['id_expediente'].'">Ver imagenes</a>';
														$script .= '</li>';
														
														$script .= '<li>';
														$script .= '<a id="editarindices_'.$campotp['id_documento'].'" href="javascript:;" onclick="editarindices('.$campo2['id_documento'].','.$campotp['id_tipodoc'].','.$campo2['id_folder'].','.$dtabla['id_tabla'].','.$campo2['id_expediente'].')"  data-valor="'.$campotp['id_documento'].'" >Editar Indices</a>';
														$script .= '</li>';
														
														//aca va la estructura de los indices del documento   $scriptventana
														$script .= '<li>';
														$script .= '<a href="javascript:;" title="">';
														$script .= $scriptventana;
														$script .= '</a>';
														$script .= '</li>';
														///////														
														$script .= '</ul>';
														$script .= '</div>';
														$script .= '</li>';
															
													}
												$script .= '</ul>';
											}
										else
											{
												$script = '';
											}
										
										if ($numimg > 0)
											{
												
												//$script .= '<a id="imagenesde_'.$campo2['id_expediente'].'" class="sb-toggle-right actibleind" data-valor="'.$campo2['id_expediente'].'" data-folder="'.$campo2['id_folder'].'" onclick="verimgtpfull(this.id)">'.$traduce->traduce('titimage').' '.$numimg.'</a>';
												
											}	
										else
											{
												
												//$script .= $traduce->traduce('titimage').' '.$numimg;
											}
										
									}	
								else 
									{
										$script .= $traduce->traduce('titnodoc').'<br>';
										
										$script .= $scvrit.'<br>';
										
										if ($numimg > 0)
											{
												
												//$script .= '<a id="imagenesde_'.$campo2['id_expediente'].'" class="sb-toggle-right actibleind" data-valor="'.$campo2['id_expediente'].'" >'.$traduce->traduce('titimage').' '.$numimg.'</a>';
												
											
											}
										else
											{
											
												$script .= $traduce->traduce('titimage').' '.$numimg;
											}
									}
									
								$script .= '</div>';
								
								$script .= '</div>';								
						
								$script .= '</div>';
								
							}
												
					}
				else 
					{
						if ($configdb[0] == 'pgsql')
							{
								$sql = "SELECT distinct vi.id_documento,e.id_expediente,e.nombre,d.id_tipodocumental,d.id_folder from sgd_valorindice vi, sgd_documentos d, sgd_expedientes e ,sgd_folders_tipodocs ft,sgd_tipodocumentales tp where  upper(vi.valor) like '%".strtoupper($valorinbus)."%' and d.id_documento = vi.id_documento and e.id_expediente = d.id_expediente and ft.id_tipodoc = d.id_tipodocumental group by vi.id_documento,e.id_expediente,e.nombre,d.id_tipodocumental,d.id_folder order by e.id_expediente asc";
								
								$queryids = pg_query($conn,$sql);
																
								
								
								while($campo2 = pg_fetch_array($queryids))
									{
										// se buscan los datos los documentos
										
										//primero los documentos
										
										$sql = "select count(id_documento) as tdoc from sgd_documentos where id_documento = ".$campo2['id_documento'];
										
										$querycd =   pg_query($conn,$sql);
										
										$numdoc = 0;
										
										$querycd = pg_fetch_assoc($querycd);
										
										$numdoc = $querycd['tdoc'];
										
										//la cantidad de imagens
										
										$sql = "select count(i.id_imagendocum) as timg from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_documento = ".$campo2['id_documento'];
										
										$querycd =   pg_query($conn,$sql);
										
										$querycd = pg_fetch_assoc($querycd);
										
										$numimg = $querycd['timg'];
										
										//el folder donde esta el documento
										
										$sql = "SELECT f.nombre FROM sgd_folders f WHERE f.id  = ".$campo2['id_folder'];
										
										$querynfol =   pg_query($conn,$sql);
										
										$qfolder = pg_fetch_assoc($querynfol);
										
										$nfolderd = $qfolder['nombre'];
										
										$script .= '<div class="col-md-6 column-sort colsort">';
										$script .= '<div class="content-box">';
										$script .= '<h3 class="content-box-header bg-primary">';
										$script .= utf8_encode($campo2['nombre']); //nombre del expediente
										$script .= '</h3>';
										
										$script .= '<div class="content-box-wrapper">';
										if ($numdoc > 0 )
										{
											$script .= $traduce->traduce('titdocnum').'  <b>'.$numdoc.'</b><br>';
										
											//la lista de tipos documentales
										
																				
											$sql = "select distinct d.id_documento,tp.id_tipodoc,tp.nombre,tp.color from sgd_documentos d,sgd_tipodocumentales tp where d.id_tipodocumental = tp.id_tipodoc and d.id_documento = ".$campo2['id_documento'];
												
											$querycd =   pg_query($conn,$sql);
										
											$numreg = pg_num_rows($querycd);
										
											//$scvrit = '';
										
											if ($numreg > 0)
											{
												$script .= '<ul class="tll">';
												while($campotp = pg_fetch_array($querycd))
												{
													//se buscan las imagenes de cada tipodocumental
										
													$sql = "select count(i.id_imagendocum) as timg from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_expediente = ".$campo2['id_expediente']." and i.id_documento = ".$campotp['id_documento'];
										
													$querynim =   pg_query($conn,$sql);
										
													$nim= pg_fetch_assoc($querynim);
										
													//se buscan los indices de ese documento
													$sql = "select vi.id_indice,vi.valor,i.nombre from sgd_valorindice vi,sgd_indices i where i.id_indice = vi.id_indice and vi.id_documento = ".$campotp['id_documento'];
										
													$queryindv =   pg_query($conn,$sql);
										
													//se arma la lineas de indices
														
													$scriptventana = '<span style="font-size:1em"><strong>Archivo de Gesti&oacute;n</strong></span><br>';
										
													while($campoindv = pg_fetch_array($queryindv))
													{
										
														$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campoindv['nombre']).': </strong></span>'.utf8_encode($campoindv['valor']).'<br>';
										
													}
														
													//la tabla correspondiente
										
													$sql = "select id_tabla from sgd_documentos where id_documento = ".$campotp['id_documento'];
										
													$querytablarid =   pg_query($conn,$sql);
										
													$dtabla = pg_fetch_assoc($querytablarid);
														
										
													$script .= '<li class="lni sombraicono sb-toggle-right" style="cursor:pointer;color:'.$campotp['color'].'">';  //
													$script .= '<div class="dropdown" >';
													$script .= '<a href="#" class="btn btn-default" title="" data-toggle="dropdown">';
													$script .= utf8_encode($nfolderd).' - '.utf8_encode($campotp['nombre']).'  ('.$nim['timg'].')';
													$script .= '<span class="caret"></span>';
													$script .= '</a>';
													$script .= '<ul class="dropdown-menu" style="z-index:9999999 !important;">';
													$script .= '<li>';
													$script .= '<a id="tpdocimg_'.$campotp['id_documento'].'" href="javascript:;" onclick="verimgtp(this.id)" data-valor="'.$campo2['id_documento'].'" data-tp="'.$id_tpdoc.'" data-exp="'.$campo2['id_expediente'].'">Ver imagenes</a>';
													$script .= '</li>';
										
													$script .= '<li>';
													$script .= '<a id="editarindices_'.$campotp['id_documento'].'" href="javascript:;" onclick="editarindices('.$campo2['id_documento'].','.$campotp['id_tipodoc'].','.$campo2['id_folder'].','.$dtabla['id_tabla'].','.$campo2['id_expediente'].')"  data-valor="'.$campotp['id_documento'].'" >Editar Indices</a>';
													$script .= '</li>';
										
													//aca va la estructura de los indices del documento   $scriptventana
													$script .= '<li>';
													$script .= '<a href="javascript:;" title="">';
													$script .= $scriptventana;
													$script .= '</a>';
													$script .= '</li>';
													///////
													$script .= '</ul>';
													$script .= '</div>';
													$script .= '</li>';
														
												}
												$script .= '</ul>';
											}
											else
											{
												$script = '';
											}
										
											if ($numimg > 0)
											{
										
												//$script .= '<a id="imagenesde_'.$campo2['id_expediente'].'" class="sb-toggle-right actibleind" data-valor="'.$campo2['id_expediente'].'" data-folder="'.$campo2['id_folder'].'" onclick="verimgtpfull(this.id)">'.$traduce->traduce('titimage').' '.$numimg.'</a>';
										
												
										
											}
											else
											{
										
												$script .= $traduce->traduce('titimage').' '.$numimg;
											}
										
										}
										else
										{
											$script .= $traduce->traduce('titnodoc').'<br>';
										
											$script .= $scvrit.'<br>';
										
											if ($numimg > 0)
											{
										
												//$script .= '<a id="imagenesde_'.$campo2['id_expediente'].'" class="sb-toggle-right actibleind" data-valor="'.$campo2['id_expediente'].'" >'.$traduce->traduce('titimage').' '.$numimg.'</a>';
										
												
													
											}
											else
											{
													
												$script .= $traduce->traduce('titimage').' '.$numimg;
											}
										}
											
										$script .= '</div>';
										
										$script .= '</div>';
										
										
										$script .= '</div>';
										
										}
							}	
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$sql = "SELECT distinct vi.id_documento,e.id_expediente,e.nombre,d.id_tipodocumental,d.id_folder from sgd_valorindice vi, sgd_documentos d, sgd_expedientes e ,sgd_folders_tipodocs ft,sgd_tipodocumentales tp where  upper(vi.valor) like '%".strtoupper($valorinbus)."%' and d.id_documento = vi.id_documento and e.id_expediente = d.id_expediente and ft.id_tipodoc = d.id_tipodocumental group by vi.id_documento,e.id_expediente,e.nombre,d.id_tipodocumental,d.id_folder order by e.id_expediente asc";
										
										$queryids = sqlsrv_query($conn,$sql);
										
										while( $campo2 = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC ))
											{
												// se buscan los datos los documentos
											
												//primero los documentos
											
												$sql = "select count(id_documento) as tdoc from sgd_documentos where id_documento = ".$campo2['id_documento'];
											
												$querycd =   sqlsrv_query($conn,$sql);
											
												$numdoc = 0;
											
												while( $campocd = sqlsrv_fetch_array( $querycd, SQLSRV_FETCH_ASSOC ))
													{
														$numdoc = $campocd['tdoc'];
													}	
											
												//la cantidad de imagens
											
												$sql = "select count(i.id_imagendocum) as timg from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_documento = ".$campo2['id_documento'];
											
												$querycd = sqlsrv_query($conn,$sql);
												
												while( $campocd1 = sqlsrv_fetch_array( $querycd, SQLSRV_FETCH_ASSOC ))
													{
														$numimg = $campocd1['timg'];
													}
													
												//el folder donde esta el documento
											
												$sql = "SELECT f.nombre FROM sgd_folders f WHERE f.id  = ".$campo2['id_folder'];
											
												$querynfol = sqlsrv_query($conn,$sql);
												
												while( $campocd2 = sqlsrv_fetch_array( $querynfol, SQLSRV_FETCH_ASSOC ))
													{
														$nfolderd = $campocd2['nombre'];
													}
											
											
												$script .= '<div class="col-md-6 column-sort colsort">';
												$script .= '<div class="content-box sombradiv">';
												$script .= '<h3 class="content-box-header bg-primary">';
												$script .= utf8_encode($campo2['nombre']); //nombre del expediente
												$script .= '</h3>';
											
												$script .= '<div class="content-box-wrapper">';
												if ($numdoc > 0 )
												{
													$script .= $traduce->traduce('titdocnum').'  <b>'.$numdoc.'</b><br>';
											
													//la lista de tipos documentales
											
											
													$sql = "select distinct d.id_documento,tp.id_tipodoc,tp.nombre,tp.color from sgd_documentos d,sgd_tipodocumentales tp where d.id_tipodocumental = tp.id_tipodoc and d.id_documento = ".$campo2['id_documento'];
											
													$querycd = sqlsrv_query($conn,$sql);
													
													$querycd2 = sqlsrv_query($conn,$sql);
													
													$numreg = 0;
													
													while( $camponreg = sqlsrv_fetch_array( $querycd2, SQLSRV_FETCH_ASSOC ))
														{
															$numreg = $numreg + 1;
														}
											
													
													if ($numreg > 0)
													{
														$script .= '<ul class="tll">';
														while( $campotp = sqlsrv_fetch_array( $querycd, SQLSRV_FETCH_ASSOC )) 
														{
															//se buscan las imagenes de cada tipodocumental
											
															$sql = "select count(i.id_imagendocum) as timg from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_expediente = ".$campo2['id_expediente']." and i.id_documento = ".$campotp['id_documento'];
											
															$querynim = sqlsrv_query($conn,$sql);
															
															$nim = 0;
															
															while( $campnim = sqlsrv_fetch_array( $querynim, SQLSRV_FETCH_ASSOC ))
																{
																	$nim = $campnim['timg'];
																}
															 											
															//se buscan los indices de ese documento
															$sql = "select vi.id_indice,vi.valor,i.nombre from sgd_valorindice vi,sgd_indices i where i.id_indice = vi.id_indice and vi.id_documento = ".$campotp['id_documento'];  //$script .=  $sql;
											
															$queryindv = sqlsrv_query($conn,$sql);
											
															//se arma la lineas de indices
											
															$scriptventana = '<span style="font-size:1em"><strong>Archivo de Gesti&oacute;n</strong></span><br>';
											
															while( $campoindv = sqlsrv_fetch_array( $queryindv, SQLSRV_FETCH_ASSOC )) 
																{
												
																	$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campoindv['nombre']).': </strong></span>'.utf8_encode($campoindv['valor']).'<br>';
												
																}
											
															//la tabla correspondiente
											
															$sql = "select id_tabla from sgd_documentos where id_documento = ".$campotp['id_documento'];
											
															$querytablarid =   sqlsrv_query($conn,$sql);
															
															while( $camptabla = sqlsrv_fetch_array( $querytablarid, SQLSRV_FETCH_ASSOC ))
																{
																	$dtabla = $camptabla['id_tabla'];
																}										
											
															$script .= '<li class="lni sombraicono sb-toggle-right" style="cursor:pointer;color:'.$campotp['color'].'">';  
															$script .= '<div class="dropdown" >';
															$script .= '<a href="#" class="btn btn-default" title="" data-toggle="dropdown">';
															$script .= utf8_encode($nfolderd).' - '.utf8_encode($campotp['nombre']).'  ('.$nim.')';
															$script .= '<span class="caret"></span>';
															$script .= '</a>';
															$script .= '<ul class="dropdown-menu" style="z-index:9999999 !important;">';
															$script .= '<li>';
															$script .= '<a id="tpdocimg_'.$campotp['id_documento'].'" href="javascript:;" onclick="verimgtp(this.id)" data-valor="'.$campo2['id_documento'].'" data-tp="'.$id_tpdoc.'" data-exp="'.$campo2['id_expediente'].'">Ver imagenes</a>';
															$script .= '</li>';
											
															$script .= '<li>';
															$script .= '<a id="editarindices_'.$campotp['id_documento'].'" href="javascript:;" onclick="editarindices('.$campo2['id_documento'].','.$campotp['id_tipodoc'].','.$campo2['id_folder'].','.$dtabla.','.$campo2['id_expediente'].')"  data-valor="'.$campotp['id_documento'].'" >Editar Indices</a>';
															$script .= '</li>';
											
															//aca va la estructura de los indices del documento   $scriptventana
															$script .= '<li>';
															$script .= '<a href="javascript:;" title="">';
															$script .= $scriptventana;
															$script .= '</a>';
															$script .= '</li>';
															///////
															$script .= '</ul>';
															$script .= '</div>';
															$script .= '</li>';
											
														}
														$script .= '</ul>';
													}
													else
													{
														$script = '';
													}
											
													if ($numimg > 0)
													{
											
														//$script .= '<a id="imagenesde_'.$campo2['id_expediente'].'" class="sb-toggle-right actibleind" data-valor="'.$campo2['id_expediente'].'" data-folder="'.$campo2['id_folder'].'" onclick="verimgtpfull(this.id)">'.$traduce->traduce('titimage').' '.$numimg.'</a>';
											
											
											
													}
													else
													{
											
														//$script .= $traduce->traduce('titimage').' '.$numimg;
													}
											
												}
												else
												{
													$script .= $traduce->traduce('titnodoc').'<br>';
											
													$script .= $scvrit.'<br>';
											
													if ($numimg > 0)
													{
											
														//$script .= '<a id="imagenesde_'.$campo2['id_expediente'].'" class="sb-toggle-right actibleind" data-valor="'.$campo2['id_expediente'].'" >'.$traduce->traduce('titimage').' '.$numimg.'</a>';
															
													}
													else
													{
															
														//$script .= $traduce->traduce('titimage').' '.$numimg;
													}
												}
													
												$script .= '</div>';
											
												$script .= '</div>';
											
											
												$script .= '</div>';
											
											}
									}	
							}	
					}
				echo $script;
			break;	 //
			
			case 'dameimagenescentrofolder':
				$id_expediente = isset($_GET['id_expediente']) && $_GET['id_expediente'] !== '#' ? (int)$_GET['id_expediente'] : 0;
				
				$idfolder = isset($_GET['idfolder']) && $_GET['idfolder'] !== '#' ? (int)$_GET['idfolder'] : 0;
			
				$conteoimg = 0;
			
				$sql ="select i.id_imagendocum,i.nombre,i.extension,i.id_bodega,i.id_documento from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_expediente = ".$id_expediente." and d.id_folder = ".$idfolder;
					
				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
				
						$numreg = mysql_num_rows($queryids);
							
						$idexpediente = $id_expediente;
						
						$script = '';
						
						$ictl = 0;
						$script .= '<h3 class="title-hero">';
				
						$script .= '</h3>';
						$script .= '<div class="example-box-wrapper">';
						$script .= '<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">';
						$script .= '<ol class="carousel-indicators">';
						for ($i = 1; $i <= $numreg; $i++) {
							if ($i == 0)
								{
									$estadoi = 'active';
								}
							else
								{
									$estadoi = '';
								}
							$script .= '<li data-target="#carousel-example-generic" data-slide-to="'.$i.'" class="'.$estadoi.'"></li>';
						}
						$script .= '</ol>';
						$script .= '<div class="carousel-inner" style="width: 50% !important;margin: 0 auto !important;">';
						while($campo2 = mysql_fetch_array($queryids))
						{
								
							$ictl = $ictl + 1;
				
							//buscamos la bodega respectiva
							$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
				
							$queryidimg =  mysql_query($sql,$conn);
				
							$labodega = mysql_fetch_assoc($queryidimg);
				
							//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
				
							if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
								{
									//se debe crear la imagen en la carpeta visor
					
									if (copy($ruta_bodega.$labodega['nombre'].'/'.$campo2['id_imagendocum'].'_.bin',$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
										{
						
											if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
												{
							
													$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
														
													exec($command);
							
													$limagen = $campo2['id_imagendocum'].'_.jpg';
							
												}
											else
												{
							
													$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
							
												}
										}
					
								}
								
							else
								
								{
									if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
										{
												
											$limagen = $campo2['id_imagendocum'].'_.jpg';
										}
									else
										{
						
											$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
										}
								}
				
							if ($ictl == 1)
								{
									$script .= '<div class="item active">';
								}
							else
								{
									$script .= '<div class="item">';
								}
								
							//$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/expedientes/'.$limagen.'/mostrar" class="kv-preview-data file-preview-image milazi tiraimg"  data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'" onclick="zoomimg(this.id,1)"  onmouseover="mostrartabla(this.id)" onmouseout="nomostrartabla(this.id)" data-exp="'.$idexpediente.'" data-original="'.$rutadir.'/expedientes/'.$limagen.'/mostrar" alt="" style="width:auto;height:200px;position:relative;left:3%;cursor:pointer">';
								
							$conteoimg = $conteoimg + 1;  //$_SESSION['espaciotrabajo']
								
							$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="70%" max-width="70%" style="cursor:pointer">';
				
							
							
							$script .= '</div>';
						}
						$script .= '</div>';
						$script .= '<a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">';
						$script .= '<span class="glyph-icon icon-chevron-left"></span>';
						$script .= '</a>';
						$script .= '<a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">';
						$script .= '<span class="glyph-icon icon-chevron-right"></span>';
						$script .= '</a>';
						$script .= '</div>';
						$script .= '</div>';
						$script .= '</div>';
							
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
					
								$queryids =  pg_query($conn,$sql);
					
								$numreg = pg_num_rows($queryids);
					
								$idexpediente = $id_expediente;
					
								$script = '';
								$ictl = 0;
								$script .= '<h3 class="title-hero">';
					
								$script .= '</h3>';
								$script .= '<div class="example-box-wrapper">';
								$script .= '<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">';
								$script .= '<ol class="carousel-indicators">';
					
								for ($i = 1; $i <= $numreg; $i++) {
									if ($i == 0)
										{
											$estadoi = 'active';
										}
									else
										{
											$estadoi = '';
										}
									$script .= '<li data-target="#carousel-example-generic" data-slide-to="'.$i.'" class="'.$estadoi.'"></li>';
								}
					
								$script .= '</ol>';
								$script .= '<div class="carousel-inner" style="width: 50% !important;margin: 0 auto !important;">';
					
								while($campo2 = pg_fetch_array($queryids))
									{
											
										$ictl = $ictl + 1;
											
										//buscamos la bodega respectiva
										$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
											
										$queryidimg =  pg_query($conn,$sql);
											
										$labodega = pg_fetch_assoc($queryidimg);
											
										//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
											
										if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
											{
												//se debe crear la imagen en la carpeta visor
							
												if (copy($ruta_bodega.$labodega['nombre'].'/'.$campo2['id_imagendocum'].'_.bin',$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
													{
															
														if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
															{
									
																$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																	
																exec($command);
									
																$limagen = $campo2['id_imagendocum'].'_.jpg';
									
															}
														else
															{
									
																$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
									
															}
													}
							
											}
											
										else
											
											{
												if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
													{
															
														$limagen = $campo2['id_imagendocum'].'_.jpg';
													}
												else
													{
															
														$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
													}
											}
											
										if ($ictl == 1)
											{
												$script .= '<div class="item active">';
											}
										else
											{
												$script .= '<div class="item">';
											}
											
										$conteoimg = $conteoimg + 1; //$_SESSION['espaciotrabajo']
						
										$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="70%" max-width="70%" style="cursor:pointer">';
										
										
											
										$script .= '</div>';
									}
								$script .= '</div>';
								$script .= '<a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">';
								$script .= '<span class="glyph-icon icon-chevron-left"></span>';
								$script .= '</a>';
								$script .= '<a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">';
								$script .= '<span class="glyph-icon icon-chevron-right"></span>';
								$script .= '</a>';
								$script .= '</div>';
								$script .= '</div>';
								$script .= '</div>';
					
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$queryids =  sqlsrv_query($conn,$sql);
										
										$numreg = sqlsrv_num_rows( $queryids );
											
										$idexpediente = $id_expediente;
											
										$script = '';
										$ictl = 0;
										$script .= '<h3 class="title-hero">';
											
										$script .= '</h3>';
										$script .= '<div class="example-box-wrapper">';
										$script .= '<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">';
										$script .= '<ol class="carousel-indicators">';
											
										for ($i = 1; $i <= $numreg; $i++) {
											if ($i == 0)
												{
													$estadoi = 'active';
												}
											else
												{
													$estadoi = '';
												}
											$script .= '<li data-target="#carousel-example-generic" data-slide-to="'.$i.'" class="'.$estadoi.'"></li>';
										}
											
										$script .= '</ol>';
										$script .= '<div class="carousel-inner" style="width: 50% !important;margin: 0 auto !important;">';
											
										while( $row = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC )) 
											{
													
												$ictl = $ictl + 1;
													
												//buscamos la bodega respectiva
												$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$campo2['id_bodega'];
													
												$queryidimg =  sqlsrv_query($conn,$sql);
													
												$labodega =  sqlsrv_fetch_array( $queryidimg, SQLSRV_FETCH_ASSOC ) ;
													
												//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
													
												if (!file_exists($ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
													{
														//se debe crear la imagen en la carpeta visor
															
														if (copy($ruta_bodega.$labodega['nombre'].'/'.$campo2['id_imagendocum'].'_.bin',$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension']))
															{
																	
																if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
																	{
																			
																		$command = "convert ".$ruta_temp.$campo2['id_imagendocum'].'_.'.$campo2['extension'].' '.$ruta_temp.$campo2['id_imagendocum'].'_.jpg';
																			
																		exec($command);
																			
																		$limagen = $campo2['id_imagendocum'].'_.jpg';
																			
																	}
																else
																	{
																			
																		$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
																			
																	}
															}
															
													}
													
												else
													
													{
														if ($campo2['extension'] == 'tif' or $campo2['extension'] == 'tiff')
															{
																	
																$limagen = $campo2['id_imagendocum'].'_.jpg';
															}
														else
															{
																	
																$limagen = $campo2['id_imagendocum'].'_.'.$campo2['extension'];
															}
													}
													
												if ($ictl == 1)
													{
														$script .= '<div class="item active">';
													}
												else
													{
														$script .= '<div class="item">';
													}
													
												$conteoimg = $conteoimg + 1; //$_SESSION['espaciotrabajo']
											
												$script .= '<img id="image_'.$campo2['id_imagendocum'].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="70%" max-width="70%" style="cursor:pointer">';
													
												$script .= '</div>';
											}
										$script .= '</div>';
										$script .= '<a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">';
										$script .= '<span class="glyph-icon icon-chevron-left"></span>';
										$script .= '</a>';
										$script .= '<a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">';
										$script .= '<span class="glyph-icon icon-chevron-right"></span>';
										$script .= '</a>';
										$script .= '</div>';
										$script .= '</div>';
										$script .= '</div>';
									}	
							}	
				
					}
				echo $script;
				break;
			
			case 'dameimagenescentro':
				$iddocumento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$anc = isset($_GET['anc']) && $_GET['anc'] !== '#' ? (int)$_GET['anc'] : 0;
				
				$conteoimg = 0;
				
				$espaciotrabajo = $_REQUEST['workspace']; 
				
				$idusuario = $_SESSION['elidusuario'];
				
				$rutadir = darurl();
				
				$sql ="select i.id_imagendocum,i.nombre,i.extension,i.id_bodega,i.id_documento,i.orden from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_documento = ".$iddocumento." order by i.orden asc";				
				
				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
					
						$numreg = mysql_num_rows($queryids);
					
						//buscamos el expediente
					
						$sql = "select id_expediente from sgd_documentos where id_documento = ".$iddocumento;
					
						$queryexpe =  mysql_query($sql,$conn);
					
						$idexpediente = mysql_fetch_assoc($queryexpe);
					
						$idexpediente = $idexpediente['id_expediente'];
						
						//cargo un arreglo con los nombres de las imagenes a trabajar
						
						unset($vlabodega);
						
						unset($vlasimg);
						
						unset($vlaext);
						
						unset($vorden);
						
						$script = '';
						
						$lasbodegas = '';
						
						$lasimg = '';
						
						$laext = '';
						
						$lorden = '';
										
						while($campo2 = mysql_fetch_array($queryids)) 
							{
								
								$vlabodega[] = $campo2['id_bodega'];
								
								$vorden[] = $campo2['orden'];
								
								$lorden .= $campo2['orden'].'_,_';
								
								$lasbodegas .= $campo2['id_bodega'].'_,_';
								
								$vlasimg[] = $campo2['id_imagendocum'];
								
								$lasimg .=  $campo2['id_imagendocum'].'_,_';
								
								$vlaext[] =  $campo2['extension']; 
								
								$laext .= $campo2['extension'].'_,_';
								
							}	
							
							$lasbodegas = trim($lasbodegas,"_,_");
							
							$lasimg  = trim($lasimg,"_,_"); 
							
							$laext = trim($laext,"_,_"); 
							
							$lorden = trim($lorden,"_,_"); 
							
							
						//se monta la primera imagen para que se vea
						
						//buscamos la bodega respectiva
						
						$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$vlabodega[0];
						
						$queryidimg =  mysql_query($sql,$conn);
						
						$labodega = mysql_fetch_assoc($queryidimg);
						
						//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
						
						if ($vlaext[0] != 'zip')
							{
							
								if (!file_exists($ruta_temp.$vlasimg[0].'_.'.$vlaext[0]))
									{
								
										//con encriptación
								
										inFTP($vlasimg[0].'_.'.$vlaext[0],$ruta_bodega.$labodega['nombre'],$ruta_temp,$kweyllave);
								
										if ($vlaext[0] == 'tif' or $vlaext[0] == 'tiff')
											{
													
												$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
													
												exec($command);
													
												$limagen = $vlasimg[0].'_.jpg';
													
											}
										else
											{
									
												if ($vlaext[0] == 'jpg' or $vlaext[0] == 'png' or $vlaext[0] == 'bmp' or $vlaext[0] == 'gif')
													{
														$limagen = $vlasimg[0].'_.'.$vlaext[0];
													}
												else
													{
														if ($vlaext[0] == 'pdf')
															{
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																	{
																		mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																	}
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																	{
																		//se copia
																		$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
												
																		$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
												
												
																		//copy($ruta_temp.$d1."_.".$d2,"../img/descargas/".$d1."_.".$d2);
												
																		if (copy($fichero, $nuevo_fichero))
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																			}
																		else
																			{
																				$limagen = '';
																			}
																	}
																else
																	{
																		$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																	}
											
															}
														else
															{
																//para el manejo de videos
																if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																			{
																				//se copia
																				$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																				
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																				
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																			}
																	}
																//fin del bloque de manejo de videos	
															}	
													}
											}
								
									}
							
								else
							
									{
										if ($vlaext[0] == 'tif' or $vlaext[0] == 'tiff')
											{
									
												if (!file_exists($ruta_temp.$vlasimg[0].'_.jpg'))
													{
														$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
															
														exec($command);
															
														$limagen = $vlasimg[0].'_.jpg';
													}
												else
													{
														$limagen = $vlasimg[0].'_.jpg';
													}
											}
										else
											{
													
												if ($vlaext[0] == 'jpg' or $vlaext[0] == 'png' or $vlaext[0] == 'bmp' or $vlaext[0] == 'gif')
													{
														$limagen = $vlasimg[0].'_.'.$vlaext[0];
													}
												else
													{
														if ($vlaext[0] == 'pdf')
															{
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																{
																	mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																}
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																{
																	//se copia
																	$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																		
																	$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																		
																	if (copy($fichero, $nuevo_fichero))
																	{
																		$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																	}
																	else
																	{
																		$limagen = '';
																	}
																}
																else
																	{
																		$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																	}
															}
														else
															{
																//para el manejo de videos
																if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																			{
																				//se copia
																				$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																				
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																				
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																			} 
																	}
																//fin del bloque de manejo de videos	
															}	
													}
											}
									}
							}
						else
							{
								if ($vlaext[0] == 'zip')
									{
								
										//se abre el archivo $zip
								
										$extimg = '';
								
										$workspace = $espaciotrabajo;
								
										$rutadestino = '../img/apiimg/'.$workspace.'/';
								
										$destino = $rutadestino;
								
										$rutadestinozip = '/img/apiimg/'.$workspace.'/';
								
										$rutadestinozipc = '/img/apiimg/'.$workspace.'';
								
										//se crea la carpeta de destino si solo si no existe   
										if (!file_exists($destino))
											{
												mkdir($destino, 0777, true);
											}
								
										require_once('manejozip.php');
								
										$archivopadre = $ruta_bodega.$labodega['nombre'].'/'.$vlasimg[0].'_.'.$vlaext[0];
								
										$zip_manager = new Zip_manager();
								
										$resultado = $zip_manager->extraer($archivopadre, $destino);
								
										if ($resultado)
											{
									
												$archivo_zip = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
									
												$listado = $zip_manager->listar($archivopadre, $destino);
									
												$czip = 0;
									
												for ($iti = 0; $iti < count($listado); $iti++)
													{
														$czip = $czip + 1;
										
														if ($czip == 1)
															{
											
																//se separa la extension
																//echo $listado[$iti];
											
																$extimg = substr(strrchr($listado[$iti], "."),1);
											
																$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
											
																//se verifica que existe el archivo
											
																if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
																	{
												
																		$limagen = $rutadestinozip.$filename.'.'.$extimg;
												
																	}
																else
																	{
																		if ($extimg == 'tif' or $extimg == 'tiff')
																			{
																				//se verifica que exista el jpg
																				
																				if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																					{
																						$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg';  
														
																						exec($command);
																					}
													
																				$limagen = $rutadestinozip.$filename.'_.jpg';
																			}
																	}
																//$exte = $extimg;
																break;
															}
										
													}
									
											}
								
									}
							}
						//se coloca la imagen imgcentral
						
						if ($vlaext[0] != 'zip')
							{
									
								$conteoimg = 1;
									
								$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 100% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-orden="'.$lorden.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
							
								if ($vlaext[0] != 'pdf' and $vlaext[0] != 'mp4' and $vlaext[0] != 'm4v' and $vlaext[0] != 'webm')
									{
										$script .= '<img id="image_central" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
									}
								else
									{
										if ($vlaext[0] == 'pdf')
											{
												$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="1000" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
											}
										else
											{
												if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
													{
														$script .= '<video src="'.$limagen.'" controls>';
														$script .= 'Tu navegador no soporta el elemento <code>video</code>';
														$script .= '</video>';
													}	
											}
									}
									
								$script .= '</div>';
							
								$script .= '_;_'.'<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)" style="position:relative;margin-right:3%"></span>';
							
								$script .='_;_'.'<span id="num_imgcen" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'" style="position:relative;float:right;font-size:2em;padding-right:50%" class="iconoazul sombraiconobl img_listado">'.$vorden[0].'</span>';
							
								$script .= '_;_'.'<span valign="top" id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)" style="position:relative;"></span>';
							}
						else
							{
								if ($vlaext[0] == 'zip')
									{
										$conteoimg = 1;
											
										$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 100% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-orden="'.$lorden.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
								
										if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'tif' or $extimg == 'tiff' )
											{
												$script .= '<img id="image_central" src="'.$rutadir.$limagen.'" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
											}
										else
											{
												if ($extimg == 'pdf')
													{
														$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="1000" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
													}
												else
													{
														if ($extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
															{
																$script .= '<video src="'.$limagen.'" controls>';
																$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																$script .= '</video>';
															}	
													}	
											}
											
										$script .= '</div>';
											
										$script .= '_;_'.'<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)" style="position:relative;margin-right:3%"></span>';
											
										$script .='_;_'.'<span id="num_imgcen" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'" style="position:relative;float:right;font-size:2em;padding-right:50%" class="iconoazul sombraiconobl img_listado">'.$vorden[0].'</span>';
											
										$script .= '_;_'.'<span valign="top" id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)" style="position:relative;"></span>';
											
									}
							}
							
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryids = pg_query($conn,$sql);
									
								$numreg = pg_num_rows($queryids);
									
								//buscamos el expediente
									
								$sql = "select id_expediente from sgd_documentos where id_documento = ".$iddocumento;
									
								$queryexpe =  pg_query($conn,$sql);
									
								$idexpediente = pg_fetch_assoc($queryexpe);
									
								$idexpediente = $idexpediente['id_expediente'];
								
								//cargo un arreglo con los nombres de las imagenes a trabajar
								
								unset($vlabodega);
								
								unset($vlasimg);
								
								unset($vlaext);
								
								unset($vorden);
								
								$script = '';
								
								$lasbodegas = '';
								
								$lasimg = '';
								
								$laext = '';
								
								$lorden = ''; 
								
								while($campo2 = pg_fetch_array($queryids))
									{
									
										$vlabodega[] = $campo2['id_bodega'];
										
										$vorden[] = $campo2['orden'];
									
										$lorden .= $campo2['orden'].'_,_';
										
										$lasbodegas .= $campo2['id_bodega'].'_,_';
									
										$vlasimg[] = $campo2['id_imagendocum'];
									
										$lasimg .=  $campo2['id_imagendocum'].'_,_';
									
										$vlaext[] =  $campo2['extension'];
									
										$laext .= $campo2['extension'].'_,_';
									
									}
									
								//se monta la primera imagen para que se vea
								
								//buscamos la bodega respectiva
								
								$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$vlabodega[0];
								
								$queryidimg =  pg_query($conn,$sql);
								
								$labodega = pg_fetch_assoc($queryidimg);
								
								//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
								
								if ($vlaext[0] != 'zip')
								{
								
									if (!file_exists($ruta_temp.$vlasimg[0].'_.'.$vlaext[0]))
										{
									
											//con encriptación
									
											inFTP($vlasimg[0].'_.'.$vlaext[0],$ruta_bodega.$labodega['nombre'],$ruta_temp,$kweyllave);
									
											if ($vlaext[0] == 'tif' or $vlaext[0] == 'tiff')
												{
														
													$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
														
													exec($command);
														
													$limagen = $vlasimg[0].'_.jpg';
														
												}
											else
											{
									
												if ($vlaext[0] == 'jpg' or $vlaext[0] == 'png' or $vlaext[0] == 'bmp' or $vlaext[0] == 'gif')
													{
														$limagen = $vlasimg[0].'_.'.$vlaext[0];
													}
												else
												{
													if ($vlaext[0] == 'pdf')
														{
															if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																{
																	mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																}
															if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																{
																	//se copia
																	$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
											
																	$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																						
																	if (copy($fichero, $nuevo_fichero))
																		{
																			$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																		}
																	else
																		{
																			$limagen = '';
																		}
																}
															else
																{
																	$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																}									
														}
													else
														{ //para el manejo de videos
															if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
																{
																	if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																		{
																			mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																		}
																	if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																		{
																			//se copia
																			$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																			
																			$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];																				
																																							
																			if (copy($fichero, $nuevo_fichero))
																				{
																					$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																				}
																			else
																				{
																					$limagen = '';
																				}
																		}
																	else
																		{
																			$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																		}
																}	
														 //fin del bloque de manejo de videos	
														}	
													
												}
											}
									
										}
								
									else
								
									{
										if ($vlaext[0] == 'tif' or $vlaext[0] == 'tiff')
											{
									
												if (!file_exists($ruta_temp.$vlasimg[0].'_.jpg'))
													{
														$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
															
														exec($command);
															
														$limagen = $vlasimg[0].'_.jpg';
													}
												else
													{
														$limagen = $vlasimg[0].'_.jpg';
													}
											}
										else
											{
													
												if ($vlaext[0] == 'jpg' or $vlaext[0] == 'png' or $vlaext[0] == 'bmp' or $vlaext[0] == 'gif')
													{
														$limagen = $vlasimg[0].'_.'.$vlaext[0];
													}
												else
													{
														if ($vlaext[0] == 'pdf')
															{
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																	{
																		mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																	}
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																	{
																		//se copia
																		$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																			
																		$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																			
																		if (copy($fichero, $nuevo_fichero))
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																			}
																		else
																			{
																				$limagen = '';
																			}
																	}
																else
																	{
																		$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																	}
															}
														else
															{
																 //para el manejo de videos
																	if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
																		{
																			if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																				{
																					mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																				}
																			if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																				{
																					//se copia
																					$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																					
																					$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																					
																					if (copy($fichero, $nuevo_fichero))
																						{
																							$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																						}
																					else
																						{
																							$limagen = '';
																						}
																				}
																			else
																				{
																					$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																				}
																		}
																	//fin del bloque de manejo de videos
																
															}	
													}
											}
									}
								}
								else
								{
									if ($vlaext[0] == 'zip')
									{
								
										//se abre el archivo $zip
								
										$extimg = '';
								
										$workspace = $espaciotrabajo;
								
										$rutadestino = '../img/apiimg/'.$workspace.'/';
								
										$destino = $rutadestino;
								
										$rutadestinozip = '/img/apiimg/'.$workspace.'/';
								
										$rutadestinozipc = '/img/apiimg/'.$workspace.'';
								
										//se crea la carpeta de destino si solo si no existe   $vlasimg[0].'_.'.$vlaext[0]
										if (!file_exists($destino))
											{
												mkdir($destino, 0777, true);
											}
								
										require_once('manejozip.php');
								
										$archivopadre = $ruta_bodega.$labodega['nombre'].'/'.$vlasimg[0].'_.'.$vlaext[0];
								
										$zip_manager = new Zip_manager();
								
										$resultado = $zip_manager->extraer($archivopadre, $destino);
								
										if ($resultado)
											{
									
												$archivo_zip = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
									
												$listado = $zip_manager->listar($archivopadre, $destino);
									
												$czip = 0;
									
												for ($iti = 0; $iti < count($listado); $iti++)
												{
													$czip = $czip + 1;
									
													if ($czip == 1)
													{
									
														//se separa la extension
														//echo $listado[$iti];
									
														$extimg = substr(strrchr($listado[$iti], "."),1);
									
														$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
									
														//se verifica que existe el archivo
									
														if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
															{
										
																$limagen = $rutadestinozip.$filename.'.'.$extimg;
										
															}
														else
															{
																if ($extimg == 'tif' or $extimg == 'tiff')
																	{
																		//se verifica que exista el jpg
																		//echo $rutadestinozip.$filename.'.jpg';
																		if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																			{
																				$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg'; //echo $command;
												
																				exec($command);
																			}
											
																		$limagen = $rutadestinozip.$filename.'_.jpg';
																	}
															}
														//$exte = $extimg;
														break;
													}
									
												}
									
											}
								
									}
								}
								//se coloca la imagen imgcentral
								
								if ($vlaext[0] != 'zip')
									{
											
										$conteoimg = 1;
											
										$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 100% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-orden="'.$lorden.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
									
										if ($vlaext[0] != 'pdf' and $vlaext[0] != 'mp4' and $vlaext[0] != 'm4v' and $vlaext[0] != 'webm') 
											{
												$script .= '<img id="image_central" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
											}
										else
											{
												if ($vlaext[0] == 'pdf') 
													{
														$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="1000" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
													}
												else
													{
														if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
															{
																$script .= '<video src="'.$limagen.'" controls>';
																$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																$script .= '</video>';
															}	
													}	
											}
										$script .= '</div>';
									
										$script .= '_;_'.'<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)" style="position:relative;margin-right:3%"></span>';
									
										$script .='_;_'.'<span id="num_imgcen" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'" style="position:relative;float:right;font-size:2em;padding-right:50%" class="iconoazul sombraiconobl img_listado">'.$vorden[0].'</span>';
									
										$script .= '_;_'.'<span valign="top" id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)" style="position:relative;"></span>';
									}
								else
								{
									if ($vlaext[0] == 'zip')
									{
										$conteoimg = 1;
											
										$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 100% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-orden="'.$lorden.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
								
										if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'tif' or $extimg == 'tiff' )
											{
												$script .= '<img id="image_central" src="'.$rutadir.$limagen.'" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
											}
										else
											{
												if ($extimg == 'pdf')
													{
														$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="1000" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
													}
												else
													{
														if ($extimg== 'mp4' or $extimg== 'm4v' or $extimg == 'webm')
															{
																$script .= '<video src="'.$limagen.'" controls>';
																$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																$script .= '</video>';
															}
													}	
											}
											
										$script .= '</div>';
											
										$script .= '_;_'.'<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)" style="position:relative;margin-right:3%"></span>';
											
										$script .='_;_'.'<span id="num_imgcen" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'" style="position:relative;float:right;font-size:2em;padding-right:50%" class="iconoazul sombraiconobl img_listado">'.$vorden[0].'</span>';
											
										$script .= '_;_'.'<span valign="top" id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)" style="position:relative;"></span>';
											
									}
								}
						}		
					else
						{
							if (trim($configdb[0]) == 'sqlsrv')
								{
										$queryids = sqlsrv_query($conn,$sql);
										
										$paranumreg = sqlsrv_query($conn,$sql);
										
										$numreg = 0;
										
										while( $row = sqlsrv_fetch_array( $paranumreg, SQLSRV_FETCH_ASSOC ))
											{
												$numreg =  $numreg + 1;
											}
											
											
										//buscamos el expediente
											
										$sql = "select id_expediente from sgd_documentos where id_documento = ".$iddocumento; 
											
										$queryexpe =  sqlsrv_query($conn,$sql);
										
										$idexpediente = 0;
										
										while( $idexpediente = sqlsrv_fetch_array( $queryexpe, SQLSRV_FETCH_ASSOC ))
											{
												if ($idexpediente['id_expediente'] > 0)
													{
														$ideexpe = $idexpediente['id_expediente'];   
													}	
											}	
											
										
										//cargo un arreglo con los nombres de las imagenes a trabajar
										
										unset($vlabodega);
										
										unset($vlasimg);
										
										unset($vlaext);
										
										unset($vorden);
										
										$script = '';
										
										$lasbodegas = '';
										
										$lasimg = '';
										
										$laext = '';
										
										$lorden = '';
										
										while( $campo2 = sqlsrv_fetch_array($queryids, SQLSRV_FETCH_ASSOC )) 
											{
													
												$vlabodega[] = $campo2['id_bodega'];
											
												$vorden[] = $campo2['orden'];
													
												$lorden .= $campo2['orden'].'_,_';
											
												$lasbodegas .= $campo2['id_bodega'].'_,_';
													
												$vlasimg[] = $campo2['id_imagendocum'];
													
												$lasimg .=  $campo2['id_imagendocum'].'_,_';
													
												$vlaext[] =  $campo2['extension'];
													
												$laext .= $campo2['extension'].'_,_';
													
											}
											
										//se monta la primera imagen para que se vea
										
										//buscamos la bodega respectiva
										
										$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$vlabodega[0];
										
										$queryidimg =  sqlsrv_query($conn,$sql);
										
										$labodega = sqlsrv_fetch_array($queryidimg, SQLSRV_FETCH_ASSOC);
																				
										//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
										
										if ($vlaext[0] != 'zip')
											{
										
												if (!file_exists($ruta_temp.$vlasimg[0].'_.'.$vlaext[0]))
													{
															
														//con encriptación
															
														inFTP($vlasimg[0].'_.'.$vlaext[0],$ruta_bodega.$labodega['nombre'],$ruta_temp,$kweyllave);
															
														if ($vlaext[0] == 'tif' or $vlaext[0] == 'tiff')
															{
																	
																$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
																	
																exec($command);
																	
																$limagen = $vlasimg[0].'_.jpg';
																	
															}
														else
															{
														
																if ($vlaext[0] == 'jpg' or $vlaext[0] == 'png' or $vlaext[0] == 'bmp' or $vlaext[0] == 'gif')
																	{
																		$limagen = $vlasimg[0].'_.'.$vlaext[0];
																	}
																else
																	{
																		if ($vlaext[0] == 'pdf')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																					{
																						//se copia
																						$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																	
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																																		
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																					}
																
																			}
																		else
																			{
																				//para el manejo de videos
																				if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
																					{
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																							{
																								mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																							}
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																							{
																								//se copia
																								$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																								
																								$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																								
																								if (copy($fichero, $nuevo_fichero))
																									{
																										$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																									}
																								else
																									{
																										$limagen = '';
																									}
																							}
																						else
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																							}
																					}
																					//fin del bloque de manejo de videos
																			}	
																	}
															}
													
													}
												
												else
												
													{
														if ($vlaext[0] == 'tif' or $vlaext[0] == 'tiff')
															{
															
																if (!file_exists($ruta_temp.$vlasimg[0].'_.jpg'))
																	{
																		$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
																
																		exec($command);
																
																		$limagen = $vlasimg[0].'_.jpg';
																	}
																else
																	{
																		$limagen = $vlasimg[0].'_.jpg';
																	}
															}
														else
															{
																	
																if ($vlaext[0] == 'jpg' or $vlaext[0] == 'png' or $vlaext[0] == 'bmp' or $vlaext[0] == 'gif')
																	{
																		$limagen = $vlasimg[0].'_.'.$vlaext[0];
																	}
																else
																	{
																		if ($vlaext[0] == 'pdf')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																					{
																						//se copia
																						$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																							
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																							
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																					}
																			}
																		else
																			{
																				//para el manejo de videos
																				if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
																					{
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																							{
																								mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																							}
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0]))
																							{
																								//se copia
																								$fichero = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																								
																								$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																								
																								if (copy($fichero, $nuevo_fichero))
																									{
																										$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																									}
																								else
																									{
																										$limagen = '';
																									}
																							}
																						else
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$vlasimg[0].'_.'.$vlaext[0];
																							}
																					}
																				//fin del bloque de manejo de videos
																			}	
																	}
															}
													}
											}
										else
											{
												if ($vlaext[0] == 'zip')
													{
														
														//se abre el archivo $zip
														
														$extimg = '';
														
														$workspace = $espaciotrabajo;
														
														$rutadestino = '../img/apiimg/'.$workspace.'/';
														
														$destino = $rutadestino;
														
														$rutadestinozip = '/img/apiimg/'.$workspace.'/';
														
														$rutadestinozipc = '/img/apiimg/'.$workspace.'';
														
														//se crea la carpeta de destino si solo si no existe   $vlasimg[0].'_.'.$vlaext[0]
														if (!file_exists($destino))
															{
																mkdir($destino, 0777, true);
															}
														
														require_once('manejozip.php');
														
														$archivopadre = $ruta_bodega.$labodega['nombre'].'/'.$vlasimg[0].'_.'.$vlaext[0];
														
														$zip_manager = new Zip_manager();
														
														$resultado = $zip_manager->extraer($archivopadre, $destino);
														
														if ($resultado)
															{
															
																$archivo_zip = $ruta_temp.$vlasimg[0].'_.'.$vlaext[0];
																	
																$listado = $zip_manager->listar($archivopadre, $destino);
																	
																$czip = 0;
																	
																for ($iti = 0; $iti < count($listado); $iti++)
																	{
																		$czip = $czip + 1;
																
																		if ($czip == 1)
																			{
																	
																				//se separa la extension
																				//echo $listado[$iti];
																	
																				$extimg = substr(strrchr($listado[$iti], "."),1);
																	
																				$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));    
																	
																				//se verifica que existe el archivo
																	
																				if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm') 
																					{
																		 
																						$limagen = $rutadestinozip.$filename.'.'.$extimg;
																		
																					}
																				else
																					{
																						if ($extimg == 'tif' or $extimg == 'tiff')
																							{
																								//se verifica que exista el jpg
																								//echo $rutadestinozip.$filename.'.jpg';
																								if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																									{
																										$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg'; //echo $command;
																				
																										exec($command);
																									}
																									
																								$limagen = $rutadestinozip.$filename.'_.jpg';
																							}
																					}
																				//$exte = $extimg;
																				break;
																			}
																
																	}
																	
															}
														
													}	
											}	
											//se coloca la imagen imgcentral
											
											if ($vlaext[0] != 'zip')
												{
													
													$conteoimg = 1;
													
													$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 100% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-orden="'.$lorden.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
													
													if ($vlaext[0] != 'pdf' and $vlaext[0] != 'mp4' and $vlaext[0] != 'm4v' and $vlaext[0] != 'webm')
														{
															$script .= '<img id="image_central" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
														}
													else
														{
															if ($vlaext[0] == 'pdf')
																{
																	$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="1000" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
																}
															else
																{
																	if ($vlaext[0] == 'mp4' or $vlaext[0] == 'm4v' or $vlaext[0] == 'webm')
																		{
																			$script .= '<video src="'.$limagen.'" controls>';
																			$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																			$script .= '</video>';
																		}
																}
														}
													$script .= '</div>';
													
													$script .= '_;_'.'<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)" style="position:relative;margin-right:3%"></span>';
													
													$script .='_;_'.'<span id="num_imgcen" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'" style="position:relative;float:right;font-size:2em;padding-right:50%" class="iconoazul sombraiconobl img_listado">'.$vorden[0].'</span>';
													
													$script .= '_;_'.'<span valign="top" id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)" style="position:relative;"></span>';
												}
											else
												{
													if ($vlaext[0] == 'zip')
														{
															$conteoimg = 1;
															
															$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 100% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-orden="'.$lorden.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
															
															if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'tif' or $extimg == 'tiff' )
																{
																	$script .= '<img id="image_central" src="'.$rutadir.$limagen.'" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
																}
															else
																{
																	if ($extimg == 'pdf')
																		{
																			$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="tiraimg" height="1000" width="80%" data-bod="'.$campo2['id_bodega'].'" data-ordenimg="'.$campo2['orden'].'" data-d="'.$campo2['id_documento'].'" data-1="'.$campo2['id_imagendocum'].'"  data-2="'.$campo2['extension'].'" data-num="'.$conteoimg.'"></iframe>';
																		}
																	else
																		{
																			if ($extimg== 'mp4' or $extimg== 'm4v' or $extimg == 'webm')
																				{
																					$script .= '<video src="'.$limagen.'" controls>';
																					$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																					$script .= '</video>';
																				}
																		}
																}
															
															$script .= '</div>';
															
															$script .= '_;_'.'<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)" style="position:relative;margin-right:3%"></span>';
															
															$script .='_;_'.'<span id="num_imgcen" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'" style="position:relative;float:right;font-size:2em;padding-right:50%" class="iconoazul sombraiconobl img_listado">'.$vorden[0].'</span>';
															
															$script .= '_;_'.'<span valign="top" id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)" style="position:relative;"></span>';
															
														}
												}
								}	
						}	
					}
				echo $script;
			break;	
			
			case 'dameimagenescentrofullexp':
				$idexpediente = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$anc = isset($_GET['anc']) && $_GET['anc'] !== '#' ? (int)$_GET['anc'] : 0;
				
				$conteoimg = 0;
				
				//$sql = "select  ";
				
				
				$sql ="select i.id_imagendocum,i.nombre,i.extension,i.id_bodega,i.id_documento from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_expediente = ".$idexpediente." order by i.orden asc";
				
				//echo $sql;
				
				if ($configdb[0] == 'mysql')
					{
						$queryids =  mysql_query($sql,$conn);
							
						$numreg = mysql_num_rows($queryids);
							
						//buscamos el expediente
							
						$sql = "select id_expediente from sgd_documentos where id_documento = ".$iddocumento;
							
						$queryexpe =  mysql_query($sql,$conn);
							
						$idexpediente = mysql_fetch_assoc($queryexpe);
							
						$idexpediente = $idexpediente['id_expediente'];
					
						//cargo un arreglo con los nombres de las imagenes a trabajar
					
						unset($vlabodega);
					
						unset($vlasimg);
					
						unset($vlaext);
					
						$script = '';
					
						$lasbodegas = '';
					
						$lasimg = '';
					
						$laext = '';
					
						while($campo2 = mysql_fetch_array($queryids))
							{
						
								$vlabodega[] = $campo2['id_bodega'];
						
								$lasbodegas .= $campo2['id_bodega'].'_,_';
						
								$vlasimg[] = $campo2['id_imagendocum'];
						
								$lasimg .=  $campo2['id_imagendocum'].'_,_';
						
								$vlaext[] =  $campo2['extension'];
						
								$laext .= $campo2['extension'].'_,_';
						
							}
							
						//se monta la primera imagen para que se vea
					
						//buscamos la bodega respectiva
					
						$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$vlabodega[0];
					
						$queryidimg =  mysql_query($sql,$conn);
					
						$labodega = mysql_fetch_assoc($queryidimg);
					
						//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
					
						if (!file_exists($ruta_temp.$vlasimg[0].'_.'.$vlaext[0]))
							{
								
						
								//con encriptación
						
								inFTP($vlasimg[0].'_.'.$vlaext[0],$ruta_bodega.$labodega['nombre'],$ruta_temp,$kweyllave);
						
								if ($vlaext[0] == 'tif' or $vlaext['extension'] == 'tiff')
									{
											
										$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
											
										exec($command);
											
										$limagen = $vlasimg[0].'_.jpg';
											
									}
								else
									{
											
										$limagen = $vlasimg[0].'_.'.$vlaext[0];
											
									}
									
							}							
						else							
							{
								if ($vlaext[0] == 'tif' or $vlaext['extension'] == 'tiff')
									{
											
										$limagen = $vlasimg[0].'_.jpg';
									}
								else
									{
							
										$limagen = $vlasimg[0].'_.'.$vlaext[0];
									}
							}
					
						//se coloca la imagen imgcentral
					
						$conteoimg = 1;
							
						//glyphicon glyphicon-forward
							
							
						$script .= '<table width="100%" border="0">';
							
						$script .= '<tr>';
							
						if ($anc > 0)
							{
						
								$script .= '<td style="text-align:center;" id="retro" width="'.$anc.'%">';
							}
						else
							{
								$script .= '<td style="text-align:center;" id="retro" >';
							}
					
							
						$script .= '<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)"></span>';
					
						$script .= '</td>';
							
						$script .= '<td width="100%">'; //$_SESSION['espaciotrabajo']
							
						$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 50% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
							
						$script .= '<img id="image_'.$vlasimg[0].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="100%" max-width="100%" style="cursor:pointer">';
							
						$script .= '</div>';
							
						$script .= '</td>';
							
						$script .= '<td style="text-align:center;" id="avant">';
							
						//$script .= '<li >';
					
						$script .= '<span id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)"></span>';
					
						//$script .= '<li>';
							
						$script .= '</td>';
							
						$script .= '</tr>';
						
						$script .= '</table>';
					}
				else
				{
					if ($configdb[0] == 'pgsql')
					{
						$queryids = pg_query($conn,$sql);
							
						$numreg = pg_num_rows($queryids);
							
						//buscamos el expediente
							
						$sql = "select id_expediente from sgd_documentos where id_documento = ".$iddocumento;
							
						$queryexpe =  pg_query($conn,$sql);
							
						$idexpediente = pg_fetch_assoc($queryexpe);
							
						$idexpediente = $idexpediente['id_expediente'];
				
						//cargo un arreglo con los nombres de las imagenes a trabajar
				
						unset($vlabodega);
				
						unset($vlasimg);
				
						unset($vlaext);
				
						$script = '';
				
						$lasbodegas = '';
				
						$lasimg = '';
				
						$laext = '';
				
						while($campo2 = pg_fetch_array($queryids))
							{
									
								$vlabodega[] = $campo2['id_bodega'];
									
								$lasbodegas .= $campo2['id_bodega'].'_,_';
									
								$vlasimg[] = $campo2['id_imagendocum'];
									
								$lasimg .=  $campo2['id_imagendocum'].'_,_';
									
								$vlaext[] =  $campo2['extension'];
									
								$laext .= $campo2['extension'].'_,_';
									
							}
							
						//se monta la primera imagen para que se vea
				
						//buscamos la bodega respectiva
				
						$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$vlabodega[0];
				
						$queryidimg =  pg_query($conn,$sql);
				
						$labodega = pg_fetch_assoc($queryidimg);
				
						//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
				
						if (!file_exists($ruta_temp.$vlasimg[0].'_.'.$vlaext[0]))
						{
							
							//con encriptación
								
							inFTP($vlasimg[0].'_.'.$vlaext[0],$ruta_bodega.$labodega['nombre'],$ruta_temp,$kweyllave);
								
							if ($vlaext[0] == 'tif' or $vlaext['extension'] == 'tiff')
								{
					
									$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
					
									exec($command);
					
									$limagen = $vlasimg[0].'_.jpg';
					
								}
							else
								{
					
									$limagen = $vlasimg[0].'_.'.$vlaext[0];
					
								}
				
						}
							
						else
							
						{
							if ($vlaext[0] == 'tif' or $vlaext['extension'] == 'tiff')
							{
									
								$limagen = $vlasimg[0].'_.jpg';
							}
							else
							{
				
								$limagen = $vlasimg[0].'_.'.$vlaext[0];
							}
						}
				
						//se coloca la imagen imgcentral
				
						$conteoimg = 1;
							
						//glyphicon glyphicon-forward
							
							
						$script .= '<table width="100%" border="0">';
							
						$script .= '<tr>';
							
						if ($anc > 0)
						{
				
							$script .= '<td style="text-align:center;" id="retro" width="'.$anc.'%">';
						}
						else
						{
							$script .= '<td style="text-align:center;" id="retro" >';
						}
				
							
						$script .= '<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)"></span>';
				
						$script .= '</td>';
							
						$script .= '<td width="100%">'; //$_SESSION['espaciotrabajo']
							
						$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 50% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
							
						$script .= '<img id="image_'.$vlasimg[0].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="100%" max-width="100%" style="cursor:pointer">';
							
						$script .= '</div>';
							
						$script .= '</td>';
							
						$script .= '<td style="text-align:center;" id="avant">';
							
						//$script .= '<li >';
				
						$script .= '<span id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)"></span>';
				
						//$script .= '<li>';
							
						$script .= '</td>';
							
						$script .= '</tr>';
						
						$script .= '</table>';
					}
				else 
					{
						if (trim($configdb[0]) == 'sqlsrv')
							{
								$queryidocs = sqlsrv_query($conn,$sql);
								
								$queryids = sqlsrv_query($conn,$sql);
								
								$queryids2 = sqlsrv_query($conn,$sql);
								
								while( $row = sqlsrv_fetch_array( $queryidocs, SQLSRV_FETCH_ASSOC ))
									{
										$iddocumento = $row['id_documento'];
									}
								
								$numreg = 0;
								
								while( $row = sqlsrv_fetch_array( $queryids2, SQLSRV_FETCH_ASSOC ))
									{
										$numreg = $numreg + 1;
									}
									
								//buscamos el expediente
									
								$sql = "select id_expediente from sgd_documentos where id_documento = ".$iddocumento;
									
								$queryexpe =  sqlsrv_query($conn,$sql);
								
								while( $row = sqlsrv_fetch_array( $queryexpe, SQLSRV_FETCH_ASSOC ))
									{
										$idexpediente = $row['id_expediente'];
									}								
								
								//cargo un arreglo con los nombres de las imagenes a trabajar
								
								unset($vlabodega);
								
								unset($vlasimg);
								
								unset($vlaext);
								
								$script = '';
								
								$lasbodegas = '';
								
								$lasimg = '';
								
								$laext = '';
								
								while( $campo2 = sqlsrv_fetch_array( $queryids, SQLSRV_FETCH_ASSOC )) 
									{
									
										$vlabodega[] = $campo2['id_bodega'];
									
										$lasbodegas .= $campo2['id_bodega'].'_,_';
									
										$vlasimg[] = $campo2['id_imagendocum'];
									
										$lasimg .=  $campo2['id_imagendocum'].'_,_';
									
										$vlaext[] =  $campo2['extension'];
									
										$laext .= $campo2['extension'].'_,_';
									
									}
									
								//se monta la primera imagen para que se vea
								
								//buscamos la bodega respectiva
								
								$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$vlabodega[0];
								
								$queryidimg =  sqlsrv_query($conn,$sql);
								
								while( $row = sqlsrv_fetch_array( $queryidimg, SQLSRV_FETCH_ASSOC ))
									{
										$labodega = $row['nombre'];
									}
								
								//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
								
								if (!file_exists($ruta_temp.$vlasimg[0].'_.'.$vlaext[0]))
									{
											
										//con encriptación
									
										inFTP($vlasimg[0].'_.'.$vlaext[0],$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
									
										if ($vlaext[0] == 'tif' or $vlaext['extension'] == 'tiff')
											{
													
												$command = "convert ".$ruta_temp.$vlasimg[0].'_.'.$vlaext[0].' '.$ruta_temp.$vlasimg[0].'_.jpg';
													
												exec($command);
													
												$limagen = $vlasimg[0].'_.jpg';
													
											}
										else
											{
													
												$limagen = $vlasimg[0].'_.'.$vlaext[0];
													
											}
									
									}
									
								else
									
									{
										if ($vlaext[0] == 'tif' or $vlaext['extension'] == 'tiff')
											{
													
												$limagen = $vlasimg[0].'_.jpg';
											}
										else
											{
										
												$limagen = $vlasimg[0].'_.'.$vlaext[0];
											}
									}
								
								//se coloca la imagen imgcentral
								
								$conteoimg = 1;
									
								//glyphicon glyphicon-forward
									
									
								$script .= '<table width="100%" border="0">';
									
								$script .= '<tr>';
									
								if ($anc > 0)
									{
									
										$script .= '<td style="text-align:center;" id="retro" width="'.$anc.'%">';
									}
								else
									{
										$script .= '<td style="text-align:center;" id="retro" >';
									}
								
									
								$script .= '<span id="retrocedeimgico" class="glyphicon glyphicon-backward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(2)"></span>';
								
								$script .= '</td>';
									
								$script .= '<td width="100%">'; //$_SESSION['espaciotrabajo']
									
								$script .= '<div id="imagen_visual" class="carousel-inner" style="width: 50% !important;margin: 0 auto !important;" data-bod="'.$lasbodegas.'" data-img="'.$lasimg.'" data-ext="'.$laext.'" data-imgact="0" data-d="'.$iddocumento.'" data-numimg="'.$numreg.'" data-exp="'.$idexpediente.'">';
									
								$script .= '<img id="image_'.$vlasimg[0].'" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$vlasimg[0].'"  data-2="'.$vlaext[0].'" class="sb-toggle-right imgcentral" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$conteoimg.'" alt="" width="100%" max-width="100%" style="cursor:pointer">';
									
								$script .= '</div>';
									
								$script .= '</td>';
									
								$script .= '<td style="text-align:center;" id="avant">';
									
								//$script .= '<li >';
								
								$script .= '<span id="avanzarimgico" class="glyphicon glyphicon-forward sombraicono iconoazul tam32 clickble" onclick="avanzarimg(1)"></span>';
								
								//$script .= '<li>';
									
								$script .= '</td>';
									
								$script .= '</tr>';
								
								$script .= '</table>';
							}	
					}	
				}
				echo $script;
				
			break;
			
			case 'dameimagenescentsigatras':
				
				$iddocumento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$idexpediente = isset($_GET['expe']) && $_GET['expe'] !== '#' ? (int)$_GET['expe'] : 0;				
				
				$bodega = isset($_GET['bodegas']) && $_GET['bodegas'] !== '#' ? (int)$_GET['bodegas'] : 0;
				
				$posiimg = isset($_GET['posiimg']) && $_GET['posiimg'] !== '#' ? (int)$_GET['posiimg'] : 0;
				
				$dir = isset($_GET['dir']) && $_GET['dir'] !== '#' ? (int)$_GET['dir'] : 0;
								
				$img = isset($_GET['img']) && $_GET['img'] !== '' ? $_GET['img'] : '';
				
				$exte = isset($_GET['exte']) && $_GET['exte'] !== '' ? $_GET['exte'] : '';	
				
				$orden = isset($_GET['orde']) && $_GET['orde'] !== '' ? $_GET['orde'] : '';
				
				$espaciotrabajo = $_REQUEST['workspace']; //$_SESSION['espaciotrabajo'];
				
				$idusuario = $_SESSION['elidusuario'];
				
				$rutadir =  darurl();
				
				//buscamos la bodega respectiva
				
				$sql = 'select nombre from sgd_bodegas  where id_bodega = '.$bodega;
				
				if ($configdb[0] == 'mysql')
					{
				
						$queryidimg =  mysql_query($sql,$conn);
						
						$labodega = mysql_fetch_assoc($queryidimg);
						
						//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
						
						if (!file_exists($ruta_temp.$img.'_.'.$exte))
							{
								if ($exte != 'zip')
									{
										//con encriptación
											
										inFTP($img.'_.'.$exte,$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
								
										if ($exte == 'tif' or $exte== 'tiff')
											{
									
												$command = "convert ".$ruta_temp.$img.'_.'.$exte.' '.$ruta_temp.$img.'_.jpg';
									
												exec($command);
									
												$limagen = $img.'_.jpg';
									
											}
										else
											{
												if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif')
													{
															
														$limagen = $img.'_.'.$exte;
															
													}
												else
													{
														if ($exte == 'pdf')
															{
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																	{
																		mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																	}
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																	{
																		//se copia
																		$fichero = $ruta_temp.$img.'_.'.$exte;
																			
																		$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			
																		if (copy($fichero, $nuevo_fichero))
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			}
																		else
																			{
																				$limagen = '';
																			}
																	}
																else
																	{
																		$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																	}
															}
														else
															{
																//para el manejo de videos
																if ($exte== 'mp4' or $exte== 'm4v' or $exte== 'webm')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																			{
																				//se copia
																				$fichero = $ruta_temp.$img.'_.'.$exte;
																				
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																				
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			}
																	}
																	//fin del bloque de manejo de videos	
															}	
													}
											}
									}
								else
									{
										if ($exte == 'zip')
											{
												//se abre el archivo $zip
									
												$extimg = '';
									
												$workspace = $espaciotrabajo;
									
												$rutadestino = '../img/apiimg/'.$workspace.'/';
									
												$destino = $rutadestino;
									
												$rutadestinozip = '/img/apiimg/'.$workspace.'/';
									
												//se crea la carpeta de destino si solo si no existe
												if (!file_exists($destino))
													{
														mkdir($destino, 0777, true);
													}
									
												require_once('manejozip.php');
									
												$archivopadre = $ruta_bodega.$labodega.'/'.$img.'_.'.$exte;
									
												$zip_manager = new Zip_manager();
									
												$resultado = $zip_manager->extraer($archivopadre, $destino);
													
												if ($resultado)
													{
										
														$archivo_zip = $ruta_temp.$img.'_.'.$exte;
															
														$listado = $zip_manager->listar($archivopadre, $destino);
															
														$czip = 0;
															
														for ($iti = 0; $iti < count($listado); $iti++)
															{
																$czip = $czip + 1;
											
																if ($czip == 1)
																	{
												
																		//se separa la extension
																		$extimg = substr(strrchr($listado[$iti], "."),1);
												
																		$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
												
																		//se verifica que existe el archivo
												
																		if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
																			{
													
																				$limagen = $rutadestinozip.$filename.'.'.$extimg;
													
																			}
																		else
																			{
																				if ($extimg == 'tif' or $extimg == 'tiff')
																					{
																						//se verifica que exista el jpg
																						if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																							{
																								$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg'; //echo $command;
															
																								exec($command);
																							}
																							
																						$limagen = $rutadestinozip.$filename.'_.jpg';
																					}
																			}
																			
																		break;
																	}
											
															}
															
													}
											}
									}
									
							}
						else							
							{
								if ($exte != 'zip')
									{
										if ($exte == 'tif' or $exte == 'tiff')
											{
													
												if (!file_exists($ruta_temp.$img.'_.jpg'))
													{
														$command = "convert ".$ruta_temp.$img.'_.'.$exte.' '.$ruta_temp.$img.'_.jpg';
											
														exec($command);
											
														$limagen = $img.'_.jpg';
													}
												else
													{
														$limagen = $img.'_.jpg';
													}
											}
										else
											{
													
												if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif')
													{
															
														$limagen = $img.'_.'.$exte;
															
													}
												else
													{
														if ($exte == 'pdf')
															{
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																	{
																		mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																	}
																if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																	{
																		//se copia
																		$fichero = $ruta_temp.$img.'_.'.$exte;
																			
																		$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			
																		if (copy($fichero, $nuevo_fichero))
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			}
																		else
																			{
																				$limagen = '';
																			}
																	}
																else
																	{
																		$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																	}
															}
														else
															{
																if ($exte == 'mp4' or $exte == 'm4v' or $exte == 'webm')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																			{
																				//se copia
																				$fichero = $ruta_temp.$img.'_.'.$exte;
																				
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																				
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			}
																	}	
															}
													}
											}
									}	
								else
									{
										if ($exte == 'zip')
											{
												
												//se abre el archivo $zip
												
												$workspace = $espaciotrabajo;
												
												$rutadestino = '../img/apiimg/'.$workspace.'/';
												
												$destino = $rutadestino;
												
												$rutadestinozip = '/img/apiimg/'.$workspace.'/';
												
												//se crea la carpeta de destino si solo si no existe
												if (!file_exists($destino))
													{
														mkdir($destino, 0777, true);
													}
												
												require_once('manejozip.php');
												
												$archivopadre = $ruta_bodega.$labodega.'/'.$img.'_.'.$exte;
												
												$zip_manager = new Zip_manager();
												
												$resultado = $zip_manager->extraer($archivopadre, $destino);
												
												if ($resultado)
													{
														
														$archivo_zip = $ruta_temp.$img.'_.'.$exte;
														
														$listado = $zip_manager->listar($archivopadre, $destino);
														
														//se busca el primer archivo de la lista
														$czip = 0;
														
														for ($iti = 0; $iti < count($listado); $iti++)
															{
																$czip = $czip + 1;
																
																if ($czip == 1)
																	{
																		
																		//se separa la extension
																		//echo $listado[$iti];
																		
																		$extimg = substr(strrchr($listado[$iti], "."),1);
																		
																		$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																		
																		//se verifica que existe el archivo
																		
																		if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
																			{
																				
																				$limagen = $rutadestinozip.$filename.'.'.$extimg;
																				
																			}
																		else
																			{
																				if ($extimg == 'tif' or $extimg == 'tiff')
																					{
																						//se verifica que exista el jpg
																						
																						if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																							{
																								$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg';
																								
																								exec($command);
																							}
																						
																						$limagen = $rutadestinozip.$filename.'_.jpg';
																					}
																			}
																		
																		break;
																	}
																
															}
														
													}
												
											}//fin del si es zip
									}	
							
						}
						
						if ($dir == '1')
							{
								$conteoimg = $posiimg + 1;
							}
						else
							{
								if ($dir == '2')
									{
										$conteoimg = $posiimg - 1;
									}
							}
						
							if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif' or $exte == 'tif' or $exte == 'tiff') //$_SESSION['espaciotrabajo']
								{
									$script = '<img id="image_central" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$orden.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
								}
							else
								{
									if ($exte == 'pdf')
										{
											$script = '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="sb-toggle-right imgcentral tiraimg" height="1000" width="80%" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" data-exp="'.$idexpediente.'" data-num="'.$orden.'" ></iframe>';
										}
									else
										{
											if ($exte == 'mp4' or  $exte == 'm4v' or $exte == 'webm')
												{
													$script = '<video src="'.$limagen.'" controls>';
													$script .= 'Tu navegador no soporta el elemento <code>video</code>';
													$script .= '</video>';
												}
											else
												{
													if ($exte == 'zip')
														{
															if ($extimg == 'pdf')
																{
																	$script = '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="sb-toggle-right imgcentral tiraimg" height="1000" width="80%" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" data-exp="'.$idexpediente.'" data-num="'.$orden.'" ></iframe>';
																}
															else
																{
																	if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'tif' or $extimg == 'tiff')
																		{
																			$script = '<img id="image_central" src="'.$rutadir.$limagen.'" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" width="80%" max-width="100%" data-num="'.$orden.'" alt=""  style="position:relative;left:5%;cursor:pointer;z-index:99;">';
																		}
																	else
																		{
																			if ($extimg== 'mp4' or  $extimg== 'm4v' or $extimg== 'webm')
																				{
																					$script = '<video src="'.$limagen.'" controls>';
																					$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																					$script .= '</video>';
																				}
																		}
																}
														}
												}
											
											
										}
								}
					}//fin de si es mysql
				else 
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryidimg =  pg_query($conn,$sql);
								
								$labodega = pg_fetch_assoc($queryidimg);
								
								//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
								
								if (!file_exists($ruta_temp.$img.'_.'.$exte))
									{
										if ($exte != 'zip')
											{
												//con encriptación
													
												inFTP($img.'_.'.$exte,$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
										
												if ($exte == 'tif' or $exte== 'tiff')
													{
											
														$command = "convert ".$ruta_temp.$img.'_.'.$exte.' '.$ruta_temp.$img.'_.jpg';
											
														exec($command);
											
														$limagen = $img.'_.jpg';
											
													}
												else
													{
														if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif')
															{
																	
																$limagen = $img.'_.'.$exte;
																	
															}
														else
															{
																if ($exte == 'pdf')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																			{
																				//se copia
																				$fichero = $ruta_temp.$img.'_.'.$exte;
																					
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																					
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			}
																	}
																else
																	{
																		//para el manejo de videos
																		if ($exte== 'mp4' or $exte== 'm4v' or $exte== 'webm')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																					{
																						//se copia
																						$fichero = $ruta_temp.$img.'_.'.$exte;
																						
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																						
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																					}
																			}
																		//fin del bloque de manejo de videos	
																	}	
															}
													}
											}
										else
											{
												if ($exte == 'zip')
													{
														//se abre el archivo $zip
											
														$extimg = '';
											
														$workspace = $espaciotrabajo;
											
														$rutadestino = '../img/apiimg/'.$workspace.'/';
											
														$destino = $rutadestino;
											
														$rutadestinozip = '/img/apiimg/'.$workspace.'/';
											
														//se crea la carpeta de destino si solo si no existe
														if (!file_exists($destino))
															{
																mkdir($destino, 0777, true);
															}
											
														require_once('manejozip.php');
											
														$archivopadre = $ruta_bodega.$labodega.'/'.$img.'_.'.$exte;
											
														$zip_manager = new Zip_manager();
											
														$resultado = $zip_manager->extraer($archivopadre, $destino);
															
														if ($resultado)
															{
												
																$archivo_zip = $ruta_temp.$img.'_.'.$exte;
																	
																$listado = $zip_manager->listar($archivopadre, $destino);
																	
																$czip = 0;
																	
																for ($iti = 0; $iti < count($listado); $iti++)
																	{
																		$czip = $czip + 1;
													
																		if ($czip == 1)
																			{
														
																				//se separa la extension
																				//echo $listado[$iti];
														
																				$extimg = substr(strrchr($listado[$iti], "."),1);
														
																				$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));   
														
																				//se verifica que existe el archivo
														
																				if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
																					{
															
																						$limagen = $rutadestinozip.$filename.'.'.$extimg;
															
																					}
																				else
																					{
																						if ($extimg == 'tif' or $extimg == 'tiff')
																							{
																								//se verifica que exista el jpg
																								
																								if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																									{
																										$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg'; //echo $command;
																	
																										exec($command);
																									}
																									
																								$limagen = $rutadestinozip.$filename.'_.jpg';
																							}
																					}
																					
																				break;
																			}
													
																	}
																	
															}
													}
											}
											
									}
								else
									{
										if ($exte != 'zip')
											{
												if ($exte == 'tif' or $exte == 'tiff')
													{
														
														if (!file_exists($ruta_temp.$img.'_.jpg'))
															{
																$command = "convert ".$ruta_temp.$img.'_.'.$exte.' '.$ruta_temp.$img.'_.jpg';
																
																exec($command);
																
																$limagen = $img.'_.jpg';
															}
														else
															{
																$limagen = $img.'_.jpg';
															}
													}
												else
													{
														
														if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif')
															{
																
																$limagen = $img.'_.'.$exte;
																
															}
														else
															{
																if ($exte == 'pdf')
																	{
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																			{
																				mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																			}
																		if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																			{
																				//se copia
																				$fichero = $ruta_temp.$img.'_.'.$exte;
																				
																				$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																				
																				if (copy($fichero, $nuevo_fichero))
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																					}
																				else
																					{
																						$limagen = '';
																					}
																			}
																		else
																			{
																				$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			}
																	}
																else
																	{
																		//para el manejo de videos
																		if ($exte== 'mp4' or $exte== 'm4v' or $exte== 'webm')
																			{
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																					{
																						mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																					}
																				if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																					{
																						//se copia
																						$fichero = $ruta_temp.$img.'_.'.$exte;
																						
																						$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																						
																						if (copy($fichero, $nuevo_fichero))
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																							}
																						else
																							{
																								$limagen = '';
																							}
																					}
																				else
																					{
																						$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																					}
																			}
																		//fin del bloque de manejo de videos
																	}
															}
													}
											}
										else 
											{
												if ($exte == 'zip')
												{
													
													//se abre el archivo $zip
													
													$workspace = $espaciotrabajo;
													
													$rutadestino = '../img/apiimg/'.$workspace.'/';
													
													$destino = $rutadestino;
													
													$rutadestinozip = '/img/apiimg/'.$workspace.'/';
													
													//se crea la carpeta de destino si solo si no existe
													if (!file_exists($destino))
														{
															mkdir($destino, 0777, true);
														}
													
													require_once('manejozip.php');
													
													$archivopadre = $ruta_bodega.$labodega.'/'.$img.'_.'.$exte;
													
													$zip_manager = new Zip_manager();
													
													$resultado = $zip_manager->extraer($archivopadre, $destino);
													
													if ($resultado)
														{
															
															$archivo_zip = $ruta_temp.$img.'_.'.$exte;
															
															$listado = $zip_manager->listar($archivopadre, $destino);
															
															//se busca el primer archivo de la lista
															$czip = 0;
															
															for ($iti = 0; $iti < count($listado); $iti++)
																{
																	$czip = $czip + 1;
																	
																	if ($czip == 1)
																		{
																			
																			//se separa la extension
																			$extimg = substr(strrchr($listado[$iti], "."),1);
																			
																			$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));   
																			
																			//se verifica que existe el archivo
																			
																			if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
																				{
																					
																					$limagen = $rutadestinozip.$filename.'.'.$extimg;
																					
																				}
																			else
																				{
																					if ($extimg == 'tif' or $extimg == 'tiff')
																						{
																							//se verifica que exista el jpg
																							//echo $rutadestinozip.$filename.'.jpg';
																							if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																								{
																									$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg'; //echo $command;
																									
																									exec($command);
																								}
																							
																							$limagen = $rutadestinozip.$filename.'_.jpg';
																						}
																				}
																			
																			//$exte = $extimg;
																			break;
																		}
																	
																}
															
														}
													
												}//fin del si es zip
											}	
										
									}
								
								if ($dir == '1')
									{
										$conteoimg = $posiimg + 1;
									}
								else
								{
									if ($dir == '2')
									{
										$conteoimg = $posiimg - 1;
									}
								}
								
									
								if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif' or $exte == 'tif' or $exte == 'tiff') //$_SESSION['espaciotrabajo']
									{
										$script = '<img id="image_central" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$orden.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
									}
								else
									{
										if ($exte == 'pdf')
											{
												$script = '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="sb-toggle-right imgcentral tiraimg" height="1000" width="80%" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" data-exp="'.$idexpediente.'" data-num="'.$orden.'" ></iframe>';
											}
										else
											{
												if ($exte == 'mp4' or  $exte == 'm4v' or $exte == 'webm')
													{
														$script = '<video src="'.$limagen.'" controls>';
														$script .= 'Tu navegador no soporta el elemento <code>video</code>';
														$script .= '</video>';	
													}	
												else 
													{
														if ($exte == 'zip')
															{
																if ($extimg == 'pdf')
																	{
																		$script = '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="sb-toggle-right imgcentral tiraimg" height="1000" width="80%" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" data-exp="'.$idexpediente.'" data-num="'.$orden.'" ></iframe>';
																	}
																else
																	{
																		if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'tif' or $extimg == 'tiff')
																			{
																				$script = '<img id="image_central" src="'.$rutadir.$limagen.'" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" width="80%" max-width="100%" data-num="'.$orden.'" alt=""  style="position:relative;left:5%;cursor:pointer;z-index:99;">';
																			}
																		else 
																			{
																				if ($extimg== 'mp4' or  $extimg== 'm4v' or $extimg== 'webm')
																					{
																						$script = '<video src="'.$limagen.'" controls>';
																						$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																						$script .= '</video>';
																					}	
																			}	
																	}
															}
													}
												
												
											}
									}
							}	//fin de si es pgsql
						else 
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{ 
										$queryidimg =  sqlsrv_query($conn,$sql);
										
										while( $row = sqlsrv_fetch_array( $queryidimg, SQLSRV_FETCH_ASSOC ))
											{
												$labodega =  $row['nombre'];
											}
										
												//se verifica si en la carpeta visor existe el archivo del documento de no existeir se copia y se cambia de bin a la ext, que le corresponda
										
												if (!file_exists($ruta_temp.$img.'_.'.$exte))
													{
														if ($exte != 'zip')
															{  
																//con encriptación
															
																inFTP($img.'_.'.$exte,$ruta_bodega.$labodega,$ruta_temp,$kweyllave);
																
																if ($exte == 'tif' or $exte== 'tiff')
																	{
																
																		$command = "convert ".$ruta_temp.$img.'_.'.$exte.' '.$ruta_temp.$img.'_.jpg';
																
																		exec($command);
																
																		$limagen = $img.'_.jpg';
																
																	}
																else
																	{
																		if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif')
																			{
																	
																				$limagen = $img.'_.'.$exte;
																	
																			}
																		else
																			{
																				if ($exte == 'pdf')
																					{
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																							{
																								mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																							}
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																							{
																								//se copia
																								$fichero = $ruta_temp.$img.'_.'.$exte;
																			
																								$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																			
																								if (copy($fichero, $nuevo_fichero))
																									{
																										$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																									}
																								else
																									{
																										$limagen = '';
																									}
																							}
																						else
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																							}
																					}
																				else
																					{
																						if ($exte == 'mp4' or $exte == 'm4v' or $exte == 'webm')
																							{
																									if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																										{
																											mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																										}
																									if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																										{
																											//se copia
																											$fichero = $ruta_temp.$img.'_.'.$exte;
																											
																											$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																											
																											if (copy($fichero, $nuevo_fichero))
																												{
																													$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																												}
																											else
																												{
																													$limagen = '';
																												}
																										}
																									else
																										{
																											$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																										}
																							}
																					}	
																			}
																	}
															}
														else
															{
																if ($exte == 'zip')
																	{ 
																		//se abre el archivo $zip
																		
																		$extimg = '';
																		
																		$workspace = $espaciotrabajo;
																		
																		$rutadestino = '../img/apiimg/'.$workspace.'/';
																		
																		$destino = $rutadestino;
																		
																		$rutadestinozip = '/img/apiimg/'.$workspace.'/';
																		
																		//se crea la carpeta de destino si solo si no existe
																		if (!file_exists($destino))
																			{
																				mkdir($destino, 0777, true);
																			}
																		
																		require_once('manejozip.php');
																		
																		$archivopadre = $ruta_bodega.$labodega.'/'.$img.'_.'.$exte;
																		
																		$zip_manager = new Zip_manager();
																		
																		$resultado = $zip_manager->extraer($archivopadre, $destino);
																															
																		if ($resultado)
																			{
																				
																				$archivo_zip = $ruta_temp.$img.'_.'.$exte;
																					
																				$listado = $zip_manager->listar($archivopadre, $destino);
																					
																				$czip = 0;
																					
																				for ($iti = 0; $iti < count($listado); $iti++)
																					{
																						$czip = $czip + 1;
																					
																						if ($czip == 1)
																							{
																						
																								//se separa la extension
																								//echo $listado[$iti];
																						
																								$extimg = substr(strrchr($listado[$iti], "."),1);
																						
																								$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																						
																								//se verifica que existe el archivo
																						
																								if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
																									{
																											
																										$limagen = $rutadestinozip.$filename.'.'.$extimg;
																							
																									}
																								else
																									{
																										if ($extimg == 'tif' or $extimg == 'tiff')
																											{
																												//se verifica que exista el jpg
																												if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																													{
																														$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg'; //echo $command;
																															
																														exec($command);
																													}
																													
																												$limagen = $rutadestinozip.$filename.'_.jpg';
																											}
																									}
																								//$exte = $extimg;
																								break;
																							}
																							
																					}
																					
																			}		
																	}	
															}	
													
													}
												else
													{
														if ($exte != 'zip')
															{
																if ($exte == 'tif' or $exte == 'tiff')
																	{
																	
																		if (!file_exists($ruta_temp.$img.'_.jpg'))
																			{
																				$command = "convert ".$ruta_temp.$img.'_.'.$exte.' '.$ruta_temp.$img.'_.jpg';
																		
																				exec($command);
																		
																				$limagen = $img.'_.jpg';
																			}
																		else
																			{
																				$limagen = $img.'_.jpg';
																			}
																	}
																else
																	{
																			
																		if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif')
																			{
																	
																				$limagen = $img.'_.'.$exte;
																	
																			}
																		else
																			{
																				if ($exte == 'pdf')
																					{
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																							{
																								mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																							}
																						if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																							{
																								//se copia
																								$fichero = $ruta_temp.$img.'_.'.$exte;
																									
																								$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																									
																								if (copy($fichero, $nuevo_fichero))
																									{
																										$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																									}
																								else
																									{
																										$limagen = '';
																									}
																							}
																						else
																							{
																								$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																							}
																					}
																				else
																					{
																						if ($exte == 'mp4' or $exte == 'm4v' or $exte == 'webm')
																							{
																								if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario))
																									{
																										mkdir("../img/descargas/".$espaciotrabajo."/".$idusuario, 0777, true);
																									}
																								if (!file_exists("../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte))
																									{
																										//se copia
																										$fichero = $ruta_temp.$img.'_.'.$exte;
																										
																										$nuevo_fichero = "../img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																										
																										if (copy($fichero, $nuevo_fichero))
																											{
																												$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																											}
																										else
																											{
																												$limagen = '';
																											}
																									}
																								else
																									{
																										$limagen = $rutadir."/img/descargas/".$espaciotrabajo."/".$idusuario."/".$img.'_.'.$exte;
																									}
																							}	
																					}		
																			}
																	}
															}	
														else 
															{
																if ($exte == 'zip')
																	{
																		
																		//se abre el archivo $zip
																		
																		$workspace = $espaciotrabajo;
																		
																		$rutadestino = '../img/apiimg/'.$workspace.'/';
																		
																		$destino = $rutadestino;
																		
																		$rutadestinozip = '/img/apiimg/'.$workspace.'/';
																		
																		//se crea la carpeta de destino si solo si no existe
																		if (!file_exists($destino))
																			{
																				mkdir($destino, 0777, true);
																			}
																		
																		require_once('manejozip.php');
																		
																		$archivopadre = $ruta_bodega.$labodega.'/'.$img.'_.'.$exte;   //echo $archivopadre;
																		
																		$zip_manager = new Zip_manager();
																		
																		$resultado = $zip_manager->extraer($archivopadre, $destino);
																		
																		if ($resultado)
																			{
																				
																				$archivo_zip = $ruta_temp.$img.'_.'.$exte;
																				
																				$listado = $zip_manager->listar($archivopadre, $destino);
																				
																				//se busca el primer archivo de la lista
																				$czip = 0;
																				
																				for ($iti = 0; $iti < count($listado); $iti++)
																					{
																						$czip = $czip + 1;
																						
																						if ($czip == 1)
																							{
																								
																								//se separa la extension
																								//echo $listado[$iti];
																								
																								$extimg = substr(strrchr($listado[$iti], "."),1);
																								
																								$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
																								
																								//se verifica que existe el archivo
																								
																								if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'pdf' or $extimg == 'mp4' or $extimg == 'm4v' or $extimg == 'webm')
																									{
																										
																										$limagen = $rutadestinozip.$filename.'.'.$extimg;
																										
																									}
																								else
																									{
																										if ($extimg == 'tif' or $extimg == 'tiff')
																											{
																												//se verifica que exista el jpg
																												if (!file_exists($rutadestinozip.$filename.'_.jpg'))
																													{
																														$command = "convert ".$rutadestino.$filename.'.'.$extimg.' '.$rutadestino.$filename.'_.jpg'; //echo $command;
																														
																														exec($command);
																													}
																												
																												$limagen = $rutadestinozip.$filename.'_.jpg';
																											}
																									}
																								
																								//$exte = $extimg;
																								break;
																							}
																						
																					}
																				
																			}
																		
																	}//fin del si es zip
															}	
														
													}
										
										if ($dir == '1')
											{
												$conteoimg = $posiimg + 1;
											}
										else
											{
												if ($dir == '2')
													{
														$conteoimg = $posiimg - 1;
													}
											}
										
											
										if ($exte == 'jpg' or $exte == 'png' or $exte == 'bmp' or $exte == 'gif' or $exte == 'tif' or $exte == 'tiff') 
											{
												$script = '<img id="image_central" src="'.$rutadir.'/'.$_REQUEST['workspace'].'/expedientes/'.$limagen.'/mostrar" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" data-num="'.$orden.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
											}
										else
											{
												if ($exte == 'pdf')
													{												
														$script = '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="sb-toggle-right imgcentral tiraimg" height="1000" width="80%" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" data-exp="'.$idexpediente.'" data-num="'.$orden.'" ></iframe>';
													}
												else
													{
														if ($exte == 'mp4' or  $exte == 'm4v' or $exte == 'webm')
															{
																$script = '<video src="'.$limagen.'" controls>';
																$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																$script .= '</video>';
															}
														else
															{
																if ($exte == 'zip')
																	{
																		if ($extimg == 'pdf')
																			{
																				$script = '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$limagen.'" class="sb-toggle-right imgcentral tiraimg" height="1000" width="80%" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" data-exp="'.$idexpediente.'" data-num="'.$orden.'" ></iframe>';
																			}	
																		else
																			{
																				if ($extimg == 'jpg' or $extimg == 'png' or $extimg == 'bmp' or $extimg == 'gif' or $extimg == 'tif' or $extimg == 'tiff')
																					{
																						$script = '<img id="image_central" src="'.$rutadir.$limagen.'" data-d="'.$iddocumento.'" data-1="'.$img.'"  data-2="'.$exte.'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$idexpediente.'" width="80%" max-width="100%" data-num="'.$orden.'" alt=""  style="position:relative;left:5%;cursor:pointer;z-index:99;">';
																					}	
																				else
																					{
																						if ($extimg == 'mp4' or  $extimg == 'm4v' or $extimg == 'webm')
																							{
																								$script = '<video src="'.$limagen.'" controls>';
																								$script .= 'Tu navegador no soporta el elemento <code>video</code>';
																								$script .= '</video>';
																							}
																					}	
																			}		
																	}	
															}	
														
														
													}
											}
									}	// fin de si es sqlserver
							}	
					}	
					
				echo $script;
			break;
			case 'descargartodo':
				$d1 = isset($_GET['d1']) && $_GET['d1'] !== '' ? $_GET['d1'] : '';
				
				$d2 = isset($_GET['d2']) && $_GET['d2'] !== '' ? $_GET['d2'] : '';    
				
				$iddocumento = isset($_GET['iddoc']) && $_GET['iddoc'] !== '#' ? (int)$_GET['iddoc'] : 0;
				
				$idusuario = isset($_GET['idusuario']) && $_GET['idusuario'] !== '#' ? (int)$_GET['idusuario'] : 0; 
				
				if (!file_exists("../img/descargas/".$dbname."/".$idusuario))
					{
						mkdir("../img/descargas/".$dbname."/".$idusuario, 0777, true);
					}
				if (!file_exists("../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.zip"))    //.pdf
					{
						unlink("../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.pdf");    ///_.pdf
						
						//se recorre y se arma el documento de pdf con todas las imagenes enviadas
						$d1 = explode('_;_',$d1);
						
						$d2 = explode('_;_',$d2);
						
						$command = "convert ";
						
						for ($i = 0; $i < count($d2); $i++) {
							 $command .= $ruta_temp.$d1[$i].'_.'.$d2[$i]." ";
						}
						
						$command .= " -density 72 ../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.pdf";     ///_.pdf
						
						exec($command);
					}
				else
					{
						unlink("../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.zip");    ///_.pdf
						
						unlink("../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.pdf");    ///_.pdf
						
						//se recorre y se arma el documento de pdf con todas las imagenes enviadas
						$d1 = explode('_;_',$d1);
						
						$d2 = explode('_;_',$d2);
						
						$command = "convert ";
						
						for ($i = 0; $i < count($d2); $i++) {
							$command .= $ruta_temp.$d1[$i].'_.'.$d2[$i]." ";
						}
						
						$command .= " -density 72 ../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.pdf";     //_.pdf
						
						exec($command);
						
					}	
				//se genera el archivo zip
					$zip = new ZipArchive();
					
					$filename = "../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.zip";
					
					if($zip->open($filename,ZIPARCHIVE::CREATE)===true) {
						$zip->addFile("../img/descargas/".$dbname."/".$idusuario."/Powerfiledoc_".$iddocumento."_.pdf");
						$zip->close();
						
						
					}
					
					
					
				//echo $command;
				
			break;
			case 'totalizarimg':
				$id_expediente = isset($_GET['id_expediente']) && $_GET['id_expediente'] !== '#' ? (int)$_GET['id_expediente'] : 0; 
				
				$sql = "select count(i.id_imagendocum) as timg from sgd_imagen_documento i, sgd_documentos d where i.id_documento = d.id_documento and d.id_expediente = ".$id_expediente;
				
				if ($configdb[0] == 'mysql')
					{
						$queryidoc =  mysql_query($sql,$conn);
						
						$totalimgh = mysql_fetch_assoc($queryidoc);
					}
				else
					{
						$queryidoc =  pg_query($conn,$sql);
						
						$totalimgh = pg_fetch_assoc($queryidoc);
					}
				echo $totalimgh['timg'];				
			break;	
			case 'limpiarlo':
				
				 $idusuario = isset($_GET['idusuario']) && $_GET['idusuario'] !== '#' ? (int)$_GET['idusuario'] : 0;
				 
				//se limpia la descargas
				 $ficherosEliminados = 0;
				 if (file_exists("../img/descargas/".$dbname."/".$idusuario))
				 	{
						 $dir = '../img/descargas/'.$dbname.'/'.$idusuario."/";
						 $handle = opendir("../img/descargas/".$dbname."/".$idusuario);
						 while ($file = readdir($handle)) {
							 if (is_file($dir.$file)) {
								 if (unlink($dir.$file) ){
								 $ficherosEliminados++;
							 	}
						 	}
						 }
				 	}	 
				 echo $ficherosEliminados;
				 
			break;	
			case 'dametabladeindices':
				
				$id_documento = isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$sql = "select vi.id_indice,vi.valor,i.nombre from sgd_valorindice vi,sgd_indices i where i.id_indice = vi.id_indice and vi.id_documento = ".$id_documento; //echo $sql;
				
				if ($configdb[0] == 'mysql')
					{
						$querytin =  mysql_query($sql,$conn);
						
						$numreg = mysql_num_rows($querytin);
						
						if ($numreg > 0)
							{
								
								$scriptventana = '<span style="font-size:1em"><strong>Archivo de Gesti&oacute;n</strong></span><br>';
								
								while($campotind = mysql_fetch_array($querytin))
									{
										$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campotind['nombre']).': </strong></span>'.utf8_encode($campotind['valor']).'<br>';
									}	
							}	
						else 
							{
							
								$scriptventana = '';
							
							}	
							
					}
				else 
					{
						if ($configdb[0] == 'pgsql')
							{
								$querytin =  pg_query($conn,$sql);
								
								$numreg = pg_num_rows($querytin);
								
								if ($numreg > 0)
									{
									
										$scriptventana = '<span style="font-size:1em"><strong>Archivo de Gesti&oacute;n</strong></span><br>';
									
										while($campotind = pg_fetch_array($querytin))
											{
												$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campotind['nombre']).': </strong></span>'.utf8_encode($campotind['valor']).'<br>';
											}
									}
									
								else
									{
											
										$scriptventana = '';
											
									}
							}	
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$querytin =  sqlsrv_query($conn,$sql);
										
										$numreg = sqlsrv_num_rows( $querytin );  
										
										if ($numreg > 0)
											{
													
												$scriptventana = '<span style="font-size:1em"><strong>Archivo de Gesti&oacute;n</strong></span><br>';
													
												while( $campotind = sqlsrv_fetch_array( $querytin, SQLSRV_FETCH_ASSOC ))   
													{
														$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campotind['nombre']).': </strong></span>'.utf8_encode($campotind['valor']).'<br>';
													}
											}
											
										else
											{
													
												$scriptventana = '';
													
											}
									}	
							}	
					}	
				
				echo $scriptventana;
			break;
			case 'dameiddocumento':
				
				$iddocumento = 0;
				
				$id_expediente = isset($_GET['id_expediente']) && $_GET['id_expediente'] !== '#' ? (int)$_GET['id_expediente'] : 0;
				
				$id_tipodoc = isset($_GET['id_tipodoc']) && $_GET['id_tipodoc'] !== '#' ? (int)$_GET['id_tipodoc'] : 0;
				
				$sql ="select id_documento from sgd_documentos  where id_tipodocumental = ".$id_tipodoc." and id_expediente = ".$id_expediente;
					
				if ($configdb[0] == 'mysql')
					{
						
						$queryidoc =  mysql_query($sql,$conn);
						
						$iddocumento = mysql_fetch_assoc($queryidoc);
						
					}
				else 
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryidoc =  pg_query($conn,$sql);
								
								$iddocumento = pg_fetch_assoc($queryidoc);
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$queryidoc =  sqlsrv_query($conn,$sql);
										
										$iddocumento =  sqlsrv_fetch_array( $queryidoc, SQLSRV_FETCH_ASSOC ); 
									}	
							}	
					}
				echo $iddocumento['id_documento'];	
			break;	
			
			case 'losindices':
				$d1 = isset($_GET['d1']) && $_GET['d1'] !== '' ? $_GET['d1'] : '';
				
				$d2 = isset($_GET['d2']) && $_GET['d2'] !== '' ? $_GET['d2'] : '';
				
				$iddocumento = isset($_GET['iddoc']) && $_GET['iddoc'] !== '#' ? (int)$_GET['iddoc'] : 0;
				
				$idusuario = isset($_GET['idusuario']) && $_GET['idusuario'] !== '#' ? (int)$_GET['idusuario'] : 0;
				
				///////
				//se buscan los datos de los indices para la imagen
				
				$script = '';
				$sql = "SELECT i.nombre,vi.valor FROM sgd_valorindice vi inner join sgd_indices i on vi.id_indice = i.id_indice WHERE id_documento = ".$iddocumento;
					
				if ($configdb[0] == 'mysql')
					{
						$queryindiceimg =  mysql_query($sql,$conn);
					
						$script .='<section id="datimg_'.$iddocumento.'" style="padding:1%">';
							
						$script .='<table width="80%" border="1" id="vertabla_'.$iddocumento.'" class="sombratabla" style="position:relative;left:3%">';
							
						$script .='<tr>';
						$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
						$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
						$script .='</tr>';
							
						while($campoimgin = mysql_fetch_array($queryindiceimg))
						{
					
							$script .='<tr>';
							$script .='<td>';
							$script .= utf8_encode($campoimgin['nombre']);
							$script .='</td>';
							$script .='<td>';
							$script .= utf8_encode($campoimgin['valor']);
							$script .='</td>';
							$script .='</tr>';
						}
					
						$script .='</table>';
					
						$script .='</section>';
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryindiceimg =  pg_query($conn,$sql);
								
								$scriptventana = '<span style="font-size:1em"><strong>'.$traduce->traduce('titimigesti').'</strong></span><br>';
								
								while($campoimgin = pg_fetch_array($queryindiceimg))
									{
										$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campoimgin['nombre']).': </strong></span>'.utf8_encode($campoimgin['valor']).'<br>';
									}
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$queryindiceimg =  sqlsrv_query($conn,$sql);
										
										$scriptventana = '<span style="font-size:1em"><strong>'.$traduce->traduce('titimigesti').'</strong></span><br>';
										
										while( $campoimgin = sqlsrv_fetch_array( $queryindiceimg, SQLSRV_FETCH_ASSOC ))   
											{
												$scriptventana .= '<span class="indicesub"><strong>'.utf8_encode($campoimgin['nombre']).': </strong></span>'.utf8_encode($campoimgin['valor']).'<br>';
											}
									}	
							}	
					}				
				echo $scriptventana;			
			break;
			case 'descargar':
										
				$d1 = isset($_GET['d1']) && $_GET['d1'] !== '' ? $_GET['d1'] : '';
				
				$d2 = isset($_GET['d2']) && $_GET['d2'] !== '' ? $_GET['d2'] : '';
				
				$iddocumento = isset($_GET['iddoc']) && $_GET['iddoc'] !== '#' ? (int)$_GET['iddoc'] : 0;
				
				$idusuario = isset($_GET['idusuario']) && $_GET['idusuario'] !== '#' ? (int)$_GET['idusuario'] : 0;
				
				//se crea la carpeta descargas 
				if (!file_exists("../img/descargas/".$dbname."/".$idusuario))
					{
						mkdir("../img/descargas/".$dbname."/".$idusuario, 0777, true);
					}
				
					
					if (!file_exists("../img/descargas/".$dbname."/".$idusuario."/Powerfile_".$d1."_.pdf"))
						{
							$command = "convert ".$ruta_temp.$d1.'_.'.$d2." -density 72 ../img/descargas/".$dbname."/".$idusuario."/Powerfile_".$d1."_.pdf";
							exec($command);
						}
						
				///////
				//se buscan los datos de los indices para la imagen
				
			 	$script = '';	
				$sql = "SELECT i.nombre,vi.valor FROM sgd_valorindice vi inner join sgd_indices i on vi.id_indice = i.id_indice WHERE id_documento = ".$iddocumento;
			
				if ($configdb[0] == 'mysql')
					{
						$queryindiceimg =  mysql_query($sql,$conn);
				
						$script .='<section id="datimg_'.$iddocumento.'" style="padding:1%">';
							
						$script .='<table width="80%" border="1" id="vertabla_'.$iddocumento.'" class="sombratabla" style="position:relative;left:3%">';
							
						$script .='<tr>';
						$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
						$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
						$script .='</tr>';
					
						while($campoimgin = mysql_fetch_array($queryindiceimg))
							{								
								
								$script .='<tr>';
								$script .='<td>';
								$script .= utf8_encode($campoimgin['nombre']);
								$script .='</td>';
								$script .='<td>';
								$script .= utf8_encode($campoimgin['valor']);
								$script .='</td>';
								$script .='</tr>';
							}
						
						$script .='</table>';
						
						$script .='</section>';
					}	
				else 
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryindiceimg =  pg_query($conn,$sql);
								
								$script .='<section id="datimg_'.$iddocumento.'" style="padding:1%">';
									
								$script .='<table width="80%" border="1" id="vertabla_'.$iddocumento.'" class="sombratabla" style="position:relative;left:3%">';
									
								$script .='<tr>';
								$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
								$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
								$script .='</tr>';
									
								while($campoimgin = pg_fetch_array($queryindiceimg))
								{
								
									$script .='<tr>';
									$script .='<td>';
									$script .= utf8_encode($campoimgin['nombre']);
									$script .='</td>';
									$script .='<td>';
									$script .= utf8_encode($campoimgin['valor']);
									$script .='</td>';
									$script .='</tr>';
								}
								
								$script .='</table>';
								
								$script .='</section>';
							}	
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$queryindiceimg =  sqlsrv_query($conn,$sql);
										
										$script .='<section id="datimg_'.$iddocumento.'" style="padding:1%">';
											
										$script .='<table width="80%" border="1" id="vertabla_'.$iddocumento.'" class="sombratabla" style="position:relative;left:3%">';
											
										$script .='<tr>';
										$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
										$script .='<th width="45%" style="background-color:#00A3B9">&nbsp;</th>';
										$script .='</tr>';
											
										while( $campoimgin = sqlsrv_fetch_array( $queryindiceimg, SQLSRV_FETCH_ASSOC )) 
											{
											
												$script .='<tr>';
												$script .='<td>';
												$script .= utf8_encode($campoimgin['nombre']);
												$script .='</td>';
												$script .='<td>';
												$script .= utf8_encode($campoimgin['valor']);
												$script .='</td>';
												$script .='</tr>';
											}
										
										$script .='</table>';
										
										$script .='</section>';
									}	
							}	
					}
						
						
						
				//copy($ruta_temp.$d1."_.".$d2,"../img/descargas/".$d1."_.".$d2);
				
				
				/*//echo $arch;
				header('Content-Description: File Transfer');
				header('Content-Type: application/octet-stream');
				header('Content-Disposition: attachment; filename='.basename($arch));
				header('Content-Transfer-Encoding: binary');
				header('Expires: 0');
				header('Cache-Control: must-revalidate');
				header('Pragma: public');
				header('Content-Length: ' . filesize($arch));
				ob_clean();
				flush();
				readfile($arch);*/
				
				
				echo $script;
			break;	
			
			
			/////   metodos del api de documentos ///////
			
			case 'grabastorage':
				
				$errors= array();
				
				$dimagenes = $_REQUEST['dimagenes'];  
				
				$dextensiones = $_REQUEST['dextensiones'];  
				
				$nombreb = $_REQUEST['nombreb'];    
				
				$workspace = $espaciotrabajo;
				
				$dimagenes = json_decode($dimagenes); 
				
				$dextensiones = json_decode($dextensiones); 
				
				/// se mueven todosd los archivos de esta carpeta al storage correspondiente
				
				for ($i = 0; $i < count($dimagenes); $i++) {
					
					$fichero = '../img/tempo/'.$workspace.'/'.$dimagenes[$i].'_.'.$dextensiones[$i];
					
					$nuevo_fichero = $ruta_bodega.$nombreb.'/'.$dimagenes[$i].'_.'.$dextensiones[$i]; 
					
					if (copy($fichero, $nuevo_fichero))
						{
							if ($dextensiones[$i] != 'dat' and $dextensiones[$i] != 'zip')
								{
									unlink($fichero);
								}	
						}
				}				
			break;
			
			case 'grabastoragezip':
				
				$errors= array();
				
				$nombearc= $_REQUEST['nombearc'];
				
				$extarc= $_REQUEST['extarc'];
				
				$nombreb = $_REQUEST['nombreb']; 
				
				$id_documento = $_REQUEST['id_documento'];  
				
				$workspace = $espaciotrabajo;
				
				$idimagenes = array();
				
				$dir = $ruta_bodega.$nombreb."/".$nombearc.'.'.$extarc;  
				
				$fichero = "../img/tempo/".$workspace.'/'.$nombearc.'.'.$extarc; 
				
				$ficherozip = $fichero;
								
				$nuevo_fichero = $ruta_bodega.$nombreb."/".$nombearc.'.'.$extarc;
								
				if (copy($fichero, $nuevo_fichero))
					{
						
						require_once('manejozip.php');
						
						$archivopadre = $ruta_bodega.$nombreb.'/'.$nombearc.'.'.$extarc;
						
						$destino = $ruta_bodega.$nombreb.'/';
						
						$zip_manager = new Zip_manager();
						
						$resultado = $zip_manager->extraer($archivopadre, $destino);
						
						if ($resultado)
							{
								$listado = $zip_manager->listar($archivopadre, $destino);
								
								$czip = 0;
								
								
								
								for ($iti = 0; $iti < count($listado); $iti++)
									{
										
										if ($configdb[0] == 'mysql')
											{
												//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
												
												$sql = 'select orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden desc limit 1';
												
												$qeryorden =  mysql_query($sql,$conn);
												
												$cuantoorden = mysql_num_rows($qeryorden);
												
												if ($cuantoorden > 0)
													{
														
														$orden = mysql_fetch_assoc($qeryorden);
														
														$norden = $orden['orden'];
														
														$norden = $norden + 1;
														
													}
												else
													{
														
														$norden = 0;
														
														$norden = $norden + 1;
														
													}	
											}
										else 
											{
												if ($configdb[0] == 'pgsql')
													{
														//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
														
														$sql = 'select orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden desc limit 1 OFFSET 0';
														
														$qeryorden =  pg_query($conn,$sql);
														
														$cuantoorden = pg_num_rows($qeryorden);
														
														if ($cuantoorden > 0)
															{
																
																$orden = pg_fetch_assoc($qeryorden);
																
																$norden = $orden['orden'];
																
																$norden = $norden + 1;
																
															}
														else
															{
																
																$norden = 0;
																
																$norden = $norden + 1;
																
															}
													}
												else
													{
														if (trim($configdb[0]) == 'sqlsrv')
															{
																
																$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden asc';
																
																$qeryorden =  sqlsrv_query($conn,$sql);
																
																$qeryorden2 = sqlsrv_query($conn,$sql);
																
																$cuantoorden = 0;
																
																while( $row = sqlsrv_fetch_array( $qeryorden, SQLSRV_FETCH_ASSOC ))
																	{
																		$cuantoorden = $cuantoorden + 1;
																	}
																
																if ($cuantoorden > 0)
																	{
																		
																		while( $row = sqlsrv_fetch_array( $qeryorden2, SQLSRV_FETCH_ASSOC ))
																			{
																				$norden = $row['orden'];
																			}
																		
																		$norden = $norden + 1;
																		
																	}
																else
																	{
																		
																		$norden = 0;
																		
																		$norden = $norden + 1;
																		
																	}
																
															}
													}
											}	
										
											$sql = 'select id_bodega,nombre,limite,actual from sgd_bodegas  where actual < limite ';
											
											if ($configdb[0] == 'mysql')
												{
													$qerybod =  mysql_query($sql,$conn);
													
													$haybodega = mysql_num_rows($qerybod);
													
													if ($haybodega == 0)
														{
															//se debe generar una bodega nueva
															//se verifica si es la primera bodega
															$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
															
															$qeryhabod =  mysql_query($sql,$conn);
															
															$cbod = mysql_num_rows($qeryhabod);
															
															if ($cbod == 0)
																{
																	//se genera la primera bodega
																	
																	$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
																	
																	$nombreb = 'Bodega_1';
																	
																	$limiteb = 1000;
																	
																	$actualb = 0;
																	
																	$queryids =  mysql_query($sql,$conn);
																	
																	//se captura el ultimo id registrado
																	$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
																	
																	$rs = mysql_fetch_assoc($rs);
																	
																	$idbodega = $rs["id"];
																	
																}
															else
																{
																	//se busca la ultima bodega para continuar el control
																	$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
																	
																	$qerybodega =  mysql_query($sql,$conn);
																	
																	$dbod = mysql_fetch_assoc($qerybodega);
																	
																	$dbod = $dbod['nombre'];
																	
																	$nombreb = explode("_".$dbod);
																	
																	$nombreb = ($nombreb[1]*1) + 1;
																	
																	$nombreb = 'Bodega_'.$nombreb;
																	
																	$limiteb = 1000;
																	
																	$actualb = 0;
																	
																	//se registra la nueva bodega
																	
																	$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
													VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
																	
																	$queryids =  mysql_query($sql,$conn);
																	
																	//se captura el ultimo id registrado
																	$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
																	
																	$rs = mysql_fetch_assoc($rs);
																	
																	$idbodega = $rs["id"];
																	
																}
															//se crea el nuevo directorioo de bodega
															$carpeta = $ruta_bodega.$nombreb;
															if (!file_exists($carpeta))
																{
																	mkdir($carpeta, 0777, true);
																}
														}
													else
														{	//existe una bodega desocupada
															
															$dbod = mysql_fetch_assoc($qerybod);
															
															$idbodega = $dbod['id_bodega'];
															
															$nombreb = $dbod['nombre'];
															
															$limiteb = $dbod['limite'];
															
															$actualb = $dbod['actual'];
															
														}
												}
											else
												{
													if ($configdb[0] == 'pgsql')
														{
															$qerybod = pg_query($conn,$sql);
															
															$haybodega = pg_num_rows($qerybod);
															
															if ($haybodega == 0)
																{
																	//se debe generar una bodega nueva
																	//se verifica si es la primera bodega
																	$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
																	
																	$qeryhabod = pg_query($conn,$sql);
																	
																	$cbod = pg_num_rows($qeryhabod);
																	
																	if ($cbod == 0)
																		{
																			//se genera la primera bodega
																			
																			$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																		VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
																			
																			$queryids = pg_query($conn,$sql);
																			
																			$resid = pg_fetch_array($queryids);
																			
																			$idbodega =  $resid[0];
																			
																			$nombreb = 'Bodega_1';
																			
																			$limiteb = 1000;
																			
																			$actualb = 0;
																			
																			
																			
																		}
																	else
																		{
																			//se busca la ultima bodega para continuar el control
																			$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
																			
																			$qerybodega =  pg_query($conn,$sql);
																			
																			$dbod = pg_fetch_assoc($qerybodega);
																			
																			$dbod = $dbod['nombre'];
																			
																			$nombreb = explode("_".$dbod);
																			
																			$nombreb = ($nombreb[1]*1) + 1;
																			
																			$nombreb = 'Bodega_'.$nombreb;
																			
																			$limiteb = 1000;
																			
																			$actualb = 0;
																			
																			//se registra la nueva bodega
																			
																			$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																		VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
																			
																			$queryids = pg_query($conn,$sql);
																			
																			$resid = pg_fetch_array($queryids);
																			
																			$idbodega =  $resid[0];
																			
																		}
																	//se crea el nuevo directorioo de bodega
																	$carpeta = $ruta_bodega.$nombreb;
																	if (!file_exists($carpeta))
																		{
																			mkdir($carpeta, 0777, true);
																		}
																}
															else
																{	//existe una bodega desocupada
																	
																	$dbod = pg_fetch_assoc($qerybod);
																	
																	$idbodega = $dbod['id_bodega'];
																	
																	$nombreb = $dbod['nombre'];
																	
																	$limiteb = $dbod['limite'];
																	
																	$actualb = $dbod['actual'];
																	
																}
														}
													else
														{
															if (trim($configdb[0]) == 'sqlsrv')
																{
																	$qerybod = sqlsrv_query( $conn, $sql);
																	
																	$haybodega = sqlsrv_num_rows( $qerybod );
																	
																	if ($haybodega == 0)
																		{
																			
																			//se verifica si es la primera bodega se debe generar una bodega nueva
																			
																			$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
																			
																			$qeryhabod = sqlsrv_query( $conn, $sql);
																			
																			$cbod = 0;
																			
																			while( $row = sqlsrv_fetch_array( $qeryhabod, SQLSRV_FETCH_ASSOC ))
																				{
																					$cbod = $cbod + 1;
																				}
																			
																			if ($cbod == 0)
																				{
																					//se genera la primera bodega
																					
																					$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																							VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
																					
																					$queryids = sqlsrv_query( $conn, $sql);
																					
																					$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
																					
																					$resource = sqlsrv_query($conn, $sql);
																					
																					while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																						{
																							$idbodega =  $row['id_bodega'];
																						}
																					
																					$nombreb = 'Bodega_1';
																					
																					$limiteb = 1000;
																					
																					$actualb = 0;
																					
																					
																				}
																			else
																				{
																					//se busca la ultima bodega para continuar el control
																					$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
																					
																					$qerybodega = sqlsrv_query( $conn, $sql);
																					
																					while( $row = sqlsrv_fetch_array( $qerybodega, SQLSRV_FETCH_ASSOC ))
																						{
																							$dbod =  $row['nombre'];
																						}
																					
																					$dbod = $dbod['nombre'];
																					
																					$nombreb = explode("_".$dbod);
																					
																					$nombreb = ($nombreb[1]*1) + 1;
																					
																					$nombreb = 'Bodega_'.$nombreb;
																					
																					$limiteb = 1000;
																					
																					$actualb = 0;
																					
																					//se registra la nueva bodega
																					
																					$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																								VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
																					
																					$queryids = sqlsrv_query( $conn, $sql);
																					
																					$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
																					
																					$resource = sqlsrv_query($conn, $sql);
																					
																					while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																						{
																							$idbodega =  $row['id_bodega'];
																						}
																					
																				}
																			//se crea el nuevo directorioo de bodega
																			$carpeta = $ruta_bodega.$nombreb;
																			if (!file_exists($carpeta))
																				{
																					mkdir($carpeta, 0777, true);
																				}
																		}
																	else
																		{	//existe una bodega desocupada
																			
																			while( $dbod = sqlsrv_fetch_array( $qerybod, SQLSRV_FETCH_ASSOC ))
																				{
																					$idbodega = $dbod['id_bodega'];
																					
																					$nombreb = $dbod['nombre'];
																					
																					$limiteb = $dbod['limite'];
																					
																					$actualb = $dbod['actual'];
																				}
																			
																			
																		}
																}
														}
												}	
											
												
											
												
												$czip = $czip + 1;
												
												//se separa la extension
												
												$extimg = substr(strrchr($listado[$iti], "."),1);
												
												$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
												
												if ($configdb[0] == 'mysql')
													{
														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
														VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
														
														$queryids =  mysql_query($sql,$conn);
														
														//se captura el ultimo id registrado
														$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
														
														$rs = mysql_fetch_assoc($rs);
														
														$idimagen = $rs["id"];
														
														//se registra que hay imagenes en la tabla de encriptacion
														
														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														
														$queryids =  mysql_query($sql,$conn);
														
													}
												else
													{
														if ($configdb[0] == 'pgsql')
															{
																$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																	VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
																
																$queryids =  pg_query($conn,$sql);
																
																$resid = pg_fetch_array($queryids);
																
																$idimagen =  $resid[0];
																
																$idimagenes[]  = $idimagen;
																
																//se registra que hay imagenes en la tabla de encriptacion
																
																$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																
																$queryids =  pg_query($conn,$sql);
																
															}
														else
															{
																if (trim($configdb[0]) == 'sqlsrv')
																	{
																		
																		$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																		VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
																		
																		$queryids = sqlsrv_query($conn,$sql);
																		
																		$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$id_documento." ORDER BY id_imagendocum desc";
																		
																		$resource = sqlsrv_query($conn, $sql);
																		
																		while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																		{
																			$ultimoid =  $row['id_imagendocum'];
																		}
																		
																		$idimagen =  $ultimoid;
																		
																		$idimagenes[]  = $idimagen;
																		//se registra que hay imagenes en la tabla de encriptacion
																		
																		$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																		
																		$queryids =  sqlsrv_query($conn,$sql);
																	}
																
															}
													}	
												
												
												if ($idimagen > 0)
													{
														
														//se copia con el id del registro de imagen
														
														$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
														
														$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
														
														if (copy($fichero, $nuevo_fichero))
															{
																$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																
																encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																
																unlink($dir); //se eliminan los archivos hijos del zip
																
																unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																
															}
													}
									}//fin del for
								
								unlink($archivopadre);   //se elimina el archivo zip padre
								
								unlink($ficherozip);   //se elimina el archivo zip padre
							}
							echo json_encode((['status'=>'ok','code'=>200,'message'=>count($idimagenes).' Obtained image','data'=>$idimagenes]));
					}
				else
					{
						echo json_encode((['status'=>'error','code'=>201,'message'=>'Problem occurred with zip']));
					}	
					
			break; 
			
			/*este script es para los archivos zip con contenido de csv*/
			
			case 'load_csv':
			
				$errors= array();
				
				$idusuario = $_REQUEST['idusuario'];
				
				$nombreb = $_REQUEST['nombreb'];
				
				$id_tabla= $_REQUEST['id_tabla'];  
				
				$id_folder = $_REQUEST['id_folder'];  
				
				$dir = $ruta_load;
				
				$directorio = opendir($dir); //ruta de la carga
				
				require_once('manejozip.php');
				
				$ctlvalidado = 0;
				
				while ($archivo = readdir($directorio)) //obtenemos un archivo y luego otro sucesivamente
					{
						if (is_dir($archivo))//verificamos si es o no un directorio
							{
								
								
							}
						else
							{
								
								$nombrear2 = explode('.',$archivo);
								
								$nombrear = $nombrear2[0];
								
								$file_ext = strtolower($nombrear2[1]);
								
								$vectindimagen = array();
								
								if ($file_ext == 'zip' or $file_ext == 'ZIP')
									{
										$paraqu = $nombrear.'.'.$file_ext;
										
										$archivopadre = $dir.$nombrear.'.'.$file_ext; 
										
										$destino = $ruta_bodega.$nombreb.'/';
										
										$zip_manager = new Zip_manager(); 										
										
										$resultado = $zip_manager->extraer($archivopadre, $destino);
									
										if ($resultado)
											{
												
												
												
												$listado = $zip_manager->listar($archivopadre, $destino);
												
												$vdatosfile = array();
												
												$vdatospdfs = array();
												
												//
												for ($iti = 0; $iti < count($listado); $iti++)
													{
														$extimg = substr(strrchr($listado[$iti], "."),1);
														
														$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
														
														
														if ($extimg == 'csv' or $extimg == 'CSV')
															{
																$archcsv = $destino.$filename.'.'.$extimg;
																
																$fp = fopen ($destino.$filename.'.'.$extimg,"r");
																
																$contl = 0;
																
																while ($data = fgetcsv ($fp, 1000, ","))
																	{
																		$contl = $contl + 1;
																		
																		$elarchivo = substr($data[0], 0, strrpos($data[0],"."));
																		
																		$extarch = substr(strrchr($data[0], "."),1);
																		
																		$num = count ($data);
																		
																		if ($contl > 1)
																			{
																				$vdatosfile[] = $data[0];
																			}	
																	}//fin del while
																	
																	fclose ($fp);
																	
															}//fin del csv
														else 
															{
																if ($extimg == 'pdf' or $extimg == 'PDF' )
																	{
																		$vdatospdfs[] = $filename.'.'.$extimg;
																	}	
															}	
													}//fin del for
												//se evaluan que el csv tenga en el listado el mismo numero de archivos que el zip sin el csv
												 
												
												if (count($vdatosfile) != count($vdatospdfs))	
													{
														echo json_encode((['status'=>'error','code'=>205,'message'=>'Does not match the number of zip files with csv listing']));
														
														//se eliminan los archivos
														
														fclose ($fp);
														
														for ($iti = 0; $iti < count($listado); $iti++)
															{
																unlink($destino.$listado[$iti]);
															}	
														exit;
													}
												else
													{
														//se verifica ue todos los archivos del listado tengan el mismo nombre que e el zip
														$conteoexiste = 0;
														
														for ($iti = 0; $iti < count($vdatospdfs); $iti++)
															{ 
																
																if (file_exists($destino.$vdatospdfs[$iti]))
																	{
																		$conteoexiste = $conteoexiste + 1;
																	}	
															}	
															
														if ($conteoexiste != count($vdatospdfs))	
															{
																echo json_encode((['status'=>'error','code'=>205,'message'=>($vdatospdfs - $conteoexiste).' File names do not match with csv listing']));
																
																//se eliminan los archivos
																
																fclose ($fp);
																
																for ($iti = 0; $iti < count($listado); $iti++)
																	{
																		unlink($destino.$listado[$iti]);
																	}
																exit;
															}
													}	
													
												//se generan los expedientes uno por cada pdf
										
												//se busca el csv para tomar data de alli para los indices
												
												for ($iti = 0; $iti < count($listado); $iti++)
													{
														$extimg = substr(strrchr($listado[$iti], "."),1);
														
														$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
														
														$vindices  = array();
														
														if ($extimg == 'csv')
															{
																$archcsv = $destino.$filename.'.'.$extimg;
																
																$fp = fopen ($destino.$filename.'.'.$extimg,"r");
																
																$contl = 0;
																
																while ($data = fgetcsv ($fp, 1000, ",")) 
																	{
																		$contl = $contl + 1;
																		
																		$elarchivo = substr($data[0], 0, strrpos($data[0],".")); 
																		
																		$extarch = substr(strrchr($data[0], "."),1);
																		
																		$num = count ($data);
																		//se toman los datos
																		
																		$narchivo = $data[0];
																		
																		//se toman los indices
																		
																		if ($contl == 1)
																			{
																				$nombreindice = array();
																				
																				$procesa = 0;
																				
																				$positpdoc = 0;
																				
																				$ctlindices = 0; 
																				
																				for ($iz = 1; $iz < $num; $iz++)
																					{
																						$ctlindices = $ctlindices + 1;
																						
																						if ($data[$iz] == 'DocType')
																							{
																						
																								$procesa  = 1;
																								
																								$positpdoc = $iz;
																								
																							}	
																						$sql = "select  id_indice from sgd_indices where nombre like '%".$data[$iz]."%'";  //echo $sql;
																						
																						$nombreindice[] = $data[$iz];
																						
																						if (trim($configdb[0]) == 'sqlsrv')
																							{
																						
																								$qeryninc =  sqlsrv_query($conn,$sql);
																								
																								while( $row = sqlsrv_fetch_array( $qeryninc, SQLSRV_FETCH_ASSOC ))
																									{
																										$vindices[] = $row['id_indice'];
																									}
																							}
																						else 
																							{
																								if ($configdb[0] == 'mysql')
																									{
																										$qeryninc=  mysql_query($sql,$conn);
																																																				
																										while($row= mysql_fetch_array($qeryninc))
																											{
																												$vindices[] = $row['id_indice'];
																											}
																									}	
																								else
																									{
																										if ($configdb[0] == 'pgsql')
																											{
																																																								
																												$qeryninc=  pg_query($conn,$sql);
																												
																												while($row= pg_fetch_array($qeryninc))
																													{
																														$vindices[] = $row['id_indice'];
																													}
																											}	
																									}	
																							}	
																					}
																				
																				if ($procesa == 0)
																					{
																						echo json_encode((['status'=>'error','code'=>205,'message'=>'The csv file does not have the document type']));
																						
																						//se eliminan los archivos
																						
																						fclose ($fp);
																						
																						for ($iflie = 0; $iflie< count($listado); $iflie++)
																							{
																								unlink($destino.$listado[$iflie]);
																							}
																					  	exit;
																					  
																					}
																				else 
																					{
																						//se verifica que el numero e campos de la cabecera correspomnda con el num de indices
																						$totalindi = count($vindices);
																						
																						if ($ctlindices != $totalindi)
																							{
																								echo json_encode((['status'=>'error','code'=>205,'message'=>'Does not match the number of indices of the total of fields in the head of the csv']));
																								
																								//se eliminan los archivos
																								
																								fclose ($fp);
																								
																								for ($iflie = 0; $iflie< count($listado); $iflie++)
																									{
																										unlink($destino.$listado[$iflie]);
																									}
																								
																								exit;
																							}	
																						
																					}
																					
																			}	
																		else 
																			{
																					$indices = array();
																					
																					for ($iz = 1; $iz < $num; $iz++)
																						{
																							$indices[] = $data[$iz];
																						}
																						
																						
																						if (trim($configdb[0]) == 'sqlsrv')
																							{
																									$sql ="INSERT INTO sgd_expedientes (nombre,id_tabla,id_usuario,id_central,spider,id_estado,created_at)
																				 					VALUES('".$elarchivo."', ".$id_tabla.", ".$idusuario.",1,1,1,'".date("Y-m-d H:i:s")."') ";
																									
																									$queryids = sqlsrv_query( $conn, $sql);
																									
																									$sql ="SELECT TOP 1 id_expediente FROM  sgd_expedientes where id_expediente > 0 ORDER BY id_expediente desc";
																									
																									$resource = sqlsrv_query($conn, $sql);
																									
																									while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																										{
																											$idexpediente =  $row['id_expediente'];
																										}
																									//se genera el documento
																									if ($idexpediente > 0)
																										{
																											
																											//se busca el id de tipo documental
																											
																											$sql ="SELECT id_tipodoc FROM  sgd_tipodocumentales where UPPER(nombre) like '%".strtoupper($data[$positpdoc])."%'";   
																											
																											$regtpdoc = sqlsrv_query($conn, $sql);
																											
																											while( $row = sqlsrv_fetch_array( $regtpdoc, SQLSRV_FETCH_ASSOC ))
																												{
																													$id_tipodoc =  $row['id_tipodoc'];
																												}
																											
																											
																											$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,id_estado,orden,created_at)
																				 							VALUES(".$idexpediente.", ".$id_tipodoc.", ".$idusuario.",".$id_tabla.",".$id_folder.",1,0,'".date("Y-m-d H:i:s")."') ";
																											
																											$queryids = sqlsrv_query( $conn, $sql);
																											
																											$sql ="SELECT TOP 1 id_documento FROM  sgd_documentos where id_documento > 0 ORDER BY id_documento desc";
																											
																											$resource = sqlsrv_query($conn, $sql);
																											
																											while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																												{
																													$iddocumento =  $row['id_documento'];
																												}
																												
																											if ($iddocumento > 0)
																												{
																													//se registran los valores indices
																													
																													$iddeindices = array();
																													
																													$valordeindices = array();
																													
																													
																													
																													for ($indi = 0; $indi < count($indices); $indi++)
																														{
																															$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
																				 											VALUES(".$iddocumento.", ".$vindices[$indi].", ".$indices[$indi].",1,'".date("Y-m-d H:i:s")."') ";
																															
																															//se crea el arreglo de los indices para este documento
																															
																															$iddeindices[] = $vindices[$indi]; 
																															
																															$valordeindices[] = $indices[$indi];
																																																														
																															$queryids = sqlsrv_query( $conn, $sql);
																													
																														}
																														
																													//se manda a procesar los archivos dentro del zip (menos csv)
																													
																														$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden asc';
																														
																														$qeryorden =  sqlsrv_query($conn,$sql);
																														
																														$qeryorden2 = sqlsrv_query($conn,$sql);
																														
																														$cuantoorden = 0;
																														
																														while( $row = sqlsrv_fetch_array( $qeryorden, SQLSRV_FETCH_ASSOC ))
																															{
																																$cuantoorden = $cuantoorden + 1;
																															}
																														
																														if ($cuantoorden > 0)
																															{
																																
																																while( $row = sqlsrv_fetch_array( $qeryorden2, SQLSRV_FETCH_ASSOC ))
																																	{
																																		$norden = $row['orden'];
																																	}
																																
																																$norden = $norden + 1;
																																
																															}
																														else
																															{
																																
																																$norden = 0;
																																
																																$norden = $norden + 1;
																																
																															}
																															// severifica la bodega
																															//se verifica si es la primera bodega
																															$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
																															
																															$qeryhabod = sqlsrv_query( $conn, $sql);
																															
																															$cbod = 0;
																															
																															while( $row = sqlsrv_fetch_array( $qeryhabod, SQLSRV_FETCH_ASSOC ))
																																{
																																	$cbod = $cbod + 1;
																																}
																															
																															
																															if ($cbod == 0)
																																{
																																	//se genera la primera bodega
																																	
																																	$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																																	VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
																																	
																																	$queryids = sqlsrv_query( $conn, $sql);
																																	
																																	$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
																																	
																																	$resource = sqlsrv_query($conn, $sql);
																																	
																																	while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																																		{
																																			$idbodega =  $row['id_bodega'];
																																		}
																																	
																																	$nombreb = 'Bodega_1';
																																	
																																	$limiteb = 1000;
																																	
																																	$actualb = 0;
																																	
																																	
																																}
																															else
																																{
																																	//se busca la ultima bodega para continuar el control
																																	$sql = 'select * from sgd_bodegas  where id_bodega > 0 ORDER BY id_bodega DESC LIMIT 1';
																																	
																																	$qerybodega = sqlsrv_query( $conn, $sql);
																																	
																																	while( @$row = sqlsrv_fetch_array( @$qerybodega, SQLSRV_FETCH_ASSOC ))
																																		{
																																			$dbod =  $row['nombre'];
																																			
																																			$actualvalor = $row['actual'];
																																			
																																			$ellimite = $row['limite']; 
																																			
																																			$idbodega =  $row['id_bodega'];
																																			
																																			$nombreb = $dbod;
																																			
																																			$limiteb = $ellimite;
																																			
																																			$actualb = $actualvalor;
																																			
																																		}
																																		
																																		
																																	$actualb = $actualb + 1;
																																	
																																	if ($actualb > $limiteb) //se genera una nueva bodega
																																		{
																																			$nombreb = explode("_".$nombreb);
																																			
																																			$nombreb = ($nombreb[1]*1) + 1;
																																			
																																			$nombreb = 'Bodega_'.$nombreb;
																																			
																																			$limiteb = 1000;
																																			
																																			$actualb = 1;
																																			
																																			//se registra la nueva bodega
																																			$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																																			VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') ";
																																			
																																			$resource = sqlsrv_query($conn, $sql);
																																			
																																			$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_documento desc";
																																			
																																			$resource = sqlsrv_query($conn, $sql);
																																			
																																			while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																																				{
																																					$idbodega =  $row['id_bodega'];
																																				}
																																		}
																																	else
																																		{
																																			//se acutaliza el valor de documentos actuales en la tabla bodega
																																			$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
																																			
																																			$queryids = sqlsrv_query($conn,$sql);
																																		}
																																	
																																}
																																
																														//se registra el archivo que le corresponde
																														
																														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																															VALUES(".$iddocumento.",'".$elarchivo."','".$extarch."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
																														 
																														$queryids = sqlsrv_query( $conn, $sql);
																														
																														$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_bodega > 0 ORDER BY id_imagendocum desc";
																														
																														$resource = sqlsrv_query($conn, $sql);
																														
																														while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																															{
																																$idimagen =  $row['id_imagendocum'];
																															}
																															
																														//se registra que hay imagenes en la tabla de encriptacion
																														
																														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																														
																														$queryids =  sqlsrv_query($conn,$sql);
																														
																														if ($idimagen > 0)
																															{
																																
																																$datosreg = array();
																																
																																$datosreg[]['expediente'] = $idexpediente;
																																
																																$datosreg[]['documento'] = $iddocumento;
																																
																																$datosreg[]['indices'] = $iddeindices;
																																
																																$datosreg[]['imagen'] = $idimagen;
																																
																																$datosreg[]['pdf'] = $elarchivo.'.'.$extarch;
																																
																																$vectindimagen[] = $datosreg;
																																
																																$dir = $ruta_bodega.$nombreb."/" . $elarchivo.'.'.$extarch; 
																																
																																encryptFilecsv($elarchivo.'.'.$extarch,$ruta_bodega.$nombreb,$kweyllave,$idimagen);
																																
																																unlink($dir); 
																															}
																															
																												}	//fin de si se crea docmuento
																										}// fin de si se crea expediente
																										
																							}// fin de si es sqlserver	
																						else 
																							{
																								if ($configdb[0] == 'mysql')
																									{
																										$sql ="INSERT INTO sgd_expedientes (nombre,id_tabla,id_usuario,id_central,spider,id_estado,created_at)
																				 						VALUES('".$elarchivo."', ".$id_tabla.", ".$idusuario.",1,1,1,'".date("Y-m-d H:i:s")."') ";
																										
																										$queryids =  mysql_query($sql,$conn);
																										
																										//se captura el ultimo id registrado
																										$rs = mysql_query("SELECT MAX(id_expediente) AS id FROM sgd_expedientes");
																										
																										$rs = mysql_fetch_assoc($rs);
																										
																										$idexpediente= $rs["id"];
																										
																										//se genera el documento
																										if ($idexpediente > 0)
																											{
																												//se busca el id de tipo documental
																												
																												$sql ="SELECT id_tipodoc FROM  sgd_tipodocumentales where UPPER(nombre) like '%".strtoupper($data[$positpdoc])."%'";  //echo $sql;
																												
																												$regtpdoc = mysql_query($sql,$conn);
																												
																												$rs = mysql_fetch_assoc($regtpdoc);
																												
																												$id_tipodoc = $rs["id_tipodoc"];
																												
																												$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,id_estado,orden,created_at)
																					 							VALUES(".$idexpediente.", ".$id_tipodoc.", ".$idusuario.",".$id_tabla.",".$id_folder.",1,0,'".date("Y-m-d H:i:s")."') ";   //echo $sql;
																												
																												$queryids =  mysql_query($sql,$conn);
																												
																												//se captura el ultimo id registrado
																												$rs = mysql_query("SELECT MAX(id_documento) AS id FROM sgd_documentos");
																												
																												$rs = mysql_fetch_assoc($rs);
																												
																												$iddocumento= $rs["id"];
																												
																												if ($iddocumento > 0)
																													{
																														//se registran los valores indices
																														$iddeindices = array();			
																														
																														//echo count($indices);
																													
																														for ($indi = 0; $indi < count($indices); $indi++)
																															{
																																$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
																							 											VALUES(".$iddocumento.", ".$vindices[$indi].", '".$indices[$indi]."',1,'".date("Y-m-d H:i:s")."') "; 
																																
																																$queryids =  mysql_query($sql,$conn);
																																
																																$cadena = str_replace(' ', '', $nombreindice[$indi]);
																																
																																$iddeindices[$cadena] = $indices[$indi];
																																
																															}
																															
																														//se manda a procesar los archivos dentro del zip (menos csv)
																														
																														$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden asc';
																														
																														$qeryorden=  mysql_query($sql,$conn); 
																														
																														$qeryorden2 = mysql_query($sql,$conn); 
																														
																														$cuantoorden = 0;
																														
																														while($row= mysql_fetch_array($qeryorden))
																															{
																																$cuantoorden = $cuantoorden + 1;
																															}
																														
																														if ($cuantoorden > 0)
																															{
																																
																																while($row= mysql_fetch_array($qeryorden2))
																																	{
																																		$norden = $row['orden'];
																																	}
																																																														
																																$norden = $norden + 1;
																																
																															}
																														else
																															{
																																
																																$norden = 0;
																																
																																$norden = $norden + 1;
																																
																															}
																														// severifica la bodega
																														//se verifica si es la primera bodega
																														$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
																														
																														$qeryhabod=  mysql_query($sql,$conn); 
																														
																														$cbod = 0;
																														
																														while($row= mysql_fetch_array($qeryhabod))
																															{
																																$cbod = $cbod + 1;
																															}
																																																											
																														
																														if ($cbod == 0)
																														{
																															//se genera la primera bodega
																															
																															$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																																			VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
																															
																															$queryids=  mysql_query($sql,$conn); 
																															
																															//se captura el ultimo id registrado
																															$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
																															
																															$rs = mysql_fetch_assoc($rs);
																															
																															$idbodega= $rs["id"];
																															
																															$nombreb = 'Bodega_1';
																															
																															$limiteb = 1000;
																															
																															$actualb = 0;
																															
																															
																														}
																														else
																														{
																															//se busca la ultima bodega para continuar el control
																															$sql = 'select * from sgd_bodegas  where id_bodega > 0 ORDER BY id_bodega DESC LIMIT 1';
																															
																															$qerybodega=  mysql_query($sql,$conn); 
																															
																															while(@$row= mysql_fetch_array(@$qerybodega))
																															{
																																$dbod =  $row['nombre'];
																																
																																$actualvalor = $row['actual'];
																																
																																$ellimite = $row['limite'];
																																
																																$idbodega =  $row['id_bodega'];
																																
																																$nombreb = $dbod;
																																
																																$limiteb = $ellimite;
																																
																																$actualb = $actualvalor;
																															}
																															
																															$actualb = $actualb + 1;
																															
																															if ($actualb > $limiteb) //se genera una nueva bodega
																															{
																																$nombreb = explode("_".$nombreb);
																																
																																$nombreb = ($nombreb[1]*1) + 1;
																																
																																$nombreb = 'Bodega_'.$nombreb;
																																
																																$limiteb = 1000;
																																
																																$actualb = 1;
																																
																																//se registra la nueva bodega
																																$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																																					VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') ";
																																
																																$resource=  mysql_query($sql,$conn);
																																
																																//se captura el ultimo id registrado
																																$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
																																
																																$rs = mysql_fetch_assoc($rs);
																																
																																$idbodega= $rs["id"];
																																
																															}
																															else
																															{
																																//se acutaliza el valor de documentos actuales en la tabla bodega
																																$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
																																
																																$resource=  mysql_query($sql,$conn);
																															}
																															
																														}
																														
																														//se registra el archivo que le corresponde
																														
																														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																																	VALUES(".$iddocumento.",'".$elarchivo."','".$extarch."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
																														
																														$queryids=  mysql_query($sql,$conn); 
																														
																														//se captura el ultimo id registrado
																														$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
																														
																														$rs = mysql_fetch_assoc($rs);
																														
																														$idimagen= $rs["id"];
																														
																														//se registra que hay imagenes en la tabla de encriptacion
																														
																														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																														
																														$queryids=  mysql_query($sql,$conn); 
																														
																														if ($idimagen > 0)
																															{
																																
																																$datosreg = array();
																																
																																$datosreg[]['expediente'] = $idexpediente;
																																
																																$datosreg[]['documento'] = $iddocumento;
																																
																																$datosreg[]['indices'] = $iddeindices;
																																																																
																																$datosreg[]['imagen'] = $idimagen;
																																
																																$datosreg[]['pdf'] = $elarchivo.'.'.$extarch;
																																
																																$vectindimagen[] = $datosreg;
																																
																																$dir = $ruta_bodega.$nombreb."/" . $elarchivo.'.'.$extarch; 
																																
																																encryptFilecsv($elarchivo.'.'.$extarch,$ruta_bodega.$nombreb,$kweyllave,$idimagen);
																																
																																unlink($dir);
																															}
																														
																													}	//fin de si se crea docmuento
																											}// fin de si se crea expediente
																									}//fin de mysql	
																								else
																									{
																										if ($configdb[0] == 'pgsql')
																											{
																												
																												$sql ="INSERT INTO sgd_expedientes (nombre,id_tabla,id_usuario,id_central,spider,id_estado,created_at)
																					 							VALUES('".$elarchivo."', ".$id_tabla.", ".$idusuario.",1,1,1,'".date("Y-m-d H:i:s")."')  RETURNING id_expediente";
																																																							
																												$queryids = pg_query($conn,$sql);
																												
																												$resid = pg_fetch_array($queryids);
																												
																												$idexpediente=  $resid[0];
																												
																												//se genera el documento
																												if ($idexpediente > 0)
																													{
																														//se busca el id de tipo documental
																														
																														$sql ="SELECT id_tipodoc FROM  sgd_tipodocumentales where UPPER(nombre) like '%".strtoupper($data[$positpdoc])."%'";
																														
																														$regtpdoc =  pg_query($conn,$sql);
																														
																														$rs = pg_fetch_assoc($regtpdoc);
																														
																														$id_tipodoc = $rs["id_tipodoc"];
																														
																														$sql ="INSERT INTO sgd_documentos (id_expediente,id_tipodocumental,id_usuario,id_tabla,id_folder,id_estado,orden,created_at)
																							 							VALUES(".$idexpediente.", ".$id_tipodoc.", ".$idusuario.",".$id_tabla.",".$id_folder.",1,0,'".date("Y-m-d H:i:s")."') RETURNING id_documento";
																														
																														$queryids = pg_query($conn,$sql);
																														
																														$resid = pg_fetch_array($queryids);
																														
																														$iddocumento=  $resid[0];
																														
																														if ($iddocumento > 0)
																															{
																																//se registran los valores indices
																																$iddeindices = array();
																																
																																for ($indi = 0; $indi < count($indices); $indi++)
																																	{
																																		$sql ="INSERT INTO sgd_valorindice (id_documento,id_indice,valor,id_estado,created_at)
																											 							VALUES(".$iddocumento.", ".$vindices[$indi].", ".$indices[$indi].",1,'".date("Y-m-d H:i:s")."') ";
																																		
																																		$queryids = pg_query($conn,$sql);
																																		
																																		$cadena = str_replace(' ', '', $nombreindice[$indi]);
																																		
																																		$iddeindices[$cadena] = $indices[$indi];
																																		
																																	}
																																
																																//se manda a procesar los archivos dentro del zip (menos csv)
																																
																																$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$iddocumento.' order by orden asc';
																																
																																$qeryorden = pg_query($conn,$sql);
																																									
																																$qeryorden2 = pg_query($conn,$sql);
																																
																																$cuantoorden = 0;
																																
																																while($row= pg_fetch_array($qeryorden))
																																	{
																																		$cuantoorden = $cuantoorden + 1;
																																	}
																																
																																if ($cuantoorden > 0)
																																	{
																																		
																																		while($row= pg_fetch_array($qeryorden2))
																																			{
																																				$norden = $row['orden'];
																																			}
																																		
																																		$norden = $norden + 1;
																																		
																																	}
																																else
																																	{
																																		
																																		$norden = 0;
																																		
																																		$norden = $norden + 1;
																																		
																																	}
																																// severifica la bodega
																																//se verifica si es la primera bodega
																																$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
																																
																																$qeryhabod= pg_query($conn,$sql);
																																
																																$cbod = 0;
																																
																																while($row= pg_fetch_array($qeryhabod))
																																	{
																																		$cbod = $cbod + 1;
																																	}
																																
																																
																																if ($cbod == 0)
																																	{
																																		//se genera la primera bodega
																																		
																																		$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																																		VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega ";
																																		
																																		$queryids= pg_query($conn,$sql);
																																		
																																		$resid = pg_fetch_array($queryids);
																																		
																																		$idbodega=  $resid[0];
																																		
																																		$nombreb = 'Bodega_1';
																																		
																																		$limiteb = 1000;
																																		
																																		$actualb = 0;
																																		
																																		
																																	}
																																else
																																	{
																																		//se busca la ultima bodega para continuar el control
																																		$sql = 'select * from sgd_bodegas  where id_bodega > 0 ORDER BY id_bodega DESC LIMIT 1';
																																																																			
																																		$qerybodega = pg_query($conn,$sql);
																																		
																																		while(@$row= pg_fetch_array(@$qerybodega))
																																			{
																																				$dbod =  $row['nombre'];
																																				
																																				$actualvalor = $row['actual'];
																																				
																																				$ellimite = $row['limite'];
																																				
																																				$idbodega =  $row['id_bodega'];
																																				
																																				$nombreb = $dbod;
																																				
																																				$limiteb = $ellimite;
																																				
																																				$actualb = $actualvalor;
																																			}
																																		
																																		$actualb = $actualb + 1;
																																		
																																		if ($actualb > $limiteb) //se genera una nueva bodega
																																			{
																																				$nombreb = explode("_".$nombreb);
																																				
																																				$nombreb = ($nombreb[1]*1) + 1;
																																				
																																				$nombreb = 'Bodega_'.$nombreb;
																																				
																																				$limiteb = 1000;
																																				
																																				$actualb = 1;
																																				
																																				//se registra la nueva bodega
																																				$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																																				VALUES('".$nombreb."', 1000, 1,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega ";
																																				
																																				$queryids= pg_query($conn,$sql);
																																				
																																				$resid = pg_fetch_array($queryids);
																																				
																																				$idbodega=  $resid[0];
																																				
																																			}
																																		else
																																			{
																																				//se acutaliza el valor de documentos actuales en la tabla bodega
																																				$sql ="UPDATE sgd_bodegas SET actual =".$actualb.", updated_at = '".date("Y-m-d H:i:s")."' WHERE id_bodega = ".$idbodega;
																																				
																																				$resource = pg_query($conn,$sql);
																																				
																																			}
																																		
																																	}
																																
																																//se registra el archivo que le corresponde
																																
																																$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																																VALUES(".$iddocumento.",'".$elarchivo."','".$extarch."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_bodega ";
																																
																																$queryids= pg_query($conn,$sql);
																																
																																$resid = pg_fetch_array($queryids);
																																
																																$idimagen=  $resid[0];
																																
																																//se registra que hay imagenes en la tabla de encriptacion
																																
																																$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
																																
																																$queryids= pg_query($conn,$sql); 
																																
																																if ($idimagen > 0)
																																	{
																																		
																																		$datosreg = array();
																																		
																																		$datosreg[]['expediente'] = $idexpediente;
																																		
																																		$datosreg[]['documento'] = $iddocumento;
																																		
																																		$datosreg[]['indices'] = $iddeindices;
																																		
																																		$datosreg[]['imagen'] = $idimagen;
																																		
																																		$datosreg[]['pdf'] = $elarchivo.'.'.$extarch;
																																		
																																		$vectindimagen[] = $datosreg;
																																		
																																		$dir = $ruta_bodega.$nombreb."/" . $elarchivo.'.'.$extarch;
																																		
																																		encryptFilecsv($elarchivo.'.'.$extarch,$ruta_bodega.$nombreb,$kweyllave,$idimagen);
																																		
																																		unlink($dir);
																																	}
																																
																															}	//fin de si se crea docmuento
																													}// fin de si se crea expediente
																											}//fin de pgsql
																									}	
																							}	
																			}// fn del si es la primera linea del csv				
																		
																	}//fin del recorrido del archivo csv
																
																
																	fclose ($fp);
																	
																	unlink($archcsv); 
																	
															}// fin de si es csv	
															
													}// fin de si es el csv		
											}	
											
											//se mueve el archivo a la carpeta de almacen zip
											$ficherozip = $archivopadre;
											
											$nuevo_fichero = $ruta_zip.$paraqu;
											
											if (copy($ficherozip, $nuevo_fichero))
												{
													unlink($ficherozip);
												}	
											
									}
								
							}
					}// fin del recorrido de la carpeta
				
					echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$vectindimagen]));   
			break;
			/* ********************* fin del bloque de carga desde una carpeta con zip*/
			
			case 'grabastoragezip_csv':
				
				$errors= array();
				
				$nombearc= $_REQUEST['nombearc'];
				
				$extarc= $_REQUEST['extarc'];
				
				$nombreb = $_REQUEST['nombreb'];
				
				$id_documento = $_REQUEST['id_documento'];
				
				$id_tipodoc= $_REQUEST['id_tipodoc']; 
				
				//se buscan la cantidad de indices del tipo documental
				
				$sql = "SELECT count(id_indice) as numindices FROM sgd_tipodoc_indices WHERE id_tipodoc = ".$id_tipodoc;
				
				if ($configdb[0] == 'mysql')
					{
						$qerynumindice =  mysql_query($sql,$conn);
						
						$numindices = mysql_fetch_assoc($qeryorden);
						
						$numindices = $numindices['numindices'];
						
					}	
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$qerynumindice=  pg_query($conn,$sql);
																
								$numindices= pg_fetch_assoc($qeryorden);
								
								$numindices = $numindices['numindices'];
							}	
						else 
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$qerynumindice=  sqlsrv_query($conn,$sql);
										
										while( $row = sqlsrv_fetch_array( $qerynumindice, SQLSRV_FETCH_ASSOC ))
											{
												$numindices= $row['numindices'];
											}
									}	
							}	
					}	
					
				//buscamos los indices del tipo dc¿ocumental para su comparación con los del csv
				
				$sql = "SELECT i.nombre,i.id_indice FROM sgd_indices i, sgd_tipodoc_indices tpd WHERE tpd.id_tipodoc = ".$id_tipodoc." AND i.id_indice = tpd.id_indice";
				
				$datosindices = array();
				
				if ($configdb[0] == 'mysql')
					{
						$qeryindices =  mysql_query($sql,$conn);
						
						while($campo2 = mysql_fetch_array($qeryindices))
							{
								$datosindices[] = $campo2['nombre'];
							}
					}	
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$qeryindices=  pg_query($conn,$sql);
								
								while($campo2= pg_fetch_array($qeryindices))
									{
										$datosindices[] = $campo2['nombre'];
									}	
							}	
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$qeryindices=  sqlsrv_query($conn,$sql);
										
										while( $row = sqlsrv_fetch_array( $qeryindices, SQLSRV_FETCH_ASSOC ))
											{
												$datosindices[] = $row['nombre'];
											}
									}	
							}	
					}
					
					
				$workspace = $espaciotrabajo;
				
				$idimagenes = array();
				
				$dir = $ruta_bodega.$nombreb."/".$nombearc.'.'.$extarc;
				
				$fichero = "../img/tempo/".$workspace.'/'.$nombearc.'.'.$extarc;
				
				$ficherozip = $fichero;
				
				$nuevo_fichero = $ruta_bodega.$nombreb."/".$nombearc.'.'.$extarc;
				
				if (copy($fichero, $nuevo_fichero))
					{
						
						require_once('manejozip.php');
						
						$archivopadre = $ruta_bodega.$nombreb.'/'.$nombearc.'.'.$extarc;
						
						$destino = $ruta_bodega.$nombreb.'/';
						
						$zip_manager = new Zip_manager();
						
						$resultado = $zip_manager->extraer($archivopadre, $destino);
						
						if ($resultado)
							{
								$listado = $zip_manager->listar($archivopadre, $destino);
								
								$czip = 0;
								
								//se recorre el contenido y se busca en el zip y se verifica q exista un archivo csv y segundo que el numero de indices y los mismos coincidan con los indices
								
								$ctlcsv = 0;
								
								for ($iti = 0; $iti < count($listado); $iti++)
									{
										$extimg = substr(strrchr($listado[$iti], "."),1);
										
										$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
										
										if ($extimg == 'csv' or $extimg == 'CSV')
											{
												$ctlcsv = + 1;
											}	
									}	
								if ($ctlcsv == 0)
									{
										echo json_encode((['status'=>'error','code'=>201,'message'=>'There is no csv in the zip']));
										break;	
									}	
								else
									{
										//se verifica el numero de indices del csv
										
										$numcamposind = count($datosindices);
										
										//se abre el csv y se verifican los campos a agregar que coincidan con el numero de indices del tipo documental
										
										
										for ($iti = 0; $iti < count($listado); $iti++)
											{
												$extimg = substr(strrchr($listado[$iti], "."),1);
												
												$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
												
												if ($extimg == 'csv' or $extimg == 'CSV')
													{
														$fpcsv = fopen ($ruta_bodega.$nombreb.'/'.$filename.'.'.$extimg,"r");  //voy aca pra el csv
														
														$nlim = 0; 
														
														while ($data = fgetcsv ($fpcsv, 1000, ";")) {
															$num = count ($data);
															
															$nlim = $nlim + 1;
															
															if ($nlim == 1)
																{
																	if ($num != $numcamposind)
																		{
																			echo json_encode((['status'=>'error','code'=>201,'message'=>'The number of indices does not match in cvs']));
																			break;	
																		}	
																	else
																		{
																			if ($num != $numcamposind)
																				{
																					  //se busca el id del indice por el nombre del mismo
																				}	
																		}	
																}	
															echo $data[0].' -> '.$data[1];
														}
														
														
													}	
												
											}	
										
										
										
										
										for ($iti = 0; $iti < count($listado); $iti++)
											{
												
												if ($configdb[0] == 'mysql')
												{
													//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
													
													$sql = 'select orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden desc limit 1';
													
													$qeryorden =  mysql_query($sql,$conn);
													
													$cuantoorden = mysql_num_rows($qeryorden);
													
													if ($cuantoorden > 0)
													{
														
														$orden = mysql_fetch_assoc($qeryorden);
														
														$norden = $orden['orden'];
														
														$norden = $norden + 1;
														
													}
													else
													{
														
														$norden = 0;
														
														$norden = $norden + 1;
														
													}
												}
												else
												{
													if ($configdb[0] == 'pgsql')
													{
														//se verifica cual es el  eultimo orden de imagenes para ese documento y se coloca la imagen al final del mismo
														
														$sql = 'select orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden desc limit 1 OFFSET 0';
														
														$qeryorden =  pg_query($conn,$sql);
														
														$cuantoorden = pg_num_rows($qeryorden);
														
														if ($cuantoorden > 0)
														{
															
															$orden = pg_fetch_assoc($qeryorden);
															
															$norden = $orden['orden'];
															
															$norden = $norden + 1;
															
														}
														else
														{
															
															$norden = 0;
															
															$norden = $norden + 1;
															
														}
													}
													else
													{
														if (trim($configdb[0]) == 'sqlsrv')
														{
															
															$sql = 'select  orden from sgd_imagen_documento where id_documento = '.$id_documento.' order by orden asc';
															
															$qeryorden =  sqlsrv_query($conn,$sql);
															
															$qeryorden2 = sqlsrv_query($conn,$sql);
															
															$cuantoorden = 0;
															
															while( $row = sqlsrv_fetch_array( $qeryorden, SQLSRV_FETCH_ASSOC ))
															{
																$cuantoorden = $cuantoorden + 1;
															}
															
															if ($cuantoorden > 0)
															{
																
																while( $row = sqlsrv_fetch_array( $qeryorden2, SQLSRV_FETCH_ASSOC ))
																{
																	$norden = $row['orden'];
																}
																
																$norden = $norden + 1;
																
															}
															else
															{
																
																$norden = 0;
																
																$norden = $norden + 1;
																
															}
															
														}
													}
												}
												
												$sql = 'select id_bodega,nombre,limite,actual from sgd_bodegas  where actual < limite ';
												
												if ($configdb[0] == 'mysql')
												{
													$qerybod =  mysql_query($sql,$conn);
													
													$haybodega = mysql_num_rows($qerybod);
													
													if ($haybodega == 0)
													{
														//se debe generar una bodega nueva
														//se verifica si es la primera bodega
														$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
														
														$qeryhabod =  mysql_query($sql,$conn);
														
														$cbod = mysql_num_rows($qeryhabod);
														
														if ($cbod == 0)
														{
															//se genera la primera bodega
															
															$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																	VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
															
															$nombreb = 'Bodega_1';
															
															$limiteb = 1000;
															
															$actualb = 0;
															
															$queryids =  mysql_query($sql,$conn);
															
															//se captura el ultimo id registrado
															$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
															
															$rs = mysql_fetch_assoc($rs);
															
															$idbodega = $rs["id"];
															
														}
														else
														{
															//se busca la ultima bodega para continuar el control
															$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
															
															$qerybodega =  mysql_query($sql,$conn);
															
															$dbod = mysql_fetch_assoc($qerybodega);
															
															$dbod = $dbod['nombre'];
															
															$nombreb = explode("_".$dbod);
															
															$nombreb = ($nombreb[1]*1) + 1;
															
															$nombreb = 'Bodega_'.$nombreb;
															
															$limiteb = 1000;
															
															$actualb = 0;
															
															//se registra la nueva bodega
															
															$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																	VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."')";
															
															$queryids =  mysql_query($sql,$conn);
															
															//se captura el ultimo id registrado
															$rs = mysql_query("SELECT MAX(id_bodega) AS id FROM sgd_bodegas");
															
															$rs = mysql_fetch_assoc($rs);
															
															$idbodega = $rs["id"];
															
														}
														//se crea el nuevo directorioo de bodega
														$carpeta = $ruta_bodega.$nombreb;
														if (!file_exists($carpeta))
														{
															mkdir($carpeta, 0777, true);
														}
													}
													else
													{	//existe una bodega desocupada
														
														$dbod = mysql_fetch_assoc($qerybod);
														
														$idbodega = $dbod['id_bodega'];
														
														$nombreb = $dbod['nombre'];
														
														$limiteb = $dbod['limite'];
														
														$actualb = $dbod['actual'];
														
													}
												}
												else
												{
													if ($configdb[0] == 'pgsql')
													{
														$qerybod = pg_query($conn,$sql);
														
														$haybodega = pg_num_rows($qerybod);
														
														if ($haybodega == 0)
														{
															//se debe generar una bodega nueva
															//se verifica si es la primera bodega
															$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
															
															$qeryhabod = pg_query($conn,$sql);
															
															$cbod = pg_num_rows($qeryhabod);
															
															if ($cbod == 0)
															{
																//se genera la primera bodega
																
																$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																						VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
																
																$queryids = pg_query($conn,$sql);
																
																$resid = pg_fetch_array($queryids);
																
																$idbodega =  $resid[0];
																
																$nombreb = 'Bodega_1';
																
																$limiteb = 1000;
																
																$actualb = 0;
																
																
																
															}
															else
															{
																//se busca la ultima bodega para continuar el control
																$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
																
																$qerybodega =  pg_query($conn,$sql);
																
																$dbod = pg_fetch_assoc($qerybodega);
																
																$dbod = $dbod['nombre'];
																
																$nombreb = explode("_".$dbod);
																
																$nombreb = ($nombreb[1]*1) + 1;
																
																$nombreb = 'Bodega_'.$nombreb;
																
																$limiteb = 1000;
																
																$actualb = 0;
																
																//se registra la nueva bodega
																
																$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																						VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') RETURNING id_bodega";
																
																$queryids = pg_query($conn,$sql);
																
																$resid = pg_fetch_array($queryids);
																
																$idbodega =  $resid[0];
																
															}
															//se crea el nuevo directorioo de bodega
															$carpeta = $ruta_bodega.$nombreb;
															if (!file_exists($carpeta))
															{
																mkdir($carpeta, 0777, true);
															}
														}
														else
														{	//existe una bodega desocupada
															
															$dbod = pg_fetch_assoc($qerybod);
															
															$idbodega = $dbod['id_bodega'];
															
															$nombreb = $dbod['nombre'];
															
															$limiteb = $dbod['limite'];
															
															$actualb = $dbod['actual'];
															
														}
													}
													else
													{
														if (trim($configdb[0]) == 'sqlsrv')
														{
															$qerybod = sqlsrv_query( $conn, $sql);
															
															$haybodega = sqlsrv_num_rows( $qerybod );
															
															if ($haybodega == 0)
															{
																
																//se verifica si es la primera bodega se debe generar una bodega nueva
																
																$sql = 'select id_bodega from sgd_bodegas  where id_bodega > 0 ';
																
																$qeryhabod = sqlsrv_query( $conn, $sql);
																
																$cbod = 0;
																
																while( $row = sqlsrv_fetch_array( $qeryhabod, SQLSRV_FETCH_ASSOC ))
																{
																	$cbod = $cbod + 1;
																}
																
																if ($cbod == 0)
																{
																	//se genera la primera bodega
																	
																	$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																														VALUES('Bodega_1', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
																	
																	$queryids = sqlsrv_query( $conn, $sql);
																	
																	$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
																	
																	$resource = sqlsrv_query($conn, $sql);
																	
																	while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																	{
																		$idbodega =  $row['id_bodega'];
																	}
																	
																	$nombreb = 'Bodega_1';
																	
																	$limiteb = 1000;
																	
																	$actualb = 0;
																	
																	
																}
																else
																{
																	//se busca la ultima bodega para continuar el control
																	$sql = 'select nombre from sgd_bodegas  where id_bodega > 0 ORDER BY id DESC LIMIT 1';
																	
																	$qerybodega = sqlsrv_query( $conn, $sql);
																	
																	while( $row = sqlsrv_fetch_array( $qerybodega, SQLSRV_FETCH_ASSOC ))
																	{
																		$dbod =  $row['nombre'];
																	}
																	
																	$dbod = $dbod['nombre'];
																	
																	$nombreb = explode("_".$dbod);
																	
																	$nombreb = ($nombreb[1]*1) + 1;
																	
																	$nombreb = 'Bodega_'.$nombreb;
																	
																	$limiteb = 1000;
																	
																	$actualb = 0;
																	
																	//se registra la nueva bodega
																	
																	$sql ="INSERT INTO sgd_bodegas (nombre,limite,actual,id_estado,created_at)
																															VALUES('".$nombreb."', 1000, 0,1,'".date("Y-m-d H:i:s")."') ";
																	
																	$queryids = sqlsrv_query( $conn, $sql);
																	
																	$sql ="SELECT TOP 1 id_bodega FROM  sgd_bodegas where id_bodega > 0 ORDER BY id_bodega desc";
																	
																	$resource = sqlsrv_query($conn, $sql);
																	
																	while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
																	{
																		$idbodega =  $row['id_bodega'];
																	}
																	
																}
																//se crea el nuevo directorioo de bodega
																$carpeta = $ruta_bodega.$nombreb;
																if (!file_exists($carpeta))
																{
																	mkdir($carpeta, 0777, true);
																}
															}
															else
															{	//existe una bodega desocupada
																
																while( $dbod = sqlsrv_fetch_array( $qerybod, SQLSRV_FETCH_ASSOC ))
																{
																	$idbodega = $dbod['id_bodega'];
																	
																	$nombreb = $dbod['nombre'];
																	
																	$limiteb = $dbod['limite'];
																	
																	$actualb = $dbod['actual'];
																}
																
																
															}
														}
													}
												}
												
												$czip = $czip + 1;
												
												//se separa la extension
												
												$extimg = substr(strrchr($listado[$iti], "."),1);
												
												$filename = substr($listado[$iti], 0, strrpos($listado[$iti],"."));
												
												if ($configdb[0] == 'mysql')
												{
													$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																			VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."')";
													
													$queryids =  mysql_query($sql,$conn);
													
													//se captura el ultimo id registrado
													$rs = mysql_query("SELECT MAX(id_imagendocum) AS id FROM sgd_imagen_documento");
													
													$rs = mysql_fetch_assoc($rs);
													
													$idimagen = $rs["id"];
													
													//se registra que hay imagenes en la tabla de encriptacion
													
													$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
													
													$queryids =  mysql_query($sql,$conn);
													
												}
												else
												{
													if ($configdb[0] == 'pgsql')
													{
														$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																							VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') RETURNING id_imagendocum";
														
														$queryids =  pg_query($conn,$sql);
														
														$resid = pg_fetch_array($queryids);
														
														$idimagen =  $resid[0];
														
														$idimagenes[]  = $idimagen;
														
														//se registra que hay imagenes en la tabla de encriptacion
														
														$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
														
														$queryids =  pg_query($conn,$sql);
														
													}
													else
													{
														if (trim($configdb[0]) == 'sqlsrv')
														{
															
															$sql ="INSERT INTO sgd_imagen_documento (id_documento,nombre,extension,id_bodega,id_estado,orden,created_at)
																									VALUES(".$id_documento.", '".$filename."', '".$extimg."',".$idbodega.",1,".$norden.",'".date("Y-m-d H:i:s")."') ";
															
															$queryids = sqlsrv_query($conn,$sql);
															
															$sql ="SELECT TOP 1 id_imagendocum FROM  sgd_imagen_documento where id_documento = ".$id_documento." ORDER BY id_imagendocum desc";
															
															$resource = sqlsrv_query($conn, $sql);
															
															while( $row = sqlsrv_fetch_array( $resource, SQLSRV_FETCH_ASSOC ))
															{
																$ultimoid =  $row['id_imagendocum'];
															}
															
															$idimagen =  $ultimoid;
															
															$idimagenes[]  = $idimagen;
															//se registra que hay imagenes en la tabla de encriptacion
															
															$sql = 'update sgd_encrypt set tiene_img = 1  where id_encrypt > 0 and id_estado = 1';
															
															$queryids =  sqlsrv_query($conn,$sql);
														}
														
													}
												}
												
												
												if ($idimagen > 0)
													{
														
														//se copia con el id del registro de imagen
														
														$fichero = $ruta_bodega.$nombreb."/".$filename.'.'.$extimg;
														
														$nuevo_fichero = $ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg;
														
														if (copy($fichero, $nuevo_fichero))
															{
																$dir = $ruta_bodega.$nombreb."/" . $filename.'.'.$extimg;
																
																encryptFile($idimagen.'_.'.$extimg,$ruta_bodega.$nombreb,$kweyllave);
																
																unlink($dir); //se eliminan los archivos hijos del zip
																
																unlink($ruta_bodega.$nombreb."/".$idimagen.'_.'.$extimg); //se eliminan el archovo hijo orignal
																
															}
													}
											}//fin del for
										
										unlink($archivopadre);   //se elimina el archivo zip padre
										
										unlink($ficherozip);   //se elimina el archivo zip padre
									}	
								
								
							}
						echo json_encode((['status'=>'ok','code'=>200,'message'=>count($idimagenes).' Obtained image','data'=>$idimagenes]));
					}
				else
					{
						echo json_encode((['status'=>'error','code'=>201,'message'=>'Problem occurred with zip']));
					}
				
				break; 
			
			/* ******************************************************** */ 
			case 'parseaimg':
				
				$idimagen = isset($_GET['idimagen']) && $_GET['idimagen'] !== '#' ? (int)$_GET['idimagen'] : 0;
				
				$nombreimg = isset($_GET['nombre']) && $_GET['nombre'] !== '' ? $_GET['nombre'] : '';
				
				$extimg = isset($_GET['extendion']) && $_GET['extendion'] !== '' ? $_GET['extendion'] : '';
				
				$bodega = isset($_GET['bodega']) && $_GET['bodega'] !== '#' ? (int)$_GET['bodega'] : 0;
				
				
				$imagenes = array();
							
				if (!file_exists($ruta_temp.$idimagen.'_.'.$extimg))
					{
				     				
						inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$ruta_temp,$kweyllave);
						
						if ($extimg == 'tif' or $extimg == 'tiff')
							{
									
								$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_tempapi.$idimagen.'_.jpg';
									
								exec($command);
									
							}
						else 
							{
								
								copy($ruta_temp.$idimagen.'_.'.$extimg, $ruta_tempapi.$idimagen.'_.'.$extimg);
							}	
					}	
				
					if ($extimg != 'tif' and $extimg != 'tiff')
						{
						
							$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.'.$extimg));
							
							$timagenes[] = $imgData;
							
							echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$timagenes])); //echo  chunk_split($imgData);//json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$base64]));
						
						}
					else
						{
							if ($extimg == 'tif' or $extimg == 'tiff')
							{
								$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.jpg'));
								
								$timagenes[] = $imgData;
								
								echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$timagenes])); //echo  chunk_split($imgData);//json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$base64]));
							
							}
						}
				
			break;
			
			case 'parseaimgs':
				$id_documento= isset($_GET['id_documento']) && $_GET['id_documento'] !== '#' ? (int)$_GET['id_documento'] : 0;
				
				$timagenes = array();
				//se buscan las imagenes de ese documento
				
				$sql = 'select id.id_documento,id.id_imagendocum ,id.nombre,id.extension,id.id_bodega,id.orden,id_estado  from sgd_imagen_documento id where  id_documento = '.$id_documento.' order by id.orden asc';
				
				if ($configdb[0] == 'mysql')
					{
						$queryusuarios =  mysql_query($sql,$conn);
						while($campoimgin = mysql_fetch_array($queryusuarios))
							{
								$nombreimg = $campoimgin['nombre'];
								
								$extimg = $campoimgin['extension'];
								
								$bodega = $campoimgin['id_bodega'];
								
								$idimagen =  $campoimgin['id_imagendocum'];
								
								if (!file_exists($ruta_temp.$idimagen.'_.'.$extimg))
									{
																						
										inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$ruta_temp,$kweyllave);
									
										if ($extimg == 'tif' or $extimg == 'tiff')
											{
												
												$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_tempapi.$idimagen.'_.jpg';
													
												exec($command);
													
											}
										else
											{
														
												copy($ruta_temp.$idimagen.'_.'.$extimg, $ruta_tempapi.$idimagen.'_.'.$extimg);
														
												
											}
									
									}
									
								if ($extimg != 'tif' and $extimg != 'tiff')
									{
									
										if (!file_exists($ruta_tempapi.$idimagen.'_.'.$extimg))
											{
												copy($ruta_temp.$idimagen.'_.'.$extimg, $ruta_tempapi.$idimagen.'_.'.$extimg);
											}
											
										$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.'.$extimg));
										
										$timagenes[] =  chunk_split($imgData);
									}
								else
									{
										if ($extimg == 'tif' or $extimg == 'tiff')
											{
												if (!file_exists($ruta_tempapi.$idimagen.'_.jpg'))
													{
														$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_tempapi.$idimagen.'_.jpg';
														
														exec($command);
													}
												
												$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.jpg'));
													
												$timagenes[] = chunk_split($imgData);//json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$base64]));
										
											}
									}
							}	
							echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$timagenes]));
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryusuarios =  pg_query($conn,$sql);	
								
								$timagenes = array();
								
								while($campoimgin = pg_fetch_array($queryusuarios))
									{
										$nombreimg = $campoimgin['nombre'];
										
										$extimg = $campoimgin['extension'];
										
										$bodega = $campoimgin['id_bodega'];
										
										$idimagen =  $campoimgin['id_imagendocum'];
										
										if (!file_exists($ruta_temp.$idimagen.'_.'.$extimg))
											{
												
												inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$ruta_temp,$kweyllave);
												
												if ($extimg == 'tif' or $extimg == 'tiff')
													{
														
														$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_tempapi.$idimagen.'_.jpg';
														
														exec($command);
														
													}
												else
													{
														
														copy($ruta_temp.$idimagen.'_.'.$extimg, $ruta_tempapi.$idimagen.'_.'.$extimg);
														
														
													}
												
											}
										
										if ($extimg != 'tif' and $extimg != 'tiff')
											{
												
												if (!file_exists($ruta_tempapi.$idimagen.'_.'.$extimg))
													{
														copy($ruta_temp.$idimagen.'_.'.$extimg, $ruta_tempapi.$idimagen.'_.'.$extimg);
													}
												
												$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.'.$extimg));
												
												$timagenes[] =  chunk_split($imgData);
											}
										else
											{
												if ($extimg == 'tif' or $extimg == 'tiff')
													{
														if (!file_exists($ruta_tempapi.$idimagen.'_.jpg'))
															{
																$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_tempapi.$idimagen.'_.jpg';
																
																exec($command);
															}
														
														$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.jpg'));
														
														$timagenes[] = chunk_split($imgData);//json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$base64]));
														
													}
											} 
									}		
									echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$timagenes]));
							}
						else 
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$queryusuarios =  sqlsrv_query($conn,$sql);
										
										//unset($timagenes);// = '';
										
										$timagenes = array();
										
										while( $campoimgin = sqlsrv_fetch_array( $queryusuarios, SQLSRV_FETCH_ASSOC ))
											{
												$nombreimg = $campoimgin['nombre'];
												
												$extimg = $campoimgin['extension'];
												
												$bodega = $campoimgin['id_bodega'];
												
												$idimagen =  $campoimgin['id_imagendocum'];
												
												if (!file_exists($ruta_temp.$idimagen.'_.'.$extimg))
													{
														
														inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$ruta_temp,$kweyllave);
														
														if ($extimg == 'tif' or $extimg == 'tiff')
															{
																
																$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_tempapi.$idimagen.'_.jpg';
																
																exec($command);
																
															}
														else
															{
																
																copy($ruta_temp.$idimagen.'_.'.$extimg, $ruta_tempapi.$idimagen.'_.'.$extimg);
																
																
															}
														
													}
												
												if ($extimg != 'tif' and $extimg != 'tiff')
													{
														
														if (!file_exists($ruta_tempapi.$idimagen.'_.'.$extimg))
															{
																copy($ruta_temp.$idimagen.'_.'.$extimg, $ruta_tempapi.$idimagen.'_.'.$extimg);
															}
														
														$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.'.$extimg));
														
														$timagenes[] =  chunk_split($imgData);
													}
												else
													{
														if ($extimg == 'tif' or $extimg == 'tiff')
															{
																if (!file_exists($ruta_tempapi.$idimagen.'_.jpg'))
																	{
																		$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_tempapi.$idimagen.'_.jpg';
																		
																		exec($command);
																	}
																
																$imgData = base64_encode(file_get_contents($ruta_tempapi.$idimagen.'_.jpg'));
																
																$timagenes[] = chunk_split($imgData);//json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$base64]));
																
															}
													} 
												
											}	
											
										echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$timagenes]));
									}	
							}	
					}	
			
			break;
			case 'unepdf':
				$id_usuario = isset($_GET['id_usuario']) && $_GET['id_usuario'] !== '#' ? (int)$_GET['id_usuario'] : 0;
				
				$idimagenes =  isset($_GET['idimagenes']) && $_GET['idimagenes'] !== '' ? $_GET['idimagenes'] : '';
				
				$nompdf= isset($_GET['nompdf']) && $_GET['nompdf'] !== '' ? $_GET['nompdf'] : '';   
				
				$idimagenes = explode(",",$idimagenes); 
				
				$timagenes = count($idimagenes);   //echo $timagenes; 
				
				//$ruta_tempapi ;
				
				if ($configdb[0] == 'mysql')
					{
						$unidos = '';
						
						for ( $i = 0 ; $i < $timagenes ; $i ++)
							{
								
								//se procesan los archivos de imagenes
								
								$sql = 'select id.id_documento,id.id_imagendocum ,id.nombre,id.extension,id.id_bodega,id.orden,id_estado  from sgd_imagen_documento id where  id_imagendocum = '.$idimagenes[$i];
																
								$queryarchivos =   mysql_query($sql,$conn);
								
								while($campoimgin = mysql_fetch_array($queryarchivos))
									{
										$nombreimg = $campoimgin['nombre'];
										
										$extimg = $campoimgin['extension'];
										
										$bodega = $campoimgin['id_bodega'];
										
										$idimagen =  $campoimgin['id_imagendocum'];
										
										if (!file_exists($ruta_temp.$idimagen.'_.'.$extimg))
											{
												
												inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$ruta_temp,$kweyllave);
												
												if ($extimg == 'tif' or $extimg == 'tiff')
													{
														
														$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_temp.$idimagen.'_.jpg';
														
														exec($command);
														
														$unidos .= $ruta_temp.$idimagen.'_.jpg '.' ';
														
													}
												else
													{
													
														$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
														
													}
											}
										else 
											{
												if ($extimg == 'tif' or $extimg == 'tiff')
													{
														if (!file_exists($ruta_temp.$idimagen.'_.jpg'))
															{
																$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_temp.$idimagen.'_.jpg';
																
																exec($command);
																
																$unidos .= $ruta_temp.$idimagen.'_.jpg '.' ';
															}
														else
															{
																
																$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
																
															}
														
													}
												
												$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
												
											}
									}// fin del while
									
									
							}//fin del for
							
							$command = "convert -density 200 ".$unidos."  ".$ruta_tempapi.$nompdf;
														
							exec($command);
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$unidos = '';
								
								for ( $i = 0 ; $i < $timagenes ; $i ++)
									{
										
										//se procesan los archivos de imagenes
										
										$sql = 'select id.id_documento,id.id_imagendocum ,id.nombre,id.extension,id.id_bodega,id.orden,id_estado  from sgd_imagen_documento id where  id_imagendocum = '.$idimagenes[$i];
																		
										$queryarchivos=  pg_query($conn,$sql);
										
										$timagenes = array();
										
										while($campoimgin = pg_fetch_array($queryarchivos))
											{
												$nombreimg = $campoimgin['nombre'];
												
												$extimg = $campoimgin['extension'];
												
												$bodega = $campoimgin['id_bodega'];
												
												$idimagen =  $campoimgin['id_imagendocum'];
												
												if (!file_exists($ruta_temp.$idimagen.'_.'.$extimg))
													{
														
														inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$ruta_temp,$kweyllave);
														
														if ($extimg == 'tif' or $extimg == 'tiff')
															{
																
																$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_temp.$idimagen.'_.jpg';
																
																exec($command);
																
																$unidos .= $ruta_temp.$idimagen.'_.jpg '.' ';
																
															}
														else
															{
																
																$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
																
															}
													}
												else
													{
														if ($extimg == 'tif' or $extimg == 'tiff')
															{
																if (!file_exists($ruta_temp.$idimagen.'_.jpg'))
																	{
																		$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_temp.$idimagen.'_.jpg';
																		
																		exec($command);
																		
																		$unidos .= $ruta_temp.$idimagen.'_.jpg '.' ';
																	}
																else
																	{
																		
																		$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
																		
																	}
																
															}
														
														$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
														
													}
											}// fin del while
										
										
									}//fin del for
								
									$command = "convert -density 200 ".$unidos."  ".$ruta_tempapi.$nompdf;
								
								exec($command);
							}//fin de pgsql
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$unidos = '';
										
										for ( $i = 0 ; $i < $timagenes ; $i ++)
											{
												
												//se procesan los archivos de imagenes
												
												$sql = 'select id.id_documento,id.id_imagendocum ,id.nombre,id.extension,id.id_bodega,id.orden,id_estado  from sgd_imagen_documento id where  id_imagendocum = '.$idimagenes[$i];
												
												$queryarchivos =  sqlsrv_query($conn,$sql);
												
												$timagenes = array();
												
												while( $campoimgin = sqlsrv_fetch_array( $queryarchivos, SQLSRV_FETCH_ASSOC ))
													{
														$nombreimg = $campoimgin['nombre'];
														
														$extimg = $campoimgin['extension'];
														
														$bodega = $campoimgin['id_bodega'];
														
														$idimagen =  $campoimgin['id_imagendocum'];
														
														if (!file_exists($ruta_temp.$idimagen.'_.'.$extimg))
															{
																
																inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$ruta_temp,$kweyllave);
																
																if ($extimg == 'tif' or $extimg == 'tiff')
																	{
																		
																		$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_temp.$idimagen.'_.jpg';
																		
																		exec($command);
																		
																		$unidos .= $ruta_temp.$idimagen.'_.jpg '.' ';
																		
																}
																else
																	{
																		
																		$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
																		
																	}
															}
														else
															{
																if ($extimg == 'tif' or $extimg == 'tiff')
																	{
																		if (!file_exists($ruta_temp.$idimagen.'_.jpg'))
																			{
																				$command = "convert ".$ruta_temp.$idimagen.'_.'.$extimg.' '.$ruta_temp.$idimagen.'_.jpg';
																				
																				exec($command);
																				
																				$unidos .= $ruta_temp.$idimagen.'_.jpg '.' ';
																			}
																		else
																			{
																				
																				$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
																				
																			}
																		
																	}
																
																$unidos .= $ruta_temp.$idimagen.'_.'.$extimg.' ';
																
															}
													}// fin del while
												
												
											}//fin del for
										
											$command = "convert -density 200 ".$unidos."  ".$ruta_tempapi.$nompdf;
										
										exec($command);
									}	
							}	
					}	
				
				$vdatos = array();
				
				//$vdatos[]['nompdf'] = $nompdf;
				
				//$vdatos[]['totalarchivos'] = $timagenes;
				
				$miarchivo = $ruta_tempapi.$nompdf;
				
				$imgData = base64_encode(file_get_contents($miarchivo));
				
				$vdatos[]['pdfbase64'] = $imgData;
				
				echo json_encode((['status'=>'ok','code'=>200,'message'=>'Zip was successfully created','nombre'=>$nompdf,'data'=>$vdatos]));
				
			break;	
			case 'comprimezip':
				$id_usuario = isset($_GET['id_usuario']) && $_GET['id_usuario'] !== '#' ? (int)$_GET['id_usuario'] : 0;
				
				$idimagenes =  isset($_GET['idimagenes']) && $_GET['idimagenes'] !== '' ? $_GET['idimagenes'] : '';
				
				$nomzip = isset($_GET['nomzip']) && $_GET['nomzip'] !== '' ? $_GET['nomzip'] : '';    //echo $nomzip;
				
				$idimagenes = explode(",",$idimagenes); //  print_r($idimagenes);
				
				$timagenes = count($idimagenes); 
				
				$zip = new ZipArchive();
					
				$filename = $nomzip.'.zip';    
				
				$rutazip =  '../img/apiimg/'.$espaciotrabajo.'/zipdescarga/';

				 
				
				//se crea la caperta de zip para el usuario (espacio de trabajo)
				if (!file_exists($rutazip))
					{
						mkdir($rutazip, 0777, true);
					}
				//se elimina cualquier basura con el mismo nombre	
				if (file_exists($rutazip.$filename))
					{
						unlink($rutazip.$filename);
					}	
				
				if ($configdb[0] == 'mysql')
					{
						
						if($zip->open($rutazip.$filename,ZIPARCHIVE::CREATE)===true)
							{
								$vpborrar = array();
								
								for ( $i = 0 ; $i < $timagenes ; $i ++)
									{
											
										//se procesan los archivos de imagenes
											
										$sql = 'select id.id_documento,id.id_imagendocum ,id.nombre,id.extension,id.id_bodega,id.orden,id_estado  from sgd_imagen_documento id where  id_imagendocum = '.$idimagenes[$i];
										
																				
										$queryarchivos =   mysql_query($sql,$conn);
											
										while($campoimgin = mysql_fetch_array($queryarchivos))
											{
												$nombreimg = $campoimgin['nombre'];
													
												$extimg = $campoimgin['extension'];
													
												$bodega = $campoimgin['id_bodega'];
													
												$idimagen =  $campoimgin['id_imagendocum'];
												
												$vpborrar[] = $idimagen.'_.'.$extimg;
													
												//se verifica si existe o no en la carpeta img/apiimg/workspace/idusuario
													
												if (!file_exists($rutazip.$idimagen.'_.'.$extimg))
													{
															
														inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$rutazip,$kweyllave);
										
														if ($extimg == 'tif' or $extimg == 'tiff')
															{
																	
																$command = "convert ".$rutazip.$idimagen.'_.'.$extimg.' '.$rutazip.$idimagen.'_.jpg';
																	
																exec($command);
																	
																$miarchivo = $rutazip.$idimagen.'_.jpg';
																
																$nuevofile = $idimagen.'_.jpg';
																	
															}
														else
															{
																$miarchivo = $rutazip.$idimagen.'_.'.$extimg;
																
																$nuevofile = $idimagen.'_.'.$extimg;
																
															}
													}
												else
													{
														if ($extimg == 'tif' or $extimg == 'tiff')
															{
																$miarchivo = $rutazip.$idimagen.'_.jpg';
																
																$nuevofile = $idimagen.'_.jpg';
																
															}
														else
															{
																$miarchivo = $rutazip.$idimagen.'_.'.$extimg;
																
																$nuevofile = $idimagen.'_.'.$extimg;
																
															}
													}
													
													$zip->addFile($miarchivo,$nuevofile); 
											}
									}	//fin del for
									
								$zip->close();
									
								$vdatos = array();
								
								//se elimina el archivo temporal de compresion
								for ( $i = 0 ; $i < count($vpborrar); $i ++)
									{
										unlink($rutazip.$vpborrar[$i]);
									}
									
								$vdatos[]['nomzip'] = $filename;
									
								$vdatos[]['totalarchivos'] = $timagenes;
								
								
								$miarchivo = $rutazip.$filename;
								
								$imgData = base64_encode(file_get_contents($miarchivo));
								
								$vdatos[]['zipbase64'] = $imgData;
									
								echo json_encode((['status'=>'ok','code'=>200,'message'=>'Zip was successfully created '.$filename,'data'=>$vdatos]));
									
							}//fin del zip
						else
							{
								echo json_encode((['status'=>'error','code'=>201,'message'=>'Problem occurred while generating zip']));
							}
						
					}
				else 
					{
						if ($configdb[0] == 'pgsql')
							{
															
								if($zip->open($rutazip.$filename,ZIPARCHIVE::CREATE)===true)
									{
										$vpborrar = array();
										
										for ( $i = 0 ; $i < $timagenes ; $i ++)
											{
										
												//se procesan los archivos de imagenes
										
												$sql = 'select id.id_documento,id.id_imagendocum ,id.nombre,id.extension,id.id_bodega,id.orden,id_estado  from sgd_imagen_documento id where  id_imagendocum = '.$idimagenes[$i];
										
												$queryarchivos =  pg_query($conn,$sql);
										
												while($campoimgin= pg_fetch_array($queryarchivos))
													{
														$nombreimg = $campoimgin['nombre'];
															
														$extimg = $campoimgin['extension'];
															
														$bodega = $campoimgin['id_bodega'];
															
														$idimagen =  $campoimgin['id_imagendocum'];
														
														$vpborrar[] = $idimagen.'_.'.$extimg;
											
														//se verifica si existe o no en la carpeta img/apiimg/workspace/idusuario
														
														if (!file_exists($rutazip.$idimagen.'_.'.$extimg))
															{
																
																inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$rutazip,$kweyllave);
																
																if ($extimg == 'tif' or $extimg == 'tiff')
																	{
																	
																		$command = "convert ".$rutazip.$idimagen.'_.'.$extimg.' '.$rutazip.$idimagen.'_.jpg';
																		
																		exec($command);
																		
																		$miarchivo = $rutazip.$idimagen.'_.jpg';
																		
																		$nuevofile = $idimagen.'_.jpg';
																		
																	}
																else
																	{
																		$miarchivo = $rutazip.$idimagen.'_.'.$extimg;
																		
																		$nuevofile = $idimagen.'_.'.$extimg;
																		
																	}
															}
														else
															{
																if ($extimg == 'tif' or $extimg == 'tiff')
																	{
																		$miarchivo = $rutazip.$idimagen.'_.jpg';
																		
																		$nuevofile = $idimagen.'_.jpg';
																		
																	}
																else
																	{
																		$miarchivo = $rutazip.$idimagen.'_.'.$extimg;
																		
																		$nuevofile = $idimagen.'_.'.$extimg;
																		
																	}
															}
														
														$zip->addFile($miarchivo,$nuevofile); 
														
														
												}
										
											}	//fin del for
									
										$zip->close();
									
										$vdatos = array();
										
										//se elimina el archivo temporal de compresion
										for ( $i = 0 ; $i < count($vpborrar); $i ++)
											{
												unlink($rutazip.$vpborrar[$i]);
											}
									
										$vdatos[]['nomzip'] = $filename;
									
										$vdatos[]['totalarchivos'] = $timagenes;
										
										$miarchivo = $rutazip.$filename;
										
										$imgData = base64_encode(file_get_contents($miarchivo));
										
										$vdatos[]['zipbase64'] = $imgData;
									
										echo json_encode((['status'=>'ok','code'=>200,'message'=>'Zip was successfully created '.$filename,'data'=>$vdatos]));
									
									}//fin del zip
								else
									{
										echo json_encode((['status'=>'error','code'=>201,'message'=>'Problem occurred while generating zip']));
									}
							}								
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										
										if($zip->open($rutazip.$filename,ZIPARCHIVE::CREATE)===true) 
											{
												$vpborrar = array();
												
												for ( $i = 0 ; $i < $timagenes ; $i ++)
													{
														
														//se procesan los archivos de imagenes
														
														$sql = 'select id.id_documento,id.id_imagendocum ,id.nombre,id.extension,id.id_bodega,id.orden,id_estado  from sgd_imagen_documento id where  id_imagendocum = '.$idimagenes[$i];
														
														$queryarchivos =  sqlsrv_query($conn,$sql);
														
														while( $campoimgin = sqlsrv_fetch_array( $queryarchivos, SQLSRV_FETCH_ASSOC ))
															{
																$nombreimg = $campoimgin['nombre'];
															
																$extimg = $campoimgin['extension'];
															
																$bodega = $campoimgin['id_bodega'];
															
																$idimagen =  $campoimgin['id_imagendocum'];
																
																$vpborrar[] = $idimagen.'_.'.$extimg;
																
																//se verifica si existe o no en la carpeta img/apiimg/workspace/idusuario
																
																if (!file_exists($rutazip.$idimagen.'_.'.$extimg))
																	{
																		
																		inFTP($idimagen.'_.'.$extimg,$ruta_bodega.'Bodega_'.$bodega,$rutazip,$kweyllave);
																		
																		if ($extimg == 'tif' or $extimg == 'tiff')
																			{
																				
																				$command = "convert ".$rutazip.$idimagen.'_.'.$extimg.' '.$rutazip.$idimagen.'_.jpg';
																				
																				exec($command);
																				
																				$miarchivo = $rutazip.$idimagen.'_.jpg';
																				
																				$nuevofile = $idimagen.'_.jpg';
																				
																			}
																		else
																			{
																				$miarchivo = $rutazip.$idimagen.'_.'.$extimg;
																				
																				$nuevofile = $idimagen.'_.'.$extimg;
																				
																			}
																	}
																else
																	{
																		if ($extimg == 'tif' or $extimg == 'tiff')
																			{
																				$miarchivo = $rutazip.$idimagen.'_.jpg';
																				
																				$nuevofile = $idimagen.'_.jpg';
																				
																			}
																		else
																			{
																				$miarchivo = $rutazip.$idimagen.'_.'.$extimg;
																				
																				$nuevofile = $idimagen.'_.'.$extimg;
																				
																			}
																	}
																
																$zip->addFile($miarchivo,$nuevofile); 
																	
																	
																}
																
															}	//fin del for
														
														$zip->close();
														
														$vdatos = array();
														
														//se elimina el archivo temporal de compresion
														for ( $i = 0 ; $i < count($vpborrar); $i ++)
															{
																unlink($rutazip.$vpborrar[$i]);
															}
														
														$vdatos[]['nomzip'] = $filename;
														
														$vdatos[]['totalarchivos'] = $timagenes;
														
														$miarchivo = $rutazip.$filename;
														
														$imgData = base64_encode(file_get_contents($miarchivo));
														
														$vdatos[]['zipbase64'] = $imgData;
														
														echo json_encode((['status'=>'ok','code'=>200,'message'=>'Zip was successfully created '.$filename,'data'=>$vdatos]));
														
													}//fin del zip
											else 
												{
													echo json_encode((['status'=>'error','code'=>201,'message'=>'Problem occurred while generating zip']));
												}	
										
									}	
							}	
					}	
				
				
			break;
			case 'dameusuariosreg':
				
				$id_usuario = isset($_GET['id_usuario']) && $_GET['id_usuario'] !== '#' ? (int)$_GET['id_usuario'] : 0; 			
				
				$script = '';
				
				$sql = "SELECT u.name,u.lastname,u.id,u.avatar FROM sgd_usuarios u WHERE u.id > 0 and u.id <> ".$id_usuario;
					
				if ($configdb[0] == 'mysql')
					{
						$queryusuarios =  mysql_query($sql,$conn);
							
						while($campoimgin = mysql_fetch_array($queryusuarios))
							{
								$script .= '<div id="user_'.$campoimgin['id'].'" class="status-badge mrg10A" style="cursor:pointer;position:relative;float:left !important" data-idusuariosel="'.$campoimgin['id'].'" onclick="marcame(this.id)" title="'.$campoimgin['name'].' '.$campoimgin['lastname'].'">';
								$script .= '<img id="im_'.$campoimgin['id'].'" class="img-circle" width="40" src="../../img/perfiles/'.$campoimgin['avatar'].'" alt="">';
								$script .= '<div class="small-badge bg-red"></div>';
								$script .= '</div>';
							}	
					}
				else
					{
						if ($configdb[0] == 'pgsql')
							{
								$queryusuarios =  pg_query($conn,$sql);
								
								while($campoimgin = pg_fetch_array($queryusuarios))
									{
										$script .= '<div id="user_'.$campoimgin['id'].'" class="status-badge mrg10A" style="cursor:pointer;position:relative;float:left !important" data-idusuariosel="'.$campoimgin['id'].'" onclick="marcame(this.id)" title="'.$campoimgin['name'].' '.$campoimgin['lastname'].'">';
										$script .= '<img id="im_'.$campoimgin['id'].'" class="img-circle" width="40" src="../../img/perfiles/'.$campoimgin['avatar'].'" alt="">';
										$script .= '<div class="small-badge bg-red"></div>';
										$script .= '</div>';
									}
							}
						else
							{
								if (trim($configdb[0]) == 'sqlsrv')
									{
										$queryusuarios =  sqlsrv_query($conn,$sql);
										
										while( $campoimgin = sqlsrv_fetch_array( $queryusuarios, SQLSRV_FETCH_ASSOC ))
											{
												$script .= '<div id="user_'.$campoimgin['id'].'" class="status-badge mrg10A" style="cursor:pointer;position:relative;float:left !important" data-idusuariosel="'.$campoimgin['id'].'" onclick="marcame(this.id)" title="'.$campoimgin['name'].' '.$campoimgin['lastname'].'">';
												$script .= '<img id="im_'.$campoimgin['id'].'" class="img-circle" width="40" src="../../img/perfiles/'.$campoimgin['avatar'].'" alt="">';
												$script .= '<div class="small-badge bg-red"></div>';
												$script .= '</div>';
											}
									}	
							}	
					}	
				echo $script;	
			break;	
			case 'extraezip':
				
				$destino =  isset($_GET['destino']) && $_GET['destino'] !== '' ? $_GET['destino'] : '';
				
				$archivodelzip =  isset($_GET['archivodelzip']) && $_GET['archivodelzip'] !== '' ? $_GET['archivodelzip'] : ''; 
				
				$archivopadre =  isset($_GET['archivopadre']) && $_GET['archivopadre'] !== '' ? $_GET['archivopadre'] : ''; 
				
				$bod = isset($_GET['bod']) && $_GET['bod'] !== '#' ? (int)$_GET['bod'] : 0;
				
				$ordenimg = isset($_GET['ordenimg']) && $_GET['ordenimg'] !== '#' ? (int)$_GET['ordenimg'] : 0;
				
				$d = isset($_GET['d']) && $_GET['d'] !== '#' ? (int)$_GET['d'] : 0;
				
				$uno = isset($_GET['uno']) && $_GET['uno'] !== '#' ? (int)$_GET['uno'] : 0;
				
				$dos = isset($_GET['dos']) && $_GET['dos'] !== '#' ? (int)$_GET['dos'] : 0;
				
				$num = isset($_GET['num']) && $_GET['num'] !== '#' ? (int)$_GET['num'] : 0;
				
				$exp = isset($_GET['exp']) && $_GET['exp'] !== '#' ? (int)$_GET['exp'] : 0;
				
				
				$workspace = $espaciotrabajo;
				
				$rutadestino = '../img/apiimg/'.$workspace.'/';
				
				$rutadestinozip = '/img/apiimg/'.$workspace.'/';
				
				//se crea la carpeta de destino si solo si no existe
				if (!file_exists($destino))
					{
						mkdir($destino, 0777, true);
					}
				
				require_once('manejozip.php');
				
				$zip_manager = new Zip_manager();
				
				$resultado = $zip_manager->extraer($archivopadre, $destino);
				
				$script = '';
				
				if ($resultado)
					{	
						// se verifica que el archivo sea tiff. de ser asi se convierte a jpg en la misma carpeta destino
						
						$extimg = substr(strrchr($archivodelzip, "."),1);
						
						$filename = substr($archivodelzip, 0, strrpos($archivodelzip,"."));
						
						if ($extimg == 'tif' or $extimg == 'tiff')
							{
									
								$command = "convert ".$rutadestino.$archivodelzip.' '.$rutadestino.$filename.'_.jpg';   //echo $command;
									
								exec($command);
							
								$miarchivo = $rutadestinozip.$filename.'_.jpg';
									
							}
						else
							{
								$miarchivo = $rutadestinozip.$filename.'.'.$extimg;
							}
							
							$conteoimg = $num;
							
							if ($extimg != 'pdf')
								{
									$script .= '<img id="image_central" src="'.$rutadir.$miarchivo.'" data-d="'.$d.'" data-1="'.$uno.'"  data-2="'.$dos.'" class="sb-toggle-right imgcentral zoom" onclick="zoomimg(this.id,1)" data-exp="'.$exp.'" data-num="'.$conteoimg.'" alt="" width="80%" max-width="100%" style="position:relative;left:5%;cursor:pointer;z-index:99;">';
								}
							else
								{
									$script .= '<iframe id="print-iframep" name="print-iframep" src="/ViewerJS/./#'.$rutadir.$miarchivo.'" class="tiraimg" height="1000" width="80%" data-bod="'.$bod.'" data-ordenimg="'.$ordenimg.'" data-d="'.$d.'" data-1="'.$uno.'"  data-2="'.$dos.'" data-num="'.$conteoimg.'"></iframe>';
								}
							
						echo $script;
					}
			break;
			case 'listazip':
			
				$idzip = isset($_GET['idzip']) && $_GET['idzip'] !== '#' ? (int)$_GET['idzip'] : 0;
				
				$id_usuario = isset($_GET['id_usuario']) && $_GET['id_usuario'] !== '#' ? (int)$_GET['id_usuario'] : 0;
				
				$idbodega = isset($_GET['idbodega']) && $_GET['idbodega'] !== '#' ? (int)$_GET['idbodega'] : 0; 
				
				require_once('manejozip.php');
				
				$zip_manager = new Zip_manager();
				
				$archivo_zip = $ruta_bodega.'Bodega_'.$idbodega.'/'.$idzip.'_.zip';
					
				$listado = $zip_manager->listar($archivo_zip);
					
				//se listan los archivos que contiene
						
				$varchizip = array();
				
				for ($iti = 0; $iti < count($listado); $iti++)
					{
						
						$varchizip[] = $listado[$iti];
						
					}
				
				echo json_encode((['status'=>'ok','code'=>200,'message'=>'Zip listing: '.$idzip.'_.zip','data'=>$varchizip]));
				
			break;
			
			case 'extraedelzip':
				
				$idzip = isset($_GET['idzip']) && $_GET['idzip'] !== '#' ? (int)$_GET['idzip'] : 0;
				
				$id_usuario = isset($_GET['id_usuario']) && $_GET['id_usuario'] !== '#' ? (int)$_GET['id_usuario'] : 0;
				
				$idbodega = isset($_GET['idbodega']) && $_GET['idbodega'] !== '#' ? (int)$_GET['idbodega'] : 0;
				
				$elfile =  isset($_GET['elfile']) && $_GET['elfile'] !== '' ? $_GET['elfile'] : '';
				
				$workspace = $espaciotrabajo;
				
				$rutadestino = '../img/apiimg/'.$workspace.'/';
				
				$destino = $rutadestino;
				
				$rutadestinozip = '/img/apiimg/'.$workspace.'/';
				
				$archivodelzip = $elfile;
				
				//se crea la carpeta de destino si solo si no existe
				if (!file_exists($destino))
					{
						mkdir($destino, 0777, true);
					}
				
				require_once('manejozip.php');
				
				$archivo_zip = $ruta_bodega.'Bodega_'.$idbodega.'/'.$idzip.'_.zip';
				
				$zip_manager = new Zip_manager();
				
				$resultado = $zip_manager->extraer($archivo_zip, $destino);
				
				$timagenes = array();
				
				if ($resultado)
					{
						// se verifica que el archivo sea tiff. de ser asi se convierte a jpg en la misma carpeta destino
						
						$extimg = substr(strrchr($archivodelzip, "."),1);
						
						$filename = substr($archivodelzip, 0, strrpos($archivodelzip,"."));
						
						if ($extimg == 'tif' or $extimg == 'tiff')
							{
									
								$command = "convert ".$rutadestino.$archivodelzip.' '.$rutadestino.$filename.'_.jpg';   //echo $command;
									
								exec($command);
									
								$miarchivo = $rutadestino.$filename.'_.jpg';
								
								$imgData = base64_encode(file_get_contents($miarchivo));
									
								$timagenes[] = $imgData;
									
								echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$timagenes]));
									
							}
						else
							{
								if ($extimg != 'tif' or $extimg != 'tiff')
									{
										$miarchivo = $rutadestino.$filename.'_.'.$extimg;
										
										$imgData = base64_encode(file_get_contents($miarchivo));
											
										$timagenes[] = $imgData;
											
										echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','data'=>$timagenes]));
									}	
								
							}
						
					}
			break;
			
			case 'verdelzip':
					
				$idzip = isset($_GET['idzip']) && $_GET['idzip'] !== '#' ? (int)$_GET['idzip'] : 0;
				
				$id_usuario = isset($_GET['id_usuario']) && $_GET['id_usuario'] !== '#' ? (int)$_GET['id_usuario'] : 0;
				
				$idbodega = isset($_GET['idbodega']) && $_GET['idbodega'] !== '#' ? (int)$_GET['idbodega'] : 0;
				
				$workspace = $espaciotrabajo;
				
				$rutadestino = '../img/apiimg/'.$workspace.'/';
				
				$destino = $rutadestino;
				
				$rutadestinozip = '/img/apiimg/'.$workspace.'/';
				
				//se crea la carpeta de destino si solo si no existe
				if (!file_exists($destino))
					{
						mkdir($destino, 0777, true);
					}
				
				require_once('manejozip.php');
				
				$archivo_zip = $ruta_bodega.'Bodega_'.$idbodega.'/'.$idzip.'_.zip';
				
				$zip_manager = new Zip_manager();
				
				$resultado = $zip_manager->extraer($archivo_zip, $destino);
				
				$timagenes = array();
				
				if ($resultado)
					{
						
						$listado = $zip_manager->listar($archivo_zip);
						
						$totalzip = count($listado);
							
						//se listan los archivos que contiene
						
						for ($iti = 0; $iti < count($listado); $iti++)
							{
							
								$timagenes[]['archivo'] = $listado[$iti];
								
								// se verifica que el archivo sea tiff. de ser asi se convierte a jpg en la misma carpeta destino
								
								$archivodelzip = $listado[$iti];
									
								$extimg = substr(strrchr($archivodelzip, "."),1);
									
								$filename = substr($archivodelzip, 0, strrpos($archivodelzip,"."));
									
								if ($extimg == 'tif' or $extimg == 'tiff')
									{
											
										$command = "convert ".$rutadestino.$archivodelzip.' '.$rutadestino.$filename.'_.jpg';   //echo $command;
											
										exec($command);
											
										$miarchivo = $rutadestino.$filename.'_.jpg';
									
										$imgData = base64_encode(file_get_contents($miarchivo));
											
										$timagenes[]['base64'] = $imgData;																
											
									}
								else
									{
										if ($extimg != 'tif' or $extimg != 'tiff')
											{
												$miarchivo = $rutadestino.$filename.'_.'.$extimg;
													
												$imgData = base64_encode(file_get_contents($miarchivo));
													
												$timagenes[]['base64'] = $imgData;
													
											}
									
									}
							
							}
							
						echo json_encode((['status'=>'ok','code'=>200,'message'=>'Obtained image','total'=>$totalzip,'data'=>$timagenes]));
					
					}
			
		}
	}
	catch (Exception $e) {
		header($_SERVER["SERVER_PROTOCOL"] . ' 500 Server Error');
		header('Status:  500 Server Error');
		echo $e->getMessage();
	}
	die();
}


?>